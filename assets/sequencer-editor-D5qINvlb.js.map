{"version":3,"file":"sequencer-editor-D5qINvlb.js","sources":["../../src/customnodes/seq/sequencer-editor.ts"],"sourcesContent":["\nimport { LitElement, html, css, unsafeCSS } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { PointerDragOp } from '../../utils/pointer-drag-op';\nimport { appController } from '../../builder/controllers';\nimport { ROW_HEIGHT } from '../../constants';\n\ninterface Step {\n  noteIndex: number | null;\n  velocity: number;\n  hold: boolean;\n}\n\n@customElement('seq-sequencer-editor')\nexport class SequencerEditor extends LitElement {\n  @property() nodeId: string = '';\n  @property({ type: Object }) config: any = {};\n  @property() requestConfigUpdate: (newConfig: any) => void = () => { };\n\n  private lastHoveredStep: number = -1;\n  private dragOp: PointerDragOp | null = null;\n\n  static styles = css`\n    :host {\n      display: block;\n      width: 100%;\n      height: ${unsafeCSS(3 * ROW_HEIGHT + 'px')};\n      color: white;\n      font-family: var(--font-family, sans-serif);\n      background: #1e1e1e;\n      border-radius: 4px;\n      overflow: hidden;\n      user-select: none;\n      touch-action: none;\n    }\n\n    .sequencer-grid {\n      display: flex;\n      flex-direction: row;\n      height: 100%;\n      gap: 0;\n      padding: 4px;\n      box-sizing: border-box;\n    }\n\n    .step {\n      flex: 1;\n      background: #333;\n      border-radius: 2px;\n      position: relative;\n      cursor: pointer;\n      display: flex;\n      align-items: flex-end;\n      justify-content: center;\n      border-right: 1px solid #1e1e1e;\n    }\n\n    .step:last-child {\n      border-right: none;\n    }\n\n    .step:hover {\n      background: #444;\n    }\n\n    .step.active {\n      background: rgba(100, 149, 237, 0.2);\n    }\n\n    .step-bar {\n      width: 100%;\n      background: var(--accent-color, #6495ed);\n      border-radius: 1px;\n    }\n  `;\n\n  disconnectedCallback() {\n    super.disconnectedCallback();\n    if (this.dragOp) {\n      this.dragOp.dispose();\n      this.dragOp = null;\n    }\n  }\n\n  getSequence(): Step[] {\n    const values = this.config.values || {};\n    if (values.sequence && Array.isArray(values.sequence)) {\n      return values.sequence;\n    }\n    return Array(16).fill({ noteIndex: null, velocity: 0, hold: false });\n  }\n\n  // Toggle the step at the given index\n  toggleStep(seq: Step[], index: number) {\n    const oldStep = seq[index] || { noteIndex: null, velocity: 0, hold: false };\n    const step = { ...oldStep };\n\n    const isActive = step.noteIndex !== null;\n    if (!isActive) {\n      step.noteIndex = 60;\n      step.velocity = 1.0;\n      step.hold = false;\n    } else {\n      step.noteIndex = null;\n      step.velocity = 0;\n      step.hold = false;\n    }\n\n    seq[index] = step;\n  }\n\n  updateConfig(seq: Step[]) {\n    const newConfig = {\n      ...this.config,\n      values: {\n        ...(this.config.values || {}),\n        sequence: seq\n      }\n    };\n    this.config = newConfig;\n    this.requestConfigUpdate(newConfig);\n    this.requestUpdate();\n  }\n\n  handlePointerDown(e: PointerEvent, index: number) {\n    this.lastHoveredStep = index;\n    const seq = [...this.getSequence()];\n\n    // Toggle on down (Per-step inversion)\n    this.toggleStep(seq, index);\n    this.updateConfig(seq);\n\n    this.dragOp = new PointerDragOp(e, this, {\n      callMoveImmediately: false,\n      move: (e) => this.handleDragMove(e),\n      complete: () => {\n        this.dragOp = null;\n        this.lastHoveredStep = -1;\n      }\n    });\n  }\n\n  handleDragMove(e: PointerEvent) {\n    const elements = this.shadowRoot?.elementsFromPoint(e.clientX, e.clientY) || [];\n    const stepEl = elements.find(el => el.classList.contains('step'));\n\n    if (stepEl) {\n      const indexStr = (stepEl as HTMLElement).dataset.index;\n      if (indexStr) {\n        const index = parseInt(indexStr, 10);\n\n        if (index !== this.lastHoveredStep) {\n          const seq = [...this.getSequence()];\n\n          // Continuous Collision Detection: Fill gaps between lastHovered and current\n          // Logic: Move from lastHovered towards index\n          const start = this.lastHoveredStep;\n          const end = index;\n          const dir = Math.sign(end - start);\n\n          // We start from start + dir to avoid re-toggling the start step\n          // We include the end step\n          // Note: If fast drag, difference > 1\n          if (dir !== 0) {\n            let curr = start + dir;\n            while (curr !== end + dir) {\n              // Bounds check just in case, though grid is fixed\n              if (curr >= 0 && curr < 16) {\n                this.toggleStep(seq, curr);\n              }\n              curr += dir;\n            }\n          }\n\n          this.updateConfig(seq);\n          this.lastHoveredStep = index;\n        }\n      }\n    }\n  }\n\n  render() {\n    const seq = this.getSequence();\n\n    return html`\n      <div class=\"sequencer-grid\" @dblclick=${(e: Event) => e.stopPropagation()}>\n        ${seq.map((step, i) => {\n      const isActive = step.noteIndex !== null;\n      const velocity = step.velocity ?? 0;\n      const height = isActive ? Math.max(10, velocity * 100) : 0;\n\n      return html`\n            <div class=\"step ${isActive ? 'active' : ''}\"\n                 data-index=\"${i}\"\n                 @pointerdown=${(e: PointerEvent) => this.handlePointerDown(e, i)}\n            >\n              <div class=\"step-bar\" style=\"height: ${height}%\"></div>\n            </div>\n          `;\n    })}\n      </div>\n    `;\n  }\n}\n\n// Export as a function that returns the template\nexport const SequencerEditorRenderer = (node: any) => {\n  return html`<seq-sequencer-editor .nodeId=${node.id} .config=${node.config} .requestConfigUpdate=${(newConfig: any) => appController.setNodeConfig(node.id, newConfig)}></seq-sequencer-editor>`;\n};\n"],"names":["SequencerEditor","LitElement","values","seq","index","step","newConfig","e","PointerDragOp","stepEl","el","indexStr","start","end","dir","curr","html","i","isActive","velocity","height","css","unsafeCSS","ROW_HEIGHT","__decorateClass","property","customElement","SequencerEditorRenderer","node","appController"],"mappings":"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"}