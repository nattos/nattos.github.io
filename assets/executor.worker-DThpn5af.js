const R={kind:"atomic",type:"number",defaultValue:0},mi={kind:"atomic",type:"string",defaultValue:""},B={kind:"atomic",type:"any"};function K(e,i){if(e==null)return e;if(i.kind==="atomic")return e&&typeof e=="object"&&"kind"in e&&e.kind==="atomic"?e.value:e;if(i.kind==="array")return Array.isArray(e)?e.map(n=>K(n,i.element)):[];if(i.kind==="record"){if(typeof e=="object"){if("fields"in e){const t=e,r={};for(const[s,o]of Object.entries(i.fields))s in t.fields&&(r[s]=K(t.fields[s],o));return r}const n={};for(const[t,r]of Object.entries(i.fields))t in e&&(n[t]=K(e[t],r));return n}return e}return e}function Ye(e,i){if(e==null||i.kind==="atomic")return e;if(i.kind==="array")return Array.isArray(e)?e.map(t=>Ye(t,i.element)):(console.error("toStructor array fail: not array",e),[]);if(i.kind==="record"){const n={};for(const[t,r]of Object.entries(i.fields))e[t]!==void 0&&(n[t]=Ye(e[t],r));return{fields:n}}return e}function U(e){const i={kind:"record",fields:e.config||{}},n={kind:"record",fields:e.outputs};return{id:e.id,kind:"primitive",metadata:e.metadata,inputs:e.inputs,outputs:e.outputs,configType:i,isRealtime:e.isRealtime,onMessage:e.onMessage,getDisplayLabel:e.getDisplayLabel,subgraphExpansionTag:e.subgraphExpansionTag,getChildren:e.getChildren,getRegion:e.getRegion,cycleBreakingPorts:e.cycleBreakingPorts,consolidate:e.consolidate?(t,r,s,o)=>{const a=K(r,i),u={},l=t.fields||{};for(const[d,f]of Object.entries(e.inputs||{}))l[d]!==void 0&&(u[d]=K(l[d],f));e.consolidate(u,a,s,o)}:void 0,computeBackwardPorts:e.computeBackwardPorts,computeForwardPorts:(t,r,s,o)=>e.computeForwardPorts?e.computeForwardPorts(t,r,s,o):{inputs:{kind:"record",fields:e.inputs||{}},outputs:n},shouldRecompileOnConfigChange:(t,r)=>e.shouldRecompileOnConfigChange?e.shouldRecompileOnConfigChange(t,r):!1,compileConfig:e.compileConfig,ui:e.ui,createState:e.createState,execute:(t,r,s)=>{const o=K(r,i);let a;if(e.createState){const g=s.nodeId||`${e.id}-${JSON.stringify(r)}`;s.nodeState.has(g)||s.nodeState.set(g,e.createState(o,s)),a=s.nodeState.get(g)}let u=t;if(e.autoBroadcast&&e.inputs){const g={outputs:{},reshape:e.reshape??"none"},y=typeof e.autoBroadcast=="object"?e.autoBroadcast:{};if(o&&typeof o=="object"&&"autoBroadcast"in o){const S=o.autoBroadcast;S&&typeof S=="object"&&Object.assign(y,S)}for(const[S,A]of Object.entries(e.inputs)){const E=A.kind==="array",N=y[S],w=E?"collect":{reduce:"first"},q=N&&"combine"in N?N.combine:w;g.outputs[S]={fromFields:[S],combine:q??void 0}}const _=s.broadcast(g,t).apply(S=>{const A={};for(const[N,w]of Object.entries(e.inputs))if(g.outputs[N]?.combine==="collect"&&Array.isArray(S[N])){const V=S[N].map(z=>{if(Array.isArray(z)&&z.length>0&&Array.isArray(z[0])&&w.kind==="array"&&w.element.kind==="record")return z.map(Z=>K(Z,w.element));const $=w.element?.kind==="array",Ce=Array.isArray(z)&&z.length>0&&Array.isArray(z[0]);return $&&!Ce?K(z,w.element):K(z,w)}),J=w.element?.kind==="array";V.length===1&&Array.isArray(V[0])&&!J?A[N]=V[0]:A[N]=V}else{const V=S[N],J=w.element?.kind==="array",z=Array.isArray(V)&&V.length>0&&Array.isArray(V[0]);let $;w.kind==="array"&&J&&!z?$=K(V,w.element):$=K(V,w),A[N]=$!==void 0?$:w.defaultValue}return e.execute(A,o,s,a)});if(Array.isArray(_))if(_.length>0){const S={},A=_[0];for(const N of Object.keys(A))S[N]=[];for(const N of _)for(const[w,q]of Object.entries(N))S[w]&&S[w].push(q);const E={};for(const[N,w]of Object.entries(S)){const q=e.outputs[N]||e.dynamicOutputType;q&&(E[N]=Ye(w,{kind:"array",element:q,size:_.length}))}return{fields:E}}else return{fields:{}};else{let S=_,A;S&&typeof S=="object"&&"outputs"in S&&("ui"in S||Object.keys(S).length===2)&&("outputs"in e.outputs||(A=S.ui,S=S.outputs));const E=new Set([...Object.keys(e.outputs),...Object.keys(S)]),N={};for(const q of E){const V=e.outputs[q]||e.dynamicOutputType;V&&S[q]!==void 0&&(N[q]=Ye(S[q],V))}const w={fields:N};return A!==void 0?{outputs:w,ui:A}:w}}else if(e.inputs&&Object.keys(e.inputs).length>0){const g={};for(const[y,b]of Object.entries(e.inputs))t.fields&&t.fields[y]!==void 0?g[y]=K(t.fields[y],b):b.defaultValue!==void 0&&(g[y]=b.defaultValue);u=g}let d=e.execute(u,o,s,a),f;d&&typeof d=="object"&&"outputs"in d&&("ui"in d||Object.keys(d).length===2)&&("outputs"in e.outputs||(f=d.ui,d=d.outputs));const p={},h=d;if(h){const g=new Set([...Object.keys(e.outputs),...Object.keys(h)]);for(const y of g){const b=e.outputs[y]||e.dynamicOutputType;b&&h[y]!==void 0&&(p[y]=Ye(h[y],b))}}const m={fields:p};return f!==void 0?{outputs:m,ui:f}:m}}}function ns(e,i,n){const t={outputs:{},reshape:"none"};for(const[a,u]of Object.entries(i))t.outputs[a]={fromFields:u.source?Array.isArray(u.source)?u.source:[u.source]:[a],combine:u.combine??{reduce:"first"}};const s=e.broadcast(t,n).apply(a=>a),o={};if(Array.isArray(s)){for(const a of Object.keys(i))o[a]=[];for(const a of s)for(const u of Object.keys(i))o[u].push(a[u])}else for(const a of Object.keys(i))o[a]=s[a];for(const[a,u]of Object.entries(i))if(u.type)if(u.combine==="collect"){const l=o[a];Array.isArray(l)?o[a]=l.map(d=>K(d,u.type)):o[a]=K(l,u.type)}else{const l=o[a];Array.isArray(l)?o[a]=l.map(d=>K(d,u.type)):o[a]=K(l,u.type)}return o}function F(e,i,n,t="binary"){return U({id:e,metadata:i,inputs:t==="binary"?{a:R,b:R}:{a:R},outputs:{result:R},autoBroadcast:!0,reshape:"vector",execute:(s,o,a)=>{if(t==="binary"){const{a:u,b:l}=s;return{result:n(u,l)}}else{const{a:u}=s;return{result:n(u,0)}}}})}function vi(e){if(e.length===0)return B;const i=e[0];if(e.every(s=>s.kind===i.kind&&(s.kind==="atomic"?s.type===i.type:!0)))return i;if(e.some(s=>s.kind==="atomic"&&s.type==="string"))return B;const t=e.some(s=>s.kind==="atomic"&&s.type==="number"),r=e.some(s=>s.kind==="atomic"&&s.type==="boolean");return t||r?R:B}var tn=(e=>(e.Auto="auto",e.Show="show",e.Hide="hide",e))(tn||{});class rs{constructor(){this.nodes=new Map}register(i){this.nodes.set(i.id,i)}get(i){return this.nodes.get(i)?.definition}getNodeType(i){return this.nodes.get(i)}getAllNodeTypes(){return this.nodes.values()}}const nn=new rs;function k(e){const i={};for(const[r,s]of Object.entries(e.inputs||{}))if("kind"in s)i[r]=s;else if("type"in s){const o=s,a=o.type,u=o.allowMultiConnection?{kind:"array",size:"dynamic",element:a}:a;i[r]={...u,redirect:o.redirect,defaultValue:"defaultValue"in o?o.defaultValue:a.defaultValue}}const n={};for(const[r,s]of Object.entries(e.outputs||{}))"kind"in s?n[r]=s:"type"in s&&(n[r]=s.type);return{...U({...e,autoBroadcast:e.autoBroadcast,inputs:i,outputs:n,compileConfig:(r,s)=>e.compileConfig?e.compileConfig(r,s):r,computeForwardPorts:(r,s,o,a)=>e.computeForwardPorts?e.computeForwardPorts(r,s,o,a):{inputs:{kind:"record",fields:i},outputs:{kind:"record",fields:n}},computeBackwardPorts:(r,s,o)=>e.computeBackwardPorts?e.computeBackwardPorts(r,s,o):{inputRequirements:{kind:"record",fields:{}}},onMessage:e.onMessage,config:e.config}),ui:e.ui,version:e.version||"1.0.0",displayName:e.displayName||e.id,aliases:e.aliases,compileConfig:e.compileConfig,loadCompileDeps:e.loadCompileDeps,getDisplayLabel:e.getDisplayLabel,subgraphExpansionTag:e.subgraphExpansionTag,extendedInputs:e.inputs,extendedOutputs:e.outputs,inspectInputs:e.inspectInputs,shouldRecompileOnConfigChange:e.shouldRecompileOnConfigChange,getChildren:e.getChildren,getRegion:e.getRegion,usesMidiDeviceIO:e.usesMidiDeviceIO,syncUIFromCompiledConfig:e.syncUIFromCompiledConfig}}function v(e){const i=e.extendedInputs||e.inputs||{},n=Object.entries(i).map(([o,a])=>{const u="type"in a&&typeof a.type=="object"&&"kind"in a.type,l=u?a.type:a;return{name:o,type:l,description:u?a.description:void 0,defaultValue:u?a.defaultValue:void 0,range:u?a.range:void 0,step:u?a.step:void 0,suppressInputEditor:u?a.suppressInputEditor:l.kind==="atomic"&&l.type==="any"?!0:void 0,alwaysShowInputEditor:u?a.alwaysShowInputEditor:void 0,suppressLabel:u?a.suppressLabel:void 0,redirect:u?a.redirect:void 0,allowMultiConnection:u?a.allowMultiConnection:void 0}}),t=e.extendedOutputs||e.outputs||{},r=Object.entries(t).map(([o,a])=>{const u="type"in a&&typeof a.type=="object"&&"kind"in a.type,l=u?a.type:a;return{name:o,type:l,description:u?a.description:void 0,suppressLabel:u?a.suppressLabel:void 0}}),s={id:e.id,version:e.version||"1.0.0",displayName:e.displayName||e.id,aliases:e.aliases,definition:e,inputs:n,outputs:r,compileConfig:e.compileConfig,getDisplayLabel:e.getDisplayLabel,inspectInputs:e.inspectInputs,shouldRecompileOnConfigChange:e.shouldRecompileOnConfigChange,getChildren:e.getChildren,getRegion:e.getRegion,syncUIFromCompiledConfig:e.syncUIFromCompiledConfig};s.ui=e.ui,nn.register(s)}var x=(e=>(e.IO="IO",e.Math="Math",e.Logic="Logic",e.Data="Data",e.Functional="Functional",e.Core="Core",e.Custom="Custom",e.Utility="Utility",e.Debug="Debug",e))(x||{});const rn={kind:"record",fields:{domain:{kind:"array",element:R,size:2},range:{kind:"array",element:R,size:2},segments:{kind:"array",element:{kind:"record",fields:{id:{kind:"atomic",type:"string"},weight:R,curve:{kind:"record",fields:{type:{kind:"atomic",type:"string"},value:{...R,optional:!0},points:{kind:"array",element:{kind:"record",fields:{x:R,y:R}},optional:!0,size:"dynamic"}}}}},size:"dynamic"},envelopeNodes:{kind:"array",element:{kind:"record",fields:{id:{kind:"atomic",type:"string"},x:R,y:R}},optional:!0,size:"dynamic"}},hint:"curve"},sn=(e,i)=>{const n=e.value,t=e.easing;if(!t||!t.segments||t.segments.length===0)return{result:n};const{domain:r,range:s,segments:o}=t,[a,u]=r,[l,d]=s;let f=(n-a)/(u-a);f=Math.max(0,Math.min(1,f));const p=o.reduce((N,w)=>N+w.weight,0)||1;let h=0,m=o[o.length-1],g=0,y=0;for(const N of o){const w=N.weight/p;if(f>=h&&f<=h+w){m=N,g=h,y=w;break}h+=w}const b=(f-g)/y;let _=0;const S=m.curve,A=S.type==="step"?S.value??2:1;switch(S.type){case"exponential":const N=Math.pow(10,-(S.value??0));_=Math.pow(b,N);break;case"linear":_=b;break;case"step":A<=1?_=0:_=Math.floor(b*A)/(A-1),b>=.999&&(_=1);break;case"sin":_=-(Math.cos(Math.PI*b)-1)/2;break;case"quad":_=b*b;break;case"points":if(S.points&&S.points.length>0){const w=S.points;if(b<=w[0].x)_=w[0].y;else if(b>=w[w.length-1].x)_=w[w.length-1].y;else for(let q=0;q<w.length-1;q++){const V=w[q],J=w[q+1];if(b>=V.x&&b<=J.x){const z=(b-V.x)/(J.x-V.x);_=V.y+z*(J.y-V.y);break}}}else _=b;break;default:_=b}return{result:l+_*(d-l)}},ss=k({id:"curve.ease",version:"1.0.0",displayName:"Curve Ease",metadata:{category:x.Math,keywords:["curve","ease","envelope","shape"],description:"Applies a custom curve easing to the input value."},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0},easing:{type:{...rn,optional:!0},description:"Easing Curve Configuration",suppressInputEditor:!0}},outputs:{result:R},autoBroadcast:!0,inspectInputs:!0,compileConfig:e=>({fields:{easing:e?.easing??{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:0}}]}},untagged:[]}),execute:sn}),os=k({id:"curve.ease4",version:"1.0.0",displayName:"Curve Ease 4",metadata:{category:x.Math,keywords:["curve","ease","envelope","shape","multi"],description:"Applies a custom 4-segment curve easing to the input value."},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0},easing:{type:{...rn,optional:!0},description:"Easing Curve Configuration",suppressInputEditor:!0,defaultValue:{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:.5}},{id:"s2",weight:1,curve:{type:"exponential",value:0}},{id:"s3",weight:1,curve:{type:"exponential",value:-.5}},{id:"s4",weight:1,curve:{type:"exponential",value:-1}}]}}},outputs:{result:R},autoBroadcast:!0,inspectInputs:!0,compileConfig:e=>({fields:{easing:e?.easing??{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:.5}},{id:"s2",weight:1,curve:{type:"exponential",value:0}},{id:"s3",weight:1,curve:{type:"exponential",value:-.5}},{id:"s4",weight:1,curve:{type:"exponential",value:-1}}]}},untagged:[]}),execute:sn});v(ss);v(os);const as=(e,i,n,t)=>{const r=e.value??0,s=i?.config;if(!s||!s.envelopeNodes||s.envelopeNodes.length<2||!s.segments)return{result:r};const o=s.envelopeNodes,a=s.segments||[],u=o[0],l=o[o.length-1];if(r<=u.x)return{result:u.y};if(r>=l.x)return{result:l.y};let d=t.lastSegmentIndex||0;if(d>=o.length-1||r<o[d].x||r>=o[d+1].x){for(let b=0;b<o.length-1;b++)if(r>=o[b].x&&r<o[b+1].x){d=b;break}}t.lastSegmentIndex=d;const f=o[d],p=o[d+1],h=a[d],m=(r-f.x)/(p.x-f.x);let g=m;if(h&&h.curve){const b=h.curve.type||"linear",_=h.curve.value||0;if(b==="linear")g=m;else if(b==="exponential"){const S=Math.pow(10,-(_??0)),A=Math.max(0,m);g=Math.pow(A,S)}}return{result:f.y+(p.y-f.y)*g}},us=k({id:"curve.env",version:"1.0.0",displayName:"Curve Envelope",metadata:{category:"Curve",keywords:["envelope","automation","ramp"],description:"User-editable curve envelope"},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0}},outputs:{result:{type:R,description:"Output value"}},config:{config:{kind:"atomic",type:"any",defaultValue:{}}},inspectInputs:!0,createState:()=>({lastSegmentIndex:0}),autoBroadcast:!0,compileConfig:e=>({config:e.config??e.curveData??e.values?.config??{domain:[0,1],range:[0,1],envelopeNodes:[{id:"n1",x:0,y:0},{id:"n2",x:1,y:1}],segments:[{id:"s1",weight:1,curve:{type:"linear"}}]}}),execute:as});v(us);const ls={value:{type:R,defaultValue:0},start:{type:R,defaultValue:0},end:{type:R,defaultValue:1,optional:!0},length:{type:R,defaultValue:1,optional:!0}},cs=k({id:"curve.crop",version:"1.0.0",displayName:"Curve Crop",metadata:{category:"Curve",keywords:["crop","slice","remap","linear"],description:"Linear mapping from 0-1 to start-end range."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-end"}},computeForwardPorts:(e,i,n)=>{const t=i.mode||"start-end",r={value:{...R,description:"Input value (0-1)",defaultValue:0},start:{...R,description:"Output at 0",defaultValue:0}};return t==="start-length"?r.length={...R,description:"Length of crop",defaultValue:1}:r.end={...R,description:"Output at 1",defaultValue:1},{inputs:{kind:"record",fields:r},outputs:{kind:"record",fields:{result:R}}}},inputs:ls,outputs:{result:{type:R}},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}]}]}},compileConfig:e=>({mode:e.mode||"start-end"}),autoBroadcast:!0,inspectInputs:!0,execute:(e,i,n)=>{const t=i.mode||"start-end",r=e.start??0,s=e.value??0;let o;if(t==="start-length"){const l=e.length??1;o=r+l}else o=e.end??1;o<r&&(o=r);let a=0;const u=o-r;if(u<1e-6)a=s>=r?1:0;else{const l=(s-r)/u;a=Math.max(0,Math.min(1,l))}return{outputs:{result:a},ui:{start:r,end:o}}},shouldRecompileOnConfigChange:e=>!0});v(cs);const c={kind:"atomic",type:"number",defaultValue:0},Vi={kind:"atomic",type:"string"},on={kind:"atomic",type:"boolean"},P={kind:"atomic",type:"any"},an={kind:"atomic",type:"string",options:["time","beats"],defaultValue:"time"},ds={kind:"record",fields:{type:Vi,channel:c,deviceId:{...Vi,optional:!0},time:{...c,optional:!0},note:{...c,optional:!0},velocity:{...c,optional:!0},cc:{...c,optional:!0},value:{...c,optional:!0}},hint:"midi"},M={kind:"array",size:"dynamic",element:ds,hint:"midi-stream"},yi={kind:"array",element:c,size:4,hint:"float4"},Pi={kind:"record",fields:{note:c,velocity:c},untagged:[]};({...Pi},{...Pi});const ps={kind:"record",fields:{noteIndex:P,velocity:c,hold:on},untagged:[]},X={kind:"array",size:"dynamic",element:ps,hint:"step-sequence"},un=k({id:"debug.scope",version:"1.0.0",displayName:"Scope",metadata:{category:x.Debug,keywords:["debug","scope","chart","visualize"],description:"Visualizes input values over time."},inputs:{value:{type:c,suppressLabel:!0,alwaysShowInputEditor:!0}},outputs:{value:c},config:{},inspectInputs:!0,execute:e=>({value:e.value}),compileConfig:e=>({})});v(un);v(un);var fs=(e=>(e.Primitive="primitive",e.Struct="struct",e.Array="array",e.Union="union",e.Literal="literal",e.Tuple="tuple",e.Function="function",e.Generic="generic",e.GenericInstantiation="generic_instantiation",e.Any="any",e))(fs||{}),hs=(e=>(e.Const="const",e.Binary="binary",e.Unary="unary",e.Var="var",e.Assign="assign",e.Block="block",e.If="if",e.Return="return",e.VarDecl="var_decl",e.Array="array",e.Struct="struct",e.PropAccess="prop_access",e.IndexAccess="index_access",e.Phi="phi",e.Intrinsic="intrinsic",e.While="while",e.Break="break",e.SetProp="set_prop",e.SetIndex="set_index",e))(hs||{}),ei=(e=>(e.Error="error",e.Warning="warning",e.Information="info",e.Hint="hint",e))(ei||{});let yt=null;const ms=[{type:"string",label:"Expression",path:"code",placeholder:"e.g. sin(time) * 0.5"}],vs=k({id:"logic.expression",version:"2.0.0",displayName:"Expression",metadata:{category:x.Logic,keywords:["expression","math","script","code"],description:"Evaluates a mathematical expression (V2)."},inputs:{},config:{jsCode:{...mi,optional:!0},inputs:{kind:"record",fields:{},optional:!0},outputs:{kind:"record",fields:{},optional:!0},diagnostics:{kind:"atomic",type:"any",optional:!0}},outputs:{result:B},autoBroadcast:!1,ui:{inspector:{fields:ms}},loadCompileDeps:async()=>{yt||(yt={buildCode:(await import("./builder-VFrwVD8p.js")).buildCode})},shouldRecompileOnConfigChange:e=>!0,compileConfig:(e,i)=>{const n=e.code||"",t=`expr_v2_1:${n}`;if(i&&i.compileCache&&i.compileCache.has(t))return i.compileCache.get(t);if(!yt)return{jsCode:void 0,diagnostics:[{message:"Compiler not loaded. Please wait...",severity:ei.Warning,source:"system"}],inputs:{},outputs:{}};try{const r=yt.buildCode({code:n,emitJS:!0,autoInputs:!0,containerMode:"expression-like"}),s=r.diagnostics.some(l=>l.severity==="error"),o={};for(const[l,d]of Object.entries(r.inputs)){let f=P;d.kind==="primitive"&&d.name==="number"&&(f=c),o[l]={...f,description:`Variable ${l}`}}const a={result:{...P,description:"Result"}},u={jsCode:s?void 0:r.outJS?.code,diagnostics:r.diagnostics,inputs:o,outputs:a};return i&&i.compileCache&&i.compileCache.set(t,u),u}catch(r){return{jsCode:void 0,diagnostics:[{message:`Internal Compiler Error: ${r}`,severity:ei.Error,source:"compiler"}],inputs:{},outputs:{}}}},computeForwardPorts:(e,i)=>{const n=i&&i.inputs?i.inputs:{},t=i&&i.outputs?i.outputs:{result:P};return{inputs:{kind:"record",fields:n},outputs:{kind:"record",fields:t}}},createState:()=>({}),syncUIFromCompiledConfig:(e,i)=>{i.diagnostics=e.diagnostics||[],i.jsCode=e.jsCode},execute:(e,i,n,t)=>{if(!i.jsCode)return{result:0};if(!t)return{result:0};if(t.lastCode!==i.jsCode||!t.runner)try{const r=i.jsCode.replace(/module\.exports\s*=\s*{\s*compute\s*};?;?/,"return compute;"),s=new Function(r);t.runner=s(),t.lastCode=i.jsCode}catch(r){return console.error("Failed to compile runner:",r),{result:null}}try{const r=e.fields?e.fields:e;return{result:t.runner(r)}}catch(r){return console.error("Runtime error:",r),{result:null}}}});v(vs);const ys=k({id:"gen.sawtooth",version:"1.0.0",displayName:"Sawtooth",metadata:{category:"Oscillator",keywords:["oscillator","sawtooth","ramp","lfo","generator"],description:"Generates a linear sawtooth wave (0.0 to 1.0) at the given frequency."},inputs:{freq:{type:c,defaultValue:1,range:[0,60],description:"Frequency in Hz"}},outputs:{out:c},autoBroadcast:!0,isRealtime:()=>!0,createState:()=>({phase:0}),execute:(e,i,n,t)=>{const r=e.freq,s=n.clock.dt;return r>=60-1e-6?{out:Math.random()}:(t.phase+=s*r,t.phase-=Math.floor(t.phase),{out:t.phase})}});v(ys);const H={IDLE:0,ATTACK:1,DECAY:2,SUSTAIN:3,RELEASE:4},gs=k({id:"gen.adsr",version:"1.0.0",displayName:"ADSR",metadata:{category:"Envelope",keywords:["envelope","adsr","modulation"],description:"Attack-Decay-Sustain-Release envelope generator triggered by MIDI."},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},inputs:{stream:{type:M,description:"MIDI Stream",allowMultiConnection:!0},attack:{type:c,defaultValue:.1,range:[0,5],description:"Attack Time (s)"},decay:{type:c,defaultValue:1,range:[0,5],description:"Decay Time (s)"},sustain:{type:c,defaultValue:.7,range:[0,1],description:"Sustain Level (0-1)"},release:{type:c,defaultValue:1,range:[0,5],description:"Release Time (s)"}},config:{mode:{kind:"atomic",type:"string",defaultValue:"D"}},ui:{inspector:{fields:[{label:"Mode",path:"mode",type:"tab-bar",options:[{label:"ADSR",value:"ADSR"},{label:"ADS",value:"ADS"},{label:"D",value:"D"}]}]}},compileConfig:e=>({mode:e.mode||e.values?.mode||"D"}),computeForwardPorts:(e,i)=>{const n=i.mode||"D",t={stream:M};return n==="ADSR"?(t.attack=c,t.decay=c,t.sustain=c,t.release=c):n==="ADS"?(t.attack=c,t.decay=c,t.sustain=c):n==="D"&&(t.decay=c),{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{value:c}}}},outputs:{value:{type:c,description:"Envelope Value (0-1)"}},isRealtime:()=>!0,shouldRecompileOnConfigChange:e=>!0,createState:()=>({phase:H.IDLE,value:0,time:0,activeNotes:0}),execute:(e,i,n,t)=>{const r=n.clock.dt,s=i.mode||"D",o=e.stream;let a=0,u=0,l=0,d=0;if(s==="D"?(a=0,u=Math.max(0,e.decay??.1),l=0,d=u):s==="ADS"?(a=Math.max(0,e.attack??.1),u=Math.max(0,e.decay??.1),l=Math.max(0,Math.min(1,e.sustain??.7)),d=u):(a=Math.max(0,e.attack??.1),u=Math.max(0,e.decay??.1),l=Math.max(0,Math.min(1,e.sustain??.7)),d=Math.max(0,e.release??.5)),Array.isArray(o))for(const f of o)f.type==="note_on"&&(f.velocity??0)>0?(t.activeNotes++,t.activeNotes===1&&(t.phase=H.ATTACK,t.value=0,t.time=0,a<=0&&(t.value=1,t.phase=H.DECAY,t.time=0,u<=0&&(t.value=l,t.phase=H.SUSTAIN)))):(f.type==="note_off"||f.type==="note_on"&&(f.velocity??0)===0)&&(t.activeNotes=Math.max(0,t.activeNotes-1));switch(t.activeNotes===0&&t.phase!==H.IDLE&&t.phase!==H.RELEASE&&(t.phase=H.RELEASE,t.time=0),t.phase){case H.IDLE:t.value=0,t.time=0;break;case H.ATTACK:t.time+=r,t.value+=1/Math.max(.001,a)*r,t.value>=1&&(t.value=1,t.phase=H.DECAY,t.time=0,u<=0&&(t.value=l,t.phase=H.SUSTAIN));break;case H.DECAY:t.time+=r,t.value-=(1-l)/Math.max(.001,u)*r,t.value<=l&&(t.value=l,t.phase=H.SUSTAIN,t.time=0);break;case H.SUSTAIN:t.time+=r,t.value=l;break;case H.RELEASE:t.time+=r,d<=0?(t.value=0,t.phase=H.IDLE,t.time=0):(t.value-=1/d*r,t.value<=0&&(t.value=0,t.phase=H.IDLE,t.time=0));break}return{outputs:{value:Math.max(0,Math.min(1,t.value))},ui:{value:t.value,phase:t.phase,time:t.time}}},inspectInputs:!0});v(gs);function _s(e){let r=e;return{next:()=>(r=(1103515245*r+12345)%2147483648,r/2147483647)}}const bs=k({id:"math.random",version:"1.1.0",displayName:"Random",metadata:{category:"Math",keywords:["random","stochastic","noise","seed","white"],description:"Generates a random number (0-1). Supports on-trigger or free-run modes."},inputs:{trigger:{type:M,description:"Trigger Signal",allowMultiConnection:!0}},config:{seed:{kind:"atomic",type:"number",defaultValue:12345},mode:{kind:"atomic",type:"string",defaultValue:"on-trigger"}},outputs:{value:{type:c,description:"Random Value"}},autoBroadcast:{trigger:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"On Trigger",value:"on-trigger"},{label:"Free Run",value:"free-run"}],default:"on-trigger"},{type:"number",label:"Seed",path:"seed",default:12345}]}},compileConfig:e=>({mode:e.mode||e.values?.mode||"on-trigger",seed:e.seed||e.values?.seed||12345}),computeForwardPorts:(e,i)=>{const n=i.mode||"on-trigger",t={};return n==="on-trigger"&&(t.trigger={type:M,description:"Trigger Signal",allowMultiConnection:!0}),{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{value:c}}}},isRealtime:e=>e.mode==="free-run",shouldRecompileOnConfigChange:e=>!0,createState:e=>{const n=e?.seed||12345,t=_s(n);return{generator:t,currentValue:t.next()}},execute:(e,i,n,t)=>{const r=i.mode||"on-trigger",s=e.trigger;if(r==="free-run")t.currentValue=t.generator.next();else if(Array.isArray(s))for(const o of s)o.type==="note_on"&&(o.velocity??0)>0&&(t.currentValue=t.generator.next());return{value:t.currentValue}}});v(bs);const xs=[{type:"string",label:"Device ID",path:"deviceId",placeholder:"Optional Device ID"}],Os=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"CC",path:"cc",min:0,max:127,step:1},{type:"string",label:"Device ID",path:"deviceId",placeholder:"Optional Device ID"}],Ss=k({id:"midi.input",version:"1.0.0",displayName:"MIDI Input",metadata:{category:x.IO,keywords:["midi","input","source"],description:"Reads raw MIDI messages from a specific device."},inputs:{},config:{deviceId:{kind:"atomic",type:"string",optional:!0}},outputs:{stream:M},ui:{inspector:{fields:xs}},isRealtime:()=>!0,usesMidiDeviceIO:()=>!0,execute:(e,i,n)=>{const t=n.midi?.events,r=i.deviceId;return t&&r?{stream:t.filter(o=>o.deviceId===r)}:{stream:t||[]}},compileConfig:e=>({deviceId:e.deviceId})}),As=k({id:"midi.cc.input",version:"1.0.0",displayName:"MIDI CC Input",metadata:{category:x.IO,keywords:["midi","cc","input"],description:"Reads a MIDI CC value directly from the environment."},inputs:{},config:{channel:c,cc:c,deviceId:{kind:"atomic",type:"string",optional:!0}},outputs:{value:c},ui:{inspector:{fields:Os}},isRealtime:()=>!0,usesMidiDeviceIO:()=>!0,execute:(e,i,n)=>{const t=i.channel||1,r=i.cc||0;i.deviceId;const s=`${t}:${r}`;return{value:n.midi?.values.get(s)??0}},compileConfig:e=>({channel:e.channel??1,cc:e.cc??0,deviceId:e.deviceId})});v(Ss);v(As);const Is=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"CC",path:"cc",min:0,max:127,step:1}],ws=k({id:"midi.cc",version:"1.0.0",displayName:"MIDI CC",metadata:{category:x.IO,keywords:["midi","cc","control change"],description:"Reads MIDI Control Change messages from a stream."},inputs:{stream:{type:M,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,cc:c},outputs:{value:c},ui:{inspector:{fields:Is}},createState:()=>({value:0}),execute:(e,i,n,t)=>{const r=i.channel||1,s=i.cc||0,o=e.stream||[];if(o&&Array.isArray(o))for(const a of o)a.type==="cc"&&a.channel===r&&a.cc===s&&(t.value=a.value??0);return{value:t.value}},compileConfig:e=>({channel:e.channel??1,cc:e.cc??0})});v(ws);const ks=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Note",path:"note",min:0,max:127,step:1}],Ms=k({id:"midi.note",version:"1.0.0",displayName:"MIDI Note",metadata:{category:x.IO,keywords:["midi","note","keyboard"],description:"Reads MIDI Note messages from a stream."},inputs:{stream:{type:M,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,note:c},outputs:{note:{kind:"atomic",type:"number",optional:!0},velocity:c,gate:c},ui:{inspector:{fields:ks}},createState:()=>({velocity:0,gate:0}),execute:(e,i,n,t)=>{const r=i.channel||1,s=i.note||60,o=e.stream||[];if(o&&Array.isArray(o))for(const a of o)a.channel===r&&(a.type==="note_on"&&a.note===s?(t.velocity=a.velocity??0,t.gate=1):a.type==="note_off"&&a.note===s&&(t.gate=0));return{note:t.gate?s:null,velocity:t.velocity,gate:t.gate}},compileConfig:e=>({channel:e.channel??1,note:e.note??60})});v(Ms);const Ns=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1},{type:"select",label:"Priority",path:"priority",options:[{label:"Last Note",value:"last"},{label:"Low Note",value:"low"},{label:"High Note",value:"high"}]}],Cs=k({id:"midi.to_mono",version:"1.0.0",displayName:"MIDI to Mono",metadata:{category:x.IO,keywords:["midi","mono","converter"],description:"Converts a polyphonic MIDI stream to a monophonic note signal."},inputs:{stream:{type:M,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,rootNote:c,priority:{kind:"atomic",type:"string",optional:!0}},outputs:{note:{kind:"atomic",type:"number",optional:!0},velocity:c,gate:c,frequency:c},ui:{inspector:{fields:Ns}},createState:()=>({activeNotes:[],gate:0}),execute:(e,i,n,t)=>{const r=i.channel||1,s=i.rootNote??60,o=e.stream||[];if(t.activeNotes||(t.activeNotes=[]),o&&Array.isArray(o))for(const u of o)u.channel===r&&(u.type==="note_on"?(t.activeNotes=t.activeNotes.filter(l=>l.note!==u.note),t.activeNotes.push({note:u.note,velocity:u.velocity??0})):u.type==="note_off"&&(t.activeNotes=t.activeNotes.filter(l=>l.note!==u.note)));const a=t.activeNotes.length>0?t.activeNotes[t.activeNotes.length-1]:null;if(a){t.gate=1;const u=a.note-s,l=440*Math.pow(2,(a.note-69)/12);return{note:u,velocity:a.velocity,gate:1,frequency:l}}else return t.gate=0,{note:null,velocity:0,gate:0,frequency:0}},compileConfig:e=>({channel:e.channel??1,rootNote:e.rootNote??60,priority:e.priority??"last"})});v(Cs);const Ts=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Note",path:"note",min:0,max:127,step:1}],Es=k({id:"midi.filter",version:"1.0.0",displayName:"MIDI Filter",metadata:{category:x.IO,keywords:["midi","filter","note"],description:"Filters MIDI events, allowing only specific Note On/Off messages through."},inputs:{stream:{type:M,allowMultiConnection:!0},channel:{type:c,description:"MIDI Channel (1-16)",defaultValue:1},note:{type:c,description:"Note Number (0-127)",defaultValue:60}},config:{},outputs:{stream:M},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:Ts}},execute:(e,i)=>{const n=e.channel??1,t=e.note??60,r=e.stream||[],s=[];if(r&&Array.isArray(r))for(const o of r)o.channel===n&&(o.type==="note_on"||o.type==="note_off")&&o.note===t&&s.push(o);return{stream:s}},compileConfig:e=>({channel:e.channel??1,note:e.note??60})});v(Es);const Rs=k({id:"midi.pitch",version:"1.0.0",displayName:"MIDI Pitch",metadata:{category:x.IO,keywords:["midi","pitch","transpose","shift"],description:"Transposes MIDI Note events by a specified amount."},inputs:{stream:{type:M,allowMultiConnection:!0},pitch:{type:c,description:"Pitch shift amount (semitones)",defaultValue:0,range:[-24,24]}},config:{},outputs:{stream:M},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},execute:(e,i)=>{const n=e.pitch??0,t=e.stream||[];return!t||!Array.isArray(t)?{stream:[]}:{stream:t.map(s=>{if(s.type==="note_on"||s.type==="note_off"){const o=Math.max(0,Math.min(127,Math.floor(s.note+n)));return{...s,note:o}}return s})}},compileConfig:e=>({pitch:e.pitch??0})});v(Rs);const Vs=k({id:"midi.trigger",version:"1.0.0",displayName:"MIDI Trigger",metadata:{category:x.IO,keywords:["midi","trigger","bang","button"],description:"Manually sends a Middle C Note On/Off pair when triggered."},inputs:{trigger:{type:c,description:"Trigger Signal",suppressInputEditor:!0}},config:{pitch:{...c,defaultValue:60},velocity:{...c,defaultValue:1,range:[0,1]},trigger:c},outputs:{stream:M},createState:()=>({lastTrigger:0,initialized:!1}),execute:(e,i,n,t)=>{const r=i.pitch||60,s=i.velocity||1,o=e.trigger||0;n.clock.dt;const a=[];return t.initialized?(o>t.lastTrigger&&(a.push({type:"note_on",channel:1,note:r,velocity:s,deviceId:"virtual",time:0}),a.push({type:"note_off",channel:1,note:r,velocity:0,deviceId:"virtual",time:0}),n.markSelfDirty&&n.markSelfDirty()),t.lastTrigger=o,{stream:a}):(t.lastTrigger=o,t.initialized=!0,{stream:a})},compileConfig:e=>({pitch:e.pitch??60,velocity:e.velocity??1,trigger:e.trigger}),ui:{inspector:{fields:[{type:"button",label:"Trigger",path:"trigger",text:"Bang"},{type:"number",label:"Pitch",path:"pitch",min:0,max:127,step:1,default:60},{type:"number",label:"Velocity",path:"velocity",min:0,max:1,step:.01,default:1}]}}});v(Vs);const Ps=k({id:"midi.merge",version:"1.0.0",displayName:"MIDI Merge",metadata:{category:x.IO,keywords:["midi","merge","combine","mix"],description:"Merges multiple MIDI streams into one using auto-broadcast."},inputs:{stream:{type:M,description:"Input Streams",allowMultiConnection:!0}},outputs:{stream:M},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{},execute:(e,i,n)=>({stream:e.stream||[]}),compileConfig:()=>({})});v(Ps);const Ds=k({id:"midi.select",version:"1.0.0",displayName:"MIDI Select",metadata:{category:x.IO,keywords:["midi","select","router","switch","demux"],description:"Routes MIDI events to different ports based on note pitch."},inputs:{stream:{type:M,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{count:{...c,defaultValue:4},root:{...c,defaultValue:60},skip:{...c,defaultValue:1}},outputs:{},dynamicOutputType:M,isRealtime:()=>!0,computeForwardPorts:(e,i,n)=>{const t=i.count||4,r={};for(let s=0;s<t;s++)r[s.toString()]={...M,hint:"midi-stream",description:`Offset ${s}`};return r.rem={...M,hint:"midi-stream",description:"Remainder"},{inputs:{kind:"record",fields:{stream:M}},outputs:{kind:"record",fields:r}}},shouldRecompileOnConfigChange:e=>!0,execute:(e,i,n)=>{const t=e.stream||[],r=i.count||4,s=i.root||60,o=i.skip||1,a={};for(let u=0;u<r;u++)a[u.toString()]=[];if(a.rem=[],t&&Array.isArray(t)){for(const u of t)if(u.type==="note_on"||u.type==="note_off"){const l=u.note-s;if(l>=0&&l%o===0){const d=l/o;if(d>=0&&d<r){a[d.toString()].push(u);continue}}a.rem.push(u)}}return{...a}},compileConfig:e=>({count:e.count??4,root:e.root??60,skip:e.skip??1}),ui:{inspector:{fields:[{type:"number",label:"Output Count",path:"count",min:1,max:128,step:1,default:4},{type:"number",label:"Root Note",path:"root",min:0,max:127,step:1,default:60},{type:"number",label:"Skip (Semitones)",path:"skip",min:1,max:24,step:1,default:1}]}}});v(Ds);const js=k({id:"midi.onchange",version:"1.0.0",displayName:"MIDI On Change",metadata:{category:x.IO,keywords:["midi","trigger","change","delta"],description:"Triggers a note when input value changes."},inputs:{value:{type:B,description:"Input Value"}},config:{rootNote:{...c,defaultValue:60}},outputs:{stream:M},ui:{inspector:{fields:[{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1,default:60}]}},isRealtime:()=>!0,createState:()=>({lastValue:void 0}),execute:(e,i,n,t)=>{const r=e.value,s=i.rootNote??60,o=[];let a=!1;return typeof r=="number"&&typeof t.lastValue=="number"?Math.abs(r-t.lastValue)>1e-5&&(a=!0):r!==t.lastValue&&(a=!0),a?(o.push({type:"note_on",note:s,velocity:1,channel:1,time:0,deviceId:"onchange"}),o.push({type:"note_off",note:s,velocity:0,channel:1,time:0,deviceId:"onchange"}),t.lastValue=r):t.lastValue===void 0&&r!==void 0&&(t.lastValue=r),{stream:o}},compileConfig:e=>({rootNote:e.rootNote??60})});v(js);const ln={};for(let e=1;e<=16;e++)ln[`w${e}`]={type:c,defaultValue:1,optional:!0,description:`Weight ${e}`};const Ls=k({id:"midi.onrange",version:"1.0.0",displayName:"MIDI On Range",metadata:{category:x.IO,keywords:["midi","trigger","range","zone"],description:"Triggers notes based on value position in weighted zones."},inputs:{value:{type:c,description:"Input Value"},start:{type:c,defaultValue:0},end:{type:c,defaultValue:1},...ln},config:{rootNote:{...c,defaultValue:60,description:"Root Note"},zoneCount:{...c,defaultValue:1,description:"Number of Zones"},noteSkip:{...c,defaultValue:1}},outputs:{stream:M},ui:{inspector:{fields:[{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1,default:60},{type:"number",label:"Zone Count",path:"zoneCount",min:1,max:16,step:1,default:1},{type:"number",label:"Note Skip",path:"noteSkip",min:1,max:12,step:1,default:1}]}},isRealtime:()=>!0,createState:()=>({activeZoneIndex:null}),computeForwardPorts:(e,i)=>{const n=i.zoneCount??1,t={value:{...c},start:{...c,defaultValue:0},end:{...c,defaultValue:1}};if(n>1)for(let r=1;r<=n;r++)t[`w${r}`]={...c,defaultValue:1,description:`Weight ${r}`};return{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{stream:M}}}},shouldRecompileOnConfigChange:()=>!0,execute:(e,i,n,t)=>{const r=e.value??0,s=e.start??0,o=e.end??1,a=i.rootNote??60,u=i.zoneCount??1,l=i.noteSkip??1;let d=s,f=o;f<d&&(f=s,d=o);const p=[];if(r>=d&&r<=f){let h=0;if(u>1){const m=[];let g=0;for(let y=1;y<=u;y++){let _=e[`w${y}`];_&&typeof _=="object"&&"value"in _&&(_=_.value),_=_??1,typeof _!="number"&&(_=1),m.push(_),g+=_}if(g<=0)h=0;else{const y=f-d,_=(y===0?0:(r-d)/y)*g;let S=0;for(let A=0;A<u;A++)if(S+=m[A],_<=S){h=A;break}h>=u&&(h=u-1)}}else h=0;if(t.activeZoneIndex===null){const m=a+h*l;p.push({type:"note_on",note:m,velocity:1,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=h}else if(t.activeZoneIndex!==h){const m=a+t.activeZoneIndex*l;p.push({type:"note_off",note:m,velocity:0,channel:1,time:0,deviceId:"onrange"});const g=a+h*l;p.push({type:"note_on",note:g,velocity:1,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=h}}else if(t.activeZoneIndex!==null){const h=a+t.activeZoneIndex*l;p.push({type:"note_off",note:h,velocity:0,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=null}return{stream:p}},compileConfig:e=>({rootNote:e.rootNote??60,zoneCount:e.zoneCount??1,noteSkip:e.noteSkip??1})});v(Ls);const cn={type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Time",value:"time"},{label:"Beats",value:"beats"}],default:"time"},Bs={type:"tab-bar",label:"Beat Denom",path:"beatDenom",options:[{label:"1/64",value:.015625},{label:"1/32",value:.03125},{label:"1/16",value:.0625},{label:"1/8",value:.125},{label:"1/4",value:.25},{label:"1/2",value:.5},{label:"1/1",value:1}],default:.25},qs=[cn],Fs=k({id:"midi.delay",version:"1.0.0",displayName:"MIDI Delay",metadata:{category:x.Utility,keywords:["midi","delay","time","beats"],description:"Delays MIDI events by a specified duration."},inputs:{stream:{type:M,allowMultiConnection:!0},duration:{...c,defaultValue:.25}},config:{mode:{...an,defaultValue:"time"}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},outputs:{stream:M},ui:{inspector:{fields:qs}},isRealtime:()=>!0,createState:()=>({queue:[]}),execute:(e,i,n,t)=>{const r=e.stream||[],s=e.duration||0,o=i.mode||"time";let a=0;if(o==="beats"?a=n.clock.beat:a=n.time||0,t.queue||(t.queue=[]),r&&Array.isArray(r))for(const d of r)t.queue.push({event:d,releaseTime:a+s});const u=[],l=[];for(const d of t.queue)d.releaseTime<=a?u.push(d.event):l.push(d);return t.queue=l,{stream:u}},compileConfig:e=>({mode:e.mode??"time"})});v(Fs);const $s=k({id:"midi.istrigger",version:"1.0.0",displayName:"MIDI Is Trigger",metadata:{category:x.Logic,keywords:["midi","check","trigger","gate"],description:"Outputs 1 if the stream contains any Note On event, 0 otherwise."},inputs:{stream:{type:M,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},outputs:{result:c},createState:()=>({}),execute:(e,i,n,t)=>{const r=e.stream||[];let s=0;if(r&&Array.isArray(r)){for(const o of r)if(o.type==="note_on"){s=1;break}}return{result:s}}});v($s);const Us=[cn,Bs,{type:"number",label:"Note",path:"note",min:0,max:127,default:60}],zs=k({id:"midi.metronome",version:"1.0.0",displayName:"Metronome",metadata:{category:x.Utility,keywords:["midi","metronome","clock","beat","trigger"],description:"Generates MIDI note events at regular intervals."},inputs:{duration:{...c,defaultValue:1,description:"Interval duration (seconds or beats)",min:0,max:4}},config:{mode:{...an,defaultValue:"time"},beatDenom:{...c,defaultValue:.25},note:{...c,defaultValue:60}},outputs:{stream:M},ui:{inspector:{fields:Us}},isRealtime:()=>!0,createState:()=>({lastTriggerTime:-99999,noteActive:!1}),execute:(e,i,n,t)=>{const r=e.duration||1,s=i.mode||"time",o=i.beatDenom||.25,a=i.note||60;let u=0,l=r;s==="beats"?(u=n.clock.beat,l=Math.round(r)*o*4,l<=0&&(l=o)):u=n.time||0;const d=[];if(t.lastTriggerTime===-99999)return t.lastTriggerTime=u,{stream:[]};const f=t.lastTriggerTime,p=Math.floor(f/l),m=Math.floor(u/l)-p;for(let g=1;g<=m;g++)d.push({type:"note_on",deviceId:"metronome",channel:1,note:a,velocity:1,time:0}),d.push({type:"note_off",deviceId:"metronome",channel:1,note:a,velocity:0,time:0});return t.lastTriggerTime=u,{stream:d}},compileConfig:e=>({mode:e.mode??"time",beatDenom:e.beatDenom??.25,note:e.note??60})});v(zs);const Gs=k({id:"time.time",version:"1.0.0",displayName:"Time",metadata:{category:x.Utility,keywords:["time","seconds","clock"],description:"Outputs the current execution time in seconds."},inputs:{},outputs:{time:c,delta:c},isRealtime:()=>!0,execute:(e,i,n)=>({time:n.time||0,delta:n.clock.dt||0})}),Hs=k({id:"time.beat",version:"1.0.0",displayName:"Beat",metadata:{category:x.Utility,keywords:["beat","bar","clock","tempo"],description:"Outputs the current beat number."},inputs:{},outputs:{beat:c,delta:c},isRealtime:()=>!0,createState:()=>({lastBeat:-1}),execute:(e,i,n,t)=>{const r=n.clock.beat||0;let s=0;return t.lastBeat>=0&&(s=r-t.lastBeat),t.lastBeat=r,{beat:r,delta:s}}});v(Gs);v(Hs);const Ot={kind:"atomic",type:"number"},Ht=16,Ws=[{type:"number",label:"Target Note",path:"targetNote"}],Ys=k({id:"nicepattern.rhythmic_generator",version:"1.0.0",displayName:"Rhythmic Generator",metadata:{category:"NicePattern",keywords:["rhythm","generator","sequence","euclidean"],description:"Generates a rhythmic sequence based on density."},config:{targetNote:c},inputs:{density:{...c,defaultValue:.5}},outputs:{seq_out:X},ui:{inspector:{fields:Ws}},execute:(e,i,n)=>{const t=i.targetNote||60,r=e.density??.5,s=[],o=Math.round(r*Ht);for(let a=0;a<Ht;a++)a*o%Ht<o?s.push({noteIndex:t,velocity:1,hold:!1}):s.push({noteIndex:null,velocity:0,hold:!1});return{seq_out:s}},compileConfig:e=>({targetNote:e.targetNote??60})});v(Ys);class St{constructor(i){this.state=i}next(){let i=this.state+=1831565813;return i=Math.imul(i^i>>>15,i|1),i^=i+Math.imul(i^i>>>7,i|61),((i^i>>>14)>>>0)/4294967296}nextRange(i,n){return Math.floor(this.next()*(n-i+1))+i}}const Ks=16,Xs=[{type:"number",label:"Min Note",path:"minNote"},{type:"number",label:"Max Note",path:"maxNote"},{type:"number",label:"Seed",path:"seed"}],Js=k({id:"nicepattern.chaos_generator",version:"1.0.0",displayName:"Chaos Generator",metadata:{category:"NicePattern",keywords:["chaos","random","generator","sequence","stochastic"],description:"Generates a random sequence of notes."},config:{minNote:c,maxNote:c,seed:c},inputs:{density:{...c,defaultValue:.5}},outputs:{seq_out:X},ui:{inspector:{fields:Xs}},execute:(e,i,n)=>{const{minNote:t,maxNote:r,seed:s}=i,o=e.density??.5,a=new St(s??12345),u=[];for(let l=0;l<Ks;l++)if(a.next()<o){const d=a.nextRange(t||60,r||60);u.push({noteIndex:d,velocity:a.next()*.5+.5,hold:!1})}else u.push({noteIndex:null,velocity:0,hold:!1});return{seq_out:u}},compileConfig:e=>({minNote:e.minNote??60,maxNote:e.maxNote??60,seed:e.seed??12345})});v(Js);class dt{constructor(i){this.config=i,this.output=0,this.lastActive=!1}update(i,n,t){let s=i.noteIndex!==null&&i.noteIndex!==void 0;if(s){let o=!1;this.lastActive?t&&!i.hold&&(this.onRelease(),o=!0):o=!0,o&&this.onTrigger(i.velocity,i.noteIndex)}else this.lastActive&&this.onRelease();this.process(s,i,n),this.lastActive=s}forceRelease(){this.onRelease(),this.lastActive=!1,this.output=0}getValue(){return this.output}}class Zs extends dt{onTrigger(i,n){this.output=i}onRelease(){this.output=0}process(i){i&&this.output===0&&(this.output=1)}previewSequence(i,n){return i.map(t=>t.noteIndex!==null&&t.noteIndex!==void 0?t.velocity:0)}}class Qs extends dt{constructor(i,n=.96){super(i),this.decayRate=.96,this.decayRate=n}onTrigger(i,n){this.output=i}onRelease(){this.output=0}process(i,n){i&&(this.output*=this.decayRate)}previewSequence(i,n){const t=[];let r=0,s=!1;for(const o of i){const a=o.noteIndex!==null&&o.noteIndex!==void 0;a&&!s?r=o.velocity:!a&&s&&(r=0),a&&(r*=this.decayRate),t.push(r),s=a}return t}}class eo extends dt{constructor(){super(...arguments),this.phase=0,this.duty=.5,this.freq=.2}onTrigger(i,n){this.duty=.5}onRelease(){}process(i,n,t){if(!i){this.output*=.85;return}this.duty*=.98,this.phase+=this.freq,this.phase>1&&(this.phase-=1),this.output=this.phase<this.duty?1:0}previewSequence(i,n){const t=[];let r=0,s=0,o=.5,a=!1;for(const u of i){const l=u.noteIndex!==null&&u.noteIndex!==void 0;l&&!a&&(o=.5),l?(o*=.98,s+=this.freq,s>1&&(s-=1),r=s<o?1:0):r*=.85,t.push(r),a=l}return t}}class to extends dt{onTrigger(i,n){}onRelease(){this.output*=.85}process(i){i?this.output=Math.random():this.output*=.85}previewSequence(i,n){const t=[];let r=0,s=!1;const a=(u=>()=>{u|=0,u=u+1831565813|0;var l=Math.imul(u^u>>>15,1|u);return l=l+Math.imul(l^l>>>7,61|l)^l,((l^l>>>14)>>>0)/4294967296})(12345);for(const u of i){const l=u.noteIndex!==null&&u.noteIndex!==void 0;!l&&s&&(r*=.85),l?r=a():r*=.85,t.push(r),s=l}return t}}class Wt extends dt{constructor(i,n,t){super(i),this.osc=null,this.gain=null,this.filter=null,this.ctx=n,this.frequency=t??440}get audioContext(){return this.ctx}set audioContext(i){this.ctx=i}safeParam(i,n,t){if(Number.isFinite(n)&&Number.isFinite(t))try{i.setValueAtTime(n,t)}catch{}}initVoice(i,n){if(!this.ctx||this.ctx.state==="suspended")return;this.cleanup(),this.osc=this.ctx.createOscillator(),this.gain=this.ctx.createGain(),this.filter=this.ctx.createBiquadFilter();const t=Number.isFinite(this.frequency)&&this.frequency>0?this.frequency:440;this.safeParam(this.osc.frequency,t,i),this.filter.type="lowpass";const r=800+n*2e3;this.safeParam(this.filter.frequency,r,i),this.safeParam(this.gain.gain,0,i);try{this.gain.gain.linearRampToValueAtTime(n,i+.005),this.gain.gain.setTargetAtTime(0,i+.005,.1)}catch{}this.osc.connect(this.filter),this.filter.connect(this.gain),this.gain.connect(this.ctx.destination),this.osc.start(i)}retirePreviousVoice(i){if(!this.osc||!this.gain||!this.filter)return;const n=this.osc,t=this.gain,r=this.filter;this.osc=null,this.gain=null,this.filter=null;try{try{t.gain.cancelAndHoldAtTime(i)}catch{t.gain.cancelScheduledValues(i),this.safeParam(t.gain,t.gain.value,i)}t.gain.linearRampToValueAtTime(0,i+.005);const o=i+.005+.01;n.stop(o),n.onended=()=>{n.disconnect(),r.disconnect(),t.disconnect(),n.dispose?.(),r.dispose?.(),t.dispose?.()}}catch{n.disconnect(),r.disconnect(),t.disconnect()}}cleanup(){this.retirePreviousVoice(this.ctx?.currentTime??0)}onTrigger(i,n){if(this.ctx?.state!=="suspended"){if(n!=null){const t=440*Math.pow(2,(n-69)/12);Number.isFinite(t)&&(this.frequency=t)}this.initVoice(this.ctx?.currentTime??0,i)}}onRelease(){if(this.ctx?.state!=="suspended"&&this.gain){const i=this.ctx?.currentTime??0;try{this.gain.gain.cancelAndHoldAtTime(i)}catch{this.gain.gain.cancelScheduledValues(i),this.safeParam(this.gain.gain,this.gain.gain.value,i)}try{this.gain.gain.linearRampToValueAtTime(0,i+.005)}catch{}if(this.osc)try{this.osc.stop(i+.01)}catch{}}}process(i,n){i&&n.hold&&this.osc}previewSequence(i,n){const t=[];let r=!1;for(const s of i){const o=s.noteIndex!==null&&s.noteIndex!==void 0;o&&!r?t.push(s.velocity):t.push(0),r=o}return t}}function Rt(e,i,n){return k({id:e,version:"1.0.0",displayName:i,metadata:{category:"NicePattern",keywords:["layer","effect","modifier"],description:`Layer node: ${i}`},config:{},inputs:{midi_in:{type:M,description:"Input MIDI stream",allowMultiConnection:!0},prev_layer:{type:Ot,description:"Previous layer output"}},outputs:{out:Ot},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[]}},isRealtime:()=>!0,createState:(t,r)=>({layer:new n({}),lastActive:!1,activeVelocity:0,activeNote:null}),execute:(t,r,s,o)=>{const a=o.layer,u=t.midi_in||[];for(const p of u)p.type==="note_on"?(o.lastActive=!0,o.activeVelocity=p.velocity,o.activeNote=p.note):p.type==="note_off"&&o.activeNote===p.note&&(o.lastActive=!1,o.activeNote=null);const l={noteIndex:o.lastActive?o.activeNote??60:null,velocity:o.activeVelocity,hold:!1},d=u.some(p=>p.type==="note_on");return a.update(l,s.clock.dt,d),{out:a.getValue()}},compileConfig:t=>({})})}const io=Rt("nicepattern.gate_layer","Gate Layer",Zs),no=Rt("nicepattern.exp_layer","Exponential Layer",Qs),ro=Rt("nicepattern.pwm_layer","PWM Layer",eo),so=Rt("nicepattern.noise_layer","Noise Layer",to);v(io);v(no);v(ro);v(so);const oo=k({id:"nicepattern.tone_synth_layer",version:"1.0.0",displayName:"Tone Synth Layer",metadata:{category:"NicePattern",keywords:["synth","audio","sound","tone"],description:"Simple synthesizer layer using Tone.js."},config:{},inputs:{midi_in:{type:M,description:"Input MIDI stream",allowMultiConnection:!0},prev_layer:{type:Ot,description:"Previous layer output"}},outputs:{out:Ot},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[]}},isRealtime:()=>!0,createState:(e,i)=>({layer:new Wt({}),lastActive:!1,lastActiveNote:null,activeVelocity:0,contextId:""}),execute:(e,i,n,t)=>{const r=n.audio?.context;t.layer||(t.layer=new Wt({})),r&&t.contextId!==r.contextId&&(t.layer=new Wt({}),t.contextId=r.contextId);const s=t.layer,o=e.midi_in||[];let a=!1;for(const d of o)d.type==="note_on"?(t.lastActive=!0,t.lastActiveNote=d.note,t.activeVelocity=d.velocity,a=!0):d.type==="note_off"&&t.lastActiveNote===d.note&&(t.lastActive=!1,t.lastActiveNote=null);const u={noteIndex:t.lastActive?t.lastActiveNote:null,velocity:t.activeVelocity,hold:!1};return s.audioContext||(n.audio?.context?s.audioContext=n.audio.context:typeof window<"u"&&(s.audioContext=new(window.AudioContext||window.webkitAudioContext))),s.update(u,n.clock.dt,a),{out:s.getValue()}},compileConfig:e=>({})});v(oo);function dn(e){if(e===1)return[[0]];const i=dn(e/2),n=[];for(let t=0;t<i.length;t++)n.push([...i[t],...i[t]]);for(let t=0;t<i.length;t++)n.push([...i[t],...i[t].map(r=>1-r)]);return n}function Di(e){let i=0;for(let n=0;n<e.length-1;n++)e[n]!==e[n+1]&&i++;return i}function ao(e,i){const n=dn(8).sort((a,u)=>Di(a)-Di(u));n[0]=[1,1,1,1,1,1,1,1];const t=[0,1,2,3,4,5,6,7],r=new St(i);for(let a=t.length-1;a>0;a--){const u=r.nextRange(0,a);[t[a],t[u]]=[t[u],t[a]]}const s=Math.max(2,Math.min(8,e));return n.slice(0,s).map(a=>{const u=new Array(8);for(let l=0;l<8;l++)u[l]=a[t[l]];return u})}const uo=[{type:"number",label:"Seed",path:"seed",step:1}],lo=k({id:"nicepattern.orthomod",version:"1.0.0",displayName:"Orthomod",metadata:{category:"NicePattern",keywords:["envelope","modulation","orthogonal","hadamard"],description:"Orthogonal code-based envelope generator."},config:{seed:c},inputs:{midi_in:{type:M,description:"Trigger Input",allowMultiConnection:!0},decay:{type:c,defaultValue:1.2,description:"Decay Time (s)",range:[0,4],step:.01},curve:{type:c,defaultValue:1.5,description:"Response Curve",range:[.1,4],step:.1},relcurve:{type:c,defaultValue:12,description:"Release Curve",range:[.1,20],step:.1},resolution:{type:c,defaultValue:8,range:[2,8],step:1,description:"Codebook Size"},manual_phase:{type:c,defaultValue:-1,description:"Manual Phase Override (0-1)",suppressInputEditor:!0}},outputs:{env:{type:c,description:"Envelope Output (0-1)"},vec:{type:yi,description:"Channel Values [c1, c2, c3, c4]"},ch1:{type:c,description:"Channel 1"},ch2:{type:c,description:"Channel 2"},ch3:{type:c,description:"Channel 3"},ch4:{type:c,description:"Channel 4"}},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:uo}},isRealtime:()=>!0,createState:()=>({linearEnv:0,gateOpen:!1,active:!1,codes:[],lastSeed:-1,lastResolution:-1,currentEffectiveCurve:1.5,phase:0}),execute:(e,i,n,t)=>{const r=n.clock.dt;t.phase+=r;const s=t.phase,o=e.decay,a=typeof o=="number"&&Number.isFinite(o)?Math.max(.001,o):1.2,u=e.curve,l=typeof u=="number"&&Number.isFinite(u)?Math.max(.001,u):1.5,d=e.relcurve,f=typeof d=="number"&&Number.isFinite(d)?Math.max(.1,d):12,p=e.resolution,h=typeof p=="number"&&Number.isFinite(p)?Math.floor(Math.max(2,Math.min(8,p))):8,m=i.seed??12345,g=e.manual_phase,y=typeof g=="number"&&Number.isFinite(g)?g:-1;(m!==t.lastSeed||h!==t.lastResolution)&&(t.codes=ao(h,m),t.lastSeed=m,t.lastResolution=h);const b=(e.midi_in||[]).flat();for(const G of b)G.type==="note_on"?(t.linearEnv=1,t.gateOpen=!0,t.active=!0):G.type==="note_off"&&(t.gateOpen=!1);let _=0;y>=0?(t.linearEnv=Math.max(0,Math.min(1,y)),t.active=!0,t.currentEffectiveCurve=1):(t.active&&(t.linearEnv-=r/Math.max(.01,a),t.linearEnv<=0&&(t.linearEnv=0,t.active=!1)),!t.gateOpen&&t.active?t.currentEffectiveCurve=f:t.currentEffectiveCurve=l);const S=Math.max(0,t.linearEnv),A=t.currentEffectiveCurve;_=Math.pow(S,A),Number.isNaN(_)&&(_=0);let E=1-_;E=Math.max(0,Math.min(.999,E));const N=t.codes.length,w=Math.floor(E*N),q=t.codes[w]||t.codes[0],V=15,J=s*V%1>.5?1:0,z=Math.abs(Math.sin(s*V*Math.PI*2)),$=[0,0,0,0],Ce=[0,0,0,0];if(t.active)for(let G=0;G<4;G++){const Ae=q[G*2]||0,Ie=q[G*2+1]||0;let ye=0;Ae===0&&Ie===0?ye=0:Ae===1&&Ie===1?ye=1:Ae===1&&Ie===0?ye=J:Ae===0&&Ie===1&&(ye=z),Ce[G]=ye,$[G]=ye*_,Number.isNaN($[G])&&($[G]=0)}const Z=G=>Number.isFinite(G)?G:0;return{outputs:{env:Z(_),vec:$.map(Z),ch1:Z($[0]),ch2:Z($[1]),ch3:Z($[2]),ch4:Z($[3])},ui:{codes:t.codes,env:Z(_),vec:$.map(Z),rawVec:t.active?Ce.map(Z):[0,0,0,0],activeCodeIndex:w,gate:t.gateOpen?1:0}}},compileConfig:e=>({seed:e?.seed??12345})});v(lo);const co=()=>({initialized:!1,contextId:"",masterGain:null,voices:[],lastRoot:-1}),po=k({id:"nicepattern.tone4",version:"1.0.0",displayName:"Tone 4",metadata:{category:"NicePattern",keywords:["synth","additive","oscillator","audio"],description:"4-voice additive synth driven by vector input."},inputs:{vec:{type:yi,description:"Modulation Vector [c1, c2, c3, c4]"},root:{type:c,defaultValue:60,description:"Root Note (MIDI)",range:[0,127]},gain:{type:c,defaultValue:.5,description:"Master Volume"}},outputs:{},isRealtime:()=>!0,createState:co,execute:(e,i,n,t)=>{const r=n.audio?.context;if(!r||r.state==="suspended")return{};const s=r.currentTime;if(!t.initialized||t.contextId!==r.contextId){t.masterGain=r.createGain(),t?.masterGain?.connect(r.destination);const p=[1,1.5,2,3],h=["square","sawtooth","triangle","sine"];t.voices=p.map((m,g)=>{const y=r.createOscillator(),b=r.createGain();return y.type=h[g],y.connect(b),b.connect(t.masterGain),y.start(s),b.gain.setValueAtTime(0,s),{osc:y,gain:b,freqRatio:m,wave:h[g]}}),t.initialized=!0,t.contextId=r.contextId,t.lastRoot=-1}const o=Math.max(0,Math.min(1,e.gain??.5));t.masterGain&&t.masterGain.gain.setTargetAtTime(o,s,.05);const a=e.root,u=typeof a=="number"&&Number.isFinite(a)?Math.floor(Math.max(0,Math.min(127,a))):69,l=440*Math.pow(2,(u-69)/12);Math.abs(l-t.lastRoot)>.01&&(t.voices.forEach(p=>{t.lastRoot===-1?p.osc.frequency.setValueAtTime(l*p.freqRatio,s):p.osc.frequency.setTargetAtTime(l*p.freqRatio,s,.05)}),t.lastRoot=l);const d=e.vec,f=Array.isArray(d)&&d.length===4?d:[0,0,0,0];return t.voices.forEach((p,h)=>{const m=Math.max(0,Math.min(1,f[h]??0));p.gain.gain.setTargetAtTime(m,s,.02)}),{}}});v(po);const W={gravity:800,magnetEpsilon:50,physicsRate:120,solverSteps:16,sphereCount:16,magnetRange:800,height:600};class ji{constructor(i,n,t,r,s,o){this.id=i,this.radius=6+o.next()*8,this.mass=this.radius,this.restLength=20+Math.pow(o.next(),2)*150;const a=n*.1,u=n-a*2;this.x=a+u/(s-1)*r,this.y=t-this.restLength,this.vx=0,this.vy=0,this.isLatched=!1,this.tensionRatio=0,this.currentSpringForce=0,this.currentMagForce=0}update(i,n,t,r,s){this.currentMagForce=0,this.currentSpringForce=0,this.tensionRatio=0;const a=(n-this.restLength-this.y)*s.springK,l=s.gravity*this.mass+a;this.currentSpringForce=Math.max(0,l);const d=h=>{if(h>=W.magnetRange)return 0;const m=W.magnetEpsilon/(h*h+W.magnetEpsilon);return s.magnetStrength*m},f=d(0);if(r){const h=this.y-this.radius-t;if(this.isLatched||h<=2)if(f>l){this.isLatched=!0,this.y=t+this.radius,this.vy=0,this.currentMagForce=f,this.tensionRatio=Math.max(0,Math.min(1,l/f));return}else this.isLatched=!1}else this.isLatched=!1;let p=l;if(r&&!this.isLatched){const h=Math.max(0,this.y-this.radius-t),m=-d(h);this.currentMagForce=Math.abs(m),p+=m}this.vy+=p/this.mass*i,this.vy*=s.damping,this.y+=this.vy*i,this.y+this.radius>n&&(this.y=n-this.radius,this.vy*=-.5),this.y-this.radius<t&&(this.y=t+this.radius,r?this.vy<0&&(this.vy=0):this.vy*=-.6)}}const fo=[{type:"number",label:"Seed",path:"seed",step:1,min:0,max:999999}],ho=k({id:"nicepattern.magneto",version:"1.0.0",displayName:"Magneto",metadata:{category:"NicePattern",keywords:["envelope","physics","magnet","modulator"],description:"Physics-based magnetic envelope generator."},config:{seed:{...c,defaultValue:1337}},inputs:{midi_in:{type:M,description:"Trigger Input",allowMultiConnection:!0},attack:{type:c,defaultValue:.2,range:[.01,2],step:.01,description:"Attack Time (s)"},decay:{type:c,defaultValue:.25,range:[.01,2],step:.01,description:"Decay Time (s)"},sustain:{type:c,defaultValue:.6,range:[0,1],step:.01,description:"Sustain Level (0-1)"},release:{type:c,defaultValue:.3,range:[.01,5],step:.01,description:"Release Time (s)"},peak:{type:c,defaultValue:.9,range:[.1,1],step:.01,description:"Peak Level (0-1, inverted)"},mag_flux:{type:c,defaultValue:2e6,range:[1e5,4e6],step:1e4,description:"Magnet Strength"},spring_k:{type:c,defaultValue:25e3,range:[1e3,5e4],step:100,description:"Spring Stiffness"},damping:{type:c,defaultValue:.999,range:[.9,1],step:.001,description:"Damping Factor"}},outputs:{env:{type:c,description:"Envelope Output (Tension)"},vec:yi,ch1:{type:c,description:"Channel 1 (Tension)"},ch2:{type:c,description:"Channel 2 (Extension)"},ch3:{type:c,description:"Channel 3 (Spring Force)"},ch4:{type:c,description:"Channel 4 (Mag Force)"}},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:fo}},isRealtime:()=>!0,createState:()=>{const e=[],n=W.height,t=new St(1337);for(let r=0;r<W.sphereCount;r++)e.push(new ji(r,600,n,r,W.sphereCount,t));return{spheres:e,plateY:40,phase:"IDLE",sustainProgress:0,accumulator:0,lastGate:!1,isTouchingSim:!1,touchY:0}},onMessage:(e,i)=>{i.type==="manual_interaction"&&(e.isTouchingSim=i.active,typeof i.y=="number"&&(e.touchY=i.y))},execute:(e,i,n,t)=>{const r=n.clock.dt,s=e.midi_in||[];let o=t.lastGate;for(const D of s)D.type==="note_on"?o=!0:D.type==="note_off"&&(o=!1);const a=Math.max(.005,e.attack??.2),u=Math.max(.005,e.decay??.25),l=e.sustain??.6,d=Math.max(.005,e.release??.3),f=e.peak??.9,p=i.seed??1337,h=e.mag_flux??2e6,m=e.spring_k??25e3,g=e.damping??.999;if(t.currentSeed!==p||t.spheres.length===0){t.currentSeed=p;const D=new St(p);t.spheres=[];const pe=600,Gt=W.height;for(let Fe=0;Fe<W.sphereCount;Fe++)t.spheres.push(new ji(Fe,pe,Gt,Fe,W.sphereCount,D))}const y=W.height,b=y*.95,_=y*.1,S=40,A=_+f*(b-_),E=_+l*(b-_),N=Math.min(1,.05/Math.max(.001,a)),w=Math.min(1,.02/Math.max(.001,u)),q=Math.min(1,.02/Math.max(.001,d));o&&!t.lastGate?(t.phase="ATTACK",t.sustainProgress=0):!o&&t.lastGate&&(t.phase="RELEASE",t.sustainProgress=0),t.lastGate=o,t.accumulator+=r;const V=1/W.physicsRate;let J=!1,z=0;for(;t.accumulator>=V&&z<5;){t.accumulator-=V,z++;let D=S,pe=q;t.isTouchingSim?(t.phase="MANUAL",J=!0,D=t.touchY,D=Math.max(S,Math.min(b,D)),pe=N,t.sustainProgress=0):o?((t.phase==="IDLE"||t.phase==="RELEASE"||t.phase==="MANUAL")&&(t.phase==="MANUAL"?t.phase="ATTACK":(t.phase="ATTACK",t.sustainProgress=0)),t.phase==="ATTACK"?(D=A,pe=N,Math.abs(t.plateY-A)<10&&(t.phase="DECAY")):t.phase==="DECAY"?(D=E,pe=w,Math.abs(t.plateY-E)<5&&(t.phase="SUSTAIN")):t.phase==="SUSTAIN"&&(D=E,pe=.1,t.sustainProgress+=(1-t.sustainProgress)*2*V),J=!0):(t.phase="RELEASE",D=S,pe=q,Math.abs(t.plateY-S)<15?(J=!1,t.phase="IDLE"):J=!0);const Gt=D-t.plateY;t.plateY+=Gt*pe;const Fe=V/W.solverSteps,ts={gravity:W.gravity,springK:m,magnetStrength:h,damping:g};for(let Ri=0;Ri<W.solverSteps;Ri++)t.spheres.forEach(is=>{is.update(Fe,y,t.plateY,J,ts)})}t.accumulator>V&&(t.accumulator=0);let $=0,Ce=0,Z=0,G=0,Ae=0;t.spheres.forEach(D=>{D.isLatched&&(Ae++,$+=D.tensionRatio);const pe=Math.max(0,y-D.restLength-D.y);Ce+=pe,Z+=D.currentSpringForce,G+=D.currentMagForce});const Ie=Ae>0?$/Ae:0,ye=Math.min(1,Ce/(y*W.sphereCount*.4)),Jr=W.sphereCount*m*y*.3,Zr=W.sphereCount*h,Ti=Math.min(1,Z/Jr),Ei=Math.min(1,G/Zr),Qr=[Ie,ye,Ti,Ei],es={plateY:t.plateY,phase:t.phase,sustainProgress:t.sustainProgress,spheres:t.spheres.map(D=>({x:D.x,y:D.y,r:D.radius,l:D.isLatched,t:D.tensionRatio})),adsr:{attack:a,decay:u,sustain:l,release:d,peak:f},seed:p};return{outputs:{env:Ie,vec:Qr,ch1:Ie,ch2:ye,ch3:Ti,ch4:Ei},ui:es}},compileConfig:e=>({seed:e?.seed??1337})});v(ho);const Yt=16,mo=k({id:"seq.tomidi",version:"1.0.0",displayName:"To MIDI",metadata:{category:"Sequence",keywords:["pattern","sequencer","combiner","event","midi"],description:"Converts sequence(s) into a MIDI stream."},config:{},inputs:{seq_in:{type:X,description:"Input sequence(s)",allowMultiConnection:!0}},outputs:{midi_out:M},autoBroadcast:!0,reshape:"none",isRealtime:()=>!0,createState:()=>({sequenceStates:new Map}),execute:(e,i,n,t)=>{let s=e.seq_in||[];s.length===1&&Array.isArray(s[0])&&s[0].length>0&&Array.isArray(s[0][0])&&(s=s[0]);const o=[],l=(Math.floor(n.clock.beat*4)%Yt+Yt)%Yt,d=new Set;s.forEach((f,p)=>d.add(p)),t.sequenceStates.forEach((f,p)=>d.add(p));for(const f of d){const p=s[f];t.sequenceStates.has(f)||t.sequenceStates.set(f,{lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map});const h=t.sequenceStates.get(f);if(!p&&h.lastNoteIndex===null){t.sequenceStates.delete(f);continue}let m={noteIndex:null,velocity:0,hold:!1};if(p&&p[l]&&(m=p[l]),l!==h.lastStepIndex||!p||m.noteIndex!==h.lastNoteIndex){const g=h.lastNoteIndex,y=h.lastHold,b=m.noteIndex!==null&&m.noteIndex!==void 0,_=b&&m.noteIndex===g,S=g!==null&&(!_||!y),A=b&&(!_||!y);S&&g!==null&&(o.push({type:"note_off",note:g,velocity:0,channel:1,deviceId:"tomidi",time:0}),h.activeNotes.delete(g),h.lastNoteIndex=null,h.lastHold=!1),A&&m.noteIndex!==null?(o.push({type:"note_on",note:m.noteIndex,velocity:m.velocity,channel:1,deviceId:"tomidi",time:0}),h.activeNotes.set(m.noteIndex,m.velocity),h.lastNoteIndex=m.noteIndex,h.lastHold=m.hold):_&&y&&(h.lastHold=m.hold),h.lastStepIndex=l}}return{midi_out:o}}});v(mo);const vo=k({id:"seq.sequencer",version:"1.0.0",displayName:"Sequencer",metadata:{category:"Sequence",keywords:["sequencer","step","pattern"],description:"16-step sequencer."},config:{sequence:{kind:"array",size:16,element:{kind:"record",fields:{noteIndex:c,velocity:c,hold:{kind:"atomic",type:"boolean"}}}}},inputs:{},outputs:{seq_out:X},ui:{},compileConfig:e=>{const i=Array(16).fill({noteIndex:null,velocity:0,hold:!1});return{sequence:e?.values?.sequence??i}},createState:()=>({currentStepIndex:0}),isRealtime:()=>!1,execute:(e,i,n,t)=>{const r=Array(16).fill({noteIndex:null,velocity:0,hold:!1});return{outputs:{seq_out:i.sequence||r},ui:{currentStepIndex:t.currentStepIndex}}}});v(vo);const yo=k({id:"seq.oneshot",version:"1.0.0",displayName:"One Shot",metadata:{category:"Sequence",keywords:["player","trigger","oneshot","envelope"],description:"Plays a sequence once upon trigger."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}},trigger:{combine:{reduce:"flatten"}}},reshape:"none",inputs:{seq_in:{type:X,description:"Input sequence"},trigger:{type:M,description:"Trigger",allowMultiConnection:!0},duration:{type:c,defaultValue:4,description:"Duration (s)"}},outputs:{midi_out:M},isRealtime:()=>!0,createState:()=>({isPlaying:!1,startTime:0,lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map}),execute:(e,i,n,t)=>{const r=e.trigger||[];let s=!1;for(const g of r)if(g&&g.type==="note_on"&&g.velocity>0){s=!0;break}const o=n.audio?.context?.currentTime??0;s&&(t.isPlaying=!0,t.startTime=o);const a=e.seq_in||[],u=[];if(!t.isPlaying||!a||a.length===0)return t.lastNoteIndex!==null&&(u.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.lastNoteIndex=null,t.lastHold=!1),t.activeNotes.size>0&&t.activeNotes.clear(),{midi_out:u};const l=Math.max(.001,e.duration??4),f=(o-t.startTime)/l;if(f>=1)return t.isPlaying=!1,t.lastNoteIndex!==null&&(u.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.lastNoteIndex=null,t.lastHold=!1),{midi_out:u};const p=a.length,h=Math.floor(f*p);let m={noteIndex:null,velocity:0,hold:!1};if(a[h]&&(m=a[h]),h!==t.lastStepIndex||m.noteIndex!==t.lastNoteIndex){const g=t.lastNoteIndex,y=t.lastHold,b=m.noteIndex!==null,_=b&&m.noteIndex===g,S=g!==null&&(!_||!y),A=b&&(!_||!y);S&&g!==null&&(u.push({type:"note_off",note:g,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.activeNotes.delete(g),t.lastNoteIndex=null,t.lastHold=!1),A&&m.noteIndex!==null?(u.push({type:"note_on",note:m.noteIndex,velocity:m.velocity,channel:1,time:0,deviceId:"oneshot"}),t.activeNotes.set(m.noteIndex,m.velocity),t.lastNoteIndex=m.noteIndex,t.lastHold=m.hold):_&&y&&(t.lastHold=m.hold),t.lastStepIndex=h}return{midi_out:u}}}),go=k({id:"seq.scan",version:"1.0.0",displayName:"Scan Sequence",metadata:{category:"Sequence",keywords:["player","scan","scrub"],description:"Plays a sequence by scanning through positions."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},reshape:"none",inputs:{seq_in:{type:X,description:"Input sequence"},pos:{type:c,defaultValue:0,description:"Position (0-1)"}},outputs:{midi_out:M},isRealtime:()=>!0,createState:()=>({lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map}),execute:(e,i,n,t)=>{const r=e.seq_in||[],s=e.pos??0,o=[];if(!r||r.length===0||s>=1||s<0)return t.lastNoteIndex!==null&&(o.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=null,t.lastHold=!1),{midi_out:o};const a=r.length,u=Math.floor(s*a);let l={noteIndex:null,velocity:0,hold:!1};if(r[u]&&(l=r[u]),u!==t.lastStepIndex||l.noteIndex!==t.lastNoteIndex){const d=t.lastNoteIndex,f=t.lastHold,p=l.noteIndex!==null,h=p&&l.noteIndex===d,m=d!==null&&(!h||!f),g=p&&(!h||!f);m&&d!==null&&(o.push({type:"note_off",note:d,velocity:0,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=null,t.lastHold=!1),g&&l.noteIndex!==null?(o.push({type:"note_on",note:l.noteIndex,velocity:l.velocity,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=l.noteIndex,t.lastHold=l.hold):h&&f&&(t.lastHold=l.hold),t.lastStepIndex=u}return{midi_out:o}}});v(yo);v(go);const _o=k({id:"seq.crop",version:"1.0.0",displayName:"Crop Sequence",metadata:{category:"Sequence",keywords:["modifier","crop","slice"],description:"Mutes steps outside the specified range."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-end"}},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},inputs:{seq_in:{type:X,description:"Input sequence"},start:{type:c,defaultValue:0},end:{type:c,defaultValue:1,optional:!0},length:{type:c,defaultValue:1,optional:!0}},outputs:{seq_out:X},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}]}]}},computeForwardPorts:(e,i)=>{const n=i.mode||"start-end",t={seq_in:X,start:{...c,defaultValue:0}};return n==="start-length"?t.length={...c,defaultValue:1}:t.end={...c,defaultValue:1},{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{seq_out:X}}}},shouldRecompileOnConfigChange:()=>!0,compileConfig:e=>({mode:e.mode||"start-end"}),execute:(e,i)=>{const n=e.seq_in||[],t=i.mode||"start-end",r=n.map(u=>({...u})),s=e.start??0;let o=1;if(t==="start-length"){const u=e.length??1;o=s+u}else o=e.end??1;o<s&&(o=s);const a=r.length;for(let u=0;u<a;u++){const l=u/a;(l<s||l>=o)&&(r[u].noteIndex=null,r[u].velocity=0,r[u].hold=!1)}return{seq_out:r}}}),bo=k({id:"seq.fill",version:"1.0.0",displayName:"Fill Sequence",metadata:{category:"Sequence",keywords:["generator","fill","range"],description:"Generates a sequence where steps inside the specified range are ON."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-length"},count:{...c,defaultValue:16}},inputs:{start:{type:c,defaultValue:0},end:{type:c,defaultValue:1,optional:!0},length:{type:c,defaultValue:.5,optional:!0}},outputs:{seq_out:X},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}],default:"start-length"},{type:"number",label:"Step Count",path:"count",min:1,max:128,step:1,default:16}]}},computeForwardPorts:(e,i)=>{const n=i.mode||"start-length",t={start:{...c,defaultValue:0}};return n==="start-length"?t.length={...c,defaultValue:.5}:t.end={...c,defaultValue:1},{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{seq_out:X}}}},shouldRecompileOnConfigChange:()=>!0,compileConfig:e=>({mode:e.mode||"start-length",count:e.count??16}),execute:(e,i)=>{const n=i.count??16,t=i.mode||"start-length",r=[];for(let o=0;o<n;o++)r.push({noteIndex:null,velocity:0,hold:!1});const s=e.start??0;if(t==="start-length"){const o=e.length??.5,a=Math.round(o*n),u=Math.floor(s*n);for(let l=0;l<a;l++){const d=u+l;d>=0&&d<n&&(r[d]={noteIndex:60,velocity:1,hold:!1})}}else{const o=e.end??1;let a=s,u=o;u<a&&(u=a);for(let l=0;l<n;l++){const d=l/n;d>=a&&d<u&&(r[l]={noteIndex:60,velocity:1,hold:!1})}}return{seq_out:r}}});v(_o);v(bo);const Ke={noteIndex:null,velocity:0,hold:!1},Xe=e=>e.noteIndex!==null&&e.noteIndex!==void 0,Vt=(e,i,n,t)=>k({id:`seq.${e}`,version:"1.0.0",displayName:i,metadata:{category:"Sequence",keywords:["logic",e,"binary"],description:n},config:{},inputs:{inputs:{type:X,description:"Sequences",allowMultiConnection:!0}},outputs:{seq_out:X},execute:r=>{const s=r.inputs||[];if(s.length===0)return{seq_out:[]};let o=0;if(s.forEach(u=>o=Math.max(o,u.length)),o===0)return{seq_out:[]};const a=[];for(let u=0;u<o;u++){let l={...Ke};const d=s[0];d.length>0?l={...d[u%d.length]}:l={...Ke};for(let f=1;f<s.length;f++){const p=s[f],h=p.length>0?p[u%p.length]:Ke;l=t(l,h)}a.push(l)}return{seq_out:a}}}),xo=Vt("xor","Sequence XOR","XORs multiple sequences.",(e,i)=>{const n=Xe(e),t=Xe(i);return n!==t?t?i:e:{...Ke}}),Oo=Vt("sub","Sequence Subtract","Subtracts subsequent sequences from the first.",(e,i)=>Xe(i)?{...Ke}:e),So=Vt("and","Sequence AND","Output active only if both inputs active.",(e,i)=>Xe(e)&&Xe(i)?i:{...Ke}),Ao=Vt("or","Sequence OR","Output active if any input active.",(e,i)=>Xe(i)?i:e),Io=k({id:"seq.negate",version:"1.0.0",displayName:"Sequence Negate",metadata:{category:"Sequence",keywords:["logic","not","invert"],description:"Inverts sequence activity."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},inputs:{seq_in:{type:X}},outputs:{seq_out:X},execute:e=>({seq_out:(e.seq_in||[]).map(t=>{const r={...t};return r.noteIndex!==null?(r.noteIndex=null,r.velocity=0,r.hold=!1):(r.noteIndex=60,r.velocity=1,r.hold=!1),r})})});v(xo);v(Oo);v(So);v(Ao);v(Io);const wo=[{type:"string",label:"Path",path:"path",placeholder:"/composition/..."}],ko=k({id:"resolume.input",version:"1.0.0",displayName:"Resolume Input",metadata:{category:x.IO,keywords:["resolume","arena","parameter","read"],description:"Reads a parameter value from Resolume Arena."},inputs:{},config:{path:mi},outputs:{value:{type:c,suppressLabel:!0}},autoBroadcast:!1,isRealtime:()=>!0,ui:{inspector:{fields:wo}},getDisplayLabel:e=>{if(!e.path)return;const i=e.path.split("/");return i[i.length-1]||e.path},createState:(e,i)=>{const n={value:0,unsubscribe:()=>{},currentPath:e.path,callback:r=>{}};n.callback=r=>{n.value=r};const t=i.resolume;return e.path&&t&&(t.subscribe(e.path,n.callback,n.callback),n.unsubscribe=()=>t.unsubscribe(e.path,n.callback)),n},execute:(e,i,n,t)=>{if(i.path!==t.currentPath){t.currentPath&&t.unsubscribe(),t.currentPath=i.path;const r=n.resolume;i.path&&r&&(r.subscribe(i.path,t.callback),t.unsubscribe=()=>r.unsubscribe(i.path,t.callback))}return{value:t?.value??0}},compileConfig:e=>({path:e.path??""})});v(ko);const Mo={kind:"atomic",type:"any"},No=[{type:"string",label:"Path",path:"path",placeholder:"/composition/..."}],Co=k({id:"resolume.output",version:"1.0.0",displayName:"Resolume Output",metadata:{category:x.IO,keywords:["resolume","arena","parameter","write"],description:"Writes a value to a Resolume Arena parameter."},inputs:{value:{type:Mo,suppressInputEditor:!0,suppressLabel:!0}},config:{path:mi},outputs:{},autoBroadcast:!0,ui:{inspector:{fields:No}},getDisplayLabel:e=>{if(!e.path)return;const i=e.path.split("/");return i[i.length-1]||e.path},createState:(e,i)=>({lastValue:void 0}),execute:(e,i,n,t)=>{if(i.path&&e.value!==void 0){const r=e.value,s=t.lastValue;let o=!1;typeof r=="number"&&typeof s=="number"?Math.abs(r-s)>1e-5&&(o=!0):r!==s&&(o=!0);const a=n.resolume;o&&a&&(a.setValue(i.path,r),t.lastValue=r)}return{}},compileConfig:e=>({path:e.path??""})});v(Co);const pn=F("math.add",{category:x.Math,keywords:["sum","plus"],description:"Adds a and b."},(e,i)=>e+i);v({version:"1.0.0",...pn,displayName:"Add",aliases:["plus","sum"],extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Sum"}}});const fn=F("math.subtract",{category:x.Math,keywords:["minus","difference"],description:"Subtracts b from a."},(e,i)=>e-i);v({version:"1.0.0",...fn,displayName:"Subtract",aliases:["minus","difference"],extendedInputs:{a:{type:c,description:"Minuend"},b:{type:c,description:"Subtrahend"}},extendedOutputs:{result:{type:c,description:"Result"}}});const hn=F("math.multiply",{category:x.Math,keywords:["times","product"],description:"Multiplies a and b."},(e,i)=>e*i);v({version:"1.0.0",...hn,displayName:"Multiply",aliases:["times","product"],extendedInputs:{a:{type:c,description:"Factor A"},b:{type:c,description:"Factor B"}},extendedOutputs:{result:{type:c,description:"Product"}}});const mn=F("math.divide",{category:x.Math,keywords:["div","quotient"],description:"Divides a by b."},(e,i)=>e/i);v({version:"1.0.0",...mn,displayName:"Divide",aliases:["div","quotient"],extendedInputs:{a:{type:c,description:"Dividend"},b:{type:c,description:"Divisor"}},extendedOutputs:{result:{type:c,description:"Quotient"}}});const vn=F("math.pow",{category:x.Math,keywords:["power","exponent"],description:"Raises a to the power of b."},(e,i)=>Math.pow(e,i));v({version:"1.0.0",...vn,displayName:"Power",extendedInputs:{a:{type:c,description:"Base"},b:{type:c,description:"Exponent"}},extendedOutputs:{result:{type:c,description:"Result"}}});const yn=F("math.min",{category:x.Math,keywords:["minimum","smallest"],description:"Returns the smaller of a and b."},(e,i)=>Math.min(e,i));v({version:"1.0.0",...yn,displayName:"Min",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Minimum"}}});const gn=F("math.max",{category:x.Math,keywords:["maximum","largest"],description:"Returns the larger of a and b."},(e,i)=>Math.max(e,i));v({version:"1.0.0",...gn,displayName:"Max",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Maximum"}}});const _n=U({id:"math.fmod",metadata:{category:x.Math,keywords:["modulo","remainder"],description:"Floating point modulo operation."},inputs:{dividend:c,divisor:c},outputs:{div:c,mod:c},autoBroadcast:!0,execute:(e,i,n)=>{const{dividend:t,divisor:r}=e,s=Math.floor(t/r),o=t%r;return{div:s,mod:o}}});v({version:"1.0.0",..._n,displayName:"FMod",extendedInputs:{dividend:{type:c,description:"Dividend"},divisor:{type:c,description:"Divisor",defaultValue:1,range:[0,10]}},extendedOutputs:{div:{type:c,description:"The integer division result."},mod:{type:c,description:"The remainder."}}});const bn=F("logic.and",{category:x.Logic,keywords:["boolean","&&"],description:"Logical AND (1 if both non-zero, else 0)."},(e,i)=>e!==0&&i!==0?1:0);v({version:"1.0.0",...bn,displayName:"AND",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const xn=F("logic.or",{category:x.Logic,keywords:["boolean","||"],description:"Logical OR (1 if either non-zero, else 0)."},(e,i)=>e!==0||i!==0?1:0);v({version:"1.0.0",...xn,displayName:"OR",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const On=F("logic.xor",{category:x.Logic,keywords:["boolean","^"],description:"Logical XOR (1 if different truthiness, else 0)."},(e,i)=>e!==0!=(i!==0)?1:0);v({version:"1.0.0",...On,displayName:"XOR",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const Sn=F("logic.equals",{category:x.Logic,keywords:["==","equality"],description:"Returns 1 if a equals b, else 0."},(e,i)=>e===i?1:0);v({version:"1.0.0",...Sn,displayName:"Equals",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const An=F("logic.greater_than",{category:x.Logic,keywords:[">","gt"],description:"Returns 1 if a > b, else 0."},(e,i)=>e>i?1:0);v({version:"1.0.0",...An,displayName:"Greater Than",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const In=F("logic.less_than",{category:x.Logic,keywords:["<","lt"],description:"Returns 1 if a < b, else 0."},(e,i)=>e<i?1:0);v({version:"1.0.0",...In,displayName:"Less Than",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});var To=Object.freeze({__proto__:null,primitive_add:pn,primitive_and:bn,primitive_divide:mn,primitive_equals:Sn,primitive_fmod:_n,primitive_greater_than:An,primitive_less_than:In,primitive_max:gn,primitive_min:yn,primitive_multiply:hn,primitive_or:xn,primitive_pow:vn,primitive_subtract:fn,primitive_xor:On});const wn=F("math.abs",{category:x.Math,keywords:["absolute","magnitude"],description:"Returns the absolute value of a."},e=>Math.abs(e),"unary");v({version:"1.0.0",...wn,displayName:"Abs",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Absolute Value"}}});const kn=F("math.negate",{category:x.Math,keywords:["negative","invert"],description:"Negates a."},e=>-e,"unary");v({version:"1.0.0",...kn,displayName:"Negate",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Negated Value"}}});const Mn=F("math.ceil",{category:x.Math,keywords:["ceiling","round up"],description:"Rounds a up to the nearest integer."},e=>Math.ceil(e),"unary");v({version:"1.0.0",...Mn,displayName:"Ceil",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Ceiling"}}});const Nn=F("math.floor",{category:x.Math,keywords:["floor","round down"],description:"Rounds a down to the nearest integer."},e=>Math.floor(e),"unary");v({version:"1.0.0",...Nn,displayName:"Floor",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Floor"}}});const Cn=F("math.round",{category:x.Math,keywords:["round","nearest"],description:"Rounds a to the nearest integer."},e=>Math.round(e),"unary");v({version:"1.0.0",...Cn,displayName:"Round",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Rounded Value"}}});const Tn=F("math.sin",{category:x.Math,keywords:["sine"],description:"Returns the sine of a (radians)."},e=>Math.sin(e),"unary");v({version:"1.0.0",...Tn,displayName:"Sin",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Sine"}}});const En=F("math.cos",{category:x.Math,keywords:["cosine"],description:"Returns the cosine of a (radians)."},e=>Math.cos(e),"unary");v({version:"1.0.0",...En,displayName:"Cos",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Cosine"}}});const Rn=F("math.tan",{category:x.Math,keywords:["tangent"],description:"Returns the tangent of a (radians)."},e=>Math.tan(e),"unary");v({version:"1.0.0",...Rn,displayName:"Tan",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Tangent"}}});const Vn=F("math.sqrt",{category:x.Math,keywords:["square root"],description:"Returns the square root of a."},e=>Math.sqrt(e),"unary");v({version:"1.0.0",...Vn,displayName:"Sqrt",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Square Root"}}});const Pn=F("logic.not",{category:x.Logic,keywords:["!","invert"],description:"Logical NOT (1 if zero, 0 if non-zero)."},e=>e===0?1:0,"unary");v({version:"1.0.0",...Pn,displayName:"NOT",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Result"}}});var Eo=Object.freeze({__proto__:null,primitive_abs:wn,primitive_ceil:Mn,primitive_cos:En,primitive_floor:Nn,primitive_negate:kn,primitive_not:Pn,primitive_round:Cn,primitive_sin:Tn,primitive_sqrt:Vn,primitive_tan:Rn});const te=(e,i,n,t=x.Math)=>{const r=U({id:e,metadata:{category:t,description:`Apply ${e.split(".").pop()} to all inputs.`},inputs:{values:{kind:"array",element:P,size:"dynamic",allowMultiConnection:!0}},outputs:{result:c},computeForwardPorts:(s,o,a)=>{const u=s.fields.values;let l=c;if(u&&u.kind==="array"){const d=u.element;(d.kind==="array"||d.kind==="record")&&(l=d)}return{inputs:{kind:"record",fields:{values:u}},outputs:{kind:"record",fields:{result:l}}}},execute:s=>{const o=s.values;if(!o||o.length===0)return{result:0};const a=o[0],u=Array.isArray(a);let l=!1,d=[];if(!u&&typeof a=="object"&&a!==null&&typeof a.x=="number"&&typeof a.y=="number"&&(l=!0,d=["x","y"],typeof a.z=="number"&&d.push("z"),typeof a.w=="number"&&d.push("w")),u||l||typeof a=="number"){const f=u?a.length:l?d.length:1,p=new Array(f);for(let h=0;h<f;h++){let m=u?a[h]:l?a[d[h]]:a;for(let g=1;g<o.length;g++){const y=o[g];let b;if(Array.isArray(y))b=y[h]??0;else if(typeof y=="object"&&y!==null&&"x"in y){const _=d[h];b=y[_],b===void 0&&(b=0)}else b=y;m=n(m,b)}p[h]=m}if(l){const h={};return d.forEach((m,g)=>h[m]=p[g]),{result:h}}else if(!u)return{result:p[0]};return{result:p}}else return{result:0}}});return v({version:"1.0.0",...r,displayName:i,extendedInputs:{values:{type:{kind:"array",element:c,size:"dynamic"},description:"Values to process.",suppressInputEditor:!0,suppressLabel:!0,allowMultiConnection:!0}},extendedOutputs:{result:{type:c,description:"Result"}}}),r},Ro=te("math.all.add","Sum All",(e,i)=>e+i),Vo=te("math.all.subtract","Subtract All",(e,i)=>e-i),Po=te("math.all.multiply","Multiply All",(e,i)=>e*i),Do=te("math.all.divide","Divide All",(e,i)=>e/i),jo=te("math.all.pow","Power All",(e,i)=>Math.pow(e,i)),Lo=te("math.all.min","Min All",(e,i)=>Math.min(e,i)),Bo=te("math.all.max","Max All",(e,i)=>Math.max(e,i)),qo=te("logic.all.and","AND All",(e,i)=>e&&i?1:0,x.Logic),Fo=te("logic.all.or","OR All",(e,i)=>e||i?1:0,x.Logic),$o=te("logic.all.xor","XOR All",(e,i)=>!!e!=!!i?1:0,x.Logic),Uo=te("logic.all.equals","Equals All",(e,i)=>e===i?1:0,x.Logic),zo=te("logic.all.greater_than","Greater Than All",(e,i)=>e>i?1:0,x.Logic),Go=te("logic.all.less_than","Less Than All",(e,i)=>e<i?1:0,x.Logic);var Ho=Object.freeze({__proto__:null,primitive_all_add:Ro,primitive_all_and:qo,primitive_all_divide:Do,primitive_all_equals:Uo,primitive_all_greater_than:zo,primitive_all_less_than:Go,primitive_all_max:Bo,primitive_all_min:Lo,primitive_all_multiply:Po,primitive_all_or:Fo,primitive_all_pow:jo,primitive_all_subtract:Vo,primitive_all_xor:$o});const Dn=U({id:"math.pi",metadata:{category:x.Math,keywords:["pi","constant"],description:"Returns the value of Pi."},inputs:{},outputs:{result:c},execute:()=>({result:Math.PI})});v({version:"1.0.0",...Dn,displayName:"Pi",extendedOutputs:{result:{type:c,description:"Pi"}}});const jn=U({id:"math.e",metadata:{category:x.Math,keywords:["e","euler","constant"],description:"Returns the value of Euler's number."},inputs:{},outputs:{result:c},execute:()=>({result:Math.E})});v({version:"1.0.0",...jn,displayName:"E",extendedOutputs:{result:{type:c,description:"Euler's Number"}}});var Wo=Object.freeze({__proto__:null,primitive_e:jn,primitive_pi:Dn});const Ln=U({id:"math.clamp",metadata:{category:x.Math,keywords:["limit","range"],description:"Clamps a value between a minimum and maximum."},inputs:{value:c,min:{...c,defaultValue:0},max:{...c,defaultValue:1}},outputs:{result:c},autoBroadcast:{value:{combine:"collect"},min:{combine:"collect"},max:{combine:"collect"}},reshape:"vector",execute:e=>{const{value:i,min:n,max:t}=e;return{result:Math.max(n,Math.min(i,t))}}});v({version:"1.0.0",...Ln,displayName:"Clamp",extendedInputs:{value:{type:c,description:"Value to clamp."},min:{type:c,description:"Minimum value.",defaultValue:0,range:[0,1]},max:{type:c,description:"Maximum value.",defaultValue:1,range:[0,1]}},extendedOutputs:{value:{type:c,description:"The clamped value."}}});const Bn=U({id:"math.lerp",metadata:{category:x.Math,keywords:["lerp","mix","interpolate"],description:"Linear interpolation between a and b."},inputs:{a:c,b:c,t:c},config:{clamp:{kind:"atomic",type:"boolean",optional:!0}},outputs:{result:c},autoBroadcast:!0,execute:(e,i)=>{const{a:n,b:t,t:r}=e,s=i.clamp!==!1,o=n+(t-n)*r;return{result:s?Math.max(Math.min(o,Math.max(n,t)),Math.min(n,t)):o}}});v({version:"1.0.0",...Bn,displayName:"Lerp",extendedInputs:{a:{type:c,description:"Start Value"},b:{type:c,description:"End Value"},t:{type:c,description:"Interpolant (0-1)"}},extendedOutputs:{result:{type:c,description:"Interpolated Value"}},compileConfig:e=>({fields:{clamp:e.clamp??!0},untagged:[]})});const qn=U({id:"math.map",metadata:{category:x.Math,keywords:["map","remap","range"],description:"Maps a value from one range to another."},inputs:{value:c,inMin:c,inMax:c,outMin:c,outMax:c},outputs:{result:c},autoBroadcast:!0,execute:e=>{const{value:i,inMin:n,inMax:t,outMin:r,outMax:s}=e;return{result:r+(i-n)*(s-r)/(t-n)}}});v({version:"1.0.0",...qn,displayName:"Map",extendedInputs:{value:{type:c,description:"Input Value"},inMin:{type:c,description:"Input Min",defaultValue:0},inMax:{type:c,description:"Input Max",defaultValue:1},outMin:{type:c,description:"Output Min",defaultValue:0},outMax:{type:c,description:"Output Max",defaultValue:1}},extendedOutputs:{result:{type:c,description:"Mapped Value"}}});var Yo=Object.freeze({__proto__:null,primitive_clamp:Ln,primitive_lerp:Bn,primitive_map:qn});function Ko(e){if(!e)return;const i=e.type;if(!(!i||i==="any")){if(i==="float")return{kind:"atomic",type:"number"};if(i==="string")return{kind:"atomic",type:"string"};if(i.startsWith("float")){const n=parseInt(i.slice(5));if(!isNaN(n))return{kind:"array",size:n,element:{kind:"atomic",type:"number"}}}}}const Fn={kind:"record",fields:{name:{kind:"atomic",type:"string"},type:P}},$n={id:"io.input",kind:"primitive",metadata:{category:x.IO,keywords:["source","in"],description:"Graph input node."},configType:Fn,ui:{inspector:{fields:[{type:"structor-type",label:"Type",path:"type",default:"float"},{type:"string",label:"Name",path:"name"}]}},computeForwardPorts:(e,i,n)=>{let t=e.fields.value;if(!t){const r=Ko(i);r&&(t=r)}return t||(t={kind:"atomic",type:"number"}),{inputs:{kind:"record",fields:{value:{kind:"atomic",type:"number"}}},outputs:{kind:"record",fields:{value:t}}}},execute:(e,i,n)=>{const r=i?.fields?.name??"value";return{fields:{value:e.fields[r]!==void 0?e.fields[r]:e.fields.value}}}};v({version:"1.0.0",...$n,displayName:"Input",aliases:["in","source"],extendedOutputs:{value:{type:P,description:"The input value.",suppressInputEditor:!0,suppressLabel:!0}},compileConfig:e=>{const i=Ye(e,Fn);return e.values&&(i.values=e.values),i}});var Xo=Object.freeze({__proto__:null,primitive_input:$n});const Un={id:"io.output",kind:"primitive",metadata:{category:x.IO,keywords:["sink","out"],description:"Graph output node."},computeForwardPorts:(e,i,n)=>{const t=e.fields.value||{kind:"atomic",type:"any"};return{inputs:{kind:"record",fields:{value:t}},outputs:{kind:"record",fields:{value:t}}}},execute:(e,i,n)=>({fields:{value:e.fields.value}})};v({version:"1.0.0",...Un,displayName:"Output",aliases:["out","sink"],extendedInputs:{value:{type:P,description:"The output value.",suppressInputEditor:!0,suppressLabel:!0}},extendedOutputs:{value:{type:P,description:"The graph output value.",suppressInputEditor:!0,suppressLabel:!0}}});var Jo=Object.freeze({__proto__:null,primitive_output:Un});function Zo(e){if(!e)return;const i=e.type;if(!(!i||i==="any")){if(i==="float")return{kind:"atomic",type:"number"};if(i==="string")return{kind:"atomic",type:"string"};if(i.startsWith("float")){const n=parseInt(i.slice(5));if(!isNaN(n))return{kind:"array",size:n,element:{kind:"atomic",type:"number"}}}}}function ti(e,i,n,t){if(!e||!e.includes("#"))return e;let r="";return n===1?r=t==="input"?"in":"out":n<=4?r=["x","y","z","w"][i]:r=i.toString(),e.replace(/#/g,r)}const gi=(e,i,n)=>{const r=n.loadedSubgraphs;if(!r)return{inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{}}};const s=i.subgraphId,o=r.get(s);if(o){const a=Object.values(o.inner.nodes),u={},l=a.filter(p=>p.config.typeId==="io.input"||p.config.typeId==="input").sort((p,h)=>p.y-h.y);l.forEach((p,h)=>{let m=p.config.name||"value";m=ti(m,h,l.length,"input");const g=Zo(p.config);u[m]=g||{kind:"atomic",type:"any"}});const d={},f=a.filter(p=>p.config.typeId==="io.output"||p.config.typeId==="output").sort((p,h)=>p.y-h.y);return f.forEach((p,h)=>{let m=p.config.name||"value";m=ti(m,h,f.length,"output"),d[m]={kind:"atomic",type:"any"}}),{inputs:{kind:"record",fields:u},outputs:{kind:"record",fields:d}}}return{inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{}}}},zn=U({id:"core.subgraph",subgraphExpansionTag:"inline",metadata:{category:x.Core,keywords:["nested","graph"],description:"Executes a nested subgraph."},config:{subgraphId:{kind:"atomic",type:"string"}},inputs:{},outputs:{},ui:{inspector:{fields:[{type:"string",label:"Subgraph ID",path:"subgraphId"}]}},getDisplayLabel:e=>{if(e.subgraphId){const i=e.subgraphId.split(".");return i[i.length-1]}},computeForwardPorts:gi,execute:(e,i,n)=>({fields:{}})});v({version:"1.0.0",...zn,displayName:"Subgraph"});var Qo=Object.freeze({__proto__:null,computeSubgraphPorts:gi,primitive_subgraph:zn,resolvePortName:ti});const Gn=U({id:"core.thensubgraph",subgraphExpansionTag:"onTrigger",metadata:{category:x.Core,keywords:["nested","graph","conditional","midi","trigger"],description:"Executes a nested subgraph when a MIDI Note On event is received."},config:{subgraphId:{kind:"atomic",type:"string"}},inputs:{midi_in:M},outputs:{},ui:{inspector:{fields:[{type:"string",label:"Subgraph ID",path:"subgraphId"}]}},getDisplayLabel:e=>{if(e.subgraphId){const i=e.subgraphId.split(".");return`OnNote: ${i[i.length-1]}`}return"OnNote"},computeForwardPorts:((e,i,n)=>{const t=gi(e,i,n);return{inputs:{kind:"record",fields:{...t.inputs.fields,midi_in:M}},outputs:t.outputs}}),execute:(e,i,n)=>{const t=e.midi_in||[],r=Array.isArray(t)?t:[];let s=!1;for(const o of r)if(o.type==="note_on"&&(o.velocity??0)>0){s=!0;break}return s&&n.executeSubgraph&&n.executeSubgraph("onTrigger"),{fields:{}}}});v(Gn);var ea=Object.freeze({__proto__:null,primitive_thensubgraph:Gn});const Hn=U({id:"core.pack",metadata:{category:x.Core,keywords:["pack","record","struct","vector"],description:"Packs inputs into a record or vector."},config:{targetType:{kind:"atomic",type:"string",defaultValue:"infer"}},inputs:{},outputs:{result:P},ui:{inspector:{fields:[{type:"tab-bar",label:"Target Type",path:"targetType",options:[{label:"Infer",value:"infer"},{label:"float2",value:"float2"},{label:"float3",value:"float3"},{label:"float4",value:"float4"}]}]}},computeBackwardPorts:(e,i,n)=>{const t=i?.targetType||"infer";let r=null;if(t==="infer"){const o=e.fields.result;o&&o.kind==="record"&&(o.fields.x&&o.fields.y&&o.fields.z&&o.fields.w?r="float4":o.fields.x&&o.fields.y&&o.fields.z?r="float3":o.fields.x&&o.fields.y&&(r="float2"))}else r=t;const s={kind:"record",fields:{}};return r==="float4"?s.fields={x:c,y:c,z:c,w:c}:r==="float3"?s.fields={x:c,y:c,z:c}:r==="float2"&&(s.fields={x:c,y:c}),{inputRequirements:s,backwardMetadata:{inferredType:r}}},computeForwardPorts:(e,i,n,t)=>{const r=i,s=r?.targetType||r?.fields?.targetType||"infer";let o=s!=="infer"?s:t?.inferredType||"float2";const a={},u={};return["float2","float3","float4"].includes(o)||(o="float2"),o==="float4"?(a.x=c,a.y=c,a.z=c,a.w=c,u.result={kind:"array",size:4,element:c,hint:"float4"}):o==="float3"?(a.x=c,a.y=c,a.z=c,u.result={kind:"array",size:3,element:c,hint:"float3"}):(a.x=c,a.y=c,u.result={kind:"array",size:2,element:c,hint:"float2"}),{inputs:{kind:"record",fields:a},outputs:{kind:"record",fields:u}}},shouldRecompileOnConfigChange:(e,i)=>e?.targetType!==i?.targetType,execute:(e,i)=>{const n=e?.fields||{};let t=i?.targetType||"infer";return t==="infer"&&(n.w!==void 0?t="float4":n.z!==void 0?t="float3":n.y!==void 0&&n.x!==void 0?t="float2":t="record"),t==="float4"?{result:[n.x??0,n.y??0,n.z??0,n.w??0]}:t==="float3"?{result:[n.x??0,n.y??0,n.z??0]}:t==="float2"?{result:[n.x??0,n.y??0]}:{result:{fields:n}}}});v({version:"1.0.0",...Hn,displayName:"Pack",extendedOutputs:{result:{type:P,description:"Record"}}});var ta=Object.freeze({__proto__:null,primitive_pack:Hn});const Wn=U({id:"core.unpack",metadata:{category:x.Core,keywords:["unpack","destructure","split"],description:"Unpacks a record or fixed-length vector into outputs."},config:{},inputs:{record:P},computeForwardPorts:(e,i,n)=>{const t=e.fields.record;let r={};if(t){if(t.kind==="record")r=t.fields;else if(t.kind==="array"&&typeof t.size=="number"&&t.size<=16){const s=t.size;if(s===2)r.x=t.element,r.y=t.element;else if(s===3)r.x=t.element,r.y=t.element,r.z=t.element;else if(s===4)r.x=t.element,r.y=t.element,r.z=t.element,r.w=t.element;else for(let o=0;o<s;o++)r[o.toString()]=t.element}}return{inputs:{kind:"record",fields:{record:t||P}},outputs:{kind:"record",fields:r}}},outputs:{},dynamicOutputType:P,execute:e=>{let i=e.record;if(!i)return{};if(Array.isArray(i)&&i.length===1&&typeof i[0]=="object"&&i[0]!==null){const n=i[0];("x"in n||"fields"in n||Object.keys(n).length>0)&&(i=n)}if(Array.isArray(i)){const n=i.length,t={};if(n===2)t.x=i[0],t.y=i[1];else if(n===3)t.x=i[0],t.y=i[1],t.z=i[2];else if(n===4)t.x=i[0],t.y=i[1],t.z=i[2],t.w=i[3];else for(let r=0;r<n;r++)r<16&&(t[r.toString()]=i[r]);return t}return typeof i=="object"&&i!==null?"fields"in i?i.fields:i:{}}});v({version:"1.0.0",...Wn,displayName:"Unpack",extendedInputs:{record:{type:P,description:"Record to unpack"}}});var ia=Object.freeze({__proto__:null,primitive_unpack:Wn});function Yn(e){return e&&e.kind==="array"&&e.element?.kind==="record"?"midi":"primitive"}function Kn(e,i){if(i==="primitive")if(Array.isArray(e)){for(const n of e)if(n)return!0;return!1}else return!!e;else{const n=e||[];if(Array.isArray(n)){for(const t of n)if(t&&t.type==="note_on"&&(t.velocity??0)>0)return!0}return!1}}const Xn=U({id:"core.ifthen",subgraphExpansionTag:"onTrigger",metadata:{category:x.Core,keywords:["group","conditional","spatial","if","then"],description:"Spatially groups nodes and executes them when a MIDI Note On event is received."},config:{width:{kind:"atomic",type:"number",defaultValue:3},height:{kind:"atomic",type:"number",defaultValue:3},regionX:{kind:"atomic",type:"number",defaultValue:0,optional:!0},regionY:{kind:"atomic",type:"number",defaultValue:0,optional:!0},visibility:{kind:"atomic",type:"string",defaultValue:"auto",optional:!0},mode:{kind:"atomic",type:"string",defaultValue:"midi",optional:!0}},inputs:{midi_in:M},outputs:{},ui:{inspector:{fields:[{type:"number",label:"Width",path:"width",min:1,step:1},{type:"number",label:"Height",path:"height",min:1,step:1},{type:"number",label:"Region X (Offset)",path:"regionX",step:1},{type:"number",label:"Region Y (Offset)",path:"regionY",step:1},{type:"tab-bar",label:"Visibility",path:"visibility",options:[{label:"Auto",value:"auto"},{label:"Show",value:"show"},{label:"Hide",value:"hide"}],default:"auto"}]}},getDisplayLabel:()=>"IfThen",getRegion:e=>({x:e.regionX??0,y:e.regionY??0,width:e.width??1,height:e.height??1,visibility:e.visibility||tn.Show}),getChildren:(e,i)=>{const n=[],t=e.config,r=t.regionX??0,s=t.regionY??0,o=t.width??1,a=t.height??1,u=e.x+r,l=e.y+s,d=u+o,f=l+a;for(const p of Object.values(i))p.id!==e.id&&p.x>=u&&p.x<d&&p.y>=l&&p.y<f&&n.push(p.id);return n},execute:(e,i,n)=>{const t=i.mode||"midi",r=e.midi_in;return Kn(r,t)&&n.executeSubgraph&&n.executeSubgraph("onTrigger"),{fields:{}}},computeForwardPorts:(e,i,n)=>{const t=e.fields.midi_in;let r="midi",s=M;return t&&(r=Yn(t),r==="primitive"&&(s=t)),{inputs:{kind:"record",fields:{midi_in:s}},outputs:{kind:"record",fields:{}},forwardMetadata:{mode:r}}},compileConfig:(e,i)=>{const n=i?.metadata;return{fields:{...e,mode:n?.mode||"midi"}}}});v(Xn);var na=Object.freeze({__proto__:null,primitive_ifthen:Xn});function Jn(e){return typeof e=="number"?c:typeof e=="string"?{kind:"atomic",type:"string"}:typeof e=="boolean"?{kind:"atomic",type:"boolean"}:Array.isArray(e)?{kind:"array",element:e.length>0?Jn(e[0]):P,size:e.length}:P}const Zn={id:"data.literal",kind:"primitive",metadata:{category:x.Data,keywords:["value","constant"],description:"Outputs a constant value."},configType:{kind:"atomic",type:"any"},computeForwardPorts:(e,i,n)=>({inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{value:Jn(i)}}}),execute:(e,i,n)=>({fields:{value:i&&typeof i=="object"&&"value"in i?i.value:i}})};v({version:"1.0.0",...Zn,displayName:"Literal",extendedOutputs:{value:{type:P,description:"The literal value."}},compileConfig:e=>e?.literal?.value??0});var ra=Object.freeze({__proto__:null,primitive_literal:Zn});const Qn=U({id:"util.hub",metadata:{category:x.Utility,keywords:["hub","reroute"],description:"Passes input to output."},inputs:{value:P},outputs:{value:P},autoBroadcast:!0,execute:e=>({value:e.value})});v({version:"1.0.0",...Qn,displayName:"Hub",extendedInputs:{value:{type:P,description:"Input",suppressInputEditor:!0,suppressLabel:!0}},extendedOutputs:{value:{type:P,description:"Output",suppressLabel:!0}}});const er=U({id:"data.float",metadata:{category:x.Data,keywords:["float","number","slider"],description:"Float value with slider."},inputs:{value:c},outputs:{value:c},autoBroadcast:!0,execute:e=>({value:e.value})});v({version:"1.0.0",...er,displayName:"Float",extendedInputs:{value:{type:c,description:"Value",defaultValue:0}},extendedOutputs:{value:{type:c,description:"Value"}},compileConfig:e=>({values:{value:e.value??0},fields:{},untagged:[]})});var sa=Object.freeze({__proto__:null,primitive_float:er,primitive_hub:Qn});const tr={id:"functional.apply",kind:"primitive",metadata:{category:x.Functional,keywords:["call","invoke"],description:"Applies a functor to an input value."},computeForwardPorts:(e,i,n)=>{const t=e.fields.functor;return{inputs:e,outputs:{kind:"record",fields:{result:t?t.output:{kind:"atomic",type:"any"}}}}},execute:(e,i,n)=>{const t=e.fields.functor,r=e.fields.input;return{fields:{result:t(r)}}}};v({version:"1.0.0",...tr,displayName:"Apply Functor",extendedInputs:{functor:{type:{kind:"functor",input:P,output:P},description:"The functor to apply."},value:{type:P,description:"The value to apply the functor to."}},extendedOutputs:{result:{type:P,description:"The result of the functor application."}}});var oa=Object.freeze({__proto__:null,primitive_apply:tr});const ir=U({id:"logic.select",metadata:{category:x.Logic,keywords:["switch","case","mux","conditional","select"],description:"Selects an output value from multiple inputs based on a control value."},inputs:{},config:{count:{kind:"atomic",type:"number",defaultValue:2},mode:{kind:"atomic",type:"string",defaultValue:"value"},base:{kind:"atomic",type:"number",defaultValue:0,optional:!0},step:{kind:"atomic",type:"number",defaultValue:1,optional:!0}},outputs:{result:B},autoBroadcast:!1,computeForwardPorts:(e,i,n)=>{const t=i.fields,r=t.count||2,s=t.mode||"value",o={value:c},a=[];for(let l=0;l<r;l++)if(s==="range"){const d=`val_${l}`;o[d]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[d]&&a.push(e.fields[d])}else s==="value"?(o[`match_${l}`]={...c,description:`Case ${l+1} Match`},o[`val_${l}`]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[`val_${l}`]&&a.push(e.fields[`val_${l}`])):s==="zone"&&(o[`threshold_${l}`]={...c,description:`Case ${l+1} Threshold`},o[`val_${l}`]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[`val_${l}`]&&a.push(e.fields[`val_${l}`]));const u=vi(a);return{inputs:{kind:"record",fields:o},outputs:{kind:"record",fields:{result:u}}}},compileConfig:e=>({fields:{count:e.count||2,mode:e.mode||"value",base:e.base||0,step:e.step||1}}),shouldRecompileOnConfigChange:(e,i)=>{const n=e,t=i;return n.count!==t?.count||n.mode!==t?.mode},execute:(e,i,n)=>{const t=i.count??2,r=i.mode??"value",s=i.base??0,o=i.step??1,a={value:{type:c}};for(let p=0;p<t;p++){const h=`val_${p}`;a[h]={type:B},r==="value"?a[`match_${p}`]={type:c}:r==="zone"&&(a[`threshold_${p}`]={type:c})}const u=ns(n,a,e),l=u.value??0;let d=-1;if(r==="range")if(o===0)d=0;else{const p=Math.round((l-s)/o);d=Math.max(0,Math.min(t-1,p))}else if(r==="value")for(let h=0;h<t;h++){const m=u[`match_${h}`]??h+1;if(Math.abs(l-m)<1e-4){d=h;break}}else if(r==="zone")for(let p=0;p<t;p++){const h=u[`threshold_${p}`]??1/0;if(l<=h){d=p;break}}let f=0;return d!==-1?f=u[`val_${d}`]??0:f=0,{result:f}}});v({version:"1.0.0",...ir,displayName:"Select",extendedInputs:{value:{type:c,description:"Control Value"}},extendedOutputs:{result:{type:B,description:"Selected Value"}},ui:{inspector:{fields:[{type:"number",label:"Count",path:"count",min:2,max:32,step:1,default:2},{type:"tab-bar",label:"Mode",path:"mode",default:"value",options:[{label:"Value (Match)",value:"value"},{label:"Range (Index)",value:"range"},{label:"Zone (Threshold)",value:"zone"}]},{type:"number",label:"Base Index",path:"base",step:1,default:0,visible:e=>e.mode==="range"},{type:"number",label:"Step Size",path:"step",step:1,default:1,visible:e=>e.mode==="range"}]}}});var aa=Object.freeze({__proto__:null,logic_select:ir});const nr=U({id:"logic.latch",metadata:{category:x.Logic,keywords:["latch","sample","hold","trigger","store"],description:"Stores and outputs a value when the trigger condition is met."},config:{initMode:{kind:"atomic",type:"string",defaultValue:"auto"},mode:{kind:"atomic",type:"string",defaultValue:"midi",optional:!0}},inputs:{condition:M,value:B,init:B},outputs:{result:B},autoBroadcast:!1,createState:()=>({currentValue:void 0,initialized:!1}),computeForwardPorts:(e,i,n)=>{const r=i.fields.initMode||"auto",s=(e.fields||e).condition,o=Yn(s),a=(e.fields||e).value||B;let u=(e.fields||e).init||B;r==="auto"&&(u=a);const l=vi([a,u]),d={condition:s||M,value:a};return r==="manual"&&(d.init=u),{inputs:{kind:"record",fields:d},outputs:{kind:"record",fields:{result:l}},forwardMetadata:{mode:o}}},compileConfig:(e,i)=>({fields:{initMode:e.initMode||"auto",mode:i?.mode||"midi"}}),shouldRecompileOnConfigChange:(e,i)=>{const n=e,t=i;return n.initMode!==t?.initMode},execute:(e,i,n,t)=>{const r=e.condition,s=e.value,o=e.init,a=i.mode||"midi",u=i.initMode||"auto";Kn(r,a)&&(t.currentValue=s,t.initialized=!0);let l=t.currentValue;return t.initialized||(u==="auto"&&(l=s),t.initialized||(t.currentValue=u==="auto"?s:o,t.initialized=!0,l=t.currentValue)),{result:l}}});v({version:"1.0.0",...nr,inputs:{},displayName:"Latch",extendedInputs:{condition:{type:M,description:"Trigger"},value:{type:B,description:"Value to Latch"},init:{type:B,description:"Initial Value"}},extendedOutputs:{result:{type:B,description:"Latched Value"}},ui:{inspector:{fields:[{type:"tab-bar",label:"Init Mode",path:"initMode",default:"auto",options:[{label:"Auto (Use Value)",value:"auto"},{label:"Manual",value:"manual"}]}]}}});var ua=Object.freeze({__proto__:null,logic_latch:nr});const rr=U({id:"logic.delay",metadata:{category:x.Logic,keywords:["delay","z-1","feedback","memory","prev"],description:"Outputs the value from the previous frame (z)."},config:{initMode:{kind:"atomic",type:"string",defaultValue:"auto"}},inputs:{value:B,init:B},outputs:{result:B},autoBroadcast:!1,isRealtime:()=>!0,createState:()=>({storedValue:void 0,initialized:!1}),computeForwardPorts:(e,i,n)=>{const r=i.fields.initMode||"auto",s=(e.fields||e).value||B;let o=(e.fields||e).init||B;r==="auto"&&(o=s);const a=vi([s,o]),u={value:s};return r==="manual"&&(u.init=o),{inputs:{kind:"record",fields:u},outputs:{kind:"record",fields:{result:a}}}},compileConfig:(e,i)=>({fields:{initMode:e.initMode||"auto"}}),shouldRecompileOnConfigChange:(e,i)=>{const n=e,t=i;return n.initMode!==t?.initMode},cycleBreakingPorts:["value"],execute:(e,i,n,t)=>{const r=e.init,s=i.initMode||"auto";let o;return t.initialized?o=t.storedValue:(s==="auto"?o=e.value:o=r,t.initialized=!0),e.value!==void 0&&(t.storedValue=e.value),{result:o}},consolidate:(e,i,n,t)=>{e.value!==void 0&&(t.storedValue=e.value),t.initialized=!0}});v({version:"1.0.0",...rr,inputs:{},displayName:"Delay",extendedInputs:{value:{type:B,description:"Input Value"},init:{type:B,description:"Initial Value"}},extendedOutputs:{result:{type:B,description:"Delayed Value"}},ui:{inspector:{fields:[{type:"tab-bar",label:"Init Mode",path:"initMode",default:"auto",options:[{label:"Auto (Use Value)",value:"auto"},{label:"Manual",value:"manual"}]}]}}});var la=Object.freeze({__proto__:null,logic_delay:rr});const ca=[To,Eo,Ho,Wo,Yo,Xo,Jo,Qo,ea,ta,ia,na,ra,sa,oa,aa,ua,la];ca.flatMap(e=>Object.values(e).filter(i=>typeof i=="object"&&i!==null&&"kind"in i&&i.kind==="primitive"));class Li{constructor(i,n,t){this.isScalar=i,this.size=n,this.data=t}apply(i){return this.isScalar?i(this.data):this.data.map(n=>i(n))}}function Bi(e,i){(!i||!i.fields)&&console.error("broadcast: inputs or inputs.fields is undefined",i);const n={};let t=0,r=!1;for(const[s,o]of Object.entries(e.outputs)){const a=[];if(o.fromFields)for(const l of o.fromFields)i.fields[l]!==void 0&&a.push(i.fields[l]);let u;if(o.combine==="collect"){u=a;for(const l of a)Array.isArray(l)&&(r=!0,t=Math.max(t,l.length))}else{let l="first";typeof o.combine=="object"&&"reduce"in o.combine&&(l=o.combine.reduce),l==="first"?u=a[0]:l==="flatten"?u=a.flat(1/0):u=a[0],Array.isArray(u)&&(r=!0,t=Math.max(t,u.length))}n[s]=u}if(!r||e.reshape==="none"){const s={};for(const[o,a]of Object.entries(n))s[o]=a;return new Li(!0,1,s)}else{const s=[];for(let o=0;o<t;o++){const a={};for(const[u,l]of Object.entries(n))e.outputs[u].combine==="collect"?a[u]=l.map(f=>Array.isArray(f)?f[o%f.length]:f):Array.isArray(l)?a[u]=l[o%l.length]:a[u]=l;s.push(a)}return new Li(!1,t,s)}}class da{constructor(i,n,t,r,s,o,a){if(this.graph=i,this.repository=n,this.nodeStates=new Map,this.executionOrder=[],this.graphInputs=new Map,this.userNodeStates=new Map,this.inspectedInputs=new Map,this.downstreamMap=new Map,this.nodeMetadata=new Map,this.resolvedIdCache=new Map,this.executedNodesThisTick=new Set,this.mainExecutionOrder=[],this.taggedExecutionOrders=new Map,this.inferredNodeTypes=r,a)for(const[u,l]of Object.entries(a))this.resolvedIdCache.set(u,l);if(o)for(const[u,l]of Object.entries(o))this.nodeMetadata.set(u,l);for(const u of i.connections)this.downstreamMap.has(u.fromNode)||this.downstreamMap.set(u.fromNode,[]),this.downstreamMap.get(u.fromNode).push(u.toNode);if(i.nodes)for(const[u,l]of Object.entries(i.nodes))l.executionOwnerId&&(this.downstreamMap.has(u)||this.downstreamMap.set(u,[]),this.downstreamMap.get(u).push(l.executionOwnerId));this.splitExecutionOrder(i.executionOrder||[]),this.initializeStates(t,s)}get graphNodeCount(){return this.executionOrder.length}splitExecutionOrder(i){this.mainExecutionOrder=[],this.taggedExecutionOrders.clear();for(const n of i){const t=this.graph.nodes[n];if(t.executionTag&&t.executionOwnerId){this.taggedExecutionOrders.has(t.executionOwnerId)||this.taggedExecutionOrders.set(t.executionOwnerId,new Map);const r=this.taggedExecutionOrders.get(t.executionOwnerId);r.has(t.executionTag)||r.set(t.executionTag,[]),r.get(t.executionTag).push(n)}else this.mainExecutionOrder.push(n)}}getInferredNodeTypes(){return this.inferredNodeTypes}getNodeState(i){return this.nodeStates.get(i)}initializeStates(i,n){const t=new Set(n||[]);for(const[r,s]of Object.entries(this.graph.nodes)){const o=this.repository.get(s.definitionId),a=s.defaultConfig??null,u=o?.isRealtime?.(a??{fields:{}})??!1;let l,d;if(i&&i.has(r)){const f=i.get(r);f.definitionId===s.definitionId&&(l=f)}l?(d={...l,config:s.defaultConfig??null,isRealtime:u,definitionId:s.definitionId,isDirty:l.isDirty||t.has(r)},this.nodeStates.set(r,d)):(d={output:{fields:{}},config:s.defaultConfig??null,isDirty:!0,isRealtime:u,definitionId:s.definitionId},this.nodeStates.set(r,d))}}setInput(i,n){this.graphInputs.set(i,n);const t=this.graph.inputs[i];t&&this.markDirty(t.nodeId)}resolveNodeId(i){return this.nodeStates.has(i)?i:this.resolvedIdCache.has(i)?this.resolvedIdCache.get(i):i}setNodeConfig(i,n){const t=this.resolveNodeId(i),r=this.nodeStates.get(t);if(r){const s=this.repository.get(r.definitionId),o=s?.configType;let a=n;const u=this.nodeMetadata.get(i);if(s&&s.kind==="primitive"&&s.compileConfig&&u)try{const l=s.compileConfig(n,u);l&&(a=l)}catch(l){console.warn(`Dynamic config compilation failed for ${i}`,l)}if(o&&o.kind==="record"&&n&&typeof n=="object"&&!Array.isArray(n)){const l={};let d=!1;const f={...n,...n.values||{}};for(const p of Object.keys(o.fields))p in f&&(l[p]=f[p],d=!0);d&&(a={...n,fields:l})}if(a&&typeof a=="object"&&!Array.isArray(a)){const l=a,d=r.config&&typeof r.config=="object"&&!Array.isArray(r.config)?r.config:{};r.config={...d,...a,fields:{...d.fields||{},...l.fields||{}},values:{...d.values||{},...l.values||{}}}}else r.config=a;if(r.isRealtime=s?.isRealtime?.(r.config??{fields:{}})??!1,this.markDirty(i),this.graph.virtualInputMappings&&this.graph.virtualInputMappings[i]){const l=this.graph.virtualInputMappings[i],d=r.config?.values||{};for(const[f,p]of Object.entries(l))if(f in d){const h=d[f];this.nodeStates.get(p)&&this.setNodeConfig(p,{values:{[f]:h}})}}}}getNodeConfig(i){const n=this.resolveNodeId(i);return this.nodeStates.get(n)?.config}hasNode(i){return this.nodeStates.has(i)}markDirty(i){const n=this.resolveNodeId(i),t=this.nodeStates.get(n);if(!(!t||t.isDirty)){t.isDirty=!0;for(const r of this.downstreamMap.get(n)||[])this.markDirty(r)}}update(i){this.executedNodesThisTick.clear();const n=new Set;for(const[t,r]of this.nodeStates)r.isRealtime&&this.markDirty(t);for(const t of this.mainExecutionOrder)this.executeNode(t,i,n);for(const t of this.mainExecutionOrder)this.executeNode(t,i,n);for(const t of n)this.markDirty(t)}executeNode(i,n,t){const r=this.nodeStates.get(i);if(!r.isDirty&&!this.executedNodesThisTick.has(i))return;const s=this.graph.nodes[i],o=this.executedNodesThisTick.has(i),a=this.repository.get(s.definitionId);if(!a||a.kind!=="primitive"){a||console.warn(`Definition not found for node ${i}(defId: ${s.definitionId})`);return}if(o){if(a.consolidate){const d=this.collectInputs(i,a,r),f={...n,clock:n.clock??{beat:0,dt:0},audio:n.audio,broadcast:(p,h)=>Bi(p,h),repository:this.repository,nodeState:this.userNodeStates,nodeId:i,requestUiOutputs:!1,markSelfDirty:()=>{},executeSubgraph:()=>{}};try{a.consolidate(d,r.config,f,this.userNodeStates.get(i))}catch(p){console.error(`Error consolidating node ${i}:`,p)}}return}this.executedNodesThisTick.add(i);const u=this.collectInputs(i,a,r),l={...n,clock:n.clock??{beat:0,dt:0},audio:n.audio,broadcast:(d,f)=>Bi(d,f),repository:this.repository,nodeState:this.userNodeStates,nodeId:i,requestUiOutputs:!0,markSelfDirty:()=>{t.add(i)},executeSubgraph:d=>{if(this.taggedExecutionOrders.has(i)){const f=this.taggedExecutionOrders.get(i);if(f.has(d)){const p=f.get(d);for(const h of p){const m=this.nodeStates.get(h);m&&(m.isDirty=!0),this.executeNode(h,n,t)}}}}};try{a.inspectInputs&&this.inspectedInputs.set(i,u);const d=a.execute(u,r.config,l);"outputs"in d&&"ui"in d?(r.output=d.outputs,r.uiOutput=d.ui):"outputs"in d?(r.output=d.outputs,r.uiOutput=void 0):(r.output=d,r.uiOutput=void 0),r.isDirty=!1}catch(d){throw console.error(`Error executing node ${i} (${a.id}): `,d),d}}collectInputs(i,n,t){const r={fields:{}},s=this.repository.getNodeType(n.id),o=new Map,a=(f,p)=>{o.has(f)||o.set(f,[]),o.get(f).push(p)};if(this.graph.connections){for(const f of this.graph.connections)if(f.toNode===i){const p=f.fromNode,h=f.fromPort,m=this.nodeStates.get(p),g=m?m.output:void 0;if(g&&g.fields&&typeof h=="string"&&h in g.fields){const y=g.fields[h];a(f.toPort.toString(),y)}}}for(const[f,p]of Object.entries(this.graph.inputs))if(p.nodeId===i){const h=this.graphInputs.get(f);h!==void 0&&a(p.port.toString(),h)}if(t.config&&typeof t.config=="object"&&"values"in t.config){const f=t.config.values;if(f&&typeof f=="object")for(const[p,h]of Object.entries(f))o.has(p)||a(p,h)}const u=s?.inputs,l=new Set([...o.keys()]),d=new Map;Array.isArray(u)?u.forEach(f=>{l.add(f.name),d.set(f.name,f)}):u&&Object.entries(u).forEach(([f,p])=>{l.add(f),d.set(f,p)});for(const f of l){const p=d.get(f),h=o.get(f),m=p?p.type||p:void 0,g=m&&m.kind==="array";if(h&&h.length>0){const y=h[h.length-1];p&&p.allowMultiConnection||g&&!Array.isArray(y)?r.fields[f]=h:r.fields[f]=y}else p&&p.defaultValue!==void 0&&(r.fields[f]=p.defaultValue)}return r}getOutputs(){const i=new Map;for(const[n,t]of this.nodeStates.entries())i.set(n,t.output);return i}getUiOutputs(){const i=new Map;for(const[n,t]of this.nodeStates.entries()){const r=t.uiOutput;r!==void 0&&i.set(n,r)}return i}getNodeOutput(i){return this.nodeStates.get(i)?.output}getGraphOutput(i){const n=this.graph.outputs[i];if(!n)return;const t=this.nodeStates.get(n.nodeId)?.output;if(t&&typeof n.port=="string")return t.fields[n.port]}getNodeStates(){return this.nodeStates}getUserNodeStates(){return this.userNodeStates}setUserNodeStates(i){this.userNodeStates=i}getInputs(){return this.graphInputs}handleNodeMessage(i,n){const t=this.resolveNodeId(i),r=this.graph.nodes[t];if(!r)return;const s=this.repository.get(r.definitionId);if(!s||s.kind!=="primitive"||!s.onMessage)return;const o=this.userNodeStates.get(t);o&&(s.onMessage(o,n),this.markDirty(t))}getInspectedInputs(){return this.inspectedInputs}getExecutedNodes(){return this.executedNodesThisTick}}function T(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),t=1;t<i;t++)n[t-1]=arguments[t];throw new Error(typeof e=="number"?"[MobX] minified error nr: "+e+(n.length?" "+n.map(String).join(","):"")+". Find the full error at: https://github.com/mobxjs/mobx/blob/main/packages/mobx/src/errors.ts":"[MobX] "+e)}var pa={};function _i(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:pa}var sr=Object.assign,At=Object.getOwnPropertyDescriptor,he=Object.defineProperty,Pt=Object.prototype,ii=[];Object.freeze(ii);var or={};Object.freeze(or);var fa=typeof Proxy<"u",ha=Object.toString();function ar(){fa||T("Proxy not available")}function ur(e){var i=!1;return function(){if(!i)return i=!0,e.apply(this,arguments)}}var Ue=function(){};function le(e){return typeof e=="function"}function Re(e){var i=typeof e;switch(i){case"string":case"symbol":case"number":return!0}return!1}function Dt(e){return e!==null&&typeof e=="object"}function Se(e){if(!Dt(e))return!1;var i=Object.getPrototypeOf(e);if(i==null)return!0;var n=Object.hasOwnProperty.call(i,"constructor")&&i.constructor;return typeof n=="function"&&n.toString()===ha}function lr(e){var i=e?.constructor;return i?i.name==="GeneratorFunction"||i.displayName==="GeneratorFunction":!1}function jt(e,i,n){he(e,i,{enumerable:!1,writable:!0,configurable:!0,value:n})}function cr(e,i,n){he(e,i,{enumerable:!1,writable:!1,configurable:!0,value:n})}function je(e,i){var n="isMobX"+e;return i.prototype[n]=!0,function(t){return Dt(t)&&t[n]===!0}}function et(e){return e!=null&&Object.prototype.toString.call(e)==="[object Map]"}function ma(e){var i=Object.getPrototypeOf(e),n=Object.getPrototypeOf(i),t=Object.getPrototypeOf(n);return t===null}function _e(e){return e!=null&&Object.prototype.toString.call(e)==="[object Set]"}var dr=typeof Object.getOwnPropertySymbols<"u";function va(e){var i=Object.keys(e);if(!dr)return i;var n=Object.getOwnPropertySymbols(e);return n.length?[].concat(i,n.filter(function(t){return Pt.propertyIsEnumerable.call(e,t)})):i}var at=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:dr?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames;function pr(e){return e===null?null:typeof e=="object"?""+e:e}function ke(e,i){return Pt.hasOwnProperty.call(e,i)}var ya=Object.getOwnPropertyDescriptors||function(i){var n={};return at(i).forEach(function(t){n[t]=At(i,t)}),n};function Q(e,i){return!!(e&i)}function ee(e,i,n){return n?e|=i:e&=~i,e}function qi(e,i){(i==null||i>e.length)&&(i=e.length);for(var n=0,t=Array(i);n<i;n++)t[n]=e[n];return t}function ga(e,i){for(var n=0;n<i.length;n++){var t=i[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,ba(t.key),t)}}function tt(e,i,n){return i&&ga(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function ze(e,i){var n=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=xa(e))||i){n&&(e=n);var t=0;return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Je(){return Je=Object.assign?Object.assign.bind():function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i];for(var t in n)({}).hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},Je.apply(null,arguments)}function fr(e,i){e.prototype=Object.create(i.prototype),e.prototype.constructor=e,ni(e,i)}function ni(e,i){return ni=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,t){return n.__proto__=t,n},ni(e,i)}function _a(e,i){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var t=n.call(e,i);if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function ba(e){var i=_a(e,"string");return typeof i=="symbol"?i:i+""}function xa(e,i){if(e){if(typeof e=="string")return qi(e,i);var n={}.toString.call(e).slice(8,-1);return n==="Object"&&e.constructor&&(n=e.constructor.name),n==="Map"||n==="Set"?Array.from(e):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?qi(e,i):void 0}}var Ge=Symbol("mobx-stored-annotations");function me(e){function i(n,t){if(ft(t))return e.decorate_20223_(n,t);pt(n,t,e)}return Object.assign(i,e)}function pt(e,i,n){ke(e,Ge)||jt(e,Ge,Je({},e[Ge])),ka(n)||(e[Ge][i]=n)}function ft(e){return typeof e=="object"&&typeof e.kind=="string"}var I=Symbol("mobx administration"),Ne=(function(){function e(n){n===void 0&&(n="Atom"),this.name_=void 0,this.flags_=0,this.observers_=new Set,this.lastAccessedBy_=0,this.lowestObserverState_=C.NOT_TRACKING_,this.onBOL=void 0,this.onBUOL=void 0,this.name_=n}var i=e.prototype;return i.onBO=function(){this.onBOL&&this.onBOL.forEach(function(t){return t()})},i.onBUO=function(){this.onBUOL&&this.onBUOL.forEach(function(t){return t()})},i.reportObserved=function(){return Mr(this)},i.reportChanged=function(){se(),Nr(this),oe()},i.toString=function(){return this.name_},tt(e,[{key:"isBeingObserved",get:function(){return Q(this.flags_,e.isBeingObservedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isBeingObservedMask_,t)}},{key:"isPendingUnobservation",get:function(){return Q(this.flags_,e.isPendingUnobservationMask_)},set:function(t){this.flags_=ee(this.flags_,e.isPendingUnobservationMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();Ne.isBeingObservedMask_=1;Ne.isPendingUnobservationMask_=2;Ne.diffValueMask_=4;var bi=je("Atom",Ne);function hr(e,i,n){i===void 0&&(i=Ue),n===void 0&&(n=Ue);var t=new Ne(e);return i!==Ue&&Cu(t,i),n!==Ue&&Vr(t,n),t}function Oa(e,i){return Hr(e,i)}function Sa(e,i){return Object.is?Object.is(e,i):e===i?e!==0||1/e===1/i:e!==e&&i!==i}var It={structural:Oa,default:Sa};function Ve(e,i,n){return Lr(e)?e:Array.isArray(e)?Y.array(e,{name:n}):Se(e)?Y.object(e,void 0,{name:n}):et(e)?Y.map(e,{name:n}):_e(e)?Y.set(e,{name:n}):typeof e=="function"&&!Ze(e)&&!lt(e)?lr(e)?Qe(e):ut(n,e):e}function Aa(e,i,n){if(e==null||Ut(e)||$t(e)||Be(e)||fe(e))return e;if(Array.isArray(e))return Y.array(e,{name:n,deep:!1});if(Se(e))return Y.object(e,void 0,{name:n,deep:!1});if(et(e))return Y.map(e,{name:n,deep:!1});if(_e(e))return Y.set(e,{name:n,deep:!1})}function Lt(e){return e}function Ia(e,i){return Hr(e,i)?i:e}var wa="override";function ka(e){return e.annotationType_===wa}function ht(e,i){return{annotationType_:e,options_:i,make_:Ma,extend_:Na,decorate_20223_:Ca}}function Ma(e,i,n,t){var r;if((r=this.options_)!=null&&r.bound)return this.extend_(e,i,n,!1)===null?0:1;if(t===e.target_)return this.extend_(e,i,n,!1)===null?0:2;if(Ze(n.value))return 1;var s=mr(e,this,i,n,!1);return he(t,i,s),2}function Na(e,i,n,t){var r=mr(e,this,i,n);return e.defineProperty_(i,r,t)}function Ca(e,i){var n=i.kind,t=i.name,r=i.addInitializer,s=this,o=function(l){var d,f,p,h;return Pe((d=(f=s.options_)==null?void 0:f.name)!=null?d:t.toString(),l,(p=(h=s.options_)==null?void 0:h.autoAction)!=null?p:!1)};if(n=="field")return function(u){var l,d=u;return Ze(d)||(d=o(d)),(l=s.options_)!=null&&l.bound&&(d=d.bind(this),d.isMobxAction=!0),d};if(n=="method"){var a;return Ze(e)||(e=o(e)),(a=this.options_)!=null&&a.bound&&r(function(){var u=this,l=u[t].bind(u);l.isMobxAction=!0,u[t]=l}),e}T("Cannot apply '"+s.annotationType_+"' to '"+String(t)+"' (kind: "+n+"):"+(`
'`+s.annotationType_+"' can only be used on properties with a function value."))}function Ta(e,i,n,t){i.annotationType_,t.value}function mr(e,i,n,t,r){var s,o,a,u,l,d,f;r===void 0&&(r=O.safeDescriptors),Ta(e,i,n,t);var p=t.value;if((s=i.options_)!=null&&s.bound){var h;p=p.bind((h=e.proxy_)!=null?h:e.target_)}return{value:Pe((o=(a=i.options_)==null?void 0:a.name)!=null?o:n.toString(),p,(u=(l=i.options_)==null?void 0:l.autoAction)!=null?u:!1,(d=i.options_)!=null&&d.bound?(f=e.proxy_)!=null?f:e.target_:void 0),configurable:r?e.isPlainObject_:!0,enumerable:!1,writable:!r}}function vr(e,i){return{annotationType_:e,options_:i,make_:Ea,extend_:Ra,decorate_20223_:Va}}function Ea(e,i,n,t){var r;if(t===e.target_)return this.extend_(e,i,n,!1)===null?0:2;if((r=this.options_)!=null&&r.bound&&(!ke(e.target_,i)||!lt(e.target_[i]))&&this.extend_(e,i,n,!1)===null)return 0;if(lt(n.value))return 1;var s=yr(e,this,i,n,!1,!1);return he(t,i,s),2}function Ra(e,i,n,t){var r,s=yr(e,this,i,n,(r=this.options_)==null?void 0:r.bound);return e.defineProperty_(i,s,t)}function Va(e,i){var n,t=i.name,r=i.addInitializer;return lt(e)||(e=Qe(e)),(n=this.options_)!=null&&n.bound&&r(function(){var s=this,o=s[t].bind(s);o.isMobXFlow=!0,s[t]=o}),e}function Pa(e,i,n,t){i.annotationType_,t.value}function yr(e,i,n,t,r,s){s===void 0&&(s=O.safeDescriptors),Pa(e,i,n,t);var o=t.value;if(lt(o)||(o=Qe(o)),r){var a;o=o.bind((a=e.proxy_)!=null?a:e.target_),o.isMobXFlow=!0}return{value:o,configurable:s?e.isPlainObject_:!0,enumerable:!1,writable:!s}}function xi(e,i){return{annotationType_:e,options_:i,make_:Da,extend_:ja,decorate_20223_:La}}function Da(e,i,n){return this.extend_(e,i,n,!1)===null?0:1}function ja(e,i,n,t){return Ba(e,this,i,n),e.defineComputedProperty_(i,Je({},this.options_,{get:n.get,set:n.set}),t)}function La(e,i){var n=this,t=i.name,r=i.addInitializer;return r(function(){var s=nt(this)[I],o=Je({},n.options_,{get:e,context:this});o.name||(o.name="ObservableObject."+t.toString()),s.values_.set(t,new ce(o))}),function(){return this[I].getObservablePropValue_(t)}}function Ba(e,i,n,t){i.annotationType_,t.get}function Bt(e,i){return{annotationType_:e,options_:i,make_:qa,extend_:Fa,decorate_20223_:$a}}function qa(e,i,n){return this.extend_(e,i,n,!1)===null?0:1}function Fa(e,i,n,t){var r,s;return Ua(e,this),e.defineObservableProperty_(i,n.value,(r=(s=this.options_)==null?void 0:s.enhancer)!=null?r:Ve,t)}function $a(e,i){var n=this,t=i.kind,r=i.name,s=new WeakSet;function o(a,u){var l,d,f=nt(a)[I],p=new Ee(u,(l=(d=n.options_)==null?void 0:d.enhancer)!=null?l:Ve,"ObservableObject."+r.toString(),!1);f.values_.set(r,p),s.add(a)}if(t=="accessor")return{get:function(){return s.has(this)||o(this,e.get.call(this)),this[I].getObservablePropValue_(r)},set:function(u){return s.has(this)||o(this,u),this[I].setObservablePropValue_(r,u)},init:function(u){return s.has(this)||o(this,u),u}}}function Ua(e,i,n,t){i.annotationType_}var za="true",Ga=gr();function gr(e){return{annotationType_:za,options_:e,make_:Ha,extend_:Wa,decorate_20223_:Ya}}function Ha(e,i,n,t){var r,s;if(n.get)return qt.make_(e,i,n,t);if(n.set){var o=Ze(n.set)?n.set:Pe(i.toString(),n.set);return t===e.target_?e.defineProperty_(i,{configurable:O.safeDescriptors?e.isPlainObject_:!0,set:o})===null?0:2:(he(t,i,{configurable:!0,set:o}),2)}if(t!==e.target_&&typeof n.value=="function"){var a;if(lr(n.value)){var u,l=(u=this.options_)!=null&&u.autoBind?Qe.bound:Qe;return l.make_(e,i,n,t)}var d=(a=this.options_)!=null&&a.autoBind?ut.bound:ut;return d.make_(e,i,n,t)}var f=((r=this.options_)==null?void 0:r.deep)===!1?Y.ref:Y;if(typeof n.value=="function"&&(s=this.options_)!=null&&s.autoBind){var p;n.value=n.value.bind((p=e.proxy_)!=null?p:e.target_)}return f.make_(e,i,n,t)}function Wa(e,i,n,t){var r,s;if(n.get)return qt.extend_(e,i,n,t);if(n.set)return e.defineProperty_(i,{configurable:O.safeDescriptors?e.isPlainObject_:!0,set:Pe(i.toString(),n.set)},t);if(typeof n.value=="function"&&(r=this.options_)!=null&&r.autoBind){var o;n.value=n.value.bind((o=e.proxy_)!=null?o:e.target_)}var a=((s=this.options_)==null?void 0:s.deep)===!1?Y.ref:Y;return a.extend_(e,i,n,t)}function Ya(e,i){T("'"+this.annotationType_+"' cannot be used as a decorator")}var Ka="observable",Xa="observable.ref",Ja="observable.shallow",Za="observable.struct",_r={deep:!0,name:void 0,defaultDecorator:void 0,proxy:!0};Object.freeze(_r);function gt(e){return e||_r}var ri=Bt(Ka),Qa=Bt(Xa,{enhancer:Lt}),eu=Bt(Ja,{enhancer:Aa}),tu=Bt(Za,{enhancer:Ia}),br=me(ri);function _t(e){return e.deep===!0?Ve:e.deep===!1?Lt:nu(e.defaultDecorator)}function iu(e){var i;return e?(i=e.defaultDecorator)!=null?i:gr(e):void 0}function nu(e){var i,n;return e&&(i=(n=e.options_)==null?void 0:n.enhancer)!=null?i:Ve}function xr(e,i,n){if(ft(i))return ri.decorate_20223_(e,i);if(Re(i)){pt(e,i,ri);return}return Lr(e)?e:Se(e)?Y.object(e,i,n):Array.isArray(e)?Y.array(e,i):et(e)?Y.map(e,i):_e(e)?Y.set(e,i):typeof e=="object"&&e!==null?e:Y.box(e,i)}sr(xr,br);var ru={box:function(i,n){var t=gt(n);return new Ee(i,_t(t),t.name,!0,t.equals)},array:function(i,n){var t=gt(n);return(O.useProxies===!1||t.proxy===!1?Yu:Lu)(i,_t(t),t.name)},map:function(i,n){var t=gt(n);return new qr(i,_t(t),t.name)},set:function(i,n){var t=gt(n);return new Fr(i,_t(t),t.name)},object:function(i,n,t){return qe(function(){return Dr(O.useProxies===!1||t?.proxy===!1?nt({},t):Pu({},t),i,n)})},ref:me(Qa),shallow:me(eu),deep:br,struct:me(tu)},Y=sr(xr,ru),Or="computed",su="computed.struct",si=xi(Or),ou=xi(su,{equals:It.structural}),qt=function(i,n){if(ft(n))return si.decorate_20223_(i,n);if(Re(n))return pt(i,n,si);if(Se(i))return me(xi(Or,i));var t=Se(n)?n:{};return t.get=i,t.name||(t.name=i.name||""),new ce(t)};Object.assign(qt,si);qt.struct=me(ou);var Fi,$i,wt=0,au=1,uu=(Fi=($i=At(function(){},"name"))==null?void 0:$i.configurable)!=null?Fi:!1,Ui={value:"action",configurable:!0,writable:!1,enumerable:!1};function Pe(e,i,n,t){n===void 0&&(n=!1);function r(){return lu(e,n,i,t||this,arguments)}return r.isMobxAction=!0,r.toString=function(){return i.toString()},uu&&(Ui.value=e,he(r,"name",Ui)),r}function lu(e,i,n,t,r){var s=cu(e,i);try{return n.apply(t,r)}catch(o){throw s.error_=o,o}finally{du(s)}}function cu(e,i,n,t){var r=!1,s=0,o=O.trackingDerivation,a=!i||!o;se();var u=O.allowStateChanges;a&&(Le(),u=Oi(!0));var l=Ai(!0),d={runAsAction_:a,prevDerivation_:o,prevAllowStateChanges_:u,prevAllowStateReads_:l,notifySpy_:r,startTime_:s,actionId_:au++,parentActionId_:wt};return wt=d.actionId_,d}function du(e){wt!==e.actionId_&&T(30),wt=e.parentActionId_,e.error_!==void 0&&(O.suppressReactionErrors=!0),Si(e.prevAllowStateChanges_),rt(e.prevAllowStateReads_),oe(),e.runAsAction_&&Oe(e.prevDerivation_),O.suppressReactionErrors=!1}function Oi(e){var i=O.allowStateChanges;return O.allowStateChanges=e,i}function Si(e){O.allowStateChanges=e}var Ee=(function(e){function i(t,r,s,o,a){var u;return s===void 0&&(s="ObservableValue"),a===void 0&&(a=It.default),u=e.call(this,s)||this,u.enhancer=void 0,u.name_=void 0,u.equals=void 0,u.hasUnreportedChange_=!1,u.interceptors_=void 0,u.changeListeners_=void 0,u.value_=void 0,u.dehancer=void 0,u.enhancer=r,u.name_=s,u.equals=a,u.value_=r(t,void 0,s),u}fr(i,e);var n=i.prototype;return n.dehanceValue=function(r){return this.dehancer!==void 0?this.dehancer(r):r},n.set=function(r){this.value_,r=this.prepareNewValue_(r),r!==O.UNCHANGED&&this.setNewValue_(r)},n.prepareNewValue_=function(r){if(ne(this)){var s=re(this,{object:this,type:ve,newValue:r});if(!s)return O.UNCHANGED;r=s.newValue}return r=this.enhancer(r,this.value_,this.name_),this.equals(this.value_,r)?O.UNCHANGED:r},n.setNewValue_=function(r){var s=this.value_;this.value_=r,this.reportChanged(),ae(this)&&ue(this,{type:ve,object:this,newValue:r,oldValue:s})},n.get=function(){return this.reportObserved(),this.dehanceValue(this.value_)},n.intercept_=function(r){return mt(this,r)},n.observe_=function(r,s){return s&&r({observableKind:"value",debugObjectName:this.name_,object:this,type:ve,newValue:this.value_,oldValue:void 0}),vt(this,r)},n.raw=function(){return this.value_},n.toJSON=function(){return this.get()},n.toString=function(){return this.name_+"["+this.value_+"]"},n.valueOf=function(){return pr(this.get())},n[Symbol.toPrimitive]=function(){return this.valueOf()},i})(Ne),ce=(function(){function e(n){this.dependenciesState_=C.NOT_TRACKING_,this.observing_=[],this.newObserving_=null,this.observers_=new Set,this.runId_=0,this.lastAccessedBy_=0,this.lowestObserverState_=C.UP_TO_DATE_,this.unboundDepsCount_=0,this.value_=new Mt(null),this.name_=void 0,this.triggeredBy_=void 0,this.flags_=0,this.derivation=void 0,this.setter_=void 0,this.isTracing_=kt.NONE,this.scope_=void 0,this.equals_=void 0,this.requiresReaction_=void 0,this.keepAlive_=void 0,this.onBOL=void 0,this.onBUOL=void 0,n.get||T(31),this.derivation=n.get,this.name_=n.name||"ComputedValue",n.set&&(this.setter_=Pe("ComputedValue-setter",n.set)),this.equals_=n.equals||(n.compareStructural||n.struct?It.structural:It.default),this.scope_=n.context,this.requiresReaction_=n.requiresReaction,this.keepAlive_=!!n.keepAlive}var i=e.prototype;return i.onBecomeStale_=function(){mu(this)},i.onBO=function(){this.onBOL&&this.onBOL.forEach(function(t){return t()})},i.onBUO=function(){this.onBUOL&&this.onBUOL.forEach(function(t){return t()})},i.get=function(){if(this.isComputing&&T(32,this.name_,this.derivation),O.inBatch===0&&this.observers_.size===0&&!this.keepAlive_)oi(this)&&(this.warnAboutUntrackedRead_(),se(),this.value_=this.computeValue_(!1),oe());else if(Mr(this),oi(this)){var t=O.trackingContext;this.keepAlive_&&!t&&(O.trackingContext=this),this.trackAndCompute()&&hu(this),O.trackingContext=t}var r=this.value_;if(bt(r))throw r.cause;return r},i.set=function(t){if(this.setter_){this.isRunningSetter&&T(33,this.name_),this.isRunningSetter=!0;try{this.setter_.call(this.scope_,t)}finally{this.isRunningSetter=!1}}else T(34,this.name_)},i.trackAndCompute=function(){var t=this.value_,r=this.dependenciesState_===C.NOT_TRACKING_,s=this.computeValue_(!0),o=r||bt(t)||bt(s)||!this.equals_(t,s);return o&&(this.value_=s),o},i.computeValue_=function(t){this.isComputing=!0;var r=Oi(!1),s;if(t)s=Sr(this,this.derivation,this.scope_);else if(O.disableErrorBoundaries===!0)s=this.derivation.call(this.scope_);else try{s=this.derivation.call(this.scope_)}catch(o){s=new Mt(o)}return Si(r),this.isComputing=!1,s},i.suspend_=function(){this.keepAlive_||(ai(this),this.value_=void 0)},i.observe_=function(t,r){var s=this,o=!0,a=void 0;return Iu(function(){var u=s.get();if(!o||r){var l=Le();t({observableKind:"computed",debugObjectName:s.name_,type:ve,object:s,newValue:u,oldValue:a}),Oe(l)}o=!1,a=u})},i.warnAboutUntrackedRead_=function(){},i.toString=function(){return this.name_+"["+this.derivation.toString()+"]"},i.valueOf=function(){return pr(this.get())},i[Symbol.toPrimitive]=function(){return this.valueOf()},tt(e,[{key:"isComputing",get:function(){return Q(this.flags_,e.isComputingMask_)},set:function(t){this.flags_=ee(this.flags_,e.isComputingMask_,t)}},{key:"isRunningSetter",get:function(){return Q(this.flags_,e.isRunningSetterMask_)},set:function(t){this.flags_=ee(this.flags_,e.isRunningSetterMask_,t)}},{key:"isBeingObserved",get:function(){return Q(this.flags_,e.isBeingObservedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isBeingObservedMask_,t)}},{key:"isPendingUnobservation",get:function(){return Q(this.flags_,e.isPendingUnobservationMask_)},set:function(t){this.flags_=ee(this.flags_,e.isPendingUnobservationMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();ce.isComputingMask_=1;ce.isRunningSetterMask_=2;ce.isBeingObservedMask_=4;ce.isPendingUnobservationMask_=8;ce.diffValueMask_=16;var Ft=je("ComputedValue",ce),C;(function(e){e[e.NOT_TRACKING_=-1]="NOT_TRACKING_",e[e.UP_TO_DATE_=0]="UP_TO_DATE_",e[e.POSSIBLY_STALE_=1]="POSSIBLY_STALE_",e[e.STALE_=2]="STALE_"})(C||(C={}));var kt;(function(e){e[e.NONE=0]="NONE",e[e.LOG=1]="LOG",e[e.BREAK=2]="BREAK"})(kt||(kt={}));var Mt=function(i){this.cause=void 0,this.cause=i};function bt(e){return e instanceof Mt}function oi(e){switch(e.dependenciesState_){case C.UP_TO_DATE_:return!1;case C.NOT_TRACKING_:case C.STALE_:return!0;case C.POSSIBLY_STALE_:{for(var i=Ai(!0),n=Le(),t=e.observing_,r=t.length,s=0;s<r;s++){var o=t[s];if(Ft(o)){if(O.disableErrorBoundaries)o.get();else try{o.get()}catch{return Oe(n),rt(i),!0}if(e.dependenciesState_===C.STALE_)return Oe(n),rt(i),!0}}return Ir(e),Oe(n),rt(i),!1}}}function Sr(e,i,n){var t=Ai(!0);Ir(e),e.newObserving_=new Array(e.runId_===0?100:e.observing_.length),e.unboundDepsCount_=0,e.runId_=++O.runId;var r=O.trackingDerivation;O.trackingDerivation=e,O.inBatch++;var s;if(O.disableErrorBoundaries===!0)s=i.call(n);else try{s=i.call(n)}catch(o){s=new Mt(o)}return O.inBatch--,O.trackingDerivation=r,pu(e),rt(t),s}function pu(e){for(var i=e.observing_,n=e.observing_=e.newObserving_,t=C.UP_TO_DATE_,r=0,s=e.unboundDepsCount_,o=0;o<s;o++){var a=n[o];a.diffValue===0&&(a.diffValue=1,r!==o&&(n[r]=a),r++),a.dependenciesState_>t&&(t=a.dependenciesState_)}for(n.length=r,e.newObserving_=null,s=i.length;s--;){var u=i[s];u.diffValue===0&&wr(u,e),u.diffValue=0}for(;r--;){var l=n[r];l.diffValue===1&&(l.diffValue=0,fu(l,e))}t!==C.UP_TO_DATE_&&(e.dependenciesState_=t,e.onBecomeStale_())}function ai(e){var i=e.observing_;e.observing_=[];for(var n=i.length;n--;)wr(i[n],e);e.dependenciesState_=C.NOT_TRACKING_}function Ar(e){var i=Le();try{return e()}finally{Oe(i)}}function Le(){var e=O.trackingDerivation;return O.trackingDerivation=null,e}function Oe(e){O.trackingDerivation=e}function Ai(e){var i=O.allowStateReads;return O.allowStateReads=e,i}function rt(e){O.allowStateReads=e}function Ir(e){if(e.dependenciesState_!==C.UP_TO_DATE_){e.dependenciesState_=C.UP_TO_DATE_;for(var i=e.observing_,n=i.length;n--;)i[n].lowestObserverState_=C.UP_TO_DATE_}}var Kt=function(){this.version=6,this.UNCHANGED={},this.trackingDerivation=null,this.trackingContext=null,this.runId=0,this.mobxGuid=0,this.inBatch=0,this.pendingUnobservations=[],this.pendingReactions=[],this.isRunningReactions=!1,this.allowStateChanges=!1,this.allowStateReads=!0,this.enforceActions=!0,this.spyListeners=[],this.globalReactionErrorHandlers=[],this.computedRequiresReaction=!1,this.reactionRequiresObservable=!1,this.observableRequiresReaction=!1,this.disableErrorBoundaries=!1,this.suppressReactionErrors=!1,this.useProxies=!0,this.verifyProxies=!1,this.safeDescriptors=!0},Xt=!0,O=(function(){var e=_i();return e.__mobxInstanceCount>0&&!e.__mobxGlobals&&(Xt=!1),e.__mobxGlobals&&e.__mobxGlobals.version!==new Kt().version&&(Xt=!1),Xt?e.__mobxGlobals?(e.__mobxInstanceCount+=1,e.__mobxGlobals.UNCHANGED||(e.__mobxGlobals.UNCHANGED={}),e.__mobxGlobals):(e.__mobxInstanceCount=1,e.__mobxGlobals=new Kt):(setTimeout(function(){T(35)},1),new Kt)})();function fu(e,i){e.observers_.add(i),e.lowestObserverState_>i.dependenciesState_&&(e.lowestObserverState_=i.dependenciesState_)}function wr(e,i){e.observers_.delete(i),e.observers_.size===0&&kr(e)}function kr(e){e.isPendingUnobservation===!1&&(e.isPendingUnobservation=!0,O.pendingUnobservations.push(e))}function se(){O.inBatch++}function oe(){if(--O.inBatch===0){Cr();for(var e=O.pendingUnobservations,i=0;i<e.length;i++){var n=e[i];n.isPendingUnobservation=!1,n.observers_.size===0&&(n.isBeingObserved&&(n.isBeingObserved=!1,n.onBUO()),n instanceof ce&&n.suspend_())}O.pendingUnobservations=[]}}function Mr(e){var i=O.trackingDerivation;return i!==null?(i.runId_!==e.lastAccessedBy_&&(e.lastAccessedBy_=i.runId_,i.newObserving_[i.unboundDepsCount_++]=e,!e.isBeingObserved&&O.trackingContext&&(e.isBeingObserved=!0,e.onBO())),e.isBeingObserved):(e.observers_.size===0&&O.inBatch>0&&kr(e),!1)}function Nr(e){e.lowestObserverState_!==C.STALE_&&(e.lowestObserverState_=C.STALE_,e.observers_.forEach(function(i){i.dependenciesState_===C.UP_TO_DATE_&&i.onBecomeStale_(),i.dependenciesState_=C.STALE_}))}function hu(e){e.lowestObserverState_!==C.STALE_&&(e.lowestObserverState_=C.STALE_,e.observers_.forEach(function(i){i.dependenciesState_===C.POSSIBLY_STALE_?i.dependenciesState_=C.STALE_:i.dependenciesState_===C.UP_TO_DATE_&&(e.lowestObserverState_=C.UP_TO_DATE_)}))}function mu(e){e.lowestObserverState_===C.UP_TO_DATE_&&(e.lowestObserverState_=C.POSSIBLY_STALE_,e.observers_.forEach(function(i){i.dependenciesState_===C.UP_TO_DATE_&&(i.dependenciesState_=C.POSSIBLY_STALE_,i.onBecomeStale_())}))}var Me=(function(){function e(n,t,r,s){n===void 0&&(n="Reaction"),this.name_=void 0,this.onInvalidate_=void 0,this.errorHandler_=void 0,this.requiresObservable_=void 0,this.observing_=[],this.newObserving_=[],this.dependenciesState_=C.NOT_TRACKING_,this.runId_=0,this.unboundDepsCount_=0,this.flags_=0,this.isTracing_=kt.NONE,this.name_=n,this.onInvalidate_=t,this.errorHandler_=r,this.requiresObservable_=s}var i=e.prototype;return i.onBecomeStale_=function(){this.schedule_()},i.schedule_=function(){this.isScheduled||(this.isScheduled=!0,O.pendingReactions.push(this),Cr())},i.runReaction_=function(){if(!this.isDisposed){se(),this.isScheduled=!1;var t=O.trackingContext;if(O.trackingContext=this,oi(this)){this.isTrackPending=!0;try{this.onInvalidate_()}catch(r){this.reportExceptionInDerivation_(r)}}O.trackingContext=t,oe()}},i.track=function(t){if(!this.isDisposed){se(),this.isRunning=!0;var r=O.trackingContext;O.trackingContext=this;var s=Sr(this,t,void 0);O.trackingContext=r,this.isRunning=!1,this.isTrackPending=!1,this.isDisposed&&ai(this),bt(s)&&this.reportExceptionInDerivation_(s.cause),oe()}},i.reportExceptionInDerivation_=function(t){var r=this;if(this.errorHandler_){this.errorHandler_(t,this);return}if(O.disableErrorBoundaries)throw t;var s="[mobx] uncaught error in '"+this+"'";O.suppressReactionErrors||console.error(s,t),O.globalReactionErrorHandlers.forEach(function(o){return o(t,r)})},i.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.isRunning||(se(),ai(this),oe()))},i.getDisposer_=function(t){var r=this,s=function o(){r.dispose(),t==null||t.removeEventListener==null||t.removeEventListener("abort",o)};return t==null||t.addEventListener==null||t.addEventListener("abort",s),s[I]=this,"dispose"in Symbol&&typeof Symbol.dispose=="symbol"&&(s[Symbol.dispose]=s),s},i.toString=function(){return"Reaction["+this.name_+"]"},i.trace=function(t){},tt(e,[{key:"isDisposed",get:function(){return Q(this.flags_,e.isDisposedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isDisposedMask_,t)}},{key:"isScheduled",get:function(){return Q(this.flags_,e.isScheduledMask_)},set:function(t){this.flags_=ee(this.flags_,e.isScheduledMask_,t)}},{key:"isTrackPending",get:function(){return Q(this.flags_,e.isTrackPendingMask_)},set:function(t){this.flags_=ee(this.flags_,e.isTrackPendingMask_,t)}},{key:"isRunning",get:function(){return Q(this.flags_,e.isRunningMask_)},set:function(t){this.flags_=ee(this.flags_,e.isRunningMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();Me.isDisposedMask_=1;Me.isScheduledMask_=2;Me.isTrackPendingMask_=4;Me.isRunningMask_=8;Me.diffValueMask_=16;var vu=100,yu=function(i){return i()};function Cr(){O.inBatch>0||O.isRunningReactions||yu(gu)}function gu(){O.isRunningReactions=!0;for(var e=O.pendingReactions,i=0;e.length>0;){++i===vu&&(console.error("[mobx] cycle in reaction: "+e[0]),e.splice(0));for(var n=e.splice(0),t=0,r=n.length;t<r;t++)n[t].runReaction_()}O.isRunningReactions=!1}var Nt=je("Reaction",Me);function st(){return!1}function _u(e){return console.warn("[mobx.spy] Is a no-op in production builds"),function(){}}var Tr="action",bu="action.bound",Er="autoAction",xu="autoAction.bound",Ou="<unnamed action>",ui=ht(Tr),Su=ht(bu,{bound:!0}),li=ht(Er,{autoAction:!0}),Au=ht(xu,{autoAction:!0,bound:!0});function Rr(e){var i=function(t,r){if(le(t))return Pe(t.name||Ou,t,e);if(le(r))return Pe(t,r,e);if(ft(r))return(e?li:ui).decorate_20223_(t,r);if(Re(r))return pt(t,r,e?li:ui);if(Re(t))return me(ht(e?Er:Tr,{name:t,autoAction:e}))};return i}var He=Rr(!1);Object.assign(He,ui);var ut=Rr(!0);Object.assign(ut,li);He.bound=me(Su);ut.bound=me(Au);function Ze(e){return le(e)&&e.isMobxAction===!0}function Iu(e,i){var n,t,r,s;i===void 0&&(i=or);var o=(n=(t=i)==null?void 0:t.name)!=null?n:"Autorun",a=!i.scheduler&&!i.delay,u;if(a)u=new Me(o,function(){this.track(f)},i.onError,i.requiresObservable);else{var l=ku(i),d=!1;u=new Me(o,function(){d||(d=!0,l(function(){d=!1,u.isDisposed||u.track(f)}))},i.onError,i.requiresObservable)}function f(){e(u)}return(r=i)!=null&&(r=r.signal)!=null&&r.aborted||u.schedule_(),u.getDisposer_((s=i)==null?void 0:s.signal)}var wu=function(i){return i()};function ku(e){return e.scheduler?e.scheduler:e.delay?function(i){return setTimeout(i,e.delay)}:wu}var Mu="onBO",Nu="onBUO";function Cu(e,i,n){return Pr(Mu,e,i,n)}function Vr(e,i,n){return Pr(Nu,e,i,n)}function Pr(e,i,n,t){var r=ci(i),s=le(t)?t:n,o=e+"L";return r[o]?r[o].add(s):r[o]=new Set([s]),function(){var a=r[o];a&&(a.delete(s),a.size===0&&delete r[o])}}function Dr(e,i,n,t){var r=ya(i);return qe(function(){var s=nt(e,t)[I];at(r).forEach(function(o){s.extend_(o,r[o],n&&o in n?n[o]:!0)})}),e}var Tu=0;function jr(){this.message="FLOW_CANCELLED"}jr.prototype=Object.create(Error.prototype);var Jt=vr("flow"),Eu=vr("flow.bound",{bound:!0}),Qe=Object.assign(function(i,n){if(ft(n))return Jt.decorate_20223_(i,n);if(Re(n))return pt(i,n,Jt);var t=i,r=t.name||"<unnamed flow>",s=function(){var a=this,u=arguments,l=++Tu,d=He(r+" - runid: "+l+" - init",t).apply(a,u),f,p=void 0,h=new Promise(function(m,g){var y=0;f=g;function b(A){p=void 0;var E;try{E=He(r+" - runid: "+l+" - yield "+y++,d.next).call(d,A)}catch(N){return g(N)}S(E)}function _(A){p=void 0;var E;try{E=He(r+" - runid: "+l+" - yield "+y++,d.throw).call(d,A)}catch(N){return g(N)}S(E)}function S(A){if(le(A?.then)){A.then(S,g);return}return A.done?m(A.value):(p=Promise.resolve(A.value),p.then(b,_))}b(void 0)});return h.cancel=He(r+" - runid: "+l+" - cancel",function(){try{p&&zi(p);var m=d.return(void 0),g=Promise.resolve(m.value);g.then(Ue,Ue),zi(g),f(new jr)}catch(y){f(y)}}),h};return s.isMobXFlow=!0,s},Jt);Qe.bound=me(Eu);function zi(e){le(e.cancel)&&e.cancel()}function lt(e){return e?.isMobXFlow===!0}function Ru(e,i){return e?Ut(e)||!!e[I]||bi(e)||Nt(e)||Ft(e):!1}function Lr(e){return Ru(e)}function be(e,i){i===void 0&&(i=void 0),se();try{return e.apply(i)}finally{oe()}}function $e(e){return e[I]}var Vu={has:function(i,n){return $e(i).has_(n)},get:function(i,n){return $e(i).get_(n)},set:function(i,n,t){var r;return Re(n)?(r=$e(i).set_(n,t,!0))!=null?r:!0:!1},deleteProperty:function(i,n){var t;return Re(n)?(t=$e(i).delete_(n,!0))!=null?t:!0:!1},defineProperty:function(i,n,t){var r;return(r=$e(i).defineProperty_(n,t))!=null?r:!0},ownKeys:function(i){return $e(i).ownKeys_()},preventExtensions:function(i){T(13)}};function Pu(e,i){var n,t;return ar(),e=nt(e,i),(t=(n=e[I]).proxy_)!=null?t:n.proxy_=new Proxy(e,Vu)}function ne(e){return e.interceptors_!==void 0&&e.interceptors_.length>0}function mt(e,i){var n=e.interceptors_||(e.interceptors_=[]);return n.push(i),ur(function(){var t=n.indexOf(i);t!==-1&&n.splice(t,1)})}function re(e,i){var n=Le();try{for(var t=[].concat(e.interceptors_||[]),r=0,s=t.length;r<s&&(i=t[r](i),i&&!i.type&&T(14),!!i);r++);return i}finally{Oe(n)}}function ae(e){return e.changeListeners_!==void 0&&e.changeListeners_.length>0}function vt(e,i){var n=e.changeListeners_||(e.changeListeners_=[]);return n.push(i),ur(function(){var t=n.indexOf(i);t!==-1&&n.splice(t,1)})}function ue(e,i){var n=Le(),t=e.changeListeners_;if(t){t=t.slice();for(var r=0,s=t.length;r<s;r++)t[r](i);Oe(n)}}var Zt=Symbol("mobx-keys");function it(e,i,n){return Se(e)?Dr(e,e,i,n):(qe(function(){var t=nt(e,n)[I];if(!e[Zt]){var r=Object.getPrototypeOf(e),s=new Set([].concat(at(e),at(r)));s.delete("constructor"),s.delete(I),jt(r,Zt,s)}e[Zt].forEach(function(o){return t.make_(o,i&&o in i?i[o]:!0)})}),e)}var Gi="splice",ve="update",Du=1e4,ju={get:function(i,n){var t=i[I];return n===I?t:n==="length"?t.getArrayLength_():typeof n=="string"&&!isNaN(n)?t.get_(parseInt(n)):ke(Ct,n)?Ct[n]:i[n]},set:function(i,n,t){var r=i[I];return n==="length"&&r.setArrayLength_(t),typeof n=="symbol"||isNaN(n)?i[n]=t:r.set_(parseInt(n),t),!0},preventExtensions:function(){T(15)}},Ii=(function(){function e(n,t,r,s){n===void 0&&(n="ObservableArray"),this.owned_=void 0,this.legacyMode_=void 0,this.atom_=void 0,this.values_=[],this.interceptors_=void 0,this.changeListeners_=void 0,this.enhancer_=void 0,this.dehancer=void 0,this.proxy_=void 0,this.lastKnownLength_=0,this.owned_=r,this.legacyMode_=s,this.atom_=new Ne(n),this.enhancer_=function(o,a){return t(o,a,"ObservableArray[..]")}}var i=e.prototype;return i.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},i.dehanceValues_=function(t){return this.dehancer!==void 0&&t.length>0?t.map(this.dehancer):t},i.intercept_=function(t){return mt(this,t)},i.observe_=function(t,r){return r===void 0&&(r=!1),r&&t({observableKind:"array",object:this.proxy_,debugObjectName:this.atom_.name_,type:"splice",index:0,added:this.values_.slice(),addedCount:this.values_.length,removed:[],removedCount:0}),vt(this,t)},i.getArrayLength_=function(){return this.atom_.reportObserved(),this.values_.length},i.setArrayLength_=function(t){(typeof t!="number"||isNaN(t)||t<0)&&T("Out of range: "+t);var r=this.values_.length;if(t!==r)if(t>r){for(var s=new Array(t-r),o=0;o<t-r;o++)s[o]=void 0;this.spliceWithArray_(r,0,s)}else this.spliceWithArray_(t,r-t)},i.updateArrayLength_=function(t,r){t!==this.lastKnownLength_&&T(16),this.lastKnownLength_+=r,this.legacyMode_&&r>0&&Gr(t+r+1)},i.spliceWithArray_=function(t,r,s){var o=this;this.atom_;var a=this.values_.length;if(t===void 0?t=0:t>a?t=a:t<0&&(t=Math.max(0,a+t)),arguments.length===1?r=a-t:r==null?r=0:r=Math.max(0,Math.min(r,a-t)),s===void 0&&(s=ii),ne(this)){var u=re(this,{object:this.proxy_,type:Gi,index:t,removedCount:r,added:s});if(!u)return ii;r=u.removedCount,s=u.added}if(s=s.length===0?s:s.map(function(f){return o.enhancer_(f,void 0)}),this.legacyMode_){var l=s.length-r;this.updateArrayLength_(a,l)}var d=this.spliceItemsIntoValues_(t,r,s);return(r!==0||s.length!==0)&&this.notifyArraySplice_(t,s,d),this.dehanceValues_(d)},i.spliceItemsIntoValues_=function(t,r,s){if(s.length<Du){var o;return(o=this.values_).splice.apply(o,[t,r].concat(s))}else{var a=this.values_.slice(t,t+r),u=this.values_.slice(t+r);this.values_.length+=s.length-r;for(var l=0;l<s.length;l++)this.values_[t+l]=s[l];for(var d=0;d<u.length;d++)this.values_[t+s.length+d]=u[d];return a}},i.notifyArrayChildUpdate_=function(t,r,s){var o=!this.owned_&&st(),a=ae(this),u=a||o?{observableKind:"array",object:this.proxy_,type:ve,debugObjectName:this.atom_.name_,index:t,newValue:r,oldValue:s}:null;this.atom_.reportChanged(),a&&ue(this,u)},i.notifyArraySplice_=function(t,r,s){var o=!this.owned_&&st(),a=ae(this),u=a||o?{observableKind:"array",object:this.proxy_,debugObjectName:this.atom_.name_,type:Gi,index:t,removed:s,added:r,removedCount:s.length,addedCount:r.length}:null;this.atom_.reportChanged(),a&&ue(this,u)},i.get_=function(t){if(this.legacyMode_&&t>=this.values_.length){console.warn("[mobx] Out of bounds read: "+t);return}return this.atom_.reportObserved(),this.dehanceValue_(this.values_[t])},i.set_=function(t,r){var s=this.values_;if(this.legacyMode_&&t>s.length&&T(17,t,s.length),t<s.length){this.atom_;var o=s[t];if(ne(this)){var a=re(this,{type:ve,object:this.proxy_,index:t,newValue:r});if(!a)return;r=a.newValue}r=this.enhancer_(r,o);var u=r!==o;u&&(s[t]=r,this.notifyArrayChildUpdate_(t,r,o))}else{for(var l=new Array(t+1-s.length),d=0;d<l.length-1;d++)l[d]=void 0;l[l.length-1]=r,this.spliceWithArray_(s.length,0,l)}},e})();function Lu(e,i,n,t){return n===void 0&&(n="ObservableArray"),t===void 0&&(t=!1),ar(),qe(function(){var r=new Ii(n,i,t,!1);cr(r.values_,I,r);var s=new Proxy(r.values_,ju);return r.proxy_=s,e&&e.length&&r.spliceWithArray_(0,0,e),s})}var Ct={clear:function(){return this.splice(0)},replace:function(i){var n=this[I];return n.spliceWithArray_(0,n.values_.length,i)},toJSON:function(){return this.slice()},splice:function(i,n){for(var t=arguments.length,r=new Array(t>2?t-2:0),s=2;s<t;s++)r[s-2]=arguments[s];var o=this[I];switch(arguments.length){case 0:return[];case 1:return o.spliceWithArray_(i);case 2:return o.spliceWithArray_(i,n)}return o.spliceWithArray_(i,n,r)},spliceWithArray:function(i,n,t){return this[I].spliceWithArray_(i,n,t)},push:function(){for(var i=this[I],n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return i.spliceWithArray_(i.values_.length,0,t),i.values_.length},pop:function(){return this.splice(Math.max(this[I].values_.length-1,0),1)[0]},shift:function(){return this.splice(0,1)[0]},unshift:function(){for(var i=this[I],n=arguments.length,t=new Array(n),r=0;r<n;r++)t[r]=arguments[r];return i.spliceWithArray_(0,0,t),i.values_.length},reverse:function(){return O.trackingDerivation&&T(37,"reverse"),this.replace(this.slice().reverse()),this},sort:function(){O.trackingDerivation&&T(37,"sort");var i=this.slice();return i.sort.apply(i,arguments),this.replace(i),this},remove:function(i){var n=this[I],t=n.dehanceValues_(n.values_).indexOf(i);return t>-1?(this.splice(t,1),!0):!1}};j("at",ie);j("concat",ie);j("flat",ie);j("includes",ie);j("indexOf",ie);j("join",ie);j("lastIndexOf",ie);j("slice",ie);j("toString",ie);j("toLocaleString",ie);j("toSorted",ie);j("toSpliced",ie);j("with",ie);j("every",de);j("filter",de);j("find",de);j("findIndex",de);j("findLast",de);j("findLastIndex",de);j("flatMap",de);j("forEach",de);j("map",de);j("some",de);j("toReversed",de);j("reduce",Br);j("reduceRight",Br);function j(e,i){typeof Array.prototype[e]=="function"&&(Ct[e]=i(e))}function ie(e){return function(){var i=this[I];i.atom_.reportObserved();var n=i.dehanceValues_(i.values_);return n[e].apply(n,arguments)}}function de(e){return function(i,n){var t=this,r=this[I];r.atom_.reportObserved();var s=r.dehanceValues_(r.values_);return s[e](function(o,a){return i.call(n,o,a,t)})}}function Br(e){return function(){var i=this,n=this[I];n.atom_.reportObserved();var t=n.dehanceValues_(n.values_),r=arguments[0];return arguments[0]=function(s,o,a){return r(s,o,a,i)},t[e].apply(t,arguments)}}var Bu=je("ObservableArrayAdministration",Ii);function $t(e){return Dt(e)&&Bu(e[I])}var qu={},we="add",Tt="delete",qr=(function(){function e(n,t,r){var s=this;t===void 0&&(t=Ve),r===void 0&&(r="ObservableMap"),this.enhancer_=void 0,this.name_=void 0,this[I]=qu,this.data_=void 0,this.hasMap_=void 0,this.keysAtom_=void 0,this.interceptors_=void 0,this.changeListeners_=void 0,this.dehancer=void 0,this.enhancer_=t,this.name_=r,le(Map)||T(18),qe(function(){s.keysAtom_=hr("ObservableMap.keys()"),s.data_=new Map,s.hasMap_=new Map,n&&s.merge(n)})}var i=e.prototype;return i.has_=function(t){return this.data_.has(t)},i.has=function(t){var r=this;if(!O.trackingDerivation)return this.has_(t);var s=this.hasMap_.get(t);if(!s){var o=s=new Ee(this.has_(t),Lt,"ObservableMap.key?",!1);this.hasMap_.set(t,o),Vr(o,function(){return r.hasMap_.delete(t)})}return s.get()},i.set=function(t,r){var s=this.has_(t);if(ne(this)){var o=re(this,{type:s?ve:we,object:this,newValue:r,name:t});if(!o)return this;r=o.newValue}return s?this.updateValue_(t,r):this.addValue_(t,r),this},i.delete=function(t){var r=this;if(this.keysAtom_,ne(this)){var s=re(this,{type:Tt,object:this,name:t});if(!s)return!1}if(this.has_(t)){var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:Tt,object:this,oldValue:this.data_.get(t).value_,name:t}:null;return be(function(){var l;r.keysAtom_.reportChanged(),(l=r.hasMap_.get(t))==null||l.setNewValue_(!1);var d=r.data_.get(t);d.setNewValue_(void 0),r.data_.delete(t)}),a&&ue(this,u),!0}return!1},i.updateValue_=function(t,r){var s=this.data_.get(t);if(r=s.prepareNewValue_(r),r!==O.UNCHANGED){var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:ve,object:this,oldValue:s.value_,name:t,newValue:r}:null;s.setNewValue_(r),a&&ue(this,u)}},i.addValue_=function(t,r){var s=this;this.keysAtom_,be(function(){var l,d=new Ee(r,s.enhancer_,"ObservableMap.key",!1);s.data_.set(t,d),r=d.value_,(l=s.hasMap_.get(t))==null||l.setNewValue_(!0),s.keysAtom_.reportChanged()});var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:we,object:this,name:t,newValue:r}:null;a&&ue(this,u)},i.get=function(t){return this.has(t)?this.dehanceValue_(this.data_.get(t).get()):this.dehanceValue_(void 0)},i.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},i.keys=function(){return this.keysAtom_.reportObserved(),this.data_.keys()},i.values=function(){var t=this,r=this.keys();return Hi({next:function(){var o=r.next(),a=o.done,u=o.value;return{done:a,value:a?void 0:t.get(u)}}})},i.entries=function(){var t=this,r=this.keys();return Hi({next:function(){var o=r.next(),a=o.done,u=o.value;return{done:a,value:a?void 0:[u,t.get(u)]}}})},i[Symbol.iterator]=function(){return this.entries()},i.forEach=function(t,r){for(var s=ze(this),o;!(o=s()).done;){var a=o.value,u=a[0],l=a[1];t.call(r,l,u,this)}},i.merge=function(t){var r=this;return Be(t)&&(t=new Map(t)),be(function(){Se(t)?va(t).forEach(function(s){return r.set(s,t[s])}):Array.isArray(t)?t.forEach(function(s){var o=s[0],a=s[1];return r.set(o,a)}):et(t)?(ma(t)||T(19,t),t.forEach(function(s,o){return r.set(o,s)})):t!=null&&T(20,t)}),this},i.clear=function(){var t=this;be(function(){Ar(function(){for(var r=ze(t.keys()),s;!(s=r()).done;){var o=s.value;t.delete(o)}})})},i.replace=function(t){var r=this;return be(function(){for(var s=Fu(t),o=new Map,a=!1,u=ze(r.data_.keys()),l;!(l=u()).done;){var d=l.value;if(!s.has(d)){var f=r.delete(d);if(f)a=!0;else{var p=r.data_.get(d);o.set(d,p)}}}for(var h=ze(s.entries()),m;!(m=h()).done;){var g=m.value,y=g[0],b=g[1],_=r.data_.has(y);if(r.set(y,b),r.data_.has(y)){var S=r.data_.get(y);o.set(y,S),_||(a=!0)}}if(!a)if(r.data_.size!==o.size)r.keysAtom_.reportChanged();else for(var A=r.data_.keys(),E=o.keys(),N=A.next(),w=E.next();!N.done;){if(N.value!==w.value){r.keysAtom_.reportChanged();break}N=A.next(),w=E.next()}r.data_=o}),this},i.toString=function(){return"[object ObservableMap]"},i.toJSON=function(){return Array.from(this)},i.observe_=function(t,r){return vt(this,t)},i.intercept_=function(t){return mt(this,t)},tt(e,[{key:"size",get:function(){return this.keysAtom_.reportObserved(),this.data_.size}},{key:Symbol.toStringTag,get:function(){return"Map"}}])})(),Be=je("ObservableMap",qr);function Hi(e){return e[Symbol.toStringTag]="MapIterator",ki(e)}function Fu(e){if(et(e)||Be(e))return e;if(Array.isArray(e))return new Map(e);if(Se(e)){var i=new Map;for(var n in e)i.set(n,e[n]);return i}else return T(21,e)}var $u={},Fr=(function(){function e(n,t,r){var s=this;t===void 0&&(t=Ve),r===void 0&&(r="ObservableSet"),this.name_=void 0,this[I]=$u,this.data_=new Set,this.atom_=void 0,this.changeListeners_=void 0,this.interceptors_=void 0,this.dehancer=void 0,this.enhancer_=void 0,this.name_=r,le(Set)||T(22),this.enhancer_=function(o,a){return t(o,a,r)},qe(function(){s.atom_=hr(s.name_),n&&s.replace(n)})}var i=e.prototype;return i.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},i.clear=function(){var t=this;be(function(){Ar(function(){for(var r=ze(t.data_.values()),s;!(s=r()).done;){var o=s.value;t.delete(o)}})})},i.forEach=function(t,r){for(var s=ze(this),o;!(o=s()).done;){var a=o.value;t.call(r,a,a,this)}},i.add=function(t){var r=this;if(this.atom_,ne(this)){var s=re(this,{type:we,object:this,newValue:t});if(!s)return this;t=s.newValue}if(!this.has(t)){be(function(){r.data_.add(r.enhancer_(t,void 0)),r.atom_.reportChanged()});var o=!1,a=ae(this),u=a||o?{observableKind:"set",debugObjectName:this.name_,type:we,object:this,newValue:t}:null;a&&ue(this,u)}return this},i.delete=function(t){var r=this;if(ne(this)){var s=re(this,{type:Tt,object:this,oldValue:t});if(!s)return!1}if(this.has(t)){var o=!1,a=ae(this),u=a||o?{observableKind:"set",debugObjectName:this.name_,type:Tt,object:this,oldValue:t}:null;return be(function(){r.atom_.reportChanged(),r.data_.delete(t)}),a&&ue(this,u),!0}return!1},i.has=function(t){return this.atom_.reportObserved(),this.data_.has(this.dehanceValue_(t))},i.entries=function(){var t=this.values();return Wi({next:function(){var s=t.next(),o=s.value,a=s.done;return a?{value:void 0,done:a}:{value:[o,o],done:a}}})},i.keys=function(){return this.values()},i.values=function(){this.atom_.reportObserved();var t=this,r=this.data_.values();return Wi({next:function(){var o=r.next(),a=o.value,u=o.done;return u?{value:void 0,done:u}:{value:t.dehanceValue_(a),done:u}}})},i.intersection=function(t){if(_e(t)&&!fe(t))return t.intersection(this);var r=new Set(this);return r.intersection(t)},i.union=function(t){if(_e(t)&&!fe(t))return t.union(this);var r=new Set(this);return r.union(t)},i.difference=function(t){return new Set(this).difference(t)},i.symmetricDifference=function(t){if(_e(t)&&!fe(t))return t.symmetricDifference(this);var r=new Set(this);return r.symmetricDifference(t)},i.isSubsetOf=function(t){return new Set(this).isSubsetOf(t)},i.isSupersetOf=function(t){return new Set(this).isSupersetOf(t)},i.isDisjointFrom=function(t){if(_e(t)&&!fe(t))return t.isDisjointFrom(this);var r=new Set(this);return r.isDisjointFrom(t)},i.replace=function(t){var r=this;return fe(t)&&(t=new Set(t)),be(function(){Array.isArray(t)?(r.clear(),t.forEach(function(s){return r.add(s)})):_e(t)?(r.clear(),t.forEach(function(s){return r.add(s)})):t!=null&&T("Cannot initialize set from "+t)}),this},i.observe_=function(t,r){return vt(this,t)},i.intercept_=function(t){return mt(this,t)},i.toJSON=function(){return Array.from(this)},i.toString=function(){return"[object ObservableSet]"},i[Symbol.iterator]=function(){return this.values()},tt(e,[{key:"size",get:function(){return this.atom_.reportObserved(),this.data_.size}},{key:Symbol.toStringTag,get:function(){return"Set"}}])})(),fe=je("ObservableSet",Fr);function Wi(e){return e[Symbol.toStringTag]="SetIterator",ki(e)}var Yi=Object.create(null),Ki="remove",$r=(function(){function e(n,t,r,s){t===void 0&&(t=new Map),s===void 0&&(s=Ga),this.target_=void 0,this.values_=void 0,this.name_=void 0,this.defaultAnnotation_=void 0,this.keysAtom_=void 0,this.changeListeners_=void 0,this.interceptors_=void 0,this.proxy_=void 0,this.isPlainObject_=void 0,this.appliedAnnotations_=void 0,this.pendingKeys_=void 0,this.target_=n,this.values_=t,this.name_=r,this.defaultAnnotation_=s,this.keysAtom_=new Ne("ObservableObject.keys"),this.isPlainObject_=Se(this.target_)}var i=e.prototype;return i.getObservablePropValue_=function(t){return this.values_.get(t).get()},i.setObservablePropValue_=function(t,r){var s=this.values_.get(t);if(s instanceof ce)return s.set(r),!0;if(ne(this)){var o=re(this,{type:ve,object:this.proxy_||this.target_,name:t,newValue:r});if(!o)return null;r=o.newValue}if(r=s.prepareNewValue_(r),r!==O.UNCHANGED){var a=ae(this),u=!1,l=a||u?{type:ve,observableKind:"object",debugObjectName:this.name_,object:this.proxy_||this.target_,oldValue:s.value_,name:t,newValue:r}:null;s.setNewValue_(r),a&&ue(this,l)}return!0},i.get_=function(t){return O.trackingDerivation&&!ke(this.target_,t)&&this.has_(t),this.target_[t]},i.set_=function(t,r,s){return s===void 0&&(s=!1),ke(this.target_,t)?this.values_.has(t)?this.setObservablePropValue_(t,r):s?Reflect.set(this.target_,t,r):(this.target_[t]=r,!0):this.extend_(t,{value:r,enumerable:!0,writable:!0,configurable:!0},this.defaultAnnotation_,s)},i.has_=function(t){if(!O.trackingDerivation)return t in this.target_;this.pendingKeys_||(this.pendingKeys_=new Map);var r=this.pendingKeys_.get(t);return r||(r=new Ee(t in this.target_,Lt,"ObservableObject.key?",!1),this.pendingKeys_.set(t,r)),r.get()},i.make_=function(t,r){if(r===!0&&(r=this.defaultAnnotation_),r!==!1){if(!(t in this.target_)){var s;if((s=this.target_[Ge])!=null&&s[t])return;T(1,r.annotationType_,this.name_+"."+t.toString())}for(var o=this.target_;o&&o!==Pt;){var a=At(o,t);if(a){var u=r.make_(this,t,a,o);if(u===0)return;if(u===1)break}o=Object.getPrototypeOf(o)}Ji(this,r,t)}},i.extend_=function(t,r,s,o){if(o===void 0&&(o=!1),s===!0&&(s=this.defaultAnnotation_),s===!1)return this.defineProperty_(t,r,o);var a=s.extend_(this,t,r,o);return a&&Ji(this,s,t),a},i.defineProperty_=function(t,r,s){s===void 0&&(s=!1),this.keysAtom_;try{se();var o=this.delete_(t);if(!o)return o;if(ne(this)){var a=re(this,{object:this.proxy_||this.target_,name:t,type:we,newValue:r.value});if(!a)return null;var u=a.newValue;r.value!==u&&(r=Je({},r,{value:u}))}if(s){if(!Reflect.defineProperty(this.target_,t,r))return!1}else he(this.target_,t,r);this.notifyPropertyAddition_(t,r.value)}finally{oe()}return!0},i.defineObservableProperty_=function(t,r,s,o){o===void 0&&(o=!1),this.keysAtom_;try{se();var a=this.delete_(t);if(!a)return a;if(ne(this)){var u=re(this,{object:this.proxy_||this.target_,name:t,type:we,newValue:r});if(!u)return null;r=u.newValue}var l=Xi(t),d={configurable:O.safeDescriptors?this.isPlainObject_:!0,enumerable:!0,get:l.get,set:l.set};if(o){if(!Reflect.defineProperty(this.target_,t,d))return!1}else he(this.target_,t,d);var f=new Ee(r,s,"ObservableObject.key",!1);this.values_.set(t,f),this.notifyPropertyAddition_(t,f.value_)}finally{oe()}return!0},i.defineComputedProperty_=function(t,r,s){s===void 0&&(s=!1),this.keysAtom_;try{se();var o=this.delete_(t);if(!o)return o;if(ne(this)){var a=re(this,{object:this.proxy_||this.target_,name:t,type:we,newValue:void 0});if(!a)return null}r.name||(r.name="ObservableObject.key"),r.context=this.proxy_||this.target_;var u=Xi(t),l={configurable:O.safeDescriptors?this.isPlainObject_:!0,enumerable:!1,get:u.get,set:u.set};if(s){if(!Reflect.defineProperty(this.target_,t,l))return!1}else he(this.target_,t,l);this.values_.set(t,new ce(r)),this.notifyPropertyAddition_(t,void 0)}finally{oe()}return!0},i.delete_=function(t,r){if(r===void 0&&(r=!1),this.keysAtom_,!ke(this.target_,t))return!0;if(ne(this)){var s=re(this,{object:this.proxy_||this.target_,name:t,type:Ki});if(!s)return null}try{var o;se();var a=ae(this),u=!1,l=this.values_.get(t),d=void 0;if(!l&&(a||u)){var f;d=(f=At(this.target_,t))==null?void 0:f.value}if(r){if(!Reflect.deleteProperty(this.target_,t))return!1}else delete this.target_[t];if(l&&(this.values_.delete(t),l instanceof Ee&&(d=l.value_),Nr(l)),this.keysAtom_.reportChanged(),(o=this.pendingKeys_)==null||(o=o.get(t))==null||o.set(t in this.target_),a||u){var p={type:Ki,observableKind:"object",object:this.proxy_||this.target_,debugObjectName:this.name_,oldValue:d,name:t};a&&ue(this,p)}}finally{oe()}return!0},i.observe_=function(t,r){return vt(this,t)},i.intercept_=function(t){return mt(this,t)},i.notifyPropertyAddition_=function(t,r){var s,o=ae(this),a=!1;if(o||a){var u=o||a?{type:we,observableKind:"object",debugObjectName:this.name_,object:this.proxy_||this.target_,name:t,newValue:r}:null;o&&ue(this,u)}(s=this.pendingKeys_)==null||(s=s.get(t))==null||s.set(!0),this.keysAtom_.reportChanged()},i.ownKeys_=function(){return this.keysAtom_.reportObserved(),at(this.target_)},i.keys_=function(){return this.keysAtom_.reportObserved(),Object.keys(this.target_)},e})();function nt(e,i){var n;if(ke(e,I))return e;var t=(n=i?.name)!=null?n:"ObservableObject",r=new $r(e,new Map,String(t),iu(i));return jt(e,I,r),e}var Uu=je("ObservableObjectAdministration",$r);function Xi(e){return Yi[e]||(Yi[e]={get:function(){return this[I].getObservablePropValue_(e)},set:function(n){return this[I].setObservablePropValue_(e,n)}})}function Ut(e){return Dt(e)?Uu(e[I]):!1}function Ji(e,i,n){var t;(t=e.target_[Ge])==null||delete t[n]}var zu=zr(0),Gu=(function(){var e=!1,i={};return Object.defineProperty(i,"0",{set:function(){e=!0}}),Object.create(i)[0]=1,e===!1})(),Qt=0,Ur=function(){};function Hu(e,i){Object.setPrototypeOf?Object.setPrototypeOf(e.prototype,i):e.prototype.__proto__!==void 0?e.prototype.__proto__=i:e.prototype=i}Hu(Ur,Array.prototype);var wi=(function(e){function i(t,r,s,o){var a;return s===void 0&&(s="ObservableArray"),o===void 0&&(o=!1),a=e.call(this)||this,qe(function(){var u=new Ii(s,r,o,!0);u.proxy_=a,cr(a,I,u),t&&t.length&&a.spliceWithArray(0,0,t),Gu&&Object.defineProperty(a,"0",zu)}),a}fr(i,e);var n=i.prototype;return n.concat=function(){this[I].atom_.reportObserved();for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return Array.prototype.concat.apply(this.slice(),s.map(function(a){return $t(a)?a.slice():a}))},n[Symbol.iterator]=function(){var t=this,r=0;return ki({next:function(){return r<t.length?{value:t[r++],done:!1}:{done:!0,value:void 0}}})},tt(i,[{key:"length",get:function(){return this[I].getArrayLength_()},set:function(r){this[I].setArrayLength_(r)}},{key:Symbol.toStringTag,get:function(){return"Array"}}])})(Ur);Object.entries(Ct).forEach(function(e){var i=e[0],n=e[1];i!=="concat"&&jt(wi.prototype,i,n)});function zr(e){return{enumerable:!1,configurable:!0,get:function(){return this[I].get_(e)},set:function(n){this[I].set_(e,n)}}}function Wu(e){he(wi.prototype,""+e,zr(e))}function Gr(e){if(e>Qt){for(var i=Qt;i<e+100;i++)Wu(i);Qt=e}}Gr(1e3);function Yu(e,i,n){return new wi(e,i,n)}function ci(e,i){if(typeof e=="object"&&e!==null){if($t(e))return i!==void 0&&T(23),e[I].atom_;if(fe(e))return e.atom_;if(Be(e)){if(i===void 0)return e.keysAtom_;var n=e.data_.get(i)||e.hasMap_.get(i);return n||T(25,i,di(e)),n}if(Ut(e)){if(!i)return T(26);var t=e[I].values_.get(i);return t||T(27,i,di(e)),t}if(bi(e)||Ft(e)||Nt(e))return e}else if(le(e)&&Nt(e[I]))return e[I];T(28)}function Ku(e,i){if(e||T(29),bi(e)||Ft(e)||Nt(e)||Be(e)||fe(e))return e;if(e[I])return e[I];T(24,e)}function di(e,i){var n;if(i!==void 0)n=ci(e,i);else{if(Ze(e))return e.name;Ut(e)||Be(e)||fe(e)?n=Ku(e):n=ci(e)}return n.name_}function qe(e){var i=Le(),n=Oi(!0);se();try{return e()}finally{oe(),Si(n),Oe(i)}}var Zi=Pt.toString;function Hr(e,i,n){return n===void 0&&(n=-1),pi(e,i,n)}function pi(e,i,n,t,r){if(e===i)return e!==0||1/e===1/i;if(e==null||i==null)return!1;if(e!==e)return i!==i;var s=typeof e;if(s!=="function"&&s!=="object"&&typeof i!="object")return!1;var o=Zi.call(e);if(o!==Zi.call(i))return!1;switch(o){case"[object RegExp]":case"[object String]":return""+e==""+i;case"[object Number]":return+e!=+e?+i!=+i:+e==0?1/+e===1/i:+e==+i;case"[object Date]":case"[object Boolean]":return+e==+i;case"[object Symbol]":return typeof Symbol<"u"&&Symbol.valueOf.call(e)===Symbol.valueOf.call(i);case"[object Map]":case"[object Set]":n>=0&&n++;break}e=Qi(e),i=Qi(i);var a=o==="[object Array]";if(!a){if(typeof e!="object"||typeof i!="object")return!1;var u=e.constructor,l=i.constructor;if(u!==l&&!(le(u)&&u instanceof u&&le(l)&&l instanceof l)&&"constructor"in e&&"constructor"in i)return!1}if(n===0)return!1;n<0&&(n=-1),t=t||[],r=r||[];for(var d=t.length;d--;)if(t[d]===e)return r[d]===i;if(t.push(e),r.push(i),a){if(d=e.length,d!==i.length)return!1;for(;d--;)if(!pi(e[d],i[d],n-1,t,r))return!1}else{var f=Object.keys(e),p=f.length;if(Object.keys(i).length!==p)return!1;for(var h=0;h<p;h++){var m=f[h];if(!(ke(i,m)&&pi(e[m],i[m],n-1,t,r)))return!1}}return t.pop(),r.pop(),!0}function Qi(e){return $t(e)?e.slice():et(e)||Be(e)||_e(e)||fe(e)?Array.from(e.entries()):e}var en,Xu=((en=_i().Iterator)==null?void 0:en.prototype)||{};function ki(e){return e[Symbol.iterator]=Ju,Object.assign(Object.create(Xu),e)}function Ju(){return this}["Symbol","Map","Set"].forEach(function(e){var i=_i();typeof i[e]>"u"&&T("MobX requires global '"+e+"' to be available or polyfilled")});typeof __MOBX_DEVTOOLS_GLOBAL_HOOK__=="object"&&__MOBX_DEVTOOLS_GLOBAL_HOOK__.injectMobx({spy:_u,extras:{getDebugName:di},$mobx:I});class De{constructor(i,n,t){this.id=i.id,this.name=t||i.name||"Untitled",this.type=i.valuetype||"unknown",this.value=i.value;const r=n.endsWith("/")?"":"/",s=this.name.toLowerCase().replace(/[^a-z0-9]+/g,"_");this.path=`${n}${r}${s}`,it(this)}update(i){this.value=i}}class Mi{constructor(i,n){this.params=[],this.id=i.id,this.name=i.name?.value||i.display_name||`Effect ${i.id}`,this.path=`${n}/effects/${i.id}`,it(this),this.parse(i)}parse(i){if(i.params)for(const[n,t]of Object.entries(i.params))ct(t)&&this.params.push(new De(t,this.path,n));for(const[n,t]of Object.entries(i))n!=="params"&&ct(t)&&this.params.push(new De(t,this.path,n))}}class Zu{constructor(i,n,t){this.params=[],this.effects=[],this.id=i.id,this.name=i.name?.value||`Clip ${t+1}`,this.path=`${n}/clips/${t+1}`,i.thumbnail?.path&&(this.thumbnail=i.thumbnail.path),it(this),this.parse(i)}parse(i){const n=(t,r)=>{for(const[s,o]of Object.entries(t))s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mi(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&n(o,`${r}/${s}`)};n(i,this.path)}}class Qu{constructor(i,n,t){this.clips=[],this.params=[],this.effects=[],this.id=i.id,this.name=i.name?.value||`Layer ${t+1}`,this.path=`${n}/layers/${t+1}`,it(this),this.parse(i)}parse(i){i.clips&&Array.isArray(i.clips)&&(this.clips=i.clips.map((t,r)=>new Zu(t,this.path,r)));const n=(t,r)=>{for(const[s,o]of Object.entries(t))s!=="clips"&&(s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mi(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&n(o,`${r}/${s}`))};n(i,this.path)}}class el{constructor(){this.layers=[],this.params=[],this.effects=[],this.path="/composition",it(this)}load(i){this.layers=[],this.params=[],this.effects=[],i.layers&&Array.isArray(i.layers)&&(this.layers=i.layers.map((t,r)=>new Qu(t,this.path,r)));const n=(t,r)=>{for(const[s,o]of Object.entries(t))s==="layers"||s==="decks"||(s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mi(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&n(o,`${r}/${s}`))};n(i,this.path)}}function ct(e){return typeof e=="object"&&e!==null&&"valuetype"in e&&"id"in e}class tl{constructor(i){let n=i?.baseUrl??"http://127.0.0.1:8080",t=i?.customFetch,r=i?.customWebSocket??WebSocket;n.endsWith("/")&&(n=n.slice(0,-1)),this.apiBaseUrl=`${n}/api/v1`,this.customFetch=t,this.WebSocket=r}async request(i,n){try{const t=`${this.apiBaseUrl}${i}`,r=await(this.customFetch??fetch)(t,n);if(!r.ok)throw new Error(`API request failed: ${r.status} ${r.statusText}`);return r.status===204?void 0:await r.json()}catch(t){throw console.error("[RealResolumeApiClient] Error in request:",t),t}}getProductInfo(){return this.request("/product")}connectWebSocket(i,n,t){const r=this.apiBaseUrl.replace(/^http/,"ws"),s=new this.WebSocket(r);return s.onmessage=o=>{try{const a=JSON.parse(o.data);i(a)}catch(a){console.error("[RealResolumeApiClient] Error parsing message:",a)}},n&&(s.onerror=n),t&&(s.onclose=t),s.onopen=()=>console.log("[RealResolumeApiClient] Connection established."),{send:o=>{s.readyState===s.OPEN?s.send(JSON.stringify(o)):console.warn("[RealResolumeApiClient] WebSocket is not open. Message not sent:",o)},close:()=>s.close(),get readyState(){return s.readyState}}}}class il{constructor(i){this.ws=null,this.isConnecting=!1,this.parameterMap=new Map,this.subscriptions=new Map,this.client=i?.client??new tl,this.state=new el,it(this)}subscribe(i,n,t){this.subscriptions.has(i)||this.subscriptions.set(i,new Map),this.subscriptions.get(i).set(n,t);const r=this.getParameter(i);r&&this.ws?(this.sendSubscription(r),t&&t(r.value)):console.log(`[ResolumeManager] Queued subscription for ${i} (Connected: ${!!this.ws}, Param found: ${!!r})`)}sendSubscription(i){this.ws&&this.ws.send({action:"subscribe",parameter:`/parameter/by-id/${i.id}`})}unsubscribe(i,n){const t=this.subscriptions.get(i);t&&(t.delete(n),t.size===0&&this.subscriptions.delete(i))}async connect(){if(!(this.isConnected||this.isConnecting)){this.isConnecting=!0,console.log("[ResolumeManager] Connecting...");try{const i=await this.client.getProductInfo();console.log(`[ResolumeManager] Connected to ${i.name} v${i.major}.${i.minor}`),this.ws=this.client.connectWebSocket(n=>this.handleMessage(n),n=>console.error("[ResolumeManager] WS Error:",n),()=>{console.log("[ResolumeManager] WS Closed"),this.isConnecting=!1})}catch(i){console.error("[ResolumeManager] Connection failed:",i),this.isConnecting=!1}}}get isConnected(){return!!this.ws}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}handleMessage(i){if(i.layers&&i.decks)console.log("[ResolumeManager] Received initial state"),this.state.load(i),this.rebuildParameterMap();else if(i.type==="parameter_update"){const n=this.findParameterById(i.id);if(n){n.update(i.value);const t=this.subscriptions.get(n.path);t&&t.forEach(r=>{r&&r(i.value)})}}}rebuildParameterMap(){this.parameterMap.clear();const i=n=>{n instanceof De&&this.parameterMap.set(n.path,n);for(const t in n){const r=n[t];Array.isArray(r)?r.forEach(i):typeof r=="object"&&r!==null&&(r instanceof De||r.constructor.name.startsWith("Resolume"))&&i(r)}};i(this.state),console.log(`[ResolumeManager] Indexed ${this.parameterMap.size} parameters`);for(const[n,t]of this.subscriptions.entries()){const r=this.parameterMap.get(n);r&&(console.log(`[ResolumeManager] Resubscribing to ${n}`),this.sendSubscription(r),t.forEach(s=>{s&&s(r.value)}))}}findParameterById(i){for(const n of this.parameterMap.values())if(n.id===i)return n}getParameter(i){return this.parameterMap.get(i)}setValue(i,n){const t=this.getParameter(i);t&&this.ws&&this.ws.send({action:"set",parameter:`/parameter/by-id/${t.id}`,id:t.id,value:n})}}const xe=new il;class Ni{constructor(i,n,t){this.context=i,this.nodeId=n,this.paramName=t}setValueAtTime(i,n){const t=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"setParamValue",id:this.nodeId,param:this.paramName,value:i,time:t})}linearRampToValueAtTime(i,n){const t=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"linearRampToValueAtTime",id:this.nodeId,param:this.paramName,value:i,time:t})}exponentialRampToValueAtTime(i,n){const t=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"exponentialRampToValueAtTime",id:this.nodeId,param:this.paramName,value:i,time:t})}setTargetAtTime(i,n,t){const r=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"setTargetAtTime",id:this.nodeId,param:this.paramName,target:i,startTime:r,timeConstant:t})}cancelScheduledValues(i){const n=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"cancelScheduledValues",id:this.nodeId,param:this.paramName,time:n})}}class zt{constructor(i,n){this.id=i,this.context=n}connect(i){this.context.addCommand({type:"connect",sourceId:this.id,destId:i.id})}disconnect(){this.context.addCommand({type:"disconnect",sourceId:this.id})}dispose(){this.context.addCommand({type:"dispose",id:this.id})}}class nl extends zt{constructor(i,n){super(i,n),this.frequency=new Ni(n,i,"frequency")}set type(i){this.context.addCommand({type:"setNodeProperty",id:this.id,property:"type",value:i})}start(i=0){const n=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"start",id:this.id,time:n})}stop(i=0){const n=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"stop",id:this.id,time:n})}}class rl extends zt{constructor(i,n){super(i,n),this.gain=new Ni(n,i,"gain")}}class sl extends zt{constructor(i,n){super(i,n),this.frequency=new Ni(n,i,"frequency")}set type(i){this.context.addCommand({type:"setNodeProperty",id:this.id,property:"type",value:i})}}class ol{constructor(){this.commands=[],this.nodeCount=0,this.state="running",this.currentTime=0,this.contextId=Math.random().toString(36).slice(2),this.destination=new zt("destination",this)}createOscillator(){const i=`osc-${this.nodeCount++}`;return this.addCommand({type:"createOscillator",id:i}),new nl(i,this)}createGain(){const i=`gain-${this.nodeCount++}`;return this.addCommand({type:"createGain",id:i}),new rl(i,this)}createBiquadFilter(){const i=`filter-${this.nodeCount++}`;return this.addCommand({type:"createBiquadFilter",id:i}),new sl(i,this)}addCommand(i){this.commands.push(i)}flushCommands(){const i=this.commands;return this.commands=[],i}reset(){this.commands=[],this.addCommand({type:"clear"}),this.nodeCount=0,this.contextId=Math.random().toString(36).slice(2)}}class al{constructor(){this.enabled=!1,this.isActive=!1,this.pendingResync=!1,this.lastBarPhase=0,this.currentAuxPort=null,this.externalBpm=120,this.externalBarPhase=null,this.hasValidExternalClock=!1,this.lastExternalUpdate=0}setEnabled(i){this.enabled=i,this.updateValidity()}setBeatSyncActive(i){this.isActive=i,this.updateValidity()}updateValidity(){this.isActive||(this.hasValidExternalClock=!1,this.externalBarPhase=null)}handlePort(i){this.currentAuxPort&&(this.currentAuxPort.close(),this.currentAuxPort.onmessage=null),this.currentAuxPort=i,this.currentAuxPort.onmessage=n=>this.onMessage(n)}onMessage(i){const n=i.data;n.type==="CLOCK_UPDATE"?this.handleClockUpdate(n):n.type==="CLOCK_STREAM"?this.handleClockStream(n):n.type==="CLOCK_HARD_SYNC"&&this.handleHardSync()}handleHardSync(){this.enabled&&(xe.setValue("/composition/tempocontroller/resync",!0),xe.setValue("/composition/tempocontroller/resync",!1)),this.pendingResync=!1}handleClockUpdate(i){this.enabled&&(i.bpm&&xe.setValue("/composition/tempocontroller/tempo",i.bpm),i.phase!==void 0&&i.kind==="sync"&&(this.pendingResync=!0))}handleClockStream(i){if(!this.isActive)return;const n=i.data;this.externalBpm=n.bpm,this.externalBarPhase=n.barPhase,this.hasValidExternalClock=!0,this.lastExternalUpdate=self.performance.now();const t=n.barPhase;if(this.pendingResync&&this.enabled){const r=Math.floor(t/4),s=Math.floor(this.lastBarPhase/4);r>s&&(xe.setValue("/composition/tempocontroller/resync",!0),xe.setValue("/composition/tempocontroller/resync",!1),this.pendingResync=!1)}this.lastBarPhase=t}}const ge=new al;let L=null,xt=null,Ci=60,Et=!1,We=new ol,ot=new Map,Te={beat:0},Wr=new Map,fi=[];self.onerror=e=>{console.error("Executor Worker Error (Global):",e)};self.onmessage=e=>{const i=e.data;switch(i.type){case"CONNECT_AUX_PORT":ge.handlePort(i.port);break;case"RESOLUME_SETTINGS":ge.setEnabled(i.enabled);break;case"BEAT_SYNC_STATE":ge.setBeatSyncActive(i.isActive);break;case"INIT_GRAPH":let n,t,r;if(i.isRecompilation&&L&&(n=L.getNodeStates(),t=L.getUserNodeStates(),r=L.getInputs()),L=new da(i.graph,nn,n,i.inferredNodeTypes,i.dirtyNodeIds,i.nodeMetadata,i.idMap),i.idMap){ot.clear();for(const[o,a]of Object.entries(i.idMap))ot.set(a,o)}if(t&&L.setUserNodeStates(t),r)for(const[o,a]of r)L.setInput(o,a);i.isRecompilation||We.reset();const s=L.getInferredNodeTypes();s&&self.postMessage({type:"INFERRED_TYPES",inferredNodeTypes:s});break;case"UPDATE_CONFIG":L&&L.setNodeConfig(i.nodeId,i.config);break;case"UPDATE_INPUT":if(L)if(L.getNodeConfig(i.name)!==void 0){const o=L.getNodeConfig(i.name)||{fields:{},untagged:[]},a=o.values||{},u={...o,values:{...a,...i.value}};L.setNodeConfig(i.name,u)}else L.setInput(i.name,i.value);break;case"CONTROL":i.action==="START"?(i.frameRate&&(Ci=i.frameRate),ul()):i.action==="STOP"?ll():i.action==="STEP"&&Yr();break;case"UPDATE_AUDIO_STATE":We.state=i.state;break;case"RESOLUME_CONTROL":i.action==="connect"?xe.connect():i.action==="disconnect"&&xe.disconnect();break;case"RESOLUME_SET_VALUE":xe.setValue(i.path,i.value);break;case"MIDI_UPDATE":Wr=i.values,i.events&&(fi=i.events);break;case"NODE_MESSAGE":L&&L.handleNodeMessage(i.nodeId,i.message);break}};function ul(){Et||(Et=!0,xt=setInterval(()=>{Yr()},1e3/Ci))}function ll(){Et&&(Et=!1,xt&&(clearInterval(xt),xt=null))}function Yr(){if(!L)return;const e=self.performance.now(),i=1/Ci;let n=120;const r=self.performance.now()-ge.lastExternalUpdate<2e3;if(ge.hasValidExternalClock&&ge.externalBpm>0&&r&&(n=ge.externalBpm,ge.externalBarPhase!==null)){const y=Te.beat%4,b=ge.externalBarPhase%4;let _=b-y;if(_>2&&(_-=4),_<-2&&(_+=4),Math.abs(_)>1){let E=Math.floor(Te.beat/4)*4+b;E<Te.beat&&(E+=4),Te.beat=E}else{const E=_*2*i;Te.beat+=E}}const s=n/60;Te.beat+=i*s,We.currentTime+=i;try{L.update({clock:{beat:Te.beat,dt:i},audio:{context:We},time:We.currentTime,midi:{values:Wr,events:fi},resolume:xe}),fi=[]}catch(y){console.error("Executor Worker: Error during update",y);return}const o=self.performance.now(),a=L.getExecutedNodes(),u=L.getOutputs(),l=new Map;for(const y of a){const b=u.get(y);if(b){const _=ot.get(y)||y;l.set(_,hi(b))}}const d=L.getInspectedInputs(),f=new Map;for(const y of a){const b=d.get(y);if(b){const _=ot.get(y)||y;f.set(_,hi(b))}}const p=L.getUiOutputs(),h=new Map;for(const y of a){const b=p.get(y);if(b!==void 0){const _=ot.get(y)||y;h.set(_,b)}}const m=We.flushCommands(),g={type:"EXECUTION_UPDATE",outputs:l,inputs:f,uiOutputs:h,stats:{nodeCount:L.graphNodeCount,executionTime:o-e},audioCommands:m.length>0?m:void 0};self.postMessage(g)}function hi(e){return{fields:Kr(e.fields)}}function Kr(e){const i={};for(const n in e)i[n]=Xr(e[n]);return i}function Xr(e){return typeof e=="function"?"<function>":Array.isArray(e)?e.map(Xr):typeof e=="object"&&e!==null?"fields"in e?hi(e):Kr(e):e}export{ei as D,hs as O,fs as a};
//# sourceMappingURL=executor.worker-DThpn5af.js.map
