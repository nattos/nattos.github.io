class it{constructor(){this.items=[]}push(h,p){this.items.push({key:h,fScore:p}),this.bubbleUp(this.items.length-1)}pop(){if(this.items.length===0)return;const h=this.items[0],p=this.items.pop();return this.items.length>0&&p&&(this.items[0]=p,this.bubbleDown(0)),h}size(){return this.items.length}bubbleUp(h){for(;h>0;){const p=Math.floor((h-1)/2);if(this.items[h].fScore>=this.items[p].fScore)break;this.swap(h,p),h=p}}bubbleDown(h){const p=this.items.length,w=this.items[h];for(;;){let R=2*h+1,Y=2*h+2,f,G,b=null;if(R<p&&(f=this.items[R],f.fScore<w.fScore&&(b=R)),Y<p&&(G=this.items[Y],(b===null&&G.fScore<w.fScore||b!==null&&G.fScore<f.fScore)&&(b=Y)),b===null)break;this.swap(h,b),h=b}}swap(h,p){const w=this.items[h];this.items[h]=this.items[p],this.items[p]=w}}function I(m,h){return m&65535|h<<16}function K(m){return{x:m&65535,y:m>>>16}}function Q(m,h){return m.x===h.x&&m.y===h.y}function ot(m,h={}){const p=[],w={},R=new Set,Y=new Map,f=32;for(const o of h.obstacles||[]){const c=o.x*2+1,u=o.y*f;if(o.height&&o.height>1){Y.set(`${c},${o.y}`,o.height);const r=Math.min(o.height,31);for(let y=0;y<r;y++)R.add(I(c,u+y))}else Y.set(`${c},${o.y}`,1),R.add(I(c,u))}const G=o=>({x:o.x*2+1,y:o.y*f}),b=new Map,O=new Map,_=new Map,N=new Map,V=new Map;for(const o of m){const c={x:o.start.x*2+2,y:o.start.y*f+(o.startOffset||0)},u={x:o.end.x*2,y:o.end.y*f+(o.endOffset||0)};let r=[];if(Q(c,u))r=[c];else{const y=new it,i=new Map,e=new Map,t=I(c.x,c.y),x=I(u.x,u.y);e.set(t,0);const n=I(c.x-1,c.y);i.set(t,n);const l=(M,g)=>Math.abs(M-u.x)+Math.abs(g-u.y);y.push(t,l(c.x,c.y));const s=new Set,$=-1,T=Math.max(c.y,u.y)+256,k=Math.min(c.x,u.x)-100,W=Math.max(c.x,u.x)+100;let X=0;const d=5e5;for(;y.size()>0;){if(X++,X>d){console.warn(`WireLayout: A* Safety Limit Reached (${d}) for wire ${o.id}`);break}const M=y.pop();if(!M)break;const g=M.key;if(g===x){let S=g;for(r=[K(S)];i.has(S);){const L=i.get(S);if(L===n)break;S=L,r.unshift(K(S))}break}if(s.has(g))continue;s.add(g);const a=K(g),A=[a.x+1,a.x-1],D=[a.y,a.y];a.x%2===0&&(a.y>$&&(A.push(a.x),D.push(a.y-1)),a.y<T&&(A.push(a.x),D.push(a.y+1)));for(let S=0;S<A.length;S++){const L=A[S],B=D[S];if(L<k||L>W||B<$||B>T)continue;const U=I(L,B);if(s.has(U))continue;let C=1;const Z=U===x;if(R.has(U)&&!Z)continue;const q=i.get(g);if(q!==void 0){const E=K(q);E.x!==L&&E.y!==B&&(C+=1,a.x%2===0&&(C+=20)),a.x-E.x;const j=a.y-E.y;L-a.x;const tt=B-a.y;if(j===0&&tt!==0){const et=(c.x+u.x)/2,st=Math.abs(a.x-et)*25;C+=st}}const z=(e.get(g)||0)+C;if(z<(e.get(U)||1/0)){i.set(U,g),e.set(U,z);const E=z+l(L,B);y.push(U,E)}}}}if(r.length===0&&(r=[c,u]),r.length>0){const y=[r[0]];for(let i=1;i<r.length;i++){const e=y[y.length-1],t=r[i];Q(e,t)||y.push(t)}r=y}w[o.id]={path:r};for(let y=0;y<r.length;y++){const i=r[y],e=I(i.x,i.y);b.set(e,(b.get(e)||0)+1);const t=y>0?r[y-1]:null,x=y<r.length-1?r[y+1]:null;let n=!1;t&&t.x!==i.x&&(n=!0),x&&x.x!==i.x&&(n=!0),!t&&!x&&(n=!0);let l=!1;t&&t.y!==i.y&&(l=!0),x&&x.y!==i.y&&(l=!0),n&&O.set(e,(O.get(e)||0)+1),l&&N.set(e,(N.get(e)||0)+1)}}const F=new Map,v=f-1;for(const o of m){const c=w[o.id].path;if(!c||c.length===0)continue;const u=G(o.start);p.push({id:`${o.id}-start`,wireId:o.id,x:u.x,y:u.y+(o.startOffset||0),type:"start",lane:0,totalLanes:1,length:1});const r=G(o.end),y=r.y+(o.endOffset||0);p.push({id:`${o.id}-end`,wireId:o.id,x:r.x,y,type:"end",lane:0,totalLanes:1,length:1});for(let i=0;i<c.length;i++){const e=c[i],t=I(e.x,e.y);b.get(t);const x=F.get(t)||0;F.set(t,x+1);const n=i>0?c[i-1]:null,l=i<c.length-1?c[i+1]:null;let s="h";if(n&&l){const d=e.x-n.x,M=e.y-n.y,g=l.x-e.x,a=l.y-e.y;d!==0&&g!==0?s="h":M!==0&&a!==0?s="v":d===1&&a>0?s="ctr":d===1&&a<0?s="cbr":d===-1&&a>0?s="ctl":d===-1&&a<0||M>0&&g===1?s="cbl":M>0&&g===-1?s="cbr":M<0&&g===1?s="ctl":M<0&&g===-1&&(s="ctr")}else if(!n)l?s=l.x!==e.x?"h":"v":s="h",l&&(l.y<e.y?s="cbr":l.y>e.y&&(s="ctr"));else if(!l&&n){const d=r.x>e.x;n.y<e.y?s=d?"cbl":"cbr":n.y>e.y?s=d?"ctl":"ctr":s="h"}let $,T;const k=Math.floor(e.y/f);if(e.y%f<v){if(n&&n.x===e.x&&n.y<e.y){const d=Math.floor(n.y/f);d===k?n.y%f<v&&($=n.y%f):d===k-1&&n.y%f===v&&($=-1)}l&&l.x===e.x&&l.y>e.y&&Math.floor(l.y/f)===k&&(l.y%f<v?T=l.y%f:l.y%f===v&&(T=v)),n&&n.x===e.x&&n.y>e.y&&Math.floor(n.y/f)===k&&(n.y%f<v?T=n.y%f:n.y%f===v&&(T=v)),l&&l.x===e.x&&l.y<e.y&&Math.floor(l.y/f)===k&&l.y%f<v&&($=l.y%f)}else n&&n.x===e.x&&n.y<e.y&&($=-1);if(s==="h"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"){const d=_.get(t)||0;_.set(t,d+1)}if(s==="v"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"){const d=V.get(t)||0;V.set(t,d+1)}p.push({id:`${o.id}-${i}`,wireId:o.id,x:e.x,y:e.y,type:s,laneH:s==="h"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"?_.get(t)||1:void 0,totalHLanes:s==="h"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"?O.get(t)||0:void 0,laneV:s==="v"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"?V.get(t)||1:void 0,totalVLanes:s==="v"||s==="cbl"||s==="cbr"||s==="ctl"||s==="ctr"?N.get(t)||0:void 0,length:1,clipTopRem:$,clipBotRem:T})}}const H=[],P=new Map;for(const o of p){const c=Math.floor(o.y/f),u=o.y%f;let r="";u<v?r=`${o.wireId}:${o.x}:${c}:node`:r=`${o.wireId}:${o.x}:${c}:gap`,P.has(r)||P.set(r,[]),P.get(r).push(o)}for(const[o,c]of P.entries()){const u=c.some(i=>i.type!=="h"&&i.type!=="v"&&i.type!=="start"&&i.type!=="end"),r=(i,e)=>i===void 0&&e!==void 0||i!==void 0&&e!==void 0&&i<e,y=(i,e)=>i===void 0&&e!==void 0||i!==void 0&&e!==void 0&&i>e;if(u){const i=c.filter(t=>t.type==="v"),e=c.filter(t=>t.type!=="v"&&t.type!=="h"&&t.type!=="start"&&t.type!=="end");for(const t of e)if(t.type==="cbl"||t.type==="cbr")for(const x of i)r(x.clipTopRem,t.clipTopRem)&&(t.clipTopRem=x.clipTopRem);else if(t.type==="ctl"||t.type==="ctr")for(const x of i)y(x.clipBotRem,t.clipBotRem)&&(t.clipBotRem=x.clipBotRem);for(const t of c)t.type!=="v"&&H.push(t)}else{const i=c.filter(t=>t.type==="v"),e=c.filter(t=>t.type!=="v");if(i.length>0){let t={...i[0]};for(let x=1;x<i.length;x++){const n=i[x];r(n.clipTopRem,t.clipTopRem)&&(t.clipTopRem=n.clipTopRem),y(n.clipBotRem,t.clipBotRem)&&(t.clipBotRem=n.clipBotRem)}H.push(t)}H.push(...e)}}return{segments:H,wires:w}}const J=self;J.onmessage=m=>{const{type:h,wires:p,options:w}=m.data;if(h==="LAYOUT_REQUEST"){const Y={type:"LAYOUT_RESULT",layout:ot(p,w)};J.postMessage(Y)}};
//# sourceMappingURL=wire-layout.worker-80sQ2dZk.js.map
