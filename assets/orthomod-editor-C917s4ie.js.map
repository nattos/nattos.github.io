{"version":3,"file":"orthomod-editor-C917s4ie.js","sources":["../../src/customnodes/nicepattern/orthomod-editor.ts"],"sourcesContent":["import { LitElement, html, css, PropertyValueMap } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { GridNode } from '../../builder/state';\nimport { runtimeManager } from '../../builder/controllers';\nimport { appController } from '../../builder/controllers';\nimport { reaction } from 'mobx';\n\n@customElement('nicepattern-orthomod-editor')\nexport class OrthomodEditor extends LitElement {\n  @property({ type: Object }) node!: GridNode;\n\n  @state() private codes: number[][] = [];\n  @state() private activeIndex: number = 0;\n  @state() private channels: number[] = [0, 0, 0, 0];\n  @state() private rawChannels: number[] = [0, 0, 0, 0];\n  @state() private envelope: number = 0;\n  @state() private gateOpen: boolean = false;\n\n  private cleanup: (() => void) | null = null;\n  private animationFrame: number | null = null;\n\n  static styles = css`\n    :host {\n      display: flex;\n      flex-direction: column;\n      height: 100%;\n      background: #111;\n      color: #eee;\n      font-family: \"JetBrains Mono\", monospace;\n      font-size: 10px;\n      user-select: none;\n      pointer-events: auto; /* Ensure interactivity */\n    }\n\n    /* Header */\n    .header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 4px 6px;\n      border-bottom: 1px solid #222;\n      background: #080808;\n      height: 20px;\n      flex-shrink: 0;\n    }\n\n    .title {\n      font-weight: 800;\n      color: #fff;\n      font-size: 10px;\n      letter-spacing: -0.5px;\n      line-height: 1;\n    }\n\n    .highlight { color: #ffcc00; }\n\n    .gate-led {\n        width: 6px; height: 6px; background: #222; border-radius: 50%;\n        margin-right: 4px;\n    }\n    .gate-led.on { background: #fff; box-shadow: 0 0 6px #fff; }\n\n    /* Visualizer Area */\n    .visualizer {\n      flex: 1;\n      display: flex;\n      flex-direction: column; /* Stacked Vertically */\n      border-bottom: 1px solid #222;\n      min-height: 200px;\n    }\n\n    /* Matrix */\n    .matrix {\n      flex: 1; /* Take remaining space */\n      width: 100%;\n      display: flex;\n      flex-direction: column;\n      background: #000;\n    }\n\n    .matrix-row {\n      flex: 1;\n      display: flex;\n      border-bottom: 1px solid #111;\n      opacity: 0.5;\n      border-left: 2px solid transparent; /* Reserve space for active border */\n      box-sizing: border-box;\n    }\n    .matrix-row.active {\n      opacity: 1.0;\n      background: rgba(255, 204, 0, 0.15);\n      border-left: 2px solid #ffcc00;\n    }\n\n    .bit {\n      flex: 1;\n      border-right: 1px solid #111;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 8px;\n    }\n    .bit.on {\n      background: #ffcc00;\n      color: #000;\n      font-weight: 800;\n    }\n\n    /* Channels */\n    .channels {\n      height: 80px; /* Fixed height for channels */\n      display: flex;\n      flex-direction: row;\n      border-bottom: 1px solid #222;\n    }\n\n    .channel {\n      flex: 1;\n      border-right: 1px solid #222;\n      position: relative;\n      background: #000;\n      display: flex;\n      flex-direction: column;\n      justify-content: flex-end;\n    }\n    .channel:last-child { border-right: none; }\n\n\n\n    .channel-ghost {\n      position: absolute;\n      bottom: 0; left: 0; right: 0;\n      background: rgba(255, 204, 0, 0.25); /* Faint Yellow */\n      border-top: 1px solid rgba(255, 204, 0, 0.5); /* Rim */\n      z-index: 0;\n    }\n\n    .channel-fill {\n      width: 100%;\n      background: #ffcc00; /* Solid punchy yellow */\n      opacity: 1.0;\n      z-index: 1;\n      position: relative;\n      box-shadow: 0 0 10px rgba(255, 204, 0, 0.3); /* Glow */\n    }\n\n    .channel-label {\n        position: absolute;\n        top: 4px;\n        left: 0; right: 0;\n        text-align: center;\n        font-size: 9px;\n        font-weight: 700;\n        color: #666;\n        z-index: 10;\n        pointer-events: none;\n        letter-spacing: 0.5px;\n    }\n\n    .channel-type {\n        position: absolute;\n        bottom: 4px;\n        left: 0; right: 0;\n        text-align: center;\n        font-size: 9px;\n        font-weight: 900;\n        color: rgba(255, 255, 255, 0.9);\n        z-index: 11;\n        pointer-events: none;\n        opacity: 1.0;\n    }\n\n    /* Footer / Controls */\n    .footer {\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      background: #080808;\n      border-top: 1px solid #222;\n      padding: 0 4px;\n    }\n\n    button {\n      background: #111;\n      border: 1px solid #333;\n      color: #777;\n      font-size: 9px;\n      cursor: pointer;\n      padding: 2px 8px;\n      font-family: inherit;\n    }\n    button:hover {\n        border-color: #ffcc00;\n        color: #ffcc00;\n    }\n  `;\n\n  connectedCallback() {\n    super.connectedCallback();\n    this.startLoop();\n    // We strictly rely on worker UI outputs now.\n  }\n\n  disconnectedCallback() {\n    super.disconnectedCallback();\n    if (this.cleanup) this.cleanup();\n    if (this.animationFrame) cancelAnimationFrame(this.animationFrame);\n  }\n\n\n\n  private startLoop() {\n    const loop = () => {\n      this.animationFrame = requestAnimationFrame(loop);\n\n      // Poll RuntimeManager for UI outputs\n      const uiState = runtimeManager.uiStates.get(this.node.id);\n\n      if (uiState) {\n        // { codes, env, vec, gate }\n        if (uiState.codes && uiState.codes.length > 0) {\n          this.codes = uiState.codes;\n        }\n\n        this.envelope = uiState.env ?? 0;\n        this.channels = uiState.vec ?? [0, 0, 0, 0];\n        this.rawChannels = uiState.rawVec ?? [0, 0, 0, 0];\n        this.gateOpen = (uiState.gate ?? 0) > 0.5;\n\n        // Use the activeIndex provided by worker if available, else calc\n        if (typeof uiState.activeCodeIndex === 'number') {\n          if (this.activeIndex !== uiState.activeCodeIndex) {\n            this.activeIndex = uiState.activeCodeIndex;\n          }\n        } else {\n          // Fallback (legacy worker?)\n          let pos = 1.0 - this.envelope;\n          pos = Math.max(0, Math.min(0.999, pos));\n          const idx = Math.floor(pos * this.codes.length);\n          if (this.activeIndex !== idx) this.activeIndex = idx;\n        }\n        this.requestUpdate();\n      }\n    };\n    loop();\n  }\n\n  private handleShuffle() {\n    // Update seed\n    const newSeed = Math.floor(Math.random() * 100000);\n    appController.setNodeConfig(this.node.id, { seed: newSeed });\n  }\n\n  private handleMatrixDown(e: PointerEvent) {\n    e.preventDefault();\n    e.stopPropagation(); // Prevent drag initiating graph moves\n    (e.target as Element).setPointerCapture(e.pointerId);\n    this.updateScrub(e);\n  }\n\n  private handleMatrixMove(e: PointerEvent) {\n    if ((e.target as Element).hasPointerCapture(e.pointerId)) {\n      this.updateScrub(e);\n    }\n  }\n\n  private handleMatrixUp(e: PointerEvent) {\n    (e.target as Element).releasePointerCapture(e.pointerId);\n    // Reset manual phase to -1\n    const currentValues = this.node.config.values || {};\n    appController.setNodeConfig(this.node.id, { values: { ...currentValues, manual_phase: -1 } });\n  }\n\n  private updateScrub(e: PointerEvent) {\n    const matrix = this.shadowRoot?.querySelector('.matrix');\n    if (!matrix) return;\n\n    const rect = matrix.getBoundingClientRect();\n    const relativeY = e.clientY - rect.top;\n    const normalizedY = Math.max(0, Math.min(1, relativeY / rect.height));\n\n    // Map Y (0..1) to Phase (1..0) because Top is Index 0 (High Env)\n    // Wait: Env=1 -> Index 0. Env=0 -> Index Max.\n    // So Top (Y=0) should be Env=1. Bottom (Y=1) should be Env=0.\n    const phase = 1.0 - normalizedY;\n\n    const currentValues = this.node.config.values || {};\n    appController.setNodeConfig(this.node.id, { values: { ...currentValues, manual_phase: phase } });\n  }\n\n  render() {\n    const activeCode = this.codes[this.activeIndex] || [];\n    // Use envelope to determine activity, so it stays active during release\n    const isActive = this.envelope > 0.001;\n\n    return html`\n        <div class=\"container\" @dblclick=\"${(e: Event) => e.stopPropagation()}\">\n        <div class=\"header\">\n            <div style=\"display:flex; align-items:center;\">\n                <span class=\"title\">ORTHO<span class=\"highlight\">MOD</span></span>\n            </div>\n            <div style=\"display:flex; align-items:center;\">\n                <div class=\"gate-led ${this.gateOpen ? 'on' : ''}\"></div>\n                <span class=\"title\" style=\"color: #555;\">GATE</span>\n            </div>\n        </div>\n\n        <div class=\"visualizer\">\n            <!-- Channels (Top) -->\n            <div class=\"channels\">\n                ${this.channels.map((val, i) => {\n      const activeCode = this.codes[this.activeIndex] || [];\n      const b1 = activeCode[i * 2] || 0;\n      const b2 = activeCode[i * 2 + 1] || 0;\n      let typeLabel = \"OFF\";\n      if (b1 === 0 && b2 === 0) typeLabel = \"OFF\";\n      else if (b1 === 1 && b2 === 1) typeLabel = \"ON\";\n      else if (b1 === 1 && b2 === 0) typeLabel = \"SQR\"; // 10\n      else if (b1 === 0 && b2 === 1) typeLabel = \"SIN\"; // 01\n\n      const rawVal = this.rawChannels[i] || 0;\n\n      return html`\n                    <div class=\"channel\">\n                        <div class=\"channel-label\">CH ${i + 1}</div>\n                        <!-- Ghost Bar (Raw / Unmodulated) -->\n                        <div class=\"channel-ghost\" style=\"height: ${Number.isNaN(rawVal) ? 0 : Math.min(100, Math.max(0, rawVal * 100))}%\"></div>\n\n                        <!-- Main Bar (Enveloped) -->\n                        <div class=\"channel-fill\" style=\"height: ${Number.isNaN(val) ? 0 : Math.min(100, Math.max(0, val * 100))}%\"></div>\n\n                        <div class=\"channel-type\" style=\"color: ${isActive ? '#000' : '#555'}\">${typeLabel}</div>\n                    </div>\n                `})}\n            </div>\n\n            <!-- Matrix (Bottom) -->\n            <div class=\"matrix\"\n                @pointerdown=\"${this.handleMatrixDown}\"\n                @pointermove=\"${this.handleMatrixMove}\"\n                @pointerup=\"${this.handleMatrixUp}\"\n                @pointercancel=\"${this.handleMatrixUp}\"\n            >\n                ${this.codes.map((code, rIdx) => html`\n                    <div class=\"matrix-row ${rIdx === this.activeIndex && isActive ? 'active' : ''}\">\n                        <div class=\"bit\" style=\"width:12px; border-right:1px solid #222;\">${rIdx}</div>\n                        ${code.map(bit => html`\n                            <div class=\"bit ${bit ? 'on' : ''}\">${bit}</div>\n                        `)}\n                    </div>\n                `)}\n            </div>\n\n            <!-- Channels -->\n            <!-- Moved to top -->\n        </div>\n\n        <div class=\"footer\">\n             <button @click=${this.handleShuffle}>SHUFFLE CODES</button>\n            </div>\n        </div> <!-- container -->\n      `;\n  }\n}\n\n// Export renderer\nexport const OrthomodEditorRenderer = (node: GridNode) => {\n  return html`<nicepattern-orthomod-editor .node=${node}></nicepattern-orthomod-editor>`;\n}\n"],"names":["OrthomodEditor","LitElement","loop","uiState","runtimeManager","pos","idx","newSeed","appController","e","currentValues","matrix","rect","relativeY","phase","isActive","html","val","activeCode","b1","b2","typeLabel","rawVal","code","rIdx","bit","css","__decorateClass","property","state","customElement","OrthomodEditorRenderer","node"],"mappings":"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"}