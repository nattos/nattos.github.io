const R={kind:"atomic",type:"number",defaultValue:0},is={kind:"atomic",type:"string",defaultValue:""},j={kind:"atomic",type:"any"};function Y(e,n){if(e==null)return e;if(n.kind==="atomic")return e&&typeof e=="object"&&"kind"in e&&e.kind==="atomic"?e.value:e;if(n.kind==="array")return Array.isArray(e)?e.map(i=>Y(i,n.element)):[];if(n.kind==="record"){if(typeof e=="object"){if("fields"in e){const t=e,r={};for(const[s,o]of Object.entries(n.fields))s in t.fields&&(r[s]=Y(t.fields[s],o));return r}const i={};for(const[t,r]of Object.entries(n.fields))t in e&&(i[t]=Y(e[t],r));return i}return e}return e}function We(e,n){if(e==null||n.kind==="atomic")return e;if(n.kind==="array")return Array.isArray(e)?e.map(t=>We(t,n.element)):(console.error("toStructor array fail: not array",e),[]);if(n.kind==="record"){const i={};for(const[t,r]of Object.entries(n.fields))e[t]!==void 0&&(i[t]=We(e[t],r));return{fields:i}}return e}function U(e){const n={kind:"record",fields:e.config||{}},i={kind:"record",fields:e.outputs};return{id:e.id,kind:"primitive",metadata:e.metadata,inputs:e.inputs,outputs:e.outputs,configType:n,isRealtime:e.isRealtime,onMessage:e.onMessage,getDisplayLabel:e.getDisplayLabel,subgraphExpansionTag:e.subgraphExpansionTag,getChildren:e.getChildren,getRegion:e.getRegion,cycleBreakingPorts:e.cycleBreakingPorts,consolidate:e.consolidate?(t,r,s,o)=>{const a=Y(r,n),u={},l=t.fields||{};for(const[d,f]of Object.entries(e.inputs||{}))l[d]!==void 0&&(u[d]=Y(l[d],f));e.consolidate(u,a,s,o)}:void 0,computeBackwardPorts:e.computeBackwardPorts,computeForwardPorts:(t,r,s,o)=>e.computeForwardPorts?e.computeForwardPorts(t,r,s,o):{inputs:{kind:"record",fields:e.inputs||{}},outputs:i},shouldRecompileOnConfigChange:(t,r)=>e.shouldRecompileOnConfigChange?e.shouldRecompileOnConfigChange(t,r):!1,compileConfig:e.compileConfig,ui:e.ui,createState:e.createState,execute:(t,r,s)=>{const o=Y(r,n);let a;if(e.createState){const g=s.nodeId||`${e.id}-${JSON.stringify(r)}`;s.nodeState.has(g)||s.nodeState.set(g,e.createState(o,s)),a=s.nodeState.get(g)}let u=t;if(e.autoBroadcast&&e.inputs){const g={outputs:{},reshape:e.reshape??"none"},y=typeof e.autoBroadcast=="object"?e.autoBroadcast:{};if(o&&typeof o=="object"&&"autoBroadcast"in o){const S=o.autoBroadcast;S&&typeof S=="object"&&Object.assign(y,S)}for(const[S,A]of Object.entries(e.inputs)){const E=A.kind==="array",M=y[S],I=E?"collect":{reduce:"first"},q=M&&"combine"in M?M.combine:I;g.outputs[S]={fromFields:[S],combine:q??void 0}}const _=s.broadcast(g,t).apply(S=>{const A={};for(const[M,I]of Object.entries(e.inputs))if(g.outputs[M]?.combine==="collect"&&Array.isArray(S[M])){const V=S[M].map(z=>{if(Array.isArray(z)&&z.length>0&&Array.isArray(z[0])&&I.kind==="array"&&I.element.kind==="record")return z.map(J=>Y(J,I.element));const $=I.element?.kind==="array",Ce=Array.isArray(z)&&z.length>0&&Array.isArray(z[0]);return $&&!Ce?Y(z,I.element):Y(z,I)}),Z=I.element?.kind==="array";V.length===1&&Array.isArray(V[0])&&!Z?A[M]=V[0]:A[M]=V}else{const V=S[M],Z=I.element?.kind==="array",z=Array.isArray(V)&&V.length>0&&Array.isArray(V[0]);let $;I.kind==="array"&&Z&&!z?$=Y(V,I.element):$=Y(V,I),A[M]=$!==void 0?$:I.defaultValue}return e.execute(A,o,s,a)});if(Array.isArray(_))if(_.length>0){const S={},A=_[0];for(const M of Object.keys(A))S[M]=[];for(const M of _)for(const[I,q]of Object.entries(M))S[I]&&S[I].push(q);const E={};for(const[M,I]of Object.entries(S)){const q=e.outputs[M]||e.dynamicOutputType;q&&(E[M]=We(I,{kind:"array",element:q,size:_.length}))}return{fields:E}}else return{fields:{}};else{let S=_,A;S&&typeof S=="object"&&"outputs"in S&&("ui"in S||Object.keys(S).length===2)&&("outputs"in e.outputs||(A=S.ui,S=S.outputs));const E=new Set([...Object.keys(e.outputs),...Object.keys(S)]),M={};for(const q of E){const V=e.outputs[q]||e.dynamicOutputType;V&&S[q]!==void 0&&(M[q]=We(S[q],V))}const I={fields:M};return A!==void 0?{outputs:I,ui:A}:I}}else if(e.inputs&&Object.keys(e.inputs).length>0){const g={};for(const[y,b]of Object.entries(e.inputs))t.fields&&t.fields[y]!==void 0?g[y]=Y(t.fields[y],b):b.defaultValue!==void 0&&(g[y]=b.defaultValue);u=g}let d=e.execute(u,o,s,a),f;d&&typeof d=="object"&&"outputs"in d&&("ui"in d||Object.keys(d).length===2)&&("outputs"in e.outputs||(f=d.ui,d=d.outputs));const p={},h=d;if(h){const g=new Set([...Object.keys(e.outputs),...Object.keys(h)]);for(const y of g){const b=e.outputs[y]||e.dynamicOutputType;b&&h[y]!==void 0&&(p[y]=We(h[y],b))}}const m={fields:p};return f!==void 0?{outputs:m,ui:f}:m}}}function rs(e,n,i){const t={outputs:{},reshape:"none"};for(const[a,u]of Object.entries(n))t.outputs[a]={fromFields:u.source?Array.isArray(u.source)?u.source:[u.source]:[a],combine:u.combine??{reduce:"first"}};const s=e.broadcast(t,i).apply(a=>a),o={};if(Array.isArray(s)){for(const a of Object.keys(n))o[a]=[];for(const a of s)for(const u of Object.keys(n))o[u].push(a[u])}else for(const a of Object.keys(n))o[a]=s[a];for(const[a,u]of Object.entries(n))if(u.type)if(u.combine==="collect"){const l=o[a];Array.isArray(l)?o[a]=l.map(d=>Y(d,u.type)):o[a]=Y(l,u.type)}else{const l=o[a];Array.isArray(l)?o[a]=l.map(d=>Y(d,u.type)):o[a]=Y(l,u.type)}return o}function F(e,n,i,t="binary"){return U({id:e,metadata:n,inputs:t==="binary"?{a:R,b:R}:{a:R},outputs:{result:R},autoBroadcast:!0,reshape:"vector",execute:(s,o,a)=>{if(t==="binary"){const{a:u,b:l}=s;return{result:i(u,l)}}else{const{a:u}=s;return{result:i(u,0)}}}})}function vn(e){if(e.length===0)return j;const n=e[0];if(e.every(s=>s.kind===n.kind&&(s.kind==="atomic"?s.type===n.type:!0)))return n;if(e.some(s=>s.kind==="atomic"&&s.type==="string"))return j;const t=e.some(s=>s.kind==="atomic"&&s.type==="number"),r=e.some(s=>s.kind==="atomic"&&s.type==="boolean");return t||r?R:j}var ni=(e=>(e.Auto="auto",e.Show="show",e.Hide="hide",e))(ni||{});class ss{constructor(){this.nodes=new Map}register(n){this.nodes.set(n.id,n)}get(n){return this.nodes.get(n)?.definition}getNodeType(n){return this.nodes.get(n)}getAllNodeTypes(){return this.nodes.values()}}const ii=new ss;function N(e){const n={};for(const[r,s]of Object.entries(e.inputs||{}))if("kind"in s)n[r]=s;else if("type"in s){const o=s,a=o.type,u=o.allowMultiConnection?{kind:"array",size:"dynamic",element:a}:a;n[r]={...u,redirect:o.redirect,defaultValue:"defaultValue"in o?o.defaultValue:a.defaultValue}}const i={};for(const[r,s]of Object.entries(e.outputs||{}))"kind"in s?i[r]=s:"type"in s&&(i[r]=s.type);return{...U({...e,autoBroadcast:e.autoBroadcast,inputs:n,outputs:i,compileConfig:(r,s)=>e.compileConfig?e.compileConfig(r):r,computeForwardPorts:(r,s,o,a)=>e.computeForwardPorts?e.computeForwardPorts(r,s,o,a):{inputs:{kind:"record",fields:n},outputs:{kind:"record",fields:i}},computeBackwardPorts:(r,s,o)=>e.computeBackwardPorts?e.computeBackwardPorts(r,s,o):{inputRequirements:{kind:"record",fields:{}}},onMessage:e.onMessage,config:e.config}),ui:e.ui,version:e.version||"1.0.0",displayName:e.displayName||e.id,aliases:e.aliases,compileConfig:e.compileConfig,loadCompileDeps:e.loadCompileDeps,getDisplayLabel:e.getDisplayLabel,subgraphExpansionTag:e.subgraphExpansionTag,extendedInputs:e.inputs,extendedOutputs:e.outputs,inspectInputs:e.inspectInputs,shouldRecompileOnConfigChange:e.shouldRecompileOnConfigChange,getChildren:e.getChildren,getRegion:e.getRegion}}function v(e){const n=e.extendedInputs||e.inputs||{},i=Object.entries(n).map(([o,a])=>{const u="type"in a&&typeof a.type=="object"&&"kind"in a.type,l=u?a.type:a;return{name:o,type:l,description:u?a.description:void 0,defaultValue:u?a.defaultValue:void 0,range:u?a.range:void 0,step:u?a.step:void 0,suppressInputEditor:u?a.suppressInputEditor:l.kind==="atomic"&&l.type==="any"?!0:void 0,alwaysShowInputEditor:u?a.alwaysShowInputEditor:void 0,suppressLabel:u?a.suppressLabel:void 0,redirect:u?a.redirect:void 0,allowMultiConnection:u?a.allowMultiConnection:void 0}}),t=e.extendedOutputs||e.outputs||{},r=Object.entries(t).map(([o,a])=>{const u="type"in a&&typeof a.type=="object"&&"kind"in a.type,l=u?a.type:a;return{name:o,type:l,description:u?a.description:void 0,suppressLabel:u?a.suppressLabel:void 0}}),s={id:e.id,version:e.version||"1.0.0",displayName:e.displayName||e.id,aliases:e.aliases,definition:e,inputs:i,outputs:r,compileConfig:e.compileConfig,getDisplayLabel:e.getDisplayLabel,inspectInputs:e.inspectInputs,shouldRecompileOnConfigChange:e.shouldRecompileOnConfigChange,getChildren:e.getChildren,getRegion:e.getRegion};s.ui=e.ui,ii.register(s)}var x=(e=>(e.IO="IO",e.Math="Math",e.Logic="Logic",e.Data="Data",e.Functional="Functional",e.Core="Core",e.Custom="Custom",e.Utility="Utility",e.Debug="Debug",e))(x||{});const ri={kind:"record",fields:{domain:{kind:"array",element:R,size:2},range:{kind:"array",element:R,size:2},segments:{kind:"array",element:{kind:"record",fields:{id:{kind:"atomic",type:"string"},weight:R,curve:{kind:"record",fields:{type:{kind:"atomic",type:"string"},value:{...R,optional:!0},points:{kind:"array",element:{kind:"record",fields:{x:R,y:R}},optional:!0,size:"dynamic"}}}}},size:"dynamic"},envelopeNodes:{kind:"array",element:{kind:"record",fields:{id:{kind:"atomic",type:"string"},x:R,y:R}},optional:!0,size:"dynamic"}},hint:"curve"},si=(e,n)=>{const i=e.value,t=e.easing;if(!t||!t.segments||t.segments.length===0)return{result:i};const{domain:r,range:s,segments:o}=t,[a,u]=r,[l,d]=s;let f=(i-a)/(u-a);f=Math.max(0,Math.min(1,f));const p=o.reduce((M,I)=>M+I.weight,0)||1;let h=0,m=o[o.length-1],g=0,y=0;for(const M of o){const I=M.weight/p;if(f>=h&&f<=h+I){m=M,g=h,y=I;break}h+=I}const b=(f-g)/y;let _=0;const S=m.curve,A=S.type==="step"?S.value??2:1;switch(S.type){case"exponential":const M=Math.pow(10,-(S.value??0));_=Math.pow(b,M);break;case"linear":_=b;break;case"step":A<=1?_=0:_=Math.floor(b*A)/(A-1),b>=.999&&(_=1);break;case"sin":_=-(Math.cos(Math.PI*b)-1)/2;break;case"quad":_=b*b;break;case"points":if(S.points&&S.points.length>0){const I=S.points;if(b<=I[0].x)_=I[0].y;else if(b>=I[I.length-1].x)_=I[I.length-1].y;else for(let q=0;q<I.length-1;q++){const V=I[q],Z=I[q+1];if(b>=V.x&&b<=Z.x){const z=(b-V.x)/(Z.x-V.x);_=V.y+z*(Z.y-V.y);break}}}else _=b;break;default:_=b}return{result:l+_*(d-l)}},os=N({id:"curve.ease",version:"1.0.0",displayName:"Curve Ease",metadata:{category:x.Math,keywords:["curve","ease","envelope","shape"],description:"Applies a custom curve easing to the input value."},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0},easing:{type:{...ri,optional:!0},description:"Easing Curve Configuration",suppressInputEditor:!0}},outputs:{result:R},autoBroadcast:!0,inspectInputs:!0,compileConfig:e=>({fields:{easing:e?.easing??{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:0}}]}},untagged:[]}),execute:si}),as=N({id:"curve.ease4",version:"1.0.0",displayName:"Curve Ease 4",metadata:{category:x.Math,keywords:["curve","ease","envelope","shape","multi"],description:"Applies a custom 4-segment curve easing to the input value."},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0},easing:{type:{...ri,optional:!0},description:"Easing Curve Configuration",suppressInputEditor:!0,defaultValue:{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:.5}},{id:"s2",weight:1,curve:{type:"exponential",value:0}},{id:"s3",weight:1,curve:{type:"exponential",value:-.5}},{id:"s4",weight:1,curve:{type:"exponential",value:-1}}]}}},outputs:{result:R},autoBroadcast:!0,inspectInputs:!0,compileConfig:e=>({fields:{easing:e?.easing??{domain:[0,1],range:[0,1],segments:[{id:"s1",weight:1,curve:{type:"exponential",value:.5}},{id:"s2",weight:1,curve:{type:"exponential",value:0}},{id:"s3",weight:1,curve:{type:"exponential",value:-.5}},{id:"s4",weight:1,curve:{type:"exponential",value:-1}}]}},untagged:[]}),execute:si});v(os);v(as);const us=(e,n,i,t)=>{const r=e.value??0,s=n?.config;if(!s||!s.envelopeNodes||s.envelopeNodes.length<2||!s.segments)return{result:r};const o=s.envelopeNodes,a=s.segments||[],u=o[0],l=o[o.length-1];if(r<=u.x)return{result:u.y};if(r>=l.x)return{result:l.y};let d=t.lastSegmentIndex||0;if(d>=o.length-1||r<o[d].x||r>=o[d+1].x){for(let b=0;b<o.length-1;b++)if(r>=o[b].x&&r<o[b+1].x){d=b;break}}t.lastSegmentIndex=d;const f=o[d],p=o[d+1],h=a[d],m=(r-f.x)/(p.x-f.x);let g=m;if(h&&h.curve){const b=h.curve.type||"linear",_=h.curve.value||0;if(b==="linear")g=m;else if(b==="exponential"){const S=Math.pow(10,-(_??0)),A=Math.max(0,m);g=Math.pow(A,S)}}return{result:f.y+(p.y-f.y)*g}},ls=N({id:"curve.env",version:"1.0.0",displayName:"Curve Envelope",metadata:{category:"Curve",keywords:["envelope","automation","ramp"],description:"User-editable curve envelope"},inputs:{value:{type:R,description:"Input value (0-1)",defaultValue:0}},outputs:{result:{type:R,description:"Output value"}},config:{config:{kind:"atomic",type:"any",defaultValue:{}}},inspectInputs:!0,createState:()=>({lastSegmentIndex:0}),autoBroadcast:!0,compileConfig:e=>({config:e.config??e.curveData??e.values?.config??{domain:[0,1],range:[0,1],envelopeNodes:[{id:"n1",x:0,y:0},{id:"n2",x:1,y:1}],segments:[{id:"s1",weight:1,curve:{type:"linear"}}]}}),execute:us});v(ls);const cs={value:{type:R,defaultValue:0},start:{type:R,defaultValue:0},end:{type:R,defaultValue:1,optional:!0},length:{type:R,defaultValue:1,optional:!0}},ds=N({id:"curve.crop",version:"1.0.0",displayName:"Curve Crop",metadata:{category:"Curve",keywords:["crop","slice","remap","linear"],description:"Linear mapping from 0-1 to start-end range."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-end"}},computeForwardPorts:(e,n,i)=>{const t=n.mode||"start-end",r={value:{...R,description:"Input value (0-1)",defaultValue:0},start:{...R,description:"Output at 0",defaultValue:0}};return t==="start-length"?r.length={...R,description:"Length of crop",defaultValue:1}:r.end={...R,description:"Output at 1",defaultValue:1},{inputs:{kind:"record",fields:r},outputs:{kind:"record",fields:{result:R}}}},inputs:cs,outputs:{result:{type:R}},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}]}]}},compileConfig:e=>({mode:e.mode||"start-end"}),autoBroadcast:!0,inspectInputs:!0,execute:(e,n,i)=>{const t=n.mode||"start-end",r=e.start??0,s=e.value??0;let o;if(t==="start-length"){const l=e.length??1;o=r+l}else o=e.end??1;o<r&&(o=r);let a=0;const u=o-r;if(u<1e-6)a=s>=r?1:0;else{const l=(s-r)/u;a=Math.max(0,Math.min(1,l))}return{outputs:{result:a},ui:{start:r,end:o}}},shouldRecompileOnConfigChange:e=>!0});v(ds);const c={kind:"atomic",type:"number",defaultValue:0},Vn={kind:"atomic",type:"string"},oi={kind:"atomic",type:"boolean"},L={kind:"atomic",type:"any"},ai={kind:"atomic",type:"string",options:["time","beats"],defaultValue:"time"},ps={kind:"record",fields:{type:Vn,channel:c,deviceId:{...Vn,optional:!0},time:{...c,optional:!0},note:{...c,optional:!0},velocity:{...c,optional:!0},cc:{...c,optional:!0},value:{...c,optional:!0}},hint:"midi"},k={kind:"array",size:"dynamic",element:ps,hint:"midi-stream"},yn={kind:"array",element:c,size:4,hint:"float4"},Pn={kind:"record",fields:{note:c,velocity:c},untagged:[]};({...Pn},{...Pn});const fs={kind:"record",fields:{noteIndex:L,velocity:c,hold:oi},untagged:[]},X={kind:"array",size:"dynamic",element:fs,hint:"step-sequence"},ui=N({id:"debug.scope",version:"1.0.0",displayName:"Scope",metadata:{category:x.Debug,keywords:["debug","scope","chart","visualize"],description:"Visualizes input values over time."},inputs:{value:{type:c,suppressLabel:!0,alwaysShowInputEditor:!0}},outputs:{value:c},config:{},inspectInputs:!0,execute:e=>({value:e.value}),compileConfig:e=>({})});v(ui);v(ui);class hs{execute(n,i){if(!n.rootId)return null;const t=new Map,r=s=>{if(t.has(s))return t.get(s);const o=n.nodes[s];if(!o)throw new Error(`Missing node ${s}`);const a=o.inputs.map(l=>r(l));let u;switch(o.op){case"const":u=o.params.value;break;case"input":u=i[o.params.key]!==void 0?i[o.params.key]:globalThis[o.params.key];break;case"add":u=a[0]+a[1];break;case"sub":u=a[0]-a[1];break;case"mul":u=a[0]*a[1];break;case"div":u=a[0]/a[1];break;case"prop":if(a[0]===void 0||a[0]===null)throw new Error(`Cannot access property '${o.params.key}' of undefined`);u=a[0][o.params.key];break;case"struct":u={},o.params.keys.forEach((l,d)=>{u[l]=a[d]});break;default:throw new Error(`Unknown op: ${o.op}`)}return t.set(s,u),u};return r(n.rootId)}}let xt=null;const ms=new hs,Kt=new Map;function Dn(e){if(Kt.has(e))return Kt.get(e);if(!xt)return console.warn("Expression Compiler not loaded yet. Returning empty graph."),{nodes:{},rootId:null};try{const n=xt.compiler.compile(e);return Kt.set(e,n),n}catch(n){return console.error("Compilation failed:",n),{nodes:{},rootId:null}}}const vs=[{type:"string",label:"Expression",path:"code",placeholder:"e.g. sin(time) * 0.5"}],ys=N({id:"logic.expression",version:"1.0.0",displayName:"Expression",metadata:{category:x.Logic,keywords:["expression","math","script","code"],description:"Evaluates a mathematical expression."},inputs:{},config:{code:is,graph:j},outputs:{result:j},autoBroadcast:!1,ui:{inspector:{fields:vs}},loadCompileDeps:async()=>{if(!xt){const e=await import("./expr-compiler-CbE6jRbp.js");xt={compiler:new e.GraphCompiler}}},compileConfig:e=>{const n=e.code||"",i=Dn(n);return{code:n,graph:i}},computeForwardPorts:(e,n)=>{const i=n.code||"",t=Dn(i),r=new Set;for(const o of Object.values(t.nodes))o.op==="input"&&r.add(o.params.key);const s=Array.from(r).map(o=>[o,{...c,description:`Variable ${o}`}]);return{inputs:{kind:"record",fields:Object.fromEntries(s)},outputs:{kind:"record",fields:{result:{...L,description:"Result"}}}}},execute:(e,n,i)=>{const t=n.graph;if(!t||!t.rootId)return{result:0};const r={...e};try{return{result:ms.execute(t,r.fields||r)}}catch(s){return console.error("Execution failed:",s),{result:null}}}});v(ys);const gs=N({id:"gen.sawtooth",version:"1.0.0",displayName:"Sawtooth",metadata:{category:"Oscillator",keywords:["oscillator","sawtooth","ramp","lfo","generator"],description:"Generates a linear sawtooth wave (0.0 to 1.0) at the given frequency."},inputs:{freq:{type:c,defaultValue:1,range:[0,60],description:"Frequency in Hz"}},outputs:{out:c},autoBroadcast:!0,isRealtime:()=>!0,createState:()=>({phase:0}),execute:(e,n,i,t)=>{const r=e.freq,s=i.clock.dt;return r>=60-1e-6?{out:Math.random()}:(t.phase+=s*r,t.phase-=Math.floor(t.phase),{out:t.phase})}});v(gs);const K={IDLE:0,ATTACK:1,DECAY:2,SUSTAIN:3,RELEASE:4},_s=N({id:"gen.adsr",version:"1.0.0",displayName:"ADSR",metadata:{category:"Envelope",keywords:["envelope","adsr","modulation"],description:"Attack-Decay-Sustain-Release envelope generator triggered by MIDI."},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},inputs:{stream:{type:k,description:"MIDI Stream",allowMultiConnection:!0},attack:{type:c,defaultValue:.1,range:[0,5],description:"Attack Time (s)"},decay:{type:c,defaultValue:1,range:[0,5],description:"Decay Time (s)"},sustain:{type:c,defaultValue:.7,range:[0,1],description:"Sustain Level (0-1)"},release:{type:c,defaultValue:1,range:[0,5],description:"Release Time (s)"}},config:{mode:{kind:"atomic",type:"string",defaultValue:"D"}},ui:{inspector:{fields:[{label:"Mode",path:"mode",type:"tab-bar",options:[{label:"ADSR",value:"ADSR"},{label:"ADS",value:"ADS"},{label:"D",value:"D"}]}]}},compileConfig:e=>({mode:e.mode||e.values?.mode||"D"}),computeForwardPorts:(e,n)=>{const i=n.mode||"D",t={stream:k};return i==="ADSR"?(t.attack=c,t.decay=c,t.sustain=c,t.release=c):i==="ADS"?(t.attack=c,t.decay=c,t.sustain=c):i==="D"&&(t.decay=c),{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{value:c}}}},outputs:{value:{type:c,description:"Envelope Value (0-1)"}},isRealtime:()=>!0,shouldRecompileOnConfigChange:e=>!0,createState:()=>({phase:K.IDLE,value:0,time:0,activeNotes:0}),execute:(e,n,i,t)=>{const r=i.clock.dt,s=n.mode||"D",o=e.stream;let a=0,u=0,l=0,d=0;if(s==="D"?(a=0,u=Math.max(0,e.decay??.1),l=0,d=u):s==="ADS"?(a=Math.max(0,e.attack??.1),u=Math.max(0,e.decay??.1),l=Math.max(0,Math.min(1,e.sustain??.7)),d=u):(a=Math.max(0,e.attack??.1),u=Math.max(0,e.decay??.1),l=Math.max(0,Math.min(1,e.sustain??.7)),d=Math.max(0,e.release??.5)),Array.isArray(o))for(const f of o)f.type==="note_on"&&(f.velocity??0)>0?(t.activeNotes++,t.activeNotes===1&&(t.phase=K.ATTACK,t.value=0,t.time=0,a<=0&&(t.value=1,t.phase=K.DECAY,t.time=0,u<=0&&(t.value=l,t.phase=K.SUSTAIN)))):(f.type==="note_off"||f.type==="note_on"&&(f.velocity??0)===0)&&(t.activeNotes=Math.max(0,t.activeNotes-1));switch(t.activeNotes===0&&t.phase!==K.IDLE&&t.phase!==K.RELEASE&&(t.phase=K.RELEASE,t.time=0),t.phase){case K.IDLE:t.value=0,t.time=0;break;case K.ATTACK:t.time+=r,t.value+=1/Math.max(.001,a)*r,t.value>=1&&(t.value=1,t.phase=K.DECAY,t.time=0,u<=0&&(t.value=l,t.phase=K.SUSTAIN));break;case K.DECAY:t.time+=r,t.value-=(1-l)/Math.max(.001,u)*r,t.value<=l&&(t.value=l,t.phase=K.SUSTAIN,t.time=0);break;case K.SUSTAIN:t.time+=r,t.value=l;break;case K.RELEASE:t.time+=r,d<=0?(t.value=0,t.phase=K.IDLE,t.time=0):(t.value-=1/d*r,t.value<=0&&(t.value=0,t.phase=K.IDLE,t.time=0));break}return{outputs:{value:Math.max(0,Math.min(1,t.value))},ui:{value:t.value,phase:t.phase,time:t.time}}},inspectInputs:!0});v(_s);function bs(e){let r=e;return{next:()=>(r=(1103515245*r+12345)%2147483648,r/2147483647)}}const xs=N({id:"math.random",version:"1.1.0",displayName:"Random",metadata:{category:"Math",keywords:["random","stochastic","noise","seed","white"],description:"Generates a random number (0-1). Supports on-trigger or free-run modes."},inputs:{trigger:{type:k,description:"Trigger Signal",allowMultiConnection:!0}},config:{seed:{kind:"atomic",type:"number",defaultValue:12345},mode:{kind:"atomic",type:"string",defaultValue:"on-trigger"}},outputs:{value:{type:c,description:"Random Value"}},autoBroadcast:{trigger:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"On Trigger",value:"on-trigger"},{label:"Free Run",value:"free-run"}],default:"on-trigger"},{type:"number",label:"Seed",path:"seed",default:12345}]}},compileConfig:e=>({mode:e.mode||e.values?.mode||"on-trigger",seed:e.seed||e.values?.seed||12345}),computeForwardPorts:(e,n)=>{const i=n.mode||"on-trigger",t={};return i==="on-trigger"&&(t.trigger={type:k,description:"Trigger Signal",allowMultiConnection:!0}),{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{value:c}}}},isRealtime:e=>e.mode==="free-run",shouldRecompileOnConfigChange:e=>!0,createState:e=>{const i=e?.seed||12345,t=bs(i);return{generator:t,currentValue:t.next()}},execute:(e,n,i,t)=>{const r=n.mode||"on-trigger",s=e.trigger;if(r==="free-run")t.currentValue=t.generator.next();else if(Array.isArray(s))for(const o of s)o.type==="note_on"&&(o.velocity??0)>0&&(t.currentValue=t.generator.next());return{value:t.currentValue}}});v(xs);const Os=[{type:"string",label:"Device ID",path:"deviceId",placeholder:"Optional Device ID"}],Ss=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"CC",path:"cc",min:0,max:127,step:1},{type:"string",label:"Device ID",path:"deviceId",placeholder:"Optional Device ID"}],As=N({id:"midi.input",version:"1.0.0",displayName:"MIDI Input",metadata:{category:x.IO,keywords:["midi","input","source"],description:"Reads raw MIDI messages from a specific device."},inputs:{},config:{deviceId:{kind:"atomic",type:"string",optional:!0}},outputs:{stream:k},ui:{inspector:{fields:Os}},isRealtime:()=>!0,execute:(e,n,i)=>{const t=i.midi?.events,r=n.deviceId;return t&&r?{stream:t.filter(o=>o.deviceId===r)}:{stream:t||[]}},compileConfig:e=>({deviceId:e.deviceId})}),ws=N({id:"midi.cc.input",version:"1.0.0",displayName:"MIDI CC Input",metadata:{category:x.IO,keywords:["midi","cc","input"],description:"Reads a MIDI CC value directly from the environment."},inputs:{},config:{channel:c,cc:c,deviceId:{kind:"atomic",type:"string",optional:!0}},outputs:{value:c},ui:{inspector:{fields:Ss}},isRealtime:()=>!0,execute:(e,n,i)=>{const t=n.channel||1,r=n.cc||0;n.deviceId;const s=`${t}:${r}`;return{value:i.midi?.values.get(s)??0}},compileConfig:e=>({channel:e.channel??1,cc:e.cc??0,deviceId:e.deviceId})});v(As);v(ws);const Is=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"CC",path:"cc",min:0,max:127,step:1}],ks=N({id:"midi.cc",version:"1.0.0",displayName:"MIDI CC",metadata:{category:x.IO,keywords:["midi","cc","control change"],description:"Reads MIDI Control Change messages from a stream."},inputs:{stream:{type:k,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,cc:c},outputs:{value:c},ui:{inspector:{fields:Is}},createState:()=>({value:0}),execute:(e,n,i,t)=>{const r=n.channel||1,s=n.cc||0,o=e.stream||[];if(o&&Array.isArray(o))for(const a of o)a.type==="cc"&&a.channel===r&&a.cc===s&&(t.value=a.value??0);return{value:t.value}},compileConfig:e=>({channel:e.channel??1,cc:e.cc??0})});v(ks);const Ms=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Note",path:"note",min:0,max:127,step:1}],Ns=N({id:"midi.note",version:"1.0.0",displayName:"MIDI Note",metadata:{category:x.IO,keywords:["midi","note","keyboard"],description:"Reads MIDI Note messages from a stream."},inputs:{stream:{type:k,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,note:c},outputs:{note:{kind:"atomic",type:"number",optional:!0},velocity:c,gate:c},ui:{inspector:{fields:Ms}},createState:()=>({velocity:0,gate:0}),execute:(e,n,i,t)=>{const r=n.channel||1,s=n.note||60,o=e.stream||[];if(o&&Array.isArray(o))for(const a of o)a.channel===r&&(a.type==="note_on"&&a.note===s?(t.velocity=a.velocity??0,t.gate=1):a.type==="note_off"&&a.note===s&&(t.gate=0));return{note:t.gate?s:null,velocity:t.velocity,gate:t.gate}},compileConfig:e=>({channel:e.channel??1,note:e.note??60})});v(Ns);const Cs=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1},{type:"select",label:"Priority",path:"priority",options:[{label:"Last Note",value:"last"},{label:"Low Note",value:"low"},{label:"High Note",value:"high"}]}],Ts=N({id:"midi.to_mono",version:"1.0.0",displayName:"MIDI to Mono",metadata:{category:x.IO,keywords:["midi","mono","converter"],description:"Converts a polyphonic MIDI stream to a monophonic note signal."},inputs:{stream:{type:k,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{channel:c,rootNote:c,priority:{kind:"atomic",type:"string",optional:!0}},outputs:{note:{kind:"atomic",type:"number",optional:!0},velocity:c,gate:c,frequency:c},ui:{inspector:{fields:Cs}},createState:()=>({activeNotes:[],gate:0}),execute:(e,n,i,t)=>{const r=n.channel||1,s=n.rootNote??60,o=e.stream||[];if(t.activeNotes||(t.activeNotes=[]),o&&Array.isArray(o))for(const u of o)u.channel===r&&(u.type==="note_on"?(t.activeNotes=t.activeNotes.filter(l=>l.note!==u.note),t.activeNotes.push({note:u.note,velocity:u.velocity??0})):u.type==="note_off"&&(t.activeNotes=t.activeNotes.filter(l=>l.note!==u.note)));const a=t.activeNotes.length>0?t.activeNotes[t.activeNotes.length-1]:null;if(a){t.gate=1;const u=a.note-s,l=440*Math.pow(2,(a.note-69)/12);return{note:u,velocity:a.velocity,gate:1,frequency:l}}else return t.gate=0,{note:null,velocity:0,gate:0,frequency:0}},compileConfig:e=>({channel:e.channel??1,rootNote:e.rootNote??60,priority:e.priority??"last"})});v(Ts);const Es=[{type:"number",label:"Channel",path:"channel",min:1,max:16,step:1},{type:"number",label:"Note",path:"note",min:0,max:127,step:1}],Rs=N({id:"midi.filter",version:"1.0.0",displayName:"MIDI Filter",metadata:{category:x.IO,keywords:["midi","filter","note"],description:"Filters MIDI events, allowing only specific Note On/Off messages through."},inputs:{stream:{type:k,allowMultiConnection:!0},channel:{type:c,description:"MIDI Channel (1-16)",defaultValue:1},note:{type:c,description:"Note Number (0-127)",defaultValue:60}},config:{},outputs:{stream:k},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:Es}},execute:(e,n)=>{const i=e.channel??1,t=e.note??60,r=e.stream||[],s=[];if(r&&Array.isArray(r))for(const o of r)o.channel===i&&(o.type==="note_on"||o.type==="note_off")&&o.note===t&&s.push(o);return{stream:s}},compileConfig:e=>({channel:e.channel??1,note:e.note??60})});v(Rs);const Vs=N({id:"midi.pitch",version:"1.0.0",displayName:"MIDI Pitch",metadata:{category:x.IO,keywords:["midi","pitch","transpose","shift"],description:"Transposes MIDI Note events by a specified amount."},inputs:{stream:{type:k,allowMultiConnection:!0},pitch:{type:c,description:"Pitch shift amount (semitones)",defaultValue:0,range:[-24,24]}},config:{},outputs:{stream:k},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},execute:(e,n)=>{const i=e.pitch??0,t=e.stream||[];return!t||!Array.isArray(t)?{stream:[]}:{stream:t.map(s=>{if(s.type==="note_on"||s.type==="note_off"){const o=Math.max(0,Math.min(127,Math.floor(s.note+i)));return{...s,note:o}}return s})}},compileConfig:e=>({pitch:e.pitch??0})});v(Vs);const Ps=N({id:"midi.trigger",version:"1.0.0",displayName:"MIDI Trigger",metadata:{category:x.IO,keywords:["midi","trigger","bang","button"],description:"Manually sends a Middle C Note On/Off pair when triggered."},inputs:{trigger:{type:c,description:"Trigger Signal",suppressInputEditor:!0}},config:{pitch:{...c,defaultValue:60},velocity:{...c,defaultValue:1,range:[0,1]},trigger:c},outputs:{stream:k},createState:()=>({lastTrigger:0,initialized:!1}),execute:(e,n,i,t)=>{const r=n.pitch||60,s=n.velocity||1,o=e.trigger||0;i.clock.dt;const a=[];return t.initialized?(o>t.lastTrigger&&(a.push({type:"note_on",channel:1,note:r,velocity:s,deviceId:"virtual",time:0}),a.push({type:"note_off",channel:1,note:r,velocity:0,deviceId:"virtual",time:0}),i.markSelfDirty&&i.markSelfDirty()),t.lastTrigger=o,{stream:a}):(t.lastTrigger=o,t.initialized=!0,{stream:a})},compileConfig:e=>({pitch:e.pitch??60,velocity:e.velocity??1,trigger:e.trigger}),ui:{inspector:{fields:[{type:"button",label:"Trigger",path:"trigger",text:"Bang"},{type:"number",label:"Pitch",path:"pitch",min:0,max:127,step:1,default:60},{type:"number",label:"Velocity",path:"velocity",min:0,max:1,step:.01,default:1}]}}});v(Ps);const Ds=N({id:"midi.merge",version:"1.0.0",displayName:"MIDI Merge",metadata:{category:x.IO,keywords:["midi","merge","combine","mix"],description:"Merges multiple MIDI streams into one using auto-broadcast."},inputs:{stream:{type:k,description:"Input Streams",allowMultiConnection:!0}},outputs:{stream:k},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{},execute:(e,n,i)=>({stream:e.stream||[]}),compileConfig:()=>({})});v(Ds);const js=N({id:"midi.select",version:"1.0.0",displayName:"MIDI Select",metadata:{category:x.IO,keywords:["midi","select","router","switch","demux"],description:"Routes MIDI events to different ports based on note pitch."},inputs:{stream:{type:k,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},config:{count:{...c,defaultValue:4},root:{...c,defaultValue:60},skip:{...c,defaultValue:1}},outputs:{},dynamicOutputType:k,isRealtime:()=>!0,computeForwardPorts:(e,n,i)=>{const t=n.count||4,r={};for(let s=0;s<t;s++)r[s.toString()]={...k,hint:"midi-stream",description:`Offset ${s}`};return r.rem={...k,hint:"midi-stream",description:"Remainder"},{inputs:{kind:"record",fields:{stream:k}},outputs:{kind:"record",fields:r}}},shouldRecompileOnConfigChange:e=>!0,execute:(e,n,i)=>{const t=e.stream||[],r=n.count||4,s=n.root||60,o=n.skip||1,a={};for(let u=0;u<r;u++)a[u.toString()]=[];if(a.rem=[],t&&Array.isArray(t)){for(const u of t)if(u.type==="note_on"||u.type==="note_off"){const l=u.note-s;if(l>=0&&l%o===0){const d=l/o;if(d>=0&&d<r){a[d.toString()].push(u);continue}}a.rem.push(u)}}return{...a}},compileConfig:e=>({count:e.count??4,root:e.root??60,skip:e.skip??1}),ui:{inspector:{fields:[{type:"number",label:"Output Count",path:"count",min:1,max:128,step:1,default:4},{type:"number",label:"Root Note",path:"root",min:0,max:127,step:1,default:60},{type:"number",label:"Skip (Semitones)",path:"skip",min:1,max:24,step:1,default:1}]}}});v(js);const Ls=N({id:"midi.onchange",version:"1.0.0",displayName:"MIDI On Change",metadata:{category:x.IO,keywords:["midi","trigger","change","delta"],description:"Triggers a note when input value changes."},inputs:{value:{type:j,description:"Input Value"}},config:{rootNote:{...c,defaultValue:60}},outputs:{stream:k},ui:{inspector:{fields:[{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1,default:60}]}},isRealtime:()=>!0,createState:()=>({lastValue:void 0}),execute:(e,n,i,t)=>{const r=e.value,s=n.rootNote??60,o=[];let a=!1;return typeof r=="number"&&typeof t.lastValue=="number"?Math.abs(r-t.lastValue)>1e-5&&(a=!0):r!==t.lastValue&&(a=!0),a?(o.push({type:"note_on",note:s,velocity:1,channel:1,time:0,deviceId:"onchange"}),o.push({type:"note_off",note:s,velocity:0,channel:1,time:0,deviceId:"onchange"}),t.lastValue=r):t.lastValue===void 0&&r!==void 0&&(t.lastValue=r),{stream:o}},compileConfig:e=>({rootNote:e.rootNote??60})});v(Ls);const li={};for(let e=1;e<=16;e++)li[`w${e}`]={type:c,defaultValue:1,optional:!0,description:`Weight ${e}`};const Bs=N({id:"midi.onrange",version:"1.0.0",displayName:"MIDI On Range",metadata:{category:x.IO,keywords:["midi","trigger","range","zone"],description:"Triggers notes based on value position in weighted zones."},inputs:{value:{type:c,description:"Input Value"},start:{type:c,defaultValue:0},end:{type:c,defaultValue:1},...li},config:{rootNote:{...c,defaultValue:60,description:"Root Note"},zoneCount:{...c,defaultValue:1,description:"Number of Zones"},noteSkip:{...c,defaultValue:1}},outputs:{stream:k},ui:{inspector:{fields:[{type:"number",label:"Root Note",path:"rootNote",min:0,max:127,step:1,default:60},{type:"number",label:"Zone Count",path:"zoneCount",min:1,max:16,step:1,default:1},{type:"number",label:"Note Skip",path:"noteSkip",min:1,max:12,step:1,default:1}]}},isRealtime:()=>!0,createState:()=>({activeZoneIndex:null}),computeForwardPorts:(e,n)=>{const i=n.zoneCount??1,t={value:{...c},start:{...c,defaultValue:0},end:{...c,defaultValue:1}};if(i>1)for(let r=1;r<=i;r++)t[`w${r}`]={...c,defaultValue:1,description:`Weight ${r}`};return{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{stream:k}}}},shouldRecompileOnConfigChange:()=>!0,execute:(e,n,i,t)=>{const r=e.value??0,s=e.start??0,o=e.end??1,a=n.rootNote??60,u=n.zoneCount??1,l=n.noteSkip??1;let d=s,f=o;f<d&&(f=s,d=o);const p=[];if(r>=d&&r<=f){let h=0;if(u>1){const m=[];let g=0;for(let y=1;y<=u;y++){let _=e[`w${y}`];_&&typeof _=="object"&&"value"in _&&(_=_.value),_=_??1,typeof _!="number"&&(_=1),m.push(_),g+=_}if(g<=0)h=0;else{const y=f-d,_=(y===0?0:(r-d)/y)*g;let S=0;for(let A=0;A<u;A++)if(S+=m[A],_<=S){h=A;break}h>=u&&(h=u-1)}}else h=0;if(t.activeZoneIndex===null){const m=a+h*l;p.push({type:"note_on",note:m,velocity:1,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=h}else if(t.activeZoneIndex!==h){const m=a+t.activeZoneIndex*l;p.push({type:"note_off",note:m,velocity:0,channel:1,time:0,deviceId:"onrange"});const g=a+h*l;p.push({type:"note_on",note:g,velocity:1,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=h}}else if(t.activeZoneIndex!==null){const h=a+t.activeZoneIndex*l;p.push({type:"note_off",note:h,velocity:0,channel:1,time:0,deviceId:"onrange"}),t.activeZoneIndex=null}return{stream:p}},compileConfig:e=>({rootNote:e.rootNote??60,zoneCount:e.zoneCount??1,noteSkip:e.noteSkip??1})});v(Bs);const ci={type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Time",value:"time"},{label:"Beats",value:"beats"}],default:"time"},qs={type:"tab-bar",label:"Beat Denom",path:"beatDenom",options:[{label:"1/64",value:.015625},{label:"1/32",value:.03125},{label:"1/16",value:.0625},{label:"1/8",value:.125},{label:"1/4",value:.25},{label:"1/2",value:.5},{label:"1/1",value:1}],default:.25},Fs=[ci],$s=N({id:"midi.delay",version:"1.0.0",displayName:"MIDI Delay",metadata:{category:x.Utility,keywords:["midi","delay","time","beats"],description:"Delays MIDI events by a specified duration."},inputs:{stream:{type:k,allowMultiConnection:!0},duration:{...c,defaultValue:.25}},config:{mode:{...ai,defaultValue:"time"}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},outputs:{stream:k},ui:{inspector:{fields:Fs}},isRealtime:()=>!0,createState:()=>({queue:[]}),execute:(e,n,i,t)=>{const r=e.stream||[],s=e.duration||0,o=n.mode||"time";let a=0;if(o==="beats"?a=i.clock.beat:a=i.time||0,t.queue||(t.queue=[]),r&&Array.isArray(r))for(const d of r)t.queue.push({event:d,releaseTime:a+s});const u=[],l=[];for(const d of t.queue)d.releaseTime<=a?u.push(d.event):l.push(d);return t.queue=l,{stream:u}},compileConfig:e=>({mode:e.mode??"time"})});v($s);const Us=N({id:"midi.istrigger",version:"1.0.0",displayName:"MIDI Is Trigger",metadata:{category:x.Logic,keywords:["midi","check","trigger","gate"],description:"Outputs 1 if the stream contains any Note On event, 0 otherwise."},inputs:{stream:{type:k,allowMultiConnection:!0}},autoBroadcast:{stream:{combine:{reduce:"flatten"}}},outputs:{result:c},createState:()=>({}),execute:(e,n,i,t)=>{const r=e.stream||[];let s=0;if(r&&Array.isArray(r)){for(const o of r)if(o.type==="note_on"){s=1;break}}return{result:s}}});v(Us);const zs=[ci,qs,{type:"number",label:"Note",path:"note",min:0,max:127,default:60}],Gs=N({id:"midi.metronome",version:"1.0.0",displayName:"Metronome",metadata:{category:x.Utility,keywords:["midi","metronome","clock","beat","trigger"],description:"Generates MIDI note events at regular intervals."},inputs:{duration:{...c,defaultValue:1,description:"Interval duration (seconds or beats)",min:0,max:4}},config:{mode:{...ai,defaultValue:"time"},beatDenom:{...c,defaultValue:.25},note:{...c,defaultValue:60}},outputs:{stream:k},ui:{inspector:{fields:zs}},isRealtime:()=>!0,createState:()=>({lastTriggerTime:-99999,noteActive:!1}),execute:(e,n,i,t)=>{const r=e.duration||1,s=n.mode||"time",o=n.beatDenom||.25,a=n.note||60;let u=0,l=r;s==="beats"?(u=i.clock.beat,l=Math.round(r)*o*4,l<=0&&(l=o)):u=i.time||0;const d=[];if(t.lastTriggerTime===-99999)return t.lastTriggerTime=u,{stream:[]};const f=t.lastTriggerTime,p=Math.floor(f/l),m=Math.floor(u/l)-p;for(let g=1;g<=m;g++)d.push({type:"note_on",deviceId:"metronome",channel:1,note:a,velocity:1,time:0}),d.push({type:"note_off",deviceId:"metronome",channel:1,note:a,velocity:0,time:0});return t.lastTriggerTime=u,{stream:d}},compileConfig:e=>({mode:e.mode??"time",beatDenom:e.beatDenom??.25,note:e.note??60})});v(Gs);const Ks=N({id:"time.time",version:"1.0.0",displayName:"Time",metadata:{category:x.Utility,keywords:["time","seconds","clock"],description:"Outputs the current execution time in seconds."},inputs:{},outputs:{time:c,delta:c},isRealtime:()=>!0,execute:(e,n,i)=>({time:i.time||0,delta:i.clock.dt||0})}),Hs=N({id:"time.beat",version:"1.0.0",displayName:"Beat",metadata:{category:x.Utility,keywords:["beat","bar","clock","tempo"],description:"Outputs the current beat number."},inputs:{},outputs:{beat:c,delta:c},isRealtime:()=>!0,createState:()=>({lastBeat:-1}),execute:(e,n,i,t)=>{const r=i.clock.beat||0;let s=0;return t.lastBeat>=0&&(s=r-t.lastBeat),t.lastBeat=r,{beat:r,delta:s}}});v(Ks);v(Hs);const Ot={kind:"atomic",type:"number"},Ht=16,Ws=[{type:"number",label:"Target Note",path:"targetNote"}],Ys=N({id:"nicepattern.rhythmic_generator",version:"1.0.0",displayName:"Rhythmic Generator",metadata:{category:"NicePattern",keywords:["rhythm","generator","sequence","euclidean"],description:"Generates a rhythmic sequence based on density."},config:{targetNote:c},inputs:{density:{...c,defaultValue:.5}},outputs:{seq_out:X},ui:{inspector:{fields:Ws}},execute:(e,n,i)=>{const t=n.targetNote||60,r=e.density??.5,s=[],o=Math.round(r*Ht);for(let a=0;a<Ht;a++)a*o%Ht<o?s.push({noteIndex:t,velocity:1,hold:!1}):s.push({noteIndex:null,velocity:0,hold:!1});return{seq_out:s}},compileConfig:e=>({targetNote:e.targetNote??60})});v(Ys);class St{constructor(n){this.state=n}next(){let n=this.state+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}nextRange(n,i){return Math.floor(this.next()*(i-n+1))+n}}const Xs=16,Zs=[{type:"number",label:"Min Note",path:"minNote"},{type:"number",label:"Max Note",path:"maxNote"},{type:"number",label:"Seed",path:"seed"}],Js=N({id:"nicepattern.chaos_generator",version:"1.0.0",displayName:"Chaos Generator",metadata:{category:"NicePattern",keywords:["chaos","random","generator","sequence","stochastic"],description:"Generates a random sequence of notes."},config:{minNote:c,maxNote:c,seed:c},inputs:{density:{...c,defaultValue:.5}},outputs:{seq_out:X},ui:{inspector:{fields:Zs}},execute:(e,n,i)=>{const{minNote:t,maxNote:r,seed:s}=n,o=e.density??.5,a=new St(s??12345),u=[];for(let l=0;l<Xs;l++)if(a.next()<o){const d=a.nextRange(t||60,r||60);u.push({noteIndex:d,velocity:a.next()*.5+.5,hold:!1})}else u.push({noteIndex:null,velocity:0,hold:!1});return{seq_out:u}},compileConfig:e=>({minNote:e.minNote??60,maxNote:e.maxNote??60,seed:e.seed??12345})});v(Js);class dt{constructor(n){this.config=n,this.output=0,this.lastActive=!1}update(n,i,t){let s=n.noteIndex!==null&&n.noteIndex!==void 0;if(s){let o=!1;this.lastActive?t&&!n.hold&&(this.onRelease(),o=!0):o=!0,o&&this.onTrigger(n.velocity,n.noteIndex)}else this.lastActive&&this.onRelease();this.process(s,n,i),this.lastActive=s}forceRelease(){this.onRelease(),this.lastActive=!1,this.output=0}getValue(){return this.output}}class Qs extends dt{onTrigger(n,i){this.output=n}onRelease(){this.output=0}process(n){n&&this.output===0&&(this.output=1)}previewSequence(n,i){return n.map(t=>t.noteIndex!==null&&t.noteIndex!==void 0?t.velocity:0)}}class eo extends dt{constructor(n,i=.96){super(n),this.decayRate=.96,this.decayRate=i}onTrigger(n,i){this.output=n}onRelease(){this.output=0}process(n,i){n&&(this.output*=this.decayRate)}previewSequence(n,i){const t=[];let r=0,s=!1;for(const o of n){const a=o.noteIndex!==null&&o.noteIndex!==void 0;a&&!s?r=o.velocity:!a&&s&&(r=0),a&&(r*=this.decayRate),t.push(r),s=a}return t}}class to extends dt{constructor(){super(...arguments),this.phase=0,this.duty=.5,this.freq=.2}onTrigger(n,i){this.duty=.5}onRelease(){}process(n,i,t){if(!n){this.output*=.85;return}this.duty*=.98,this.phase+=this.freq,this.phase>1&&(this.phase-=1),this.output=this.phase<this.duty?1:0}previewSequence(n,i){const t=[];let r=0,s=0,o=.5,a=!1;for(const u of n){const l=u.noteIndex!==null&&u.noteIndex!==void 0;l&&!a&&(o=.5),l?(o*=.98,s+=this.freq,s>1&&(s-=1),r=s<o?1:0):r*=.85,t.push(r),a=l}return t}}class no extends dt{onTrigger(n,i){}onRelease(){this.output*=.85}process(n){n?this.output=Math.random():this.output*=.85}previewSequence(n,i){const t=[];let r=0,s=!1;const a=(u=>()=>{u|=0,u=u+1831565813|0;var l=Math.imul(u^u>>>15,1|u);return l=l+Math.imul(l^l>>>7,61|l)^l,((l^l>>>14)>>>0)/4294967296})(12345);for(const u of n){const l=u.noteIndex!==null&&u.noteIndex!==void 0;!l&&s&&(r*=.85),l?r=a():r*=.85,t.push(r),s=l}return t}}class Wt extends dt{constructor(n,i,t){super(n),this.osc=null,this.gain=null,this.filter=null,this.ctx=i,this.frequency=t??440}get audioContext(){return this.ctx}set audioContext(n){this.ctx=n}safeParam(n,i,t){if(Number.isFinite(i)&&Number.isFinite(t))try{n.setValueAtTime(i,t)}catch{}}initVoice(n,i){if(!this.ctx||this.ctx.state==="suspended")return;this.cleanup(),this.osc=this.ctx.createOscillator(),this.gain=this.ctx.createGain(),this.filter=this.ctx.createBiquadFilter();const t=Number.isFinite(this.frequency)&&this.frequency>0?this.frequency:440;this.safeParam(this.osc.frequency,t,n),this.filter.type="lowpass";const r=800+i*2e3;this.safeParam(this.filter.frequency,r,n),this.safeParam(this.gain.gain,0,n);try{this.gain.gain.linearRampToValueAtTime(i,n+.005),this.gain.gain.setTargetAtTime(0,n+.005,.1)}catch{}this.osc.connect(this.filter),this.filter.connect(this.gain),this.gain.connect(this.ctx.destination),this.osc.start(n)}retirePreviousVoice(n){if(!this.osc||!this.gain||!this.filter)return;const i=this.osc,t=this.gain,r=this.filter;this.osc=null,this.gain=null,this.filter=null;try{try{t.gain.cancelAndHoldAtTime(n)}catch{t.gain.cancelScheduledValues(n),this.safeParam(t.gain,t.gain.value,n)}t.gain.linearRampToValueAtTime(0,n+.005);const o=n+.005+.01;i.stop(o),i.onended=()=>{i.disconnect(),r.disconnect(),t.disconnect(),i.dispose?.(),r.dispose?.(),t.dispose?.()}}catch{i.disconnect(),r.disconnect(),t.disconnect()}}cleanup(){this.retirePreviousVoice(this.ctx?.currentTime??0)}onTrigger(n,i){if(this.ctx?.state!=="suspended"){if(i!=null){const t=440*Math.pow(2,(i-69)/12);Number.isFinite(t)&&(this.frequency=t)}this.initVoice(this.ctx?.currentTime??0,n)}}onRelease(){if(this.ctx?.state!=="suspended"&&this.gain){const n=this.ctx?.currentTime??0;try{this.gain.gain.cancelAndHoldAtTime(n)}catch{this.gain.gain.cancelScheduledValues(n),this.safeParam(this.gain.gain,this.gain.gain.value,n)}try{this.gain.gain.linearRampToValueAtTime(0,n+.005)}catch{}if(this.osc)try{this.osc.stop(n+.01)}catch{}}}process(n,i){n&&i.hold&&this.osc}previewSequence(n,i){const t=[];let r=!1;for(const s of n){const o=s.noteIndex!==null&&s.noteIndex!==void 0;o&&!r?t.push(s.velocity):t.push(0),r=o}return t}}function Rt(e,n,i){return N({id:e,version:"1.0.0",displayName:n,metadata:{category:"NicePattern",keywords:["layer","effect","modifier"],description:`Layer node: ${n}`},config:{},inputs:{midi_in:{type:k,description:"Input MIDI stream",allowMultiConnection:!0},prev_layer:{type:Ot,description:"Previous layer output"}},outputs:{out:Ot},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[]}},isRealtime:()=>!0,createState:(t,r)=>({layer:new i({}),lastActive:!1,activeVelocity:0,activeNote:null}),execute:(t,r,s,o)=>{const a=o.layer,u=t.midi_in||[];for(const p of u)p.type==="note_on"?(o.lastActive=!0,o.activeVelocity=p.velocity,o.activeNote=p.note):p.type==="note_off"&&o.activeNote===p.note&&(o.lastActive=!1,o.activeNote=null);const l={noteIndex:o.lastActive?o.activeNote??60:null,velocity:o.activeVelocity,hold:!1},d=u.some(p=>p.type==="note_on");return a.update(l,s.clock.dt,d),{out:a.getValue()}},compileConfig:t=>({})})}const io=Rt("nicepattern.gate_layer","Gate Layer",Qs),ro=Rt("nicepattern.exp_layer","Exponential Layer",eo),so=Rt("nicepattern.pwm_layer","PWM Layer",to),oo=Rt("nicepattern.noise_layer","Noise Layer",no);v(io);v(ro);v(so);v(oo);const ao=N({id:"nicepattern.tone_synth_layer",version:"1.0.0",displayName:"Tone Synth Layer",metadata:{category:"NicePattern",keywords:["synth","audio","sound","tone"],description:"Simple synthesizer layer using Tone.js."},config:{},inputs:{midi_in:{type:k,description:"Input MIDI stream",allowMultiConnection:!0},prev_layer:{type:Ot,description:"Previous layer output"}},outputs:{out:Ot},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:[]}},isRealtime:()=>!0,createState:(e,n)=>({layer:new Wt({}),lastActive:!1,lastActiveNote:null,activeVelocity:0,contextId:""}),execute:(e,n,i,t)=>{const r=i.audio?.context;t.layer||(t.layer=new Wt({})),r&&t.contextId!==r.contextId&&(t.layer=new Wt({}),t.contextId=r.contextId);const s=t.layer,o=e.midi_in||[];let a=!1;for(const d of o)d.type==="note_on"?(t.lastActive=!0,t.lastActiveNote=d.note,t.activeVelocity=d.velocity,a=!0):d.type==="note_off"&&t.lastActiveNote===d.note&&(t.lastActive=!1,t.lastActiveNote=null);const u={noteIndex:t.lastActive?t.lastActiveNote:null,velocity:t.activeVelocity,hold:!1};return s.audioContext||(i.audio?.context?s.audioContext=i.audio.context:typeof window<"u"&&(s.audioContext=new(window.AudioContext||window.webkitAudioContext))),s.update(u,i.clock.dt,a),{out:s.getValue()}},compileConfig:e=>({})});v(ao);function di(e){if(e===1)return[[0]];const n=di(e/2),i=[];for(let t=0;t<n.length;t++)i.push([...n[t],...n[t]]);for(let t=0;t<n.length;t++)i.push([...n[t],...n[t].map(r=>1-r)]);return i}function jn(e){let n=0;for(let i=0;i<e.length-1;i++)e[i]!==e[i+1]&&n++;return n}function uo(e,n){const i=di(8).sort((a,u)=>jn(a)-jn(u));i[0]=[1,1,1,1,1,1,1,1];const t=[0,1,2,3,4,5,6,7],r=new St(n);for(let a=t.length-1;a>0;a--){const u=r.nextRange(0,a);[t[a],t[u]]=[t[u],t[a]]}const s=Math.max(2,Math.min(8,e));return i.slice(0,s).map(a=>{const u=new Array(8);for(let l=0;l<8;l++)u[l]=a[t[l]];return u})}const lo=[{type:"number",label:"Seed",path:"seed",step:1}],co=N({id:"nicepattern.orthomod",version:"1.0.0",displayName:"Orthomod",metadata:{category:"NicePattern",keywords:["envelope","modulation","orthogonal","hadamard"],description:"Orthogonal code-based envelope generator."},config:{seed:c},inputs:{midi_in:{type:k,description:"Trigger Input",allowMultiConnection:!0},decay:{type:c,defaultValue:1.2,description:"Decay Time (s)",range:[0,4],step:.01},curve:{type:c,defaultValue:1.5,description:"Response Curve",range:[.1,4],step:.1},relcurve:{type:c,defaultValue:12,description:"Release Curve",range:[.1,20],step:.1},resolution:{type:c,defaultValue:8,range:[2,8],step:1,description:"Codebook Size"},manual_phase:{type:c,defaultValue:-1,description:"Manual Phase Override (0-1)",suppressInputEditor:!0}},outputs:{env:{type:c,description:"Envelope Output (0-1)"},vec:{type:yn,description:"Channel Values [c1, c2, c3, c4]"},ch1:{type:c,description:"Channel 1"},ch2:{type:c,description:"Channel 2"},ch3:{type:c,description:"Channel 3"},ch4:{type:c,description:"Channel 4"}},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:lo}},isRealtime:()=>!0,createState:()=>({linearEnv:0,gateOpen:!1,active:!1,codes:[],lastSeed:-1,lastResolution:-1,currentEffectiveCurve:1.5,phase:0}),execute:(e,n,i,t)=>{const r=i.clock.dt;t.phase+=r;const s=t.phase,o=e.decay,a=typeof o=="number"&&Number.isFinite(o)?Math.max(.001,o):1.2,u=e.curve,l=typeof u=="number"&&Number.isFinite(u)?Math.max(.001,u):1.5,d=e.relcurve,f=typeof d=="number"&&Number.isFinite(d)?Math.max(.1,d):12,p=e.resolution,h=typeof p=="number"&&Number.isFinite(p)?Math.floor(Math.max(2,Math.min(8,p))):8,m=n.seed??12345,g=e.manual_phase,y=typeof g=="number"&&Number.isFinite(g)?g:-1;(m!==t.lastSeed||h!==t.lastResolution)&&(t.codes=uo(h,m),t.lastSeed=m,t.lastResolution=h);const b=(e.midi_in||[]).flat();for(const G of b)G.type==="note_on"?(t.linearEnv=1,t.gateOpen=!0,t.active=!0):G.type==="note_off"&&(t.gateOpen=!1);let _=0;y>=0?(t.linearEnv=Math.max(0,Math.min(1,y)),t.active=!0,t.currentEffectiveCurve=1):(t.active&&(t.linearEnv-=r/Math.max(.01,a),t.linearEnv<=0&&(t.linearEnv=0,t.active=!1)),!t.gateOpen&&t.active?t.currentEffectiveCurve=f:t.currentEffectiveCurve=l);const S=Math.max(0,t.linearEnv),A=t.currentEffectiveCurve;_=Math.pow(S,A),Number.isNaN(_)&&(_=0);let E=1-_;E=Math.max(0,Math.min(.999,E));const M=t.codes.length,I=Math.floor(E*M),q=t.codes[I]||t.codes[0],V=15,Z=s*V%1>.5?1:0,z=Math.abs(Math.sin(s*V*Math.PI*2)),$=[0,0,0,0],Ce=[0,0,0,0];if(t.active)for(let G=0;G<4;G++){const Ae=q[G*2]||0,we=q[G*2+1]||0;let ye=0;Ae===0&&we===0?ye=0:Ae===1&&we===1?ye=1:Ae===1&&we===0?ye=Z:Ae===0&&we===1&&(ye=z),Ce[G]=ye,$[G]=ye*_,Number.isNaN($[G])&&($[G]=0)}const J=G=>Number.isFinite(G)?G:0;return{outputs:{env:J(_),vec:$.map(J),ch1:J($[0]),ch2:J($[1]),ch3:J($[2]),ch4:J($[3])},ui:{codes:t.codes,env:J(_),vec:$.map(J),rawVec:t.active?Ce.map(J):[0,0,0,0],activeCodeIndex:I,gate:t.gateOpen?1:0}}},compileConfig:e=>({seed:e?.seed??12345})});v(co);const po=()=>({initialized:!1,contextId:"",masterGain:null,voices:[],lastRoot:-1}),fo=N({id:"nicepattern.tone4",version:"1.0.0",displayName:"Tone 4",metadata:{category:"NicePattern",keywords:["synth","additive","oscillator","audio"],description:"4-voice additive synth driven by vector input."},inputs:{vec:{type:yn,description:"Modulation Vector [c1, c2, c3, c4]"},root:{type:c,defaultValue:60,description:"Root Note (MIDI)",range:[0,127]},gain:{type:c,defaultValue:.5,description:"Master Volume"}},outputs:{},isRealtime:()=>!0,createState:po,execute:(e,n,i,t)=>{const r=i.audio?.context;if(!r||r.state==="suspended")return{};const s=r.currentTime;if(!t.initialized||t.contextId!==r.contextId){t.masterGain=r.createGain(),t?.masterGain?.connect(r.destination);const p=[1,1.5,2,3],h=["square","sawtooth","triangle","sine"];t.voices=p.map((m,g)=>{const y=r.createOscillator(),b=r.createGain();return y.type=h[g],y.connect(b),b.connect(t.masterGain),y.start(s),b.gain.setValueAtTime(0,s),{osc:y,gain:b,freqRatio:m,wave:h[g]}}),t.initialized=!0,t.contextId=r.contextId,t.lastRoot=-1}const o=Math.max(0,Math.min(1,e.gain??.5));t.masterGain&&t.masterGain.gain.setTargetAtTime(o,s,.05);const a=e.root,u=typeof a=="number"&&Number.isFinite(a)?Math.floor(Math.max(0,Math.min(127,a))):69,l=440*Math.pow(2,(u-69)/12);Math.abs(l-t.lastRoot)>.01&&(t.voices.forEach(p=>{t.lastRoot===-1?p.osc.frequency.setValueAtTime(l*p.freqRatio,s):p.osc.frequency.setTargetAtTime(l*p.freqRatio,s,.05)}),t.lastRoot=l);const d=e.vec,f=Array.isArray(d)&&d.length===4?d:[0,0,0,0];return t.voices.forEach((p,h)=>{const m=Math.max(0,Math.min(1,f[h]??0));p.gain.gain.setTargetAtTime(m,s,.02)}),{}}});v(fo);const H={gravity:800,magnetEpsilon:50,physicsRate:120,solverSteps:16,sphereCount:16,magnetRange:800,height:600};class Ln{constructor(n,i,t,r,s,o){this.id=n,this.radius=6+o.next()*8,this.mass=this.radius,this.restLength=20+Math.pow(o.next(),2)*150;const a=i*.1,u=i-a*2;this.x=a+u/(s-1)*r,this.y=t-this.restLength,this.vx=0,this.vy=0,this.isLatched=!1,this.tensionRatio=0,this.currentSpringForce=0,this.currentMagForce=0}update(n,i,t,r,s){this.currentMagForce=0,this.currentSpringForce=0,this.tensionRatio=0;const a=(i-this.restLength-this.y)*s.springK,l=s.gravity*this.mass+a;this.currentSpringForce=Math.max(0,l);const d=h=>{if(h>=H.magnetRange)return 0;const m=H.magnetEpsilon/(h*h+H.magnetEpsilon);return s.magnetStrength*m},f=d(0);if(r){const h=this.y-this.radius-t;if(this.isLatched||h<=2)if(f>l){this.isLatched=!0,this.y=t+this.radius,this.vy=0,this.currentMagForce=f,this.tensionRatio=Math.max(0,Math.min(1,l/f));return}else this.isLatched=!1}else this.isLatched=!1;let p=l;if(r&&!this.isLatched){const h=Math.max(0,this.y-this.radius-t),m=-d(h);this.currentMagForce=Math.abs(m),p+=m}this.vy+=p/this.mass*n,this.vy*=s.damping,this.y+=this.vy*n,this.y+this.radius>i&&(this.y=i-this.radius,this.vy*=-.5),this.y-this.radius<t&&(this.y=t+this.radius,r?this.vy<0&&(this.vy=0):this.vy*=-.6)}}const ho=[{type:"number",label:"Seed",path:"seed",step:1,min:0,max:999999}],mo=N({id:"nicepattern.magneto",version:"1.0.0",displayName:"Magneto",metadata:{category:"NicePattern",keywords:["envelope","physics","magnet","modulator"],description:"Physics-based magnetic envelope generator."},config:{seed:{...c,defaultValue:1337}},inputs:{midi_in:{type:k,description:"Trigger Input",allowMultiConnection:!0},attack:{type:c,defaultValue:.2,range:[.01,2],step:.01,description:"Attack Time (s)"},decay:{type:c,defaultValue:.25,range:[.01,2],step:.01,description:"Decay Time (s)"},sustain:{type:c,defaultValue:.6,range:[0,1],step:.01,description:"Sustain Level (0-1)"},release:{type:c,defaultValue:.3,range:[.01,5],step:.01,description:"Release Time (s)"},peak:{type:c,defaultValue:.9,range:[.1,1],step:.01,description:"Peak Level (0-1, inverted)"},mag_flux:{type:c,defaultValue:2e6,range:[1e5,4e6],step:1e4,description:"Magnet Strength"},spring_k:{type:c,defaultValue:25e3,range:[1e3,5e4],step:100,description:"Spring Stiffness"},damping:{type:c,defaultValue:.999,range:[.9,1],step:.001,description:"Damping Factor"}},outputs:{env:{type:c,description:"Envelope Output (Tension)"},vec:yn,ch1:{type:c,description:"Channel 1 (Tension)"},ch2:{type:c,description:"Channel 2 (Extension)"},ch3:{type:c,description:"Channel 3 (Spring Force)"},ch4:{type:c,description:"Channel 4 (Mag Force)"}},autoBroadcast:{midi_in:{combine:{reduce:"flatten"}}},ui:{inspector:{fields:ho}},isRealtime:()=>!0,createState:()=>{const e=[],i=H.height,t=new St(1337);for(let r=0;r<H.sphereCount;r++)e.push(new Ln(r,600,i,r,H.sphereCount,t));return{spheres:e,plateY:40,phase:"IDLE",sustainProgress:0,accumulator:0,lastGate:!1,isTouchingSim:!1,touchY:0}},onMessage:(e,n)=>{n.type==="manual_interaction"&&(e.isTouchingSim=n.active,typeof n.y=="number"&&(e.touchY=n.y))},execute:(e,n,i,t)=>{const r=i.clock.dt,s=e.midi_in||[];let o=t.lastGate;for(const P of s)P.type==="note_on"?o=!0:P.type==="note_off"&&(o=!1);const a=Math.max(.005,e.attack??.2),u=Math.max(.005,e.decay??.25),l=e.sustain??.6,d=Math.max(.005,e.release??.3),f=e.peak??.9,p=n.seed??1337,h=e.mag_flux??2e6,m=e.spring_k??25e3,g=e.damping??.999;if(t.currentSeed!==p||t.spheres.length===0){t.currentSeed=p;const P=new St(p);t.spheres=[];const pe=600,Gt=H.height;for(let Fe=0;Fe<H.sphereCount;Fe++)t.spheres.push(new Ln(Fe,pe,Gt,Fe,H.sphereCount,P))}const y=H.height,b=y*.95,_=y*.1,S=40,A=_+f*(b-_),E=_+l*(b-_),M=Math.min(1,.05/Math.max(.001,a)),I=Math.min(1,.02/Math.max(.001,u)),q=Math.min(1,.02/Math.max(.001,d));o&&!t.lastGate?(t.phase="ATTACK",t.sustainProgress=0):!o&&t.lastGate&&(t.phase="RELEASE",t.sustainProgress=0),t.lastGate=o,t.accumulator+=r;const V=1/H.physicsRate;let Z=!1,z=0;for(;t.accumulator>=V&&z<5;){t.accumulator-=V,z++;let P=S,pe=q;t.isTouchingSim?(t.phase="MANUAL",Z=!0,P=t.touchY,P=Math.max(S,Math.min(b,P)),pe=M,t.sustainProgress=0):o?((t.phase==="IDLE"||t.phase==="RELEASE"||t.phase==="MANUAL")&&(t.phase==="MANUAL"?t.phase="ATTACK":(t.phase="ATTACK",t.sustainProgress=0)),t.phase==="ATTACK"?(P=A,pe=M,Math.abs(t.plateY-A)<10&&(t.phase="DECAY")):t.phase==="DECAY"?(P=E,pe=I,Math.abs(t.plateY-E)<5&&(t.phase="SUSTAIN")):t.phase==="SUSTAIN"&&(P=E,pe=.1,t.sustainProgress+=(1-t.sustainProgress)*2*V),Z=!0):(t.phase="RELEASE",P=S,pe=q,Math.abs(t.plateY-S)<15?(Z=!1,t.phase="IDLE"):Z=!0);const Gt=P-t.plateY;t.plateY+=Gt*pe;const Fe=V/H.solverSteps,ts={gravity:H.gravity,springK:m,magnetStrength:h,damping:g};for(let Rn=0;Rn<H.solverSteps;Rn++)t.spheres.forEach(ns=>{ns.update(Fe,y,t.plateY,Z,ts)})}t.accumulator>V&&(t.accumulator=0);let $=0,Ce=0,J=0,G=0,Ae=0;t.spheres.forEach(P=>{P.isLatched&&(Ae++,$+=P.tensionRatio);const pe=Math.max(0,y-P.restLength-P.y);Ce+=pe,J+=P.currentSpringForce,G+=P.currentMagForce});const we=Ae>0?$/Ae:0,ye=Math.min(1,Ce/(y*H.sphereCount*.4)),Zr=H.sphereCount*m*y*.3,Jr=H.sphereCount*h,Tn=Math.min(1,J/Zr),En=Math.min(1,G/Jr),Qr=[we,ye,Tn,En],es={plateY:t.plateY,phase:t.phase,sustainProgress:t.sustainProgress,spheres:t.spheres.map(P=>({x:P.x,y:P.y,r:P.radius,l:P.isLatched,t:P.tensionRatio})),adsr:{attack:a,decay:u,sustain:l,release:d,peak:f},seed:p};return{outputs:{env:we,vec:Qr,ch1:we,ch2:ye,ch3:Tn,ch4:En},ui:es}},compileConfig:e=>({seed:e?.seed??1337})});v(mo);const Yt=16,vo=N({id:"seq.tomidi",version:"1.0.0",displayName:"To MIDI",metadata:{category:"Sequence",keywords:["pattern","sequencer","combiner","event","midi"],description:"Converts sequence(s) into a MIDI stream."},config:{},inputs:{seq_in:{type:X,description:"Input sequence(s)",allowMultiConnection:!0}},outputs:{midi_out:k},autoBroadcast:!0,reshape:"none",isRealtime:()=>!0,createState:()=>({sequenceStates:new Map}),execute:(e,n,i,t)=>{let s=e.seq_in||[];s.length===1&&Array.isArray(s[0])&&s[0].length>0&&Array.isArray(s[0][0])&&(s=s[0]);const o=[],l=(Math.floor(i.clock.beat*4)%Yt+Yt)%Yt,d=new Set;s.forEach((f,p)=>d.add(p)),t.sequenceStates.forEach((f,p)=>d.add(p));for(const f of d){const p=s[f];t.sequenceStates.has(f)||t.sequenceStates.set(f,{lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map});const h=t.sequenceStates.get(f);if(!p&&h.lastNoteIndex===null){t.sequenceStates.delete(f);continue}let m={noteIndex:null,velocity:0,hold:!1};if(p&&p[l]&&(m=p[l]),l!==h.lastStepIndex||!p||m.noteIndex!==h.lastNoteIndex){const g=h.lastNoteIndex,y=h.lastHold,b=m.noteIndex!==null&&m.noteIndex!==void 0,_=b&&m.noteIndex===g,S=g!==null&&(!_||!y),A=b&&(!_||!y);S&&g!==null&&(o.push({type:"note_off",note:g,velocity:0,channel:1,deviceId:"tomidi",time:0}),h.activeNotes.delete(g),h.lastNoteIndex=null,h.lastHold=!1),A&&m.noteIndex!==null?(o.push({type:"note_on",note:m.noteIndex,velocity:m.velocity,channel:1,deviceId:"tomidi",time:0}),h.activeNotes.set(m.noteIndex,m.velocity),h.lastNoteIndex=m.noteIndex,h.lastHold=m.hold):_&&y&&(h.lastHold=m.hold),h.lastStepIndex=l}}return{midi_out:o}}});v(vo);const yo=N({id:"seq.sequencer",version:"1.0.0",displayName:"Sequencer",metadata:{category:"Sequence",keywords:["sequencer","step","pattern"],description:"16-step sequencer."},config:{sequence:{kind:"array",size:16,element:{kind:"record",fields:{noteIndex:c,velocity:c,hold:{kind:"atomic",type:"boolean"}}}}},inputs:{},outputs:{seq_out:X},ui:{},compileConfig:e=>{const n=Array(16).fill({noteIndex:null,velocity:0,hold:!1});return{sequence:e?.values?.sequence??n}},createState:()=>({currentStepIndex:0}),isRealtime:()=>!1,execute:(e,n,i,t)=>{const r=Array(16).fill({noteIndex:null,velocity:0,hold:!1});return{outputs:{seq_out:n.sequence||r},ui:{currentStepIndex:t.currentStepIndex}}}});v(yo);const go=N({id:"seq.oneshot",version:"1.0.0",displayName:"One Shot",metadata:{category:"Sequence",keywords:["player","trigger","oneshot","envelope"],description:"Plays a sequence once upon trigger."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}},trigger:{combine:{reduce:"flatten"}}},reshape:"none",inputs:{seq_in:{type:X,description:"Input sequence"},trigger:{type:k,description:"Trigger",allowMultiConnection:!0},duration:{type:c,defaultValue:4,description:"Duration (s)"}},outputs:{midi_out:k},isRealtime:()=>!0,createState:()=>({isPlaying:!1,startTime:0,lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map}),execute:(e,n,i,t)=>{const r=e.trigger||[];let s=!1;for(const g of r)if(g&&g.type==="note_on"&&g.velocity>0){s=!0;break}const o=i.audio?.context?.currentTime??0;s&&(t.isPlaying=!0,t.startTime=o);const a=e.seq_in||[],u=[];if(!t.isPlaying||!a||a.length===0)return t.lastNoteIndex!==null&&(u.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.lastNoteIndex=null,t.lastHold=!1),t.activeNotes.size>0&&t.activeNotes.clear(),{midi_out:u};const l=Math.max(.001,e.duration??4),f=(o-t.startTime)/l;if(f>=1)return t.isPlaying=!1,t.lastNoteIndex!==null&&(u.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.lastNoteIndex=null,t.lastHold=!1),{midi_out:u};const p=a.length,h=Math.floor(f*p);let m={noteIndex:null,velocity:0,hold:!1};if(a[h]&&(m=a[h]),h!==t.lastStepIndex||m.noteIndex!==t.lastNoteIndex){const g=t.lastNoteIndex,y=t.lastHold,b=m.noteIndex!==null,_=b&&m.noteIndex===g,S=g!==null&&(!_||!y),A=b&&(!_||!y);S&&g!==null&&(u.push({type:"note_off",note:g,velocity:0,channel:1,time:0,deviceId:"oneshot"}),t.activeNotes.delete(g),t.lastNoteIndex=null,t.lastHold=!1),A&&m.noteIndex!==null?(u.push({type:"note_on",note:m.noteIndex,velocity:m.velocity,channel:1,time:0,deviceId:"oneshot"}),t.activeNotes.set(m.noteIndex,m.velocity),t.lastNoteIndex=m.noteIndex,t.lastHold=m.hold):_&&y&&(t.lastHold=m.hold),t.lastStepIndex=h}return{midi_out:u}}}),_o=N({id:"seq.scan",version:"1.0.0",displayName:"Scan Sequence",metadata:{category:"Sequence",keywords:["player","scan","scrub"],description:"Plays a sequence by scanning through positions."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},reshape:"none",inputs:{seq_in:{type:X,description:"Input sequence"},pos:{type:c,defaultValue:0,description:"Position (0-1)"}},outputs:{midi_out:k},isRealtime:()=>!0,createState:()=>({lastStepIndex:-1,lastNoteIndex:null,lastHold:!1,activeNotes:new Map}),execute:(e,n,i,t)=>{const r=e.seq_in||[],s=e.pos??0,o=[];if(!r||r.length===0||s>=1||s<0)return t.lastNoteIndex!==null&&(o.push({type:"note_off",note:t.lastNoteIndex,velocity:0,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=null,t.lastHold=!1),{midi_out:o};const a=r.length,u=Math.floor(s*a);let l={noteIndex:null,velocity:0,hold:!1};if(r[u]&&(l=r[u]),u!==t.lastStepIndex||l.noteIndex!==t.lastNoteIndex){const d=t.lastNoteIndex,f=t.lastHold,p=l.noteIndex!==null,h=p&&l.noteIndex===d,m=d!==null&&(!h||!f),g=p&&(!h||!f);m&&d!==null&&(o.push({type:"note_off",note:d,velocity:0,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=null,t.lastHold=!1),g&&l.noteIndex!==null?(o.push({type:"note_on",note:l.noteIndex,velocity:l.velocity,channel:1,time:0,deviceId:"scan"}),t.lastNoteIndex=l.noteIndex,t.lastHold=l.hold):h&&f&&(t.lastHold=l.hold),t.lastStepIndex=u}return{midi_out:o}}});v(go);v(_o);const bo=N({id:"seq.crop",version:"1.0.0",displayName:"Crop Sequence",metadata:{category:"Sequence",keywords:["modifier","crop","slice"],description:"Mutes steps outside the specified range."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-end"}},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},inputs:{seq_in:{type:X,description:"Input sequence"},start:{type:c,defaultValue:0},end:{type:c,defaultValue:1,optional:!0},length:{type:c,defaultValue:1,optional:!0}},outputs:{seq_out:X},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}]}]}},computeForwardPorts:(e,n)=>{const i=n.mode||"start-end",t={seq_in:X,start:{...c,defaultValue:0}};return i==="start-length"?t.length={...c,defaultValue:1}:t.end={...c,defaultValue:1},{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{seq_out:X}}}},shouldRecompileOnConfigChange:()=>!0,compileConfig:e=>({mode:e.mode||"start-end"}),execute:(e,n)=>{const i=e.seq_in||[],t=n.mode||"start-end",r=i.map(u=>({...u})),s=e.start??0;let o=1;if(t==="start-length"){const u=e.length??1;o=s+u}else o=e.end??1;o<s&&(o=s);const a=r.length;for(let u=0;u<a;u++){const l=u/a;(l<s||l>=o)&&(r[u].noteIndex=null,r[u].velocity=0,r[u].hold=!1)}return{seq_out:r}}}),xo=N({id:"seq.fill",version:"1.0.0",displayName:"Fill Sequence",metadata:{category:"Sequence",keywords:["generator","fill","range"],description:"Generates a sequence where steps inside the specified range are ON."},config:{mode:{kind:"atomic",type:"string",defaultValue:"start-length"},count:{...c,defaultValue:16}},inputs:{start:{type:c,defaultValue:0},end:{type:c,defaultValue:1,optional:!0},length:{type:c,defaultValue:.5,optional:!0}},outputs:{seq_out:X},ui:{inspector:{fields:[{type:"tab-bar",label:"Mode",path:"mode",options:[{label:"Start / End",value:"start-end"},{label:"Start / Length",value:"start-length"}],default:"start-length"},{type:"number",label:"Step Count",path:"count",min:1,max:128,step:1,default:16}]}},computeForwardPorts:(e,n)=>{const i=n.mode||"start-length",t={start:{...c,defaultValue:0}};return i==="start-length"?t.length={...c,defaultValue:.5}:t.end={...c,defaultValue:1},{inputs:{kind:"record",fields:t},outputs:{kind:"record",fields:{seq_out:X}}}},shouldRecompileOnConfigChange:()=>!0,compileConfig:e=>({mode:e.mode||"start-length",count:e.count??16}),execute:(e,n)=>{const i=n.count??16,t=n.mode||"start-length",r=[];for(let o=0;o<i;o++)r.push({noteIndex:null,velocity:0,hold:!1});const s=e.start??0;if(t==="start-length"){const o=e.length??.5,a=Math.round(o*i),u=Math.floor(s*i);for(let l=0;l<a;l++){const d=u+l;d>=0&&d<i&&(r[d]={noteIndex:60,velocity:1,hold:!1})}}else{const o=e.end??1;let a=s,u=o;u<a&&(u=a);for(let l=0;l<i;l++){const d=l/i;d>=a&&d<u&&(r[l]={noteIndex:60,velocity:1,hold:!1})}}return{seq_out:r}}});v(bo);v(xo);const Ye={noteIndex:null,velocity:0,hold:!1},Xe=e=>e.noteIndex!==null&&e.noteIndex!==void 0,Vt=(e,n,i,t)=>N({id:`seq.${e}`,version:"1.0.0",displayName:n,metadata:{category:"Sequence",keywords:["logic",e,"binary"],description:i},config:{},inputs:{inputs:{type:X,description:"Sequences",allowMultiConnection:!0}},outputs:{seq_out:X},execute:r=>{const s=r.inputs||[];if(s.length===0)return{seq_out:[]};let o=0;if(s.forEach(u=>o=Math.max(o,u.length)),o===0)return{seq_out:[]};const a=[];for(let u=0;u<o;u++){let l={...Ye};const d=s[0];d.length>0?l={...d[u%d.length]}:l={...Ye};for(let f=1;f<s.length;f++){const p=s[f],h=p.length>0?p[u%p.length]:Ye;l=t(l,h)}a.push(l)}return{seq_out:a}}}),Oo=Vt("xor","Sequence XOR","XORs multiple sequences.",(e,n)=>{const i=Xe(e),t=Xe(n);return i!==t?t?n:e:{...Ye}}),So=Vt("sub","Sequence Subtract","Subtracts subsequent sequences from the first.",(e,n)=>Xe(n)?{...Ye}:e),Ao=Vt("and","Sequence AND","Output active only if both inputs active.",(e,n)=>Xe(e)&&Xe(n)?n:{...Ye}),wo=Vt("or","Sequence OR","Output active if any input active.",(e,n)=>Xe(n)?n:e),Io=N({id:"seq.negate",version:"1.0.0",displayName:"Sequence Negate",metadata:{category:"Sequence",keywords:["logic","not","invert"],description:"Inverts sequence activity."},config:{},autoBroadcast:{seq_in:{combine:{reduce:"first"}}},inputs:{seq_in:{type:X}},outputs:{seq_out:X},execute:e=>({seq_out:(e.seq_in||[]).map(t=>{const r={...t};return r.noteIndex!==null?(r.noteIndex=null,r.velocity=0,r.hold=!1):(r.noteIndex=60,r.velocity=1,r.hold=!1),r})})});v(Oo);v(So);v(Ao);v(wo);v(Io);const pi=F("math.add",{category:x.Math,keywords:["sum","plus"],description:"Adds a and b."},(e,n)=>e+n);v({version:"1.0.0",...pi,displayName:"Add",aliases:["plus","sum"],extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Sum"}}});const fi=F("math.subtract",{category:x.Math,keywords:["minus","difference"],description:"Subtracts b from a."},(e,n)=>e-n);v({version:"1.0.0",...fi,displayName:"Subtract",aliases:["minus","difference"],extendedInputs:{a:{type:c,description:"Minuend"},b:{type:c,description:"Subtrahend"}},extendedOutputs:{result:{type:c,description:"Result"}}});const hi=F("math.multiply",{category:x.Math,keywords:["times","product"],description:"Multiplies a and b."},(e,n)=>e*n);v({version:"1.0.0",...hi,displayName:"Multiply",aliases:["times","product"],extendedInputs:{a:{type:c,description:"Factor A"},b:{type:c,description:"Factor B"}},extendedOutputs:{result:{type:c,description:"Product"}}});const mi=F("math.divide",{category:x.Math,keywords:["div","quotient"],description:"Divides a by b."},(e,n)=>e/n);v({version:"1.0.0",...mi,displayName:"Divide",aliases:["div","quotient"],extendedInputs:{a:{type:c,description:"Dividend"},b:{type:c,description:"Divisor"}},extendedOutputs:{result:{type:c,description:"Quotient"}}});const vi=F("math.pow",{category:x.Math,keywords:["power","exponent"],description:"Raises a to the power of b."},(e,n)=>Math.pow(e,n));v({version:"1.0.0",...vi,displayName:"Power",extendedInputs:{a:{type:c,description:"Base"},b:{type:c,description:"Exponent"}},extendedOutputs:{result:{type:c,description:"Result"}}});const yi=F("math.min",{category:x.Math,keywords:["minimum","smallest"],description:"Returns the smaller of a and b."},(e,n)=>Math.min(e,n));v({version:"1.0.0",...yi,displayName:"Min",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Minimum"}}});const gi=F("math.max",{category:x.Math,keywords:["maximum","largest"],description:"Returns the larger of a and b."},(e,n)=>Math.max(e,n));v({version:"1.0.0",...gi,displayName:"Max",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Maximum"}}});const _i=U({id:"math.fmod",metadata:{category:x.Math,keywords:["modulo","remainder"],description:"Floating point modulo operation."},inputs:{dividend:c,divisor:c},outputs:{div:c,mod:c},autoBroadcast:!0,execute:(e,n,i)=>{const{dividend:t,divisor:r}=e,s=Math.floor(t/r),o=t%r;return{div:s,mod:o}}});v({version:"1.0.0",..._i,displayName:"FMod",extendedInputs:{dividend:{type:c,description:"Dividend"},divisor:{type:c,description:"Divisor",defaultValue:1,range:[0,10]}},extendedOutputs:{div:{type:c,description:"The integer division result."},mod:{type:c,description:"The remainder."}}});const bi=F("logic.and",{category:x.Logic,keywords:["boolean","&&"],description:"Logical AND (1 if both non-zero, else 0)."},(e,n)=>e!==0&&n!==0?1:0);v({version:"1.0.0",...bi,displayName:"AND",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const xi=F("logic.or",{category:x.Logic,keywords:["boolean","||"],description:"Logical OR (1 if either non-zero, else 0)."},(e,n)=>e!==0||n!==0?1:0);v({version:"1.0.0",...xi,displayName:"OR",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const Oi=F("logic.xor",{category:x.Logic,keywords:["boolean","^"],description:"Logical XOR (1 if different truthiness, else 0)."},(e,n)=>e!==0!=(n!==0)?1:0);v({version:"1.0.0",...Oi,displayName:"XOR",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const Si=F("logic.equals",{category:x.Logic,keywords:["==","equality"],description:"Returns 1 if a equals b, else 0."},(e,n)=>e===n?1:0);v({version:"1.0.0",...Si,displayName:"Equals",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const Ai=F("logic.greater_than",{category:x.Logic,keywords:[">","gt"],description:"Returns 1 if a > b, else 0."},(e,n)=>e>n?1:0);v({version:"1.0.0",...Ai,displayName:"Greater Than",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});const wi=F("logic.less_than",{category:x.Logic,keywords:["<","lt"],description:"Returns 1 if a < b, else 0."},(e,n)=>e<n?1:0);v({version:"1.0.0",...wi,displayName:"Less Than",extendedInputs:{a:{type:c,description:"Value A"},b:{type:c,description:"Value B"}},extendedOutputs:{result:{type:c,description:"Result"}}});var ko=Object.freeze({__proto__:null,primitive_add:pi,primitive_and:bi,primitive_divide:mi,primitive_equals:Si,primitive_fmod:_i,primitive_greater_than:Ai,primitive_less_than:wi,primitive_max:gi,primitive_min:yi,primitive_multiply:hi,primitive_or:xi,primitive_pow:vi,primitive_subtract:fi,primitive_xor:Oi});const Ii=F("math.abs",{category:x.Math,keywords:["absolute","magnitude"],description:"Returns the absolute value of a."},e=>Math.abs(e),"unary");v({version:"1.0.0",...Ii,displayName:"Abs",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Absolute Value"}}});const ki=F("math.negate",{category:x.Math,keywords:["negative","invert"],description:"Negates a."},e=>-e,"unary");v({version:"1.0.0",...ki,displayName:"Negate",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Negated Value"}}});const Mi=F("math.ceil",{category:x.Math,keywords:["ceiling","round up"],description:"Rounds a up to the nearest integer."},e=>Math.ceil(e),"unary");v({version:"1.0.0",...Mi,displayName:"Ceil",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Ceiling"}}});const Ni=F("math.floor",{category:x.Math,keywords:["floor","round down"],description:"Rounds a down to the nearest integer."},e=>Math.floor(e),"unary");v({version:"1.0.0",...Ni,displayName:"Floor",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Floor"}}});const Ci=F("math.round",{category:x.Math,keywords:["round","nearest"],description:"Rounds a to the nearest integer."},e=>Math.round(e),"unary");v({version:"1.0.0",...Ci,displayName:"Round",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Rounded Value"}}});const Ti=F("math.sin",{category:x.Math,keywords:["sine"],description:"Returns the sine of a (radians)."},e=>Math.sin(e),"unary");v({version:"1.0.0",...Ti,displayName:"Sin",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Sine"}}});const Ei=F("math.cos",{category:x.Math,keywords:["cosine"],description:"Returns the cosine of a (radians)."},e=>Math.cos(e),"unary");v({version:"1.0.0",...Ei,displayName:"Cos",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Cosine"}}});const Ri=F("math.tan",{category:x.Math,keywords:["tangent"],description:"Returns the tangent of a (radians)."},e=>Math.tan(e),"unary");v({version:"1.0.0",...Ri,displayName:"Tan",extendedInputs:{a:{type:c,description:"Value (Radians)"}},extendedOutputs:{result:{type:c,description:"Tangent"}}});const Vi=F("math.sqrt",{category:x.Math,keywords:["square root"],description:"Returns the square root of a."},e=>Math.sqrt(e),"unary");v({version:"1.0.0",...Vi,displayName:"Sqrt",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Square Root"}}});const Pi=F("logic.not",{category:x.Logic,keywords:["!","invert"],description:"Logical NOT (1 if zero, 0 if non-zero)."},e=>e===0?1:0,"unary");v({version:"1.0.0",...Pi,displayName:"NOT",extendedInputs:{a:{type:c,description:"Value"}},extendedOutputs:{result:{type:c,description:"Result"}}});var Mo=Object.freeze({__proto__:null,primitive_abs:Ii,primitive_ceil:Mi,primitive_cos:Ei,primitive_floor:Ni,primitive_negate:ki,primitive_not:Pi,primitive_round:Ci,primitive_sin:Ti,primitive_sqrt:Vi,primitive_tan:Ri});const te=(e,n,i,t=x.Math)=>{const r=U({id:e,metadata:{category:t,description:`Apply ${e.split(".").pop()} to all inputs.`},inputs:{values:{kind:"array",element:L,size:"dynamic",allowMultiConnection:!0}},outputs:{result:c},computeForwardPorts:(s,o,a)=>{const u=s.fields.values;let l=c;if(u&&u.kind==="array"){const d=u.element;(d.kind==="array"||d.kind==="record")&&(l=d)}return{inputs:{kind:"record",fields:{values:u}},outputs:{kind:"record",fields:{result:l}}}},execute:s=>{const o=s.values;if(!o||o.length===0)return{result:0};const a=o[0],u=Array.isArray(a);let l=!1,d=[];if(!u&&typeof a=="object"&&a!==null&&typeof a.x=="number"&&typeof a.y=="number"&&(l=!0,d=["x","y"],typeof a.z=="number"&&d.push("z"),typeof a.w=="number"&&d.push("w")),u||l||typeof a=="number"){const f=u?a.length:l?d.length:1,p=new Array(f);for(let h=0;h<f;h++){let m=u?a[h]:l?a[d[h]]:a;for(let g=1;g<o.length;g++){const y=o[g];let b;if(Array.isArray(y))b=y[h]??0;else if(typeof y=="object"&&y!==null&&"x"in y){const _=d[h];b=y[_],b===void 0&&(b=0)}else b=y;m=i(m,b)}p[h]=m}if(l){const h={};return d.forEach((m,g)=>h[m]=p[g]),{result:h}}else if(!u)return{result:p[0]};return{result:p}}else return{result:0}}});return v({version:"1.0.0",...r,displayName:n,extendedInputs:{values:{type:{kind:"array",element:c,size:"dynamic"},description:"Values to process.",suppressInputEditor:!0,suppressLabel:!0,allowMultiConnection:!0}},extendedOutputs:{result:{type:c,description:"Result"}}}),r},No=te("math.all.add","Sum All",(e,n)=>e+n),Co=te("math.all.subtract","Subtract All",(e,n)=>e-n),To=te("math.all.multiply","Multiply All",(e,n)=>e*n),Eo=te("math.all.divide","Divide All",(e,n)=>e/n),Ro=te("math.all.pow","Power All",(e,n)=>Math.pow(e,n)),Vo=te("math.all.min","Min All",(e,n)=>Math.min(e,n)),Po=te("math.all.max","Max All",(e,n)=>Math.max(e,n)),Do=te("logic.all.and","AND All",(e,n)=>e&&n?1:0,x.Logic),jo=te("logic.all.or","OR All",(e,n)=>e||n?1:0,x.Logic),Lo=te("logic.all.xor","XOR All",(e,n)=>!!e!=!!n?1:0,x.Logic),Bo=te("logic.all.equals","Equals All",(e,n)=>e===n?1:0,x.Logic),qo=te("logic.all.greater_than","Greater Than All",(e,n)=>e>n?1:0,x.Logic),Fo=te("logic.all.less_than","Less Than All",(e,n)=>e<n?1:0,x.Logic);var $o=Object.freeze({__proto__:null,primitive_all_add:No,primitive_all_and:Do,primitive_all_divide:Eo,primitive_all_equals:Bo,primitive_all_greater_than:qo,primitive_all_less_than:Fo,primitive_all_max:Po,primitive_all_min:Vo,primitive_all_multiply:To,primitive_all_or:jo,primitive_all_pow:Ro,primitive_all_subtract:Co,primitive_all_xor:Lo});const Di=U({id:"math.pi",metadata:{category:x.Math,keywords:["pi","constant"],description:"Returns the value of Pi."},inputs:{},outputs:{result:c},execute:()=>({result:Math.PI})});v({version:"1.0.0",...Di,displayName:"Pi",extendedOutputs:{result:{type:c,description:"Pi"}}});const ji=U({id:"math.e",metadata:{category:x.Math,keywords:["e","euler","constant"],description:"Returns the value of Euler's number."},inputs:{},outputs:{result:c},execute:()=>({result:Math.E})});v({version:"1.0.0",...ji,displayName:"E",extendedOutputs:{result:{type:c,description:"Euler's Number"}}});var Uo=Object.freeze({__proto__:null,primitive_e:ji,primitive_pi:Di});const Li=U({id:"math.clamp",metadata:{category:x.Math,keywords:["limit","range"],description:"Clamps a value between a minimum and maximum."},inputs:{value:c,min:{...c,defaultValue:0},max:{...c,defaultValue:1}},outputs:{result:c},autoBroadcast:{value:{combine:"collect"},min:{combine:"collect"},max:{combine:"collect"}},reshape:"vector",execute:e=>{const{value:n,min:i,max:t}=e;return{result:Math.max(i,Math.min(n,t))}}});v({version:"1.0.0",...Li,displayName:"Clamp",extendedInputs:{value:{type:c,description:"Value to clamp."},min:{type:c,description:"Minimum value.",defaultValue:0,range:[0,1]},max:{type:c,description:"Maximum value.",defaultValue:1,range:[0,1]}},extendedOutputs:{value:{type:c,description:"The clamped value."}}});const Bi=U({id:"math.lerp",metadata:{category:x.Math,keywords:["lerp","mix","interpolate"],description:"Linear interpolation between a and b."},inputs:{a:c,b:c,t:c},config:{clamp:{kind:"atomic",type:"boolean",optional:!0}},outputs:{result:c},autoBroadcast:!0,execute:(e,n)=>{const{a:i,b:t,t:r}=e,s=n.clamp!==!1,o=i+(t-i)*r;return{result:s?Math.max(Math.min(o,Math.max(i,t)),Math.min(i,t)):o}}});v({version:"1.0.0",...Bi,displayName:"Lerp",extendedInputs:{a:{type:c,description:"Start Value"},b:{type:c,description:"End Value"},t:{type:c,description:"Interpolant (0-1)"}},extendedOutputs:{result:{type:c,description:"Interpolated Value"}},compileConfig:e=>({fields:{clamp:e.clamp??!0},untagged:[]})});const qi=U({id:"math.map",metadata:{category:x.Math,keywords:["map","remap","range"],description:"Maps a value from one range to another."},inputs:{value:c,inMin:c,inMax:c,outMin:c,outMax:c},outputs:{result:c},autoBroadcast:!0,execute:e=>{const{value:n,inMin:i,inMax:t,outMin:r,outMax:s}=e;return{result:r+(n-i)*(s-r)/(t-i)}}});v({version:"1.0.0",...qi,displayName:"Map",extendedInputs:{value:{type:c,description:"Input Value"},inMin:{type:c,description:"Input Min",defaultValue:0},inMax:{type:c,description:"Input Max",defaultValue:1},outMin:{type:c,description:"Output Min",defaultValue:0},outMax:{type:c,description:"Output Max",defaultValue:1}},extendedOutputs:{result:{type:c,description:"Mapped Value"}}});var zo=Object.freeze({__proto__:null,primitive_clamp:Li,primitive_lerp:Bi,primitive_map:qi});function Go(e){if(!e)return;const n=e.type;if(!(!n||n==="any")){if(n==="float")return{kind:"atomic",type:"number"};if(n==="string")return{kind:"atomic",type:"string"};if(n.startsWith("float")){const i=parseInt(n.slice(5));if(!isNaN(i))return{kind:"array",size:i,element:{kind:"atomic",type:"number"}}}}}const Fi={kind:"record",fields:{name:{kind:"atomic",type:"string"},type:L}},$i={id:"io.input",kind:"primitive",metadata:{category:x.IO,keywords:["source","in"],description:"Graph input node."},configType:Fi,ui:{inspector:{fields:[{type:"structor-type",label:"Type",path:"type",default:"float"},{type:"string",label:"Name",path:"name"}]}},computeForwardPorts:(e,n,i)=>{let t=e.fields.value;if(!t){const r=Go(n);r&&(t=r)}return t||(t={kind:"atomic",type:"number"}),{inputs:{kind:"record",fields:{value:{kind:"atomic",type:"number"}}},outputs:{kind:"record",fields:{value:t}}}},execute:(e,n,i)=>{const r=n?.fields?.name??"value";return{fields:{value:e.fields[r]!==void 0?e.fields[r]:e.fields.value}}}};v({version:"1.0.0",...$i,displayName:"Input",aliases:["in","source"],extendedOutputs:{value:{type:L,description:"The input value.",suppressInputEditor:!0,suppressLabel:!0}},compileConfig:e=>{const n=We(e,Fi);return e.values&&(n.values=e.values),n}});var Ko=Object.freeze({__proto__:null,primitive_input:$i});const Ui={id:"io.output",kind:"primitive",metadata:{category:x.IO,keywords:["sink","out"],description:"Graph output node."},computeForwardPorts:(e,n,i)=>{const t=e.fields.value||{kind:"atomic",type:"any"};return{inputs:{kind:"record",fields:{value:t}},outputs:{kind:"record",fields:{value:t}}}},execute:(e,n,i)=>({fields:{value:e.fields.value}})};v({version:"1.0.0",...Ui,displayName:"Output",aliases:["out","sink"],extendedInputs:{value:{type:L,description:"The output value.",suppressInputEditor:!0,suppressLabel:!0}},extendedOutputs:{value:{type:L,description:"The graph output value.",suppressInputEditor:!0,suppressLabel:!0}}});var Ho=Object.freeze({__proto__:null,primitive_output:Ui});function Wo(e){if(!e)return;const n=e.type;if(!(!n||n==="any")){if(n==="float")return{kind:"atomic",type:"number"};if(n==="string")return{kind:"atomic",type:"string"};if(n.startsWith("float")){const i=parseInt(n.slice(5));if(!isNaN(i))return{kind:"array",size:i,element:{kind:"atomic",type:"number"}}}}}function tn(e,n,i,t){if(!e||!e.includes("#"))return e;let r="";return i===1?r=t==="input"?"in":"out":i<=4?r=["x","y","z","w"][n]:r=n.toString(),e.replace(/#/g,r)}const gn=(e,n,i)=>{const r=i.loadedSubgraphs;if(!r)return{inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{}}};const s=n.subgraphId,o=r.get(s);if(o){const a=Object.values(o.inner.nodes),u={},l=a.filter(p=>p.config.typeId==="io.input"||p.config.typeId==="input").sort((p,h)=>p.y-h.y);l.forEach((p,h)=>{let m=p.config.name||"value";m=tn(m,h,l.length,"input");const g=Wo(p.config);u[m]=g||{kind:"atomic",type:"any"}});const d={},f=a.filter(p=>p.config.typeId==="io.output"||p.config.typeId==="output").sort((p,h)=>p.y-h.y);return f.forEach((p,h)=>{let m=p.config.name||"value";m=tn(m,h,f.length,"output"),d[m]={kind:"atomic",type:"any"}}),{inputs:{kind:"record",fields:u},outputs:{kind:"record",fields:d}}}return{inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{}}}},zi=U({id:"core.subgraph",subgraphExpansionTag:"inline",metadata:{category:x.Core,keywords:["nested","graph"],description:"Executes a nested subgraph."},config:{subgraphId:{kind:"atomic",type:"string"}},inputs:{},outputs:{},ui:{inspector:{fields:[{type:"string",label:"Subgraph ID",path:"subgraphId"}]}},getDisplayLabel:e=>{if(e.subgraphId){const n=e.subgraphId.split(".");return n[n.length-1]}},computeForwardPorts:gn,execute:(e,n,i)=>({fields:{}})});v({version:"1.0.0",...zi,displayName:"Subgraph"});var Yo=Object.freeze({__proto__:null,computeSubgraphPorts:gn,primitive_subgraph:zi,resolvePortName:tn});const Gi=U({id:"core.thensubgraph",subgraphExpansionTag:"onTrigger",metadata:{category:x.Core,keywords:["nested","graph","conditional","midi","trigger"],description:"Executes a nested subgraph when a MIDI Note On event is received."},config:{subgraphId:{kind:"atomic",type:"string"}},inputs:{midi_in:k},outputs:{},ui:{inspector:{fields:[{type:"string",label:"Subgraph ID",path:"subgraphId"}]}},getDisplayLabel:e=>{if(e.subgraphId){const n=e.subgraphId.split(".");return`OnNote: ${n[n.length-1]}`}return"OnNote"},computeForwardPorts:((e,n,i)=>{const t=gn(e,n,i);return{inputs:{kind:"record",fields:{...t.inputs.fields,midi_in:k}},outputs:t.outputs}}),execute:(e,n,i)=>{const t=e.midi_in||[],r=Array.isArray(t)?t:[];let s=!1;for(const o of r)if(o.type==="note_on"&&(o.velocity??0)>0){s=!0;break}return s&&i.executeSubgraph&&i.executeSubgraph("onTrigger"),{fields:{}}}});v(Gi);var Xo=Object.freeze({__proto__:null,primitive_thensubgraph:Gi});const Ki=U({id:"core.pack",metadata:{category:x.Core,keywords:["pack","record","struct","vector"],description:"Packs inputs into a record or vector."},config:{targetType:{kind:"atomic",type:"string",defaultValue:"infer"}},inputs:{},outputs:{result:L},ui:{inspector:{fields:[{type:"tab-bar",label:"Target Type",path:"targetType",options:[{label:"Infer",value:"infer"},{label:"float2",value:"float2"},{label:"float3",value:"float3"},{label:"float4",value:"float4"}]}]}},computeBackwardPorts:(e,n,i)=>{const t=n?.targetType||"infer";let r=null;if(t==="infer"){const o=e.fields.result;o&&o.kind==="record"&&(o.fields.x&&o.fields.y&&o.fields.z&&o.fields.w?r="float4":o.fields.x&&o.fields.y&&o.fields.z?r="float3":o.fields.x&&o.fields.y&&(r="float2"))}else r=t;const s={kind:"record",fields:{}};return r==="float4"?s.fields={x:c,y:c,z:c,w:c}:r==="float3"?s.fields={x:c,y:c,z:c}:r==="float2"&&(s.fields={x:c,y:c}),{inputRequirements:s,backwardMetadata:{inferredType:r}}},computeForwardPorts:(e,n,i,t)=>{const r=n,s=r?.targetType||r?.fields?.targetType||"infer";let o=s!=="infer"?s:t?.inferredType||"float2";const a={},u={};return["float2","float3","float4"].includes(o)||(o="float2"),o==="float4"?(a.x=c,a.y=c,a.z=c,a.w=c,u.result={kind:"array",size:4,element:c,hint:"float4"}):o==="float3"?(a.x=c,a.y=c,a.z=c,u.result={kind:"array",size:3,element:c,hint:"float3"}):(a.x=c,a.y=c,u.result={kind:"array",size:2,element:c,hint:"float2"}),{inputs:{kind:"record",fields:a},outputs:{kind:"record",fields:u}}},shouldRecompileOnConfigChange:(e,n)=>e?.targetType!==n?.targetType,execute:(e,n)=>{const i=e?.fields||{};let t=n?.targetType||"infer";return t==="infer"&&(i.w!==void 0?t="float4":i.z!==void 0?t="float3":i.y!==void 0&&i.x!==void 0?t="float2":t="record"),t==="float4"?{result:[i.x??0,i.y??0,i.z??0,i.w??0]}:t==="float3"?{result:[i.x??0,i.y??0,i.z??0]}:t==="float2"?{result:[i.x??0,i.y??0]}:{result:{fields:i}}}});v({version:"1.0.0",...Ki,displayName:"Pack",extendedOutputs:{result:{type:L,description:"Record"}}});var Zo=Object.freeze({__proto__:null,primitive_pack:Ki});const Hi=U({id:"core.unpack",metadata:{category:x.Core,keywords:["unpack","destructure","split"],description:"Unpacks a record or fixed-length vector into outputs."},config:{},inputs:{record:L},computeForwardPorts:(e,n,i)=>{const t=e.fields.record;let r={};if(t){if(t.kind==="record")r=t.fields;else if(t.kind==="array"&&typeof t.size=="number"&&t.size<=16){const s=t.size;if(s===2)r.x=t.element,r.y=t.element;else if(s===3)r.x=t.element,r.y=t.element,r.z=t.element;else if(s===4)r.x=t.element,r.y=t.element,r.z=t.element,r.w=t.element;else for(let o=0;o<s;o++)r[o.toString()]=t.element}}return{inputs:{kind:"record",fields:{record:t||L}},outputs:{kind:"record",fields:r}}},outputs:{},dynamicOutputType:L,execute:e=>{let n=e.record;if(!n)return{};if(Array.isArray(n)&&n.length===1&&typeof n[0]=="object"&&n[0]!==null){const i=n[0];("x"in i||"fields"in i||Object.keys(i).length>0)&&(n=i)}if(Array.isArray(n)){const i=n.length,t={};if(i===2)t.x=n[0],t.y=n[1];else if(i===3)t.x=n[0],t.y=n[1],t.z=n[2];else if(i===4)t.x=n[0],t.y=n[1],t.z=n[2],t.w=n[3];else for(let r=0;r<i;r++)r<16&&(t[r.toString()]=n[r]);return t}return typeof n=="object"&&n!==null?"fields"in n?n.fields:n:{}}});v({version:"1.0.0",...Hi,displayName:"Unpack",extendedInputs:{record:{type:L,description:"Record to unpack"}}});var Jo=Object.freeze({__proto__:null,primitive_unpack:Hi});function Wi(e){return e&&e.kind==="array"&&e.element?.kind==="record"?"midi":"primitive"}function Yi(e,n){if(n==="primitive")if(Array.isArray(e)){for(const i of e)if(i)return!0;return!1}else return!!e;else{const i=e||[];if(Array.isArray(i)){for(const t of i)if(t&&t.type==="note_on"&&(t.velocity??0)>0)return!0}return!1}}const Xi=U({id:"core.ifthen",subgraphExpansionTag:"onTrigger",metadata:{category:x.Core,keywords:["group","conditional","spatial","if","then"],description:"Spatially groups nodes and executes them when a MIDI Note On event is received."},config:{width:{kind:"atomic",type:"number",defaultValue:3},height:{kind:"atomic",type:"number",defaultValue:3},regionX:{kind:"atomic",type:"number",defaultValue:0,optional:!0},regionY:{kind:"atomic",type:"number",defaultValue:0,optional:!0},visibility:{kind:"atomic",type:"string",defaultValue:"auto",optional:!0},mode:{kind:"atomic",type:"string",defaultValue:"midi",optional:!0}},inputs:{midi_in:k},outputs:{},ui:{inspector:{fields:[{type:"number",label:"Width",path:"width",min:1,step:1},{type:"number",label:"Height",path:"height",min:1,step:1},{type:"number",label:"Region X (Offset)",path:"regionX",step:1},{type:"number",label:"Region Y (Offset)",path:"regionY",step:1},{type:"tab-bar",label:"Visibility",path:"visibility",options:[{label:"Auto",value:"auto"},{label:"Show",value:"show"},{label:"Hide",value:"hide"}],default:"auto"}]}},getDisplayLabel:()=>"IfThen",getRegion:e=>({x:e.regionX??0,y:e.regionY??0,width:e.width??1,height:e.height??1,visibility:e.visibility||ni.Show}),getChildren:(e,n)=>{const i=[],t=e.config,r=t.regionX??0,s=t.regionY??0,o=t.width??1,a=t.height??1,u=e.x+r,l=e.y+s,d=u+o,f=l+a;for(const p of Object.values(n))p.id!==e.id&&p.x>=u&&p.x<d&&p.y>=l&&p.y<f&&i.push(p.id);return i},execute:(e,n,i)=>{const t=n.mode||"midi",r=e.midi_in;return Yi(r,t)&&i.executeSubgraph&&i.executeSubgraph("onTrigger"),{fields:{}}},computeForwardPorts:(e,n,i)=>{const t=e.fields.midi_in;let r="midi",s=k;return t&&(r=Wi(t),r==="primitive"&&(s=t)),{inputs:{kind:"record",fields:{midi_in:s}},outputs:{kind:"record",fields:{}},forwardMetadata:{mode:r}}},compileConfig:(e,n)=>({fields:{...e,mode:n?.mode||"midi"}})});v(Xi);var Qo=Object.freeze({__proto__:null,primitive_ifthen:Xi});function Zi(e){return typeof e=="number"?c:typeof e=="string"?{kind:"atomic",type:"string"}:typeof e=="boolean"?{kind:"atomic",type:"boolean"}:Array.isArray(e)?{kind:"array",element:e.length>0?Zi(e[0]):L,size:e.length}:L}const Ji={id:"data.literal",kind:"primitive",metadata:{category:x.Data,keywords:["value","constant"],description:"Outputs a constant value."},configType:{kind:"atomic",type:"any"},computeForwardPorts:(e,n,i)=>({inputs:{kind:"record",fields:{}},outputs:{kind:"record",fields:{value:Zi(n)}}}),execute:(e,n,i)=>({fields:{value:n&&typeof n=="object"&&"value"in n?n.value:n}})};v({version:"1.0.0",...Ji,displayName:"Literal",extendedOutputs:{value:{type:L,description:"The literal value."}},compileConfig:e=>e?.literal?.value??0});var ea=Object.freeze({__proto__:null,primitive_literal:Ji});const Qi=U({id:"util.hub",metadata:{category:x.Utility,keywords:["hub","reroute"],description:"Passes input to output."},inputs:{value:L},outputs:{value:L},autoBroadcast:!0,execute:e=>({value:e.value})});v({version:"1.0.0",...Qi,displayName:"Hub",extendedInputs:{value:{type:L,description:"Input",suppressInputEditor:!0,suppressLabel:!0}},extendedOutputs:{value:{type:L,description:"Output",suppressLabel:!0}}});const er=U({id:"data.float",metadata:{category:x.Data,keywords:["float","number","slider"],description:"Float value with slider."},inputs:{value:c},outputs:{value:c},autoBroadcast:!0,execute:e=>({value:e.value})});v({version:"1.0.0",...er,displayName:"Float",extendedInputs:{value:{type:c,description:"Value",defaultValue:0}},extendedOutputs:{value:{type:c,description:"Value"}},compileConfig:e=>({values:{value:e.value??0},fields:{},untagged:[]})});var ta=Object.freeze({__proto__:null,primitive_float:er,primitive_hub:Qi});const tr={id:"functional.apply",kind:"primitive",metadata:{category:x.Functional,keywords:["call","invoke"],description:"Applies a functor to an input value."},computeForwardPorts:(e,n,i)=>{const t=e.fields.functor;return{inputs:e,outputs:{kind:"record",fields:{result:t?t.output:{kind:"atomic",type:"any"}}}}},execute:(e,n,i)=>{const t=e.fields.functor,r=e.fields.input;return{fields:{result:t(r)}}}};v({version:"1.0.0",...tr,displayName:"Apply Functor",extendedInputs:{functor:{type:{kind:"functor",input:L,output:L},description:"The functor to apply."},value:{type:L,description:"The value to apply the functor to."}},extendedOutputs:{result:{type:L,description:"The result of the functor application."}}});var na=Object.freeze({__proto__:null,primitive_apply:tr});const nr=U({id:"logic.select",metadata:{category:x.Logic,keywords:["switch","case","mux","conditional","select"],description:"Selects an output value from multiple inputs based on a control value."},inputs:{},config:{count:{kind:"atomic",type:"number",defaultValue:2},mode:{kind:"atomic",type:"string",defaultValue:"value"},base:{kind:"atomic",type:"number",defaultValue:0,optional:!0},step:{kind:"atomic",type:"number",defaultValue:1,optional:!0}},outputs:{result:j},autoBroadcast:!1,computeForwardPorts:(e,n,i)=>{const t=n.fields,r=t.count||2,s=t.mode||"value",o={value:c},a=[];for(let l=0;l<r;l++)if(s==="range"){const d=`val_${l}`;o[d]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[d]&&a.push(e.fields[d])}else s==="value"?(o[`match_${l}`]={...c,description:`Case ${l+1} Match`},o[`val_${l}`]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[`val_${l}`]&&a.push(e.fields[`val_${l}`])):s==="zone"&&(o[`threshold_${l}`]={...c,description:`Case ${l+1} Threshold`},o[`val_${l}`]={...c,description:`Case ${l+1} Value`},e.fields&&e.fields[`val_${l}`]&&a.push(e.fields[`val_${l}`]));const u=vn(a);return{inputs:{kind:"record",fields:o},outputs:{kind:"record",fields:{result:u}}}},compileConfig:e=>({fields:{count:e.count||2,mode:e.mode||"value",base:e.base||0,step:e.step||1}}),shouldRecompileOnConfigChange:(e,n)=>{const i=e,t=n;return i.count!==t?.count||i.mode!==t?.mode},execute:(e,n,i)=>{const t=n.count??2,r=n.mode??"value",s=n.base??0,o=n.step??1,a={value:{type:c}};for(let p=0;p<t;p++){const h=`val_${p}`;a[h]={type:j},r==="value"?a[`match_${p}`]={type:c}:r==="zone"&&(a[`threshold_${p}`]={type:c})}const u=rs(i,a,e),l=u.value??0;let d=-1;if(r==="range")if(o===0)d=0;else{const p=Math.round((l-s)/o);d=Math.max(0,Math.min(t-1,p))}else if(r==="value")for(let h=0;h<t;h++){const m=u[`match_${h}`]??h+1;if(Math.abs(l-m)<1e-4){d=h;break}}else if(r==="zone")for(let p=0;p<t;p++){const h=u[`threshold_${p}`]??1/0;if(l<=h){d=p;break}}let f=0;return d!==-1?f=u[`val_${d}`]??0:f=0,{result:f}}});v({version:"1.0.0",...nr,displayName:"Select",extendedInputs:{value:{type:c,description:"Control Value"}},extendedOutputs:{result:{type:j,description:"Selected Value"}},ui:{inspector:{fields:[{type:"number",label:"Count",path:"count",min:2,max:32,step:1,default:2},{type:"tab-bar",label:"Mode",path:"mode",default:"value",options:[{label:"Value (Match)",value:"value"},{label:"Range (Index)",value:"range"},{label:"Zone (Threshold)",value:"zone"}]},{type:"number",label:"Base Index",path:"base",step:1,default:0,visible:e=>e.mode==="range"},{type:"number",label:"Step Size",path:"step",step:1,default:1,visible:e=>e.mode==="range"}]}}});var ia=Object.freeze({__proto__:null,logic_select:nr});const ir=U({id:"logic.latch",metadata:{category:x.Logic,keywords:["latch","sample","hold","trigger","store"],description:"Stores and outputs a value when the trigger condition is met."},config:{initMode:{kind:"atomic",type:"string",defaultValue:"auto"},mode:{kind:"atomic",type:"string",defaultValue:"midi",optional:!0}},inputs:{condition:k,value:j,init:j},outputs:{result:j},autoBroadcast:!1,createState:()=>({currentValue:void 0,initialized:!1}),computeForwardPorts:(e,n,i)=>{const r=n.fields.initMode||"auto",s=(e.fields||e).condition,o=Wi(s),a=(e.fields||e).value||j;let u=(e.fields||e).init||j;r==="auto"&&(u=a);const l=vn([a,u]),d={condition:s||k,value:a};return r==="manual"&&(d.init=u),{inputs:{kind:"record",fields:d},outputs:{kind:"record",fields:{result:l}},forwardMetadata:{mode:o}}},compileConfig:(e,n)=>({fields:{initMode:e.initMode||"auto",mode:n?.mode||"midi"}}),shouldRecompileOnConfigChange:(e,n)=>{const i=e,t=n;return i.initMode!==t?.initMode},execute:(e,n,i,t)=>{const r=e.condition,s=e.value,o=e.init,a=n.mode||"midi",u=n.initMode||"auto";Yi(r,a)&&(t.currentValue=s,t.initialized=!0);let l=t.currentValue;return t.initialized||(u==="auto"&&(l=s),t.initialized||(t.currentValue=u==="auto"?s:o,t.initialized=!0,l=t.currentValue)),{result:l}}});v({version:"1.0.0",...ir,inputs:{},displayName:"Latch",extendedInputs:{condition:{type:k,description:"Trigger"},value:{type:j,description:"Value to Latch"},init:{type:j,description:"Initial Value"}},extendedOutputs:{result:{type:j,description:"Latched Value"}},ui:{inspector:{fields:[{type:"tab-bar",label:"Init Mode",path:"initMode",default:"auto",options:[{label:"Auto (Use Value)",value:"auto"},{label:"Manual",value:"manual"}]}]}}});var ra=Object.freeze({__proto__:null,logic_latch:ir});const rr=U({id:"logic.delay",metadata:{category:x.Logic,keywords:["delay","z-1","feedback","memory","prev"],description:"Outputs the value from the previous frame (z)."},config:{initMode:{kind:"atomic",type:"string",defaultValue:"auto"}},inputs:{value:j,init:j},outputs:{result:j},autoBroadcast:!1,isRealtime:()=>!0,createState:()=>({storedValue:void 0,initialized:!1}),computeForwardPorts:(e,n,i)=>{const r=n.fields.initMode||"auto",s=(e.fields||e).value||j;let o=(e.fields||e).init||j;r==="auto"&&(o=s);const a=vn([s,o]),u={value:s};return r==="manual"&&(u.init=o),{inputs:{kind:"record",fields:u},outputs:{kind:"record",fields:{result:a}}}},compileConfig:(e,n)=>({fields:{initMode:e.initMode||"auto"}}),shouldRecompileOnConfigChange:(e,n)=>{const i=e,t=n;return i.initMode!==t?.initMode},cycleBreakingPorts:["value"],execute:(e,n,i,t)=>{const r=e.init,s=n.initMode||"auto";let o;return t.initialized?o=t.storedValue:(s==="auto"?o=e.value:o=r,t.initialized=!0),e.value!==void 0&&(t.storedValue=e.value),{result:o}},consolidate:(e,n,i,t)=>{e.value!==void 0&&(t.storedValue=e.value),t.initialized=!0}});v({version:"1.0.0",...rr,inputs:{},displayName:"Delay",extendedInputs:{value:{type:j,description:"Input Value"},init:{type:j,description:"Initial Value"}},extendedOutputs:{result:{type:j,description:"Delayed Value"}},ui:{inspector:{fields:[{type:"tab-bar",label:"Init Mode",path:"initMode",default:"auto",options:[{label:"Auto (Use Value)",value:"auto"},{label:"Manual",value:"manual"}]}]}}});var sa=Object.freeze({__proto__:null,logic_delay:rr});const oa=[ko,Mo,$o,Uo,zo,Ko,Ho,Yo,Xo,Zo,Jo,Qo,ea,ta,na,ia,ra,sa];oa.flatMap(e=>Object.values(e).filter(n=>typeof n=="object"&&n!==null&&"kind"in n&&n.kind==="primitive"));class Bn{constructor(n,i,t){this.isScalar=n,this.size=i,this.data=t}apply(n){return this.isScalar?n(this.data):this.data.map(i=>n(i))}}function qn(e,n){(!n||!n.fields)&&console.error("broadcast: inputs or inputs.fields is undefined",n);const i={};let t=0,r=!1;for(const[s,o]of Object.entries(e.outputs)){const a=[];if(o.fromFields)for(const l of o.fromFields)n.fields[l]!==void 0&&a.push(n.fields[l]);let u;if(o.combine==="collect"){u=a;for(const l of a)Array.isArray(l)&&(r=!0,t=Math.max(t,l.length))}else{let l="first";typeof o.combine=="object"&&"reduce"in o.combine&&(l=o.combine.reduce),l==="first"?u=a[0]:l==="flatten"?u=a.flat(1/0):u=a[0],Array.isArray(u)&&(r=!0,t=Math.max(t,u.length))}i[s]=u}if(!r||e.reshape==="none"){const s={};for(const[o,a]of Object.entries(i))s[o]=a;return new Bn(!0,1,s)}else{const s=[];for(let o=0;o<t;o++){const a={};for(const[u,l]of Object.entries(i))e.outputs[u].combine==="collect"?a[u]=l.map(f=>Array.isArray(f)?f[o%f.length]:f):Array.isArray(l)?a[u]=l[o%l.length]:a[u]=l;s.push(a)}return new Bn(!1,t,s)}}class aa{constructor(n,i,t,r,s,o,a){if(this.graph=n,this.repository=i,this.nodeStates=new Map,this.executionOrder=[],this.graphInputs=new Map,this.userNodeStates=new Map,this.inspectedInputs=new Map,this.downstreamMap=new Map,this.nodeMetadata=new Map,this.resolvedIdCache=new Map,this.executedNodesThisTick=new Set,this.mainExecutionOrder=[],this.taggedExecutionOrders=new Map,this.inferredNodeTypes=r,a)for(const[u,l]of Object.entries(a))this.resolvedIdCache.set(u,l);if(o)for(const[u,l]of Object.entries(o))this.nodeMetadata.set(u,l);for(const u of n.connections)this.downstreamMap.has(u.fromNode)||this.downstreamMap.set(u.fromNode,[]),this.downstreamMap.get(u.fromNode).push(u.toNode);if(n.nodes)for(const[u,l]of Object.entries(n.nodes))l.executionOwnerId&&(this.downstreamMap.has(u)||this.downstreamMap.set(u,[]),this.downstreamMap.get(u).push(l.executionOwnerId));this.splitExecutionOrder(n.executionOrder||[]),this.initializeStates(t,s)}get graphNodeCount(){return this.executionOrder.length}splitExecutionOrder(n){this.mainExecutionOrder=[],this.taggedExecutionOrders.clear();for(const i of n){const t=this.graph.nodes[i];if(t.executionTag&&t.executionOwnerId){this.taggedExecutionOrders.has(t.executionOwnerId)||this.taggedExecutionOrders.set(t.executionOwnerId,new Map);const r=this.taggedExecutionOrders.get(t.executionOwnerId);r.has(t.executionTag)||r.set(t.executionTag,[]),r.get(t.executionTag).push(i)}else this.mainExecutionOrder.push(i)}}getInferredNodeTypes(){return this.inferredNodeTypes}getNodeState(n){return this.nodeStates.get(n)}initializeStates(n,i){const t=new Set(i||[]);for(const[r,s]of Object.entries(this.graph.nodes)){const o=this.repository.get(s.definitionId),a=s.defaultConfig??null,u=o?.isRealtime?.(a??{fields:{}})??!1;let l,d;if(n&&n.has(r)){const f=n.get(r);f.definitionId===s.definitionId&&(l=f)}l?(d={...l,config:s.defaultConfig??null,isRealtime:u,definitionId:s.definitionId,isDirty:l.isDirty||t.has(r)},this.nodeStates.set(r,d)):(d={output:{fields:{}},config:s.defaultConfig??null,isDirty:!0,isRealtime:u,definitionId:s.definitionId},this.nodeStates.set(r,d))}}setInput(n,i){this.graphInputs.set(n,i);const t=this.graph.inputs[n];t&&this.markDirty(t.nodeId)}resolveNodeId(n){return this.nodeStates.has(n)?n:this.resolvedIdCache.has(n)?this.resolvedIdCache.get(n):n}setNodeConfig(n,i){const t=this.resolveNodeId(n),r=this.nodeStates.get(t);if(r){const s=this.repository.get(r.definitionId),o=s?.configType;let a=i;const u=this.nodeMetadata.get(n);if(s&&s.kind==="primitive"&&s.compileConfig&&u)try{const l=s.compileConfig(i,u);l&&(a=l)}catch(l){console.warn(`Dynamic config compilation failed for ${n}`,l)}if(o&&o.kind==="record"&&i&&typeof i=="object"&&!Array.isArray(i)){const l={};let d=!1;const f={...i,...i.values||{}};for(const p of Object.keys(o.fields))p in f&&(l[p]=f[p],d=!0);d&&(a={...i,fields:l})}if(a&&typeof a=="object"&&!Array.isArray(a)){const l=a,d=r.config&&typeof r.config=="object"&&!Array.isArray(r.config)?r.config:{};r.config={...d,...a,fields:{...d.fields||{},...l.fields||{}},values:{...d.values||{},...l.values||{}}}}else r.config=a;if(r.isRealtime=s?.isRealtime?.(r.config??{fields:{}})??!1,this.markDirty(n),this.graph.virtualInputMappings&&this.graph.virtualInputMappings[n]){const l=this.graph.virtualInputMappings[n],d=r.config?.values||{};for(const[f,p]of Object.entries(l))if(f in d){const h=d[f];this.nodeStates.get(p)&&this.setNodeConfig(p,{values:{[f]:h}})}}}}getNodeConfig(n){const i=this.resolveNodeId(n);return this.nodeStates.get(i)?.config}hasNode(n){return this.nodeStates.has(n)}markDirty(n){const i=this.resolveNodeId(n),t=this.nodeStates.get(i);if(!(!t||t.isDirty)){t.isDirty=!0;for(const r of this.downstreamMap.get(i)||[])this.markDirty(r)}}update(n){this.executedNodesThisTick.clear();const i=new Set;for(const[t,r]of this.nodeStates)r.isRealtime&&this.markDirty(t);for(const t of this.mainExecutionOrder)this.executeNode(t,n,i);for(const t of this.mainExecutionOrder)this.executeNode(t,n,i);for(const t of i)this.markDirty(t)}executeNode(n,i,t){const r=this.nodeStates.get(n);if(!r.isDirty&&!this.executedNodesThisTick.has(n))return;const s=this.graph.nodes[n],o=this.executedNodesThisTick.has(n),a=this.repository.get(s.definitionId);if(!a||a.kind!=="primitive"){a||console.warn(`Definition not found for node ${n}(defId: ${s.definitionId})`);return}if(o){if(a.consolidate){const d=this.collectInputs(n,a,r),f={...i,clock:i.clock??{beat:0,dt:0},audio:i.audio,broadcast:(p,h)=>qn(p,h),repository:this.repository,nodeState:this.userNodeStates,nodeId:n,requestUiOutputs:!1,markSelfDirty:()=>{},executeSubgraph:()=>{}};try{a.consolidate(d,r.config,f,this.userNodeStates.get(n))}catch(p){console.error(`Error consolidating node ${n}:`,p)}}return}this.executedNodesThisTick.add(n);const u=this.collectInputs(n,a,r),l={...i,clock:i.clock??{beat:0,dt:0},audio:i.audio,broadcast:(d,f)=>qn(d,f),repository:this.repository,nodeState:this.userNodeStates,nodeId:n,requestUiOutputs:!0,markSelfDirty:()=>{t.add(n)},executeSubgraph:d=>{if(this.taggedExecutionOrders.has(n)){const f=this.taggedExecutionOrders.get(n);if(f.has(d)){const p=f.get(d);for(const h of p){const m=this.nodeStates.get(h);m&&(m.isDirty=!0),this.executeNode(h,i,t)}}}}};try{a.inspectInputs&&this.inspectedInputs.set(n,u);const d=a.execute(u,r.config,l);"outputs"in d&&"ui"in d?(r.output=d.outputs,r.uiOutput=d.ui):"outputs"in d?(r.output=d.outputs,r.uiOutput=void 0):(r.output=d,r.uiOutput=void 0),r.isDirty=!1}catch(d){throw console.error(`Error executing node ${n} (${a.id}): `,d),d}}collectInputs(n,i,t){const r={fields:{}},s=this.repository.getNodeType(i.id),o=new Map,a=(f,p)=>{o.has(f)||o.set(f,[]),o.get(f).push(p)};if(this.graph.connections){for(const f of this.graph.connections)if(f.toNode===n){const p=f.fromNode,h=f.fromPort,m=this.nodeStates.get(p),g=m?m.output:void 0;if(g&&g.fields&&typeof h=="string"&&h in g.fields){const y=g.fields[h];a(f.toPort.toString(),y)}}}for(const[f,p]of Object.entries(this.graph.inputs))if(p.nodeId===n){const h=this.graphInputs.get(f);h!==void 0&&a(p.port.toString(),h)}if(t.config&&typeof t.config=="object"&&"values"in t.config){const f=t.config.values;if(f&&typeof f=="object")for(const[p,h]of Object.entries(f))o.has(p)||a(p,h)}const u=s?.inputs,l=new Set([...o.keys()]),d=new Map;Array.isArray(u)?u.forEach(f=>{l.add(f.name),d.set(f.name,f)}):u&&Object.entries(u).forEach(([f,p])=>{l.add(f),d.set(f,p)});for(const f of l){const p=d.get(f),h=o.get(f),m=p?p.type||p:void 0,g=m&&m.kind==="array";if(h&&h.length>0){const y=h[h.length-1];p&&p.allowMultiConnection||g&&!Array.isArray(y)?r.fields[f]=h:r.fields[f]=y}else p&&p.defaultValue!==void 0&&(r.fields[f]=p.defaultValue)}return r}getOutputs(){const n=new Map;for(const[i,t]of this.nodeStates.entries())n.set(i,t.output);return n}getUiOutputs(){const n=new Map;for(const[i,t]of this.nodeStates.entries()){const r=t.uiOutput;r!==void 0&&n.set(i,r)}return n}getNodeOutput(n){return this.nodeStates.get(n)?.output}getGraphOutput(n){const i=this.graph.outputs[n];if(!i)return;const t=this.nodeStates.get(i.nodeId)?.output;if(t&&typeof i.port=="string")return t.fields[i.port]}getNodeStates(){return this.nodeStates}getUserNodeStates(){return this.userNodeStates}setUserNodeStates(n){this.userNodeStates=n}getInputs(){return this.graphInputs}handleNodeMessage(n,i){const t=this.resolveNodeId(n),r=this.graph.nodes[t];if(!r)return;const s=this.repository.get(r.definitionId);if(!s||s.kind!=="primitive"||!s.onMessage)return;const o=this.userNodeStates.get(t);o&&(s.onMessage(o,i),this.markDirty(t))}getInspectedInputs(){return this.inspectedInputs}getExecutedNodes(){return this.executedNodesThisTick}}function T(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),t=1;t<n;t++)i[t-1]=arguments[t];throw new Error(typeof e=="number"?"[MobX] minified error nr: "+e+(i.length?" "+i.map(String).join(","):"")+". Find the full error at: https://github.com/mobxjs/mobx/blob/main/packages/mobx/src/errors.ts":"[MobX] "+e)}var ua={};function _n(){return typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:ua}var sr=Object.assign,At=Object.getOwnPropertyDescriptor,he=Object.defineProperty,Pt=Object.prototype,nn=[];Object.freeze(nn);var or={};Object.freeze(or);var la=typeof Proxy<"u",ca=Object.toString();function ar(){la||T("Proxy not available")}function ur(e){var n=!1;return function(){if(!n)return n=!0,e.apply(this,arguments)}}var Ue=function(){};function le(e){return typeof e=="function"}function Re(e){var n=typeof e;switch(n){case"string":case"symbol":case"number":return!0}return!1}function Dt(e){return e!==null&&typeof e=="object"}function Se(e){if(!Dt(e))return!1;var n=Object.getPrototypeOf(e);if(n==null)return!0;var i=Object.hasOwnProperty.call(n,"constructor")&&n.constructor;return typeof i=="function"&&i.toString()===ca}function lr(e){var n=e?.constructor;return n?n.name==="GeneratorFunction"||n.displayName==="GeneratorFunction":!1}function jt(e,n,i){he(e,n,{enumerable:!1,writable:!0,configurable:!0,value:i})}function cr(e,n,i){he(e,n,{enumerable:!1,writable:!1,configurable:!0,value:i})}function je(e,n){var i="isMobX"+e;return n.prototype[i]=!0,function(t){return Dt(t)&&t[i]===!0}}function et(e){return e!=null&&Object.prototype.toString.call(e)==="[object Map]"}function da(e){var n=Object.getPrototypeOf(e),i=Object.getPrototypeOf(n),t=Object.getPrototypeOf(i);return t===null}function _e(e){return e!=null&&Object.prototype.toString.call(e)==="[object Set]"}var dr=typeof Object.getOwnPropertySymbols<"u";function pa(e){var n=Object.keys(e);if(!dr)return n;var i=Object.getOwnPropertySymbols(e);return i.length?[].concat(n,i.filter(function(t){return Pt.propertyIsEnumerable.call(e,t)})):n}var at=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:dr?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames;function pr(e){return e===null?null:typeof e=="object"?""+e:e}function ke(e,n){return Pt.hasOwnProperty.call(e,n)}var fa=Object.getOwnPropertyDescriptors||function(n){var i={};return at(n).forEach(function(t){i[t]=At(n,t)}),i};function Q(e,n){return!!(e&n)}function ee(e,n,i){return i?e|=n:e&=~n,e}function Fn(e,n){(n==null||n>e.length)&&(n=e.length);for(var i=0,t=Array(n);i<n;i++)t[i]=e[i];return t}function ha(e,n){for(var i=0;i<n.length;i++){var t=n[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,va(t.key),t)}}function tt(e,n,i){return n&&ha(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ze(e,n){var i=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=ya(e))||n){i&&(e=i);var t=0;return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ze(){return Ze=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n];for(var t in i)({}).hasOwnProperty.call(i,t)&&(e[t]=i[t])}return e},Ze.apply(null,arguments)}function fr(e,n){e.prototype=Object.create(n.prototype),e.prototype.constructor=e,rn(e,n)}function rn(e,n){return rn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,t){return i.__proto__=t,i},rn(e,n)}function ma(e,n){if(typeof e!="object"||!e)return e;var i=e[Symbol.toPrimitive];if(i!==void 0){var t=i.call(e,n);if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}function va(e){var n=ma(e,"string");return typeof n=="symbol"?n:n+""}function ya(e,n){if(e){if(typeof e=="string")return Fn(e,n);var i={}.toString.call(e).slice(8,-1);return i==="Object"&&e.constructor&&(i=e.constructor.name),i==="Map"||i==="Set"?Array.from(e):i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Fn(e,n):void 0}}var Ge=Symbol("mobx-stored-annotations");function me(e){function n(i,t){if(ft(t))return e.decorate_20223_(i,t);pt(i,t,e)}return Object.assign(n,e)}function pt(e,n,i){ke(e,Ge)||jt(e,Ge,Ze({},e[Ge])),Sa(i)||(e[Ge][n]=i)}function ft(e){return typeof e=="object"&&typeof e.kind=="string"}var w=Symbol("mobx administration"),Ne=(function(){function e(i){i===void 0&&(i="Atom"),this.name_=void 0,this.flags_=0,this.observers_=new Set,this.lastAccessedBy_=0,this.lowestObserverState_=C.NOT_TRACKING_,this.onBOL=void 0,this.onBUOL=void 0,this.name_=i}var n=e.prototype;return n.onBO=function(){this.onBOL&&this.onBOL.forEach(function(t){return t()})},n.onBUO=function(){this.onBUOL&&this.onBUOL.forEach(function(t){return t()})},n.reportObserved=function(){return Mr(this)},n.reportChanged=function(){se(),Nr(this),oe()},n.toString=function(){return this.name_},tt(e,[{key:"isBeingObserved",get:function(){return Q(this.flags_,e.isBeingObservedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isBeingObservedMask_,t)}},{key:"isPendingUnobservation",get:function(){return Q(this.flags_,e.isPendingUnobservationMask_)},set:function(t){this.flags_=ee(this.flags_,e.isPendingUnobservationMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();Ne.isBeingObservedMask_=1;Ne.isPendingUnobservationMask_=2;Ne.diffValueMask_=4;var bn=je("Atom",Ne);function hr(e,n,i){n===void 0&&(n=Ue),i===void 0&&(i=Ue);var t=new Ne(e);return n!==Ue&&Iu(t,n),i!==Ue&&Vr(t,i),t}function ga(e,n){return Kr(e,n)}function _a(e,n){return Object.is?Object.is(e,n):e===n?e!==0||1/e===1/n:e!==e&&n!==n}var wt={structural:ga,default:_a};function Ve(e,n,i){return Lr(e)?e:Array.isArray(e)?W.array(e,{name:i}):Se(e)?W.object(e,void 0,{name:i}):et(e)?W.map(e,{name:i}):_e(e)?W.set(e,{name:i}):typeof e=="function"&&!Je(e)&&!lt(e)?lr(e)?Qe(e):ut(i,e):e}function ba(e,n,i){if(e==null||Ut(e)||$t(e)||Be(e)||fe(e))return e;if(Array.isArray(e))return W.array(e,{name:i,deep:!1});if(Se(e))return W.object(e,void 0,{name:i,deep:!1});if(et(e))return W.map(e,{name:i,deep:!1});if(_e(e))return W.set(e,{name:i,deep:!1})}function Lt(e){return e}function xa(e,n){return Kr(e,n)?n:e}var Oa="override";function Sa(e){return e.annotationType_===Oa}function ht(e,n){return{annotationType_:e,options_:n,make_:Aa,extend_:wa,decorate_20223_:Ia}}function Aa(e,n,i,t){var r;if((r=this.options_)!=null&&r.bound)return this.extend_(e,n,i,!1)===null?0:1;if(t===e.target_)return this.extend_(e,n,i,!1)===null?0:2;if(Je(i.value))return 1;var s=mr(e,this,n,i,!1);return he(t,n,s),2}function wa(e,n,i,t){var r=mr(e,this,n,i);return e.defineProperty_(n,r,t)}function Ia(e,n){var i=n.kind,t=n.name,r=n.addInitializer,s=this,o=function(l){var d,f,p,h;return Pe((d=(f=s.options_)==null?void 0:f.name)!=null?d:t.toString(),l,(p=(h=s.options_)==null?void 0:h.autoAction)!=null?p:!1)};if(i=="field")return function(u){var l,d=u;return Je(d)||(d=o(d)),(l=s.options_)!=null&&l.bound&&(d=d.bind(this),d.isMobxAction=!0),d};if(i=="method"){var a;return Je(e)||(e=o(e)),(a=this.options_)!=null&&a.bound&&r(function(){var u=this,l=u[t].bind(u);l.isMobxAction=!0,u[t]=l}),e}T("Cannot apply '"+s.annotationType_+"' to '"+String(t)+"' (kind: "+i+"):"+(`
'`+s.annotationType_+"' can only be used on properties with a function value."))}function ka(e,n,i,t){n.annotationType_,t.value}function mr(e,n,i,t,r){var s,o,a,u,l,d,f;r===void 0&&(r=O.safeDescriptors),ka(e,n,i,t);var p=t.value;if((s=n.options_)!=null&&s.bound){var h;p=p.bind((h=e.proxy_)!=null?h:e.target_)}return{value:Pe((o=(a=n.options_)==null?void 0:a.name)!=null?o:i.toString(),p,(u=(l=n.options_)==null?void 0:l.autoAction)!=null?u:!1,(d=n.options_)!=null&&d.bound?(f=e.proxy_)!=null?f:e.target_:void 0),configurable:r?e.isPlainObject_:!0,enumerable:!1,writable:!r}}function vr(e,n){return{annotationType_:e,options_:n,make_:Ma,extend_:Na,decorate_20223_:Ca}}function Ma(e,n,i,t){var r;if(t===e.target_)return this.extend_(e,n,i,!1)===null?0:2;if((r=this.options_)!=null&&r.bound&&(!ke(e.target_,n)||!lt(e.target_[n]))&&this.extend_(e,n,i,!1)===null)return 0;if(lt(i.value))return 1;var s=yr(e,this,n,i,!1,!1);return he(t,n,s),2}function Na(e,n,i,t){var r,s=yr(e,this,n,i,(r=this.options_)==null?void 0:r.bound);return e.defineProperty_(n,s,t)}function Ca(e,n){var i,t=n.name,r=n.addInitializer;return lt(e)||(e=Qe(e)),(i=this.options_)!=null&&i.bound&&r(function(){var s=this,o=s[t].bind(s);o.isMobXFlow=!0,s[t]=o}),e}function Ta(e,n,i,t){n.annotationType_,t.value}function yr(e,n,i,t,r,s){s===void 0&&(s=O.safeDescriptors),Ta(e,n,i,t);var o=t.value;if(lt(o)||(o=Qe(o)),r){var a;o=o.bind((a=e.proxy_)!=null?a:e.target_),o.isMobXFlow=!0}return{value:o,configurable:s?e.isPlainObject_:!0,enumerable:!1,writable:!s}}function xn(e,n){return{annotationType_:e,options_:n,make_:Ea,extend_:Ra,decorate_20223_:Va}}function Ea(e,n,i){return this.extend_(e,n,i,!1)===null?0:1}function Ra(e,n,i,t){return Pa(e,this,n,i),e.defineComputedProperty_(n,Ze({},this.options_,{get:i.get,set:i.set}),t)}function Va(e,n){var i=this,t=n.name,r=n.addInitializer;return r(function(){var s=it(this)[w],o=Ze({},i.options_,{get:e,context:this});o.name||(o.name="ObservableObject."+t.toString()),s.values_.set(t,new ce(o))}),function(){return this[w].getObservablePropValue_(t)}}function Pa(e,n,i,t){n.annotationType_,t.get}function Bt(e,n){return{annotationType_:e,options_:n,make_:Da,extend_:ja,decorate_20223_:La}}function Da(e,n,i){return this.extend_(e,n,i,!1)===null?0:1}function ja(e,n,i,t){var r,s;return Ba(e,this),e.defineObservableProperty_(n,i.value,(r=(s=this.options_)==null?void 0:s.enhancer)!=null?r:Ve,t)}function La(e,n){var i=this,t=n.kind,r=n.name,s=new WeakSet;function o(a,u){var l,d,f=it(a)[w],p=new Ee(u,(l=(d=i.options_)==null?void 0:d.enhancer)!=null?l:Ve,"ObservableObject."+r.toString(),!1);f.values_.set(r,p),s.add(a)}if(t=="accessor")return{get:function(){return s.has(this)||o(this,e.get.call(this)),this[w].getObservablePropValue_(r)},set:function(u){return s.has(this)||o(this,u),this[w].setObservablePropValue_(r,u)},init:function(u){return s.has(this)||o(this,u),u}}}function Ba(e,n,i,t){n.annotationType_}var qa="true",Fa=gr();function gr(e){return{annotationType_:qa,options_:e,make_:$a,extend_:Ua,decorate_20223_:za}}function $a(e,n,i,t){var r,s;if(i.get)return qt.make_(e,n,i,t);if(i.set){var o=Je(i.set)?i.set:Pe(n.toString(),i.set);return t===e.target_?e.defineProperty_(n,{configurable:O.safeDescriptors?e.isPlainObject_:!0,set:o})===null?0:2:(he(t,n,{configurable:!0,set:o}),2)}if(t!==e.target_&&typeof i.value=="function"){var a;if(lr(i.value)){var u,l=(u=this.options_)!=null&&u.autoBind?Qe.bound:Qe;return l.make_(e,n,i,t)}var d=(a=this.options_)!=null&&a.autoBind?ut.bound:ut;return d.make_(e,n,i,t)}var f=((r=this.options_)==null?void 0:r.deep)===!1?W.ref:W;if(typeof i.value=="function"&&(s=this.options_)!=null&&s.autoBind){var p;i.value=i.value.bind((p=e.proxy_)!=null?p:e.target_)}return f.make_(e,n,i,t)}function Ua(e,n,i,t){var r,s;if(i.get)return qt.extend_(e,n,i,t);if(i.set)return e.defineProperty_(n,{configurable:O.safeDescriptors?e.isPlainObject_:!0,set:Pe(n.toString(),i.set)},t);if(typeof i.value=="function"&&(r=this.options_)!=null&&r.autoBind){var o;i.value=i.value.bind((o=e.proxy_)!=null?o:e.target_)}var a=((s=this.options_)==null?void 0:s.deep)===!1?W.ref:W;return a.extend_(e,n,i,t)}function za(e,n){T("'"+this.annotationType_+"' cannot be used as a decorator")}var Ga="observable",Ka="observable.ref",Ha="observable.shallow",Wa="observable.struct",_r={deep:!0,name:void 0,defaultDecorator:void 0,proxy:!0};Object.freeze(_r);function yt(e){return e||_r}var sn=Bt(Ga),Ya=Bt(Ka,{enhancer:Lt}),Xa=Bt(Ha,{enhancer:ba}),Za=Bt(Wa,{enhancer:xa}),br=me(sn);function gt(e){return e.deep===!0?Ve:e.deep===!1?Lt:Qa(e.defaultDecorator)}function Ja(e){var n;return e?(n=e.defaultDecorator)!=null?n:gr(e):void 0}function Qa(e){var n,i;return e&&(n=(i=e.options_)==null?void 0:i.enhancer)!=null?n:Ve}function xr(e,n,i){if(ft(n))return sn.decorate_20223_(e,n);if(Re(n)){pt(e,n,sn);return}return Lr(e)?e:Se(e)?W.object(e,n,i):Array.isArray(e)?W.array(e,n):et(e)?W.map(e,n):_e(e)?W.set(e,n):typeof e=="object"&&e!==null?e:W.box(e,n)}sr(xr,br);var eu={box:function(n,i){var t=yt(i);return new Ee(n,gt(t),t.name,!0,t.equals)},array:function(n,i){var t=yt(i);return(O.useProxies===!1||t.proxy===!1?zu:Vu)(n,gt(t),t.name)},map:function(n,i){var t=yt(i);return new qr(n,gt(t),t.name)},set:function(n,i){var t=yt(i);return new Fr(n,gt(t),t.name)},object:function(n,i,t){return qe(function(){return Dr(O.useProxies===!1||t?.proxy===!1?it({},t):Tu({},t),n,i)})},ref:me(Ya),shallow:me(Xa),deep:br,struct:me(Za)},W=sr(xr,eu),Or="computed",tu="computed.struct",on=xn(Or),nu=xn(tu,{equals:wt.structural}),qt=function(n,i){if(ft(i))return on.decorate_20223_(n,i);if(Re(i))return pt(n,i,on);if(Se(n))return me(xn(Or,n));var t=Se(i)?i:{};return t.get=n,t.name||(t.name=n.name||""),new ce(t)};Object.assign(qt,on);qt.struct=me(nu);var $n,Un,It=0,iu=1,ru=($n=(Un=At(function(){},"name"))==null?void 0:Un.configurable)!=null?$n:!1,zn={value:"action",configurable:!0,writable:!1,enumerable:!1};function Pe(e,n,i,t){i===void 0&&(i=!1);function r(){return su(e,i,n,t||this,arguments)}return r.isMobxAction=!0,r.toString=function(){return n.toString()},ru&&(zn.value=e,he(r,"name",zn)),r}function su(e,n,i,t,r){var s=ou(e,n);try{return i.apply(t,r)}catch(o){throw s.error_=o,o}finally{au(s)}}function ou(e,n,i,t){var r=!1,s=0,o=O.trackingDerivation,a=!n||!o;se();var u=O.allowStateChanges;a&&(Le(),u=On(!0));var l=An(!0),d={runAsAction_:a,prevDerivation_:o,prevAllowStateChanges_:u,prevAllowStateReads_:l,notifySpy_:r,startTime_:s,actionId_:iu++,parentActionId_:It};return It=d.actionId_,d}function au(e){It!==e.actionId_&&T(30),It=e.parentActionId_,e.error_!==void 0&&(O.suppressReactionErrors=!0),Sn(e.prevAllowStateChanges_),rt(e.prevAllowStateReads_),oe(),e.runAsAction_&&Oe(e.prevDerivation_),O.suppressReactionErrors=!1}function On(e){var n=O.allowStateChanges;return O.allowStateChanges=e,n}function Sn(e){O.allowStateChanges=e}var Ee=(function(e){function n(t,r,s,o,a){var u;return s===void 0&&(s="ObservableValue"),a===void 0&&(a=wt.default),u=e.call(this,s)||this,u.enhancer=void 0,u.name_=void 0,u.equals=void 0,u.hasUnreportedChange_=!1,u.interceptors_=void 0,u.changeListeners_=void 0,u.value_=void 0,u.dehancer=void 0,u.enhancer=r,u.name_=s,u.equals=a,u.value_=r(t,void 0,s),u}fr(n,e);var i=n.prototype;return i.dehanceValue=function(r){return this.dehancer!==void 0?this.dehancer(r):r},i.set=function(r){this.value_,r=this.prepareNewValue_(r),r!==O.UNCHANGED&&this.setNewValue_(r)},i.prepareNewValue_=function(r){if(ie(this)){var s=re(this,{object:this,type:ve,newValue:r});if(!s)return O.UNCHANGED;r=s.newValue}return r=this.enhancer(r,this.value_,this.name_),this.equals(this.value_,r)?O.UNCHANGED:r},i.setNewValue_=function(r){var s=this.value_;this.value_=r,this.reportChanged(),ae(this)&&ue(this,{type:ve,object:this,newValue:r,oldValue:s})},i.get=function(){return this.reportObserved(),this.dehanceValue(this.value_)},i.intercept_=function(r){return mt(this,r)},i.observe_=function(r,s){return s&&r({observableKind:"value",debugObjectName:this.name_,object:this,type:ve,newValue:this.value_,oldValue:void 0}),vt(this,r)},i.raw=function(){return this.value_},i.toJSON=function(){return this.get()},i.toString=function(){return this.name_+"["+this.value_+"]"},i.valueOf=function(){return pr(this.get())},i[Symbol.toPrimitive]=function(){return this.valueOf()},n})(Ne),ce=(function(){function e(i){this.dependenciesState_=C.NOT_TRACKING_,this.observing_=[],this.newObserving_=null,this.observers_=new Set,this.runId_=0,this.lastAccessedBy_=0,this.lowestObserverState_=C.UP_TO_DATE_,this.unboundDepsCount_=0,this.value_=new Mt(null),this.name_=void 0,this.triggeredBy_=void 0,this.flags_=0,this.derivation=void 0,this.setter_=void 0,this.isTracing_=kt.NONE,this.scope_=void 0,this.equals_=void 0,this.requiresReaction_=void 0,this.keepAlive_=void 0,this.onBOL=void 0,this.onBUOL=void 0,i.get||T(31),this.derivation=i.get,this.name_=i.name||"ComputedValue",i.set&&(this.setter_=Pe("ComputedValue-setter",i.set)),this.equals_=i.equals||(i.compareStructural||i.struct?wt.structural:wt.default),this.scope_=i.context,this.requiresReaction_=i.requiresReaction,this.keepAlive_=!!i.keepAlive}var n=e.prototype;return n.onBecomeStale_=function(){du(this)},n.onBO=function(){this.onBOL&&this.onBOL.forEach(function(t){return t()})},n.onBUO=function(){this.onBUOL&&this.onBUOL.forEach(function(t){return t()})},n.get=function(){if(this.isComputing&&T(32,this.name_,this.derivation),O.inBatch===0&&this.observers_.size===0&&!this.keepAlive_)an(this)&&(this.warnAboutUntrackedRead_(),se(),this.value_=this.computeValue_(!1),oe());else if(Mr(this),an(this)){var t=O.trackingContext;this.keepAlive_&&!t&&(O.trackingContext=this),this.trackAndCompute()&&cu(this),O.trackingContext=t}var r=this.value_;if(_t(r))throw r.cause;return r},n.set=function(t){if(this.setter_){this.isRunningSetter&&T(33,this.name_),this.isRunningSetter=!0;try{this.setter_.call(this.scope_,t)}finally{this.isRunningSetter=!1}}else T(34,this.name_)},n.trackAndCompute=function(){var t=this.value_,r=this.dependenciesState_===C.NOT_TRACKING_,s=this.computeValue_(!0),o=r||_t(t)||_t(s)||!this.equals_(t,s);return o&&(this.value_=s),o},n.computeValue_=function(t){this.isComputing=!0;var r=On(!1),s;if(t)s=Sr(this,this.derivation,this.scope_);else if(O.disableErrorBoundaries===!0)s=this.derivation.call(this.scope_);else try{s=this.derivation.call(this.scope_)}catch(o){s=new Mt(o)}return Sn(r),this.isComputing=!1,s},n.suspend_=function(){this.keepAlive_||(un(this),this.value_=void 0)},n.observe_=function(t,r){var s=this,o=!0,a=void 0;return xu(function(){var u=s.get();if(!o||r){var l=Le();t({observableKind:"computed",debugObjectName:s.name_,type:ve,object:s,newValue:u,oldValue:a}),Oe(l)}o=!1,a=u})},n.warnAboutUntrackedRead_=function(){},n.toString=function(){return this.name_+"["+this.derivation.toString()+"]"},n.valueOf=function(){return pr(this.get())},n[Symbol.toPrimitive]=function(){return this.valueOf()},tt(e,[{key:"isComputing",get:function(){return Q(this.flags_,e.isComputingMask_)},set:function(t){this.flags_=ee(this.flags_,e.isComputingMask_,t)}},{key:"isRunningSetter",get:function(){return Q(this.flags_,e.isRunningSetterMask_)},set:function(t){this.flags_=ee(this.flags_,e.isRunningSetterMask_,t)}},{key:"isBeingObserved",get:function(){return Q(this.flags_,e.isBeingObservedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isBeingObservedMask_,t)}},{key:"isPendingUnobservation",get:function(){return Q(this.flags_,e.isPendingUnobservationMask_)},set:function(t){this.flags_=ee(this.flags_,e.isPendingUnobservationMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();ce.isComputingMask_=1;ce.isRunningSetterMask_=2;ce.isBeingObservedMask_=4;ce.isPendingUnobservationMask_=8;ce.diffValueMask_=16;var Ft=je("ComputedValue",ce),C;(function(e){e[e.NOT_TRACKING_=-1]="NOT_TRACKING_",e[e.UP_TO_DATE_=0]="UP_TO_DATE_",e[e.POSSIBLY_STALE_=1]="POSSIBLY_STALE_",e[e.STALE_=2]="STALE_"})(C||(C={}));var kt;(function(e){e[e.NONE=0]="NONE",e[e.LOG=1]="LOG",e[e.BREAK=2]="BREAK"})(kt||(kt={}));var Mt=function(n){this.cause=void 0,this.cause=n};function _t(e){return e instanceof Mt}function an(e){switch(e.dependenciesState_){case C.UP_TO_DATE_:return!1;case C.NOT_TRACKING_:case C.STALE_:return!0;case C.POSSIBLY_STALE_:{for(var n=An(!0),i=Le(),t=e.observing_,r=t.length,s=0;s<r;s++){var o=t[s];if(Ft(o)){if(O.disableErrorBoundaries)o.get();else try{o.get()}catch{return Oe(i),rt(n),!0}if(e.dependenciesState_===C.STALE_)return Oe(i),rt(n),!0}}return wr(e),Oe(i),rt(n),!1}}}function Sr(e,n,i){var t=An(!0);wr(e),e.newObserving_=new Array(e.runId_===0?100:e.observing_.length),e.unboundDepsCount_=0,e.runId_=++O.runId;var r=O.trackingDerivation;O.trackingDerivation=e,O.inBatch++;var s;if(O.disableErrorBoundaries===!0)s=n.call(i);else try{s=n.call(i)}catch(o){s=new Mt(o)}return O.inBatch--,O.trackingDerivation=r,uu(e),rt(t),s}function uu(e){for(var n=e.observing_,i=e.observing_=e.newObserving_,t=C.UP_TO_DATE_,r=0,s=e.unboundDepsCount_,o=0;o<s;o++){var a=i[o];a.diffValue===0&&(a.diffValue=1,r!==o&&(i[r]=a),r++),a.dependenciesState_>t&&(t=a.dependenciesState_)}for(i.length=r,e.newObserving_=null,s=n.length;s--;){var u=n[s];u.diffValue===0&&Ir(u,e),u.diffValue=0}for(;r--;){var l=i[r];l.diffValue===1&&(l.diffValue=0,lu(l,e))}t!==C.UP_TO_DATE_&&(e.dependenciesState_=t,e.onBecomeStale_())}function un(e){var n=e.observing_;e.observing_=[];for(var i=n.length;i--;)Ir(n[i],e);e.dependenciesState_=C.NOT_TRACKING_}function Ar(e){var n=Le();try{return e()}finally{Oe(n)}}function Le(){var e=O.trackingDerivation;return O.trackingDerivation=null,e}function Oe(e){O.trackingDerivation=e}function An(e){var n=O.allowStateReads;return O.allowStateReads=e,n}function rt(e){O.allowStateReads=e}function wr(e){if(e.dependenciesState_!==C.UP_TO_DATE_){e.dependenciesState_=C.UP_TO_DATE_;for(var n=e.observing_,i=n.length;i--;)n[i].lowestObserverState_=C.UP_TO_DATE_}}var Xt=function(){this.version=6,this.UNCHANGED={},this.trackingDerivation=null,this.trackingContext=null,this.runId=0,this.mobxGuid=0,this.inBatch=0,this.pendingUnobservations=[],this.pendingReactions=[],this.isRunningReactions=!1,this.allowStateChanges=!1,this.allowStateReads=!0,this.enforceActions=!0,this.spyListeners=[],this.globalReactionErrorHandlers=[],this.computedRequiresReaction=!1,this.reactionRequiresObservable=!1,this.observableRequiresReaction=!1,this.disableErrorBoundaries=!1,this.suppressReactionErrors=!1,this.useProxies=!0,this.verifyProxies=!1,this.safeDescriptors=!0},Zt=!0,O=(function(){var e=_n();return e.__mobxInstanceCount>0&&!e.__mobxGlobals&&(Zt=!1),e.__mobxGlobals&&e.__mobxGlobals.version!==new Xt().version&&(Zt=!1),Zt?e.__mobxGlobals?(e.__mobxInstanceCount+=1,e.__mobxGlobals.UNCHANGED||(e.__mobxGlobals.UNCHANGED={}),e.__mobxGlobals):(e.__mobxInstanceCount=1,e.__mobxGlobals=new Xt):(setTimeout(function(){T(35)},1),new Xt)})();function lu(e,n){e.observers_.add(n),e.lowestObserverState_>n.dependenciesState_&&(e.lowestObserverState_=n.dependenciesState_)}function Ir(e,n){e.observers_.delete(n),e.observers_.size===0&&kr(e)}function kr(e){e.isPendingUnobservation===!1&&(e.isPendingUnobservation=!0,O.pendingUnobservations.push(e))}function se(){O.inBatch++}function oe(){if(--O.inBatch===0){Cr();for(var e=O.pendingUnobservations,n=0;n<e.length;n++){var i=e[n];i.isPendingUnobservation=!1,i.observers_.size===0&&(i.isBeingObserved&&(i.isBeingObserved=!1,i.onBUO()),i instanceof ce&&i.suspend_())}O.pendingUnobservations=[]}}function Mr(e){var n=O.trackingDerivation;return n!==null?(n.runId_!==e.lastAccessedBy_&&(e.lastAccessedBy_=n.runId_,n.newObserving_[n.unboundDepsCount_++]=e,!e.isBeingObserved&&O.trackingContext&&(e.isBeingObserved=!0,e.onBO())),e.isBeingObserved):(e.observers_.size===0&&O.inBatch>0&&kr(e),!1)}function Nr(e){e.lowestObserverState_!==C.STALE_&&(e.lowestObserverState_=C.STALE_,e.observers_.forEach(function(n){n.dependenciesState_===C.UP_TO_DATE_&&n.onBecomeStale_(),n.dependenciesState_=C.STALE_}))}function cu(e){e.lowestObserverState_!==C.STALE_&&(e.lowestObserverState_=C.STALE_,e.observers_.forEach(function(n){n.dependenciesState_===C.POSSIBLY_STALE_?n.dependenciesState_=C.STALE_:n.dependenciesState_===C.UP_TO_DATE_&&(e.lowestObserverState_=C.UP_TO_DATE_)}))}function du(e){e.lowestObserverState_===C.UP_TO_DATE_&&(e.lowestObserverState_=C.POSSIBLY_STALE_,e.observers_.forEach(function(n){n.dependenciesState_===C.UP_TO_DATE_&&(n.dependenciesState_=C.POSSIBLY_STALE_,n.onBecomeStale_())}))}var Me=(function(){function e(i,t,r,s){i===void 0&&(i="Reaction"),this.name_=void 0,this.onInvalidate_=void 0,this.errorHandler_=void 0,this.requiresObservable_=void 0,this.observing_=[],this.newObserving_=[],this.dependenciesState_=C.NOT_TRACKING_,this.runId_=0,this.unboundDepsCount_=0,this.flags_=0,this.isTracing_=kt.NONE,this.name_=i,this.onInvalidate_=t,this.errorHandler_=r,this.requiresObservable_=s}var n=e.prototype;return n.onBecomeStale_=function(){this.schedule_()},n.schedule_=function(){this.isScheduled||(this.isScheduled=!0,O.pendingReactions.push(this),Cr())},n.runReaction_=function(){if(!this.isDisposed){se(),this.isScheduled=!1;var t=O.trackingContext;if(O.trackingContext=this,an(this)){this.isTrackPending=!0;try{this.onInvalidate_()}catch(r){this.reportExceptionInDerivation_(r)}}O.trackingContext=t,oe()}},n.track=function(t){if(!this.isDisposed){se(),this.isRunning=!0;var r=O.trackingContext;O.trackingContext=this;var s=Sr(this,t,void 0);O.trackingContext=r,this.isRunning=!1,this.isTrackPending=!1,this.isDisposed&&un(this),_t(s)&&this.reportExceptionInDerivation_(s.cause),oe()}},n.reportExceptionInDerivation_=function(t){var r=this;if(this.errorHandler_){this.errorHandler_(t,this);return}if(O.disableErrorBoundaries)throw t;var s="[mobx] uncaught error in '"+this+"'";O.suppressReactionErrors||console.error(s,t),O.globalReactionErrorHandlers.forEach(function(o){return o(t,r)})},n.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.isRunning||(se(),un(this),oe()))},n.getDisposer_=function(t){var r=this,s=function o(){r.dispose(),t==null||t.removeEventListener==null||t.removeEventListener("abort",o)};return t==null||t.addEventListener==null||t.addEventListener("abort",s),s[w]=this,"dispose"in Symbol&&typeof Symbol.dispose=="symbol"&&(s[Symbol.dispose]=s),s},n.toString=function(){return"Reaction["+this.name_+"]"},n.trace=function(t){},tt(e,[{key:"isDisposed",get:function(){return Q(this.flags_,e.isDisposedMask_)},set:function(t){this.flags_=ee(this.flags_,e.isDisposedMask_,t)}},{key:"isScheduled",get:function(){return Q(this.flags_,e.isScheduledMask_)},set:function(t){this.flags_=ee(this.flags_,e.isScheduledMask_,t)}},{key:"isTrackPending",get:function(){return Q(this.flags_,e.isTrackPendingMask_)},set:function(t){this.flags_=ee(this.flags_,e.isTrackPendingMask_,t)}},{key:"isRunning",get:function(){return Q(this.flags_,e.isRunningMask_)},set:function(t){this.flags_=ee(this.flags_,e.isRunningMask_,t)}},{key:"diffValue",get:function(){return Q(this.flags_,e.diffValueMask_)?1:0},set:function(t){this.flags_=ee(this.flags_,e.diffValueMask_,t===1)}}])})();Me.isDisposedMask_=1;Me.isScheduledMask_=2;Me.isTrackPendingMask_=4;Me.isRunningMask_=8;Me.diffValueMask_=16;var pu=100,fu=function(n){return n()};function Cr(){O.inBatch>0||O.isRunningReactions||fu(hu)}function hu(){O.isRunningReactions=!0;for(var e=O.pendingReactions,n=0;e.length>0;){++n===pu&&(console.error("[mobx] cycle in reaction: "+e[0]),e.splice(0));for(var i=e.splice(0),t=0,r=i.length;t<r;t++)i[t].runReaction_()}O.isRunningReactions=!1}var Nt=je("Reaction",Me);function st(){return!1}function mu(e){return console.warn("[mobx.spy] Is a no-op in production builds"),function(){}}var Tr="action",vu="action.bound",Er="autoAction",yu="autoAction.bound",gu="<unnamed action>",ln=ht(Tr),_u=ht(vu,{bound:!0}),cn=ht(Er,{autoAction:!0}),bu=ht(yu,{autoAction:!0,bound:!0});function Rr(e){var n=function(t,r){if(le(t))return Pe(t.name||gu,t,e);if(le(r))return Pe(t,r,e);if(ft(r))return(e?cn:ln).decorate_20223_(t,r);if(Re(r))return pt(t,r,e?cn:ln);if(Re(t))return me(ht(e?Er:Tr,{name:t,autoAction:e}))};return n}var Ke=Rr(!1);Object.assign(Ke,ln);var ut=Rr(!0);Object.assign(ut,cn);Ke.bound=me(_u);ut.bound=me(bu);function Je(e){return le(e)&&e.isMobxAction===!0}function xu(e,n){var i,t,r,s;n===void 0&&(n=or);var o=(i=(t=n)==null?void 0:t.name)!=null?i:"Autorun",a=!n.scheduler&&!n.delay,u;if(a)u=new Me(o,function(){this.track(f)},n.onError,n.requiresObservable);else{var l=Su(n),d=!1;u=new Me(o,function(){d||(d=!0,l(function(){d=!1,u.isDisposed||u.track(f)}))},n.onError,n.requiresObservable)}function f(){e(u)}return(r=n)!=null&&(r=r.signal)!=null&&r.aborted||u.schedule_(),u.getDisposer_((s=n)==null?void 0:s.signal)}var Ou=function(n){return n()};function Su(e){return e.scheduler?e.scheduler:e.delay?function(n){return setTimeout(n,e.delay)}:Ou}var Au="onBO",wu="onBUO";function Iu(e,n,i){return Pr(Au,e,n,i)}function Vr(e,n,i){return Pr(wu,e,n,i)}function Pr(e,n,i,t){var r=dn(n),s=le(t)?t:i,o=e+"L";return r[o]?r[o].add(s):r[o]=new Set([s]),function(){var a=r[o];a&&(a.delete(s),a.size===0&&delete r[o])}}function Dr(e,n,i,t){var r=fa(n);return qe(function(){var s=it(e,t)[w];at(r).forEach(function(o){s.extend_(o,r[o],i&&o in i?i[o]:!0)})}),e}var ku=0;function jr(){this.message="FLOW_CANCELLED"}jr.prototype=Object.create(Error.prototype);var Jt=vr("flow"),Mu=vr("flow.bound",{bound:!0}),Qe=Object.assign(function(n,i){if(ft(i))return Jt.decorate_20223_(n,i);if(Re(i))return pt(n,i,Jt);var t=n,r=t.name||"<unnamed flow>",s=function(){var a=this,u=arguments,l=++ku,d=Ke(r+" - runid: "+l+" - init",t).apply(a,u),f,p=void 0,h=new Promise(function(m,g){var y=0;f=g;function b(A){p=void 0;var E;try{E=Ke(r+" - runid: "+l+" - yield "+y++,d.next).call(d,A)}catch(M){return g(M)}S(E)}function _(A){p=void 0;var E;try{E=Ke(r+" - runid: "+l+" - yield "+y++,d.throw).call(d,A)}catch(M){return g(M)}S(E)}function S(A){if(le(A?.then)){A.then(S,g);return}return A.done?m(A.value):(p=Promise.resolve(A.value),p.then(b,_))}b(void 0)});return h.cancel=Ke(r+" - runid: "+l+" - cancel",function(){try{p&&Gn(p);var m=d.return(void 0),g=Promise.resolve(m.value);g.then(Ue,Ue),Gn(g),f(new jr)}catch(y){f(y)}}),h};return s.isMobXFlow=!0,s},Jt);Qe.bound=me(Mu);function Gn(e){le(e.cancel)&&e.cancel()}function lt(e){return e?.isMobXFlow===!0}function Nu(e,n){return e?Ut(e)||!!e[w]||bn(e)||Nt(e)||Ft(e):!1}function Lr(e){return Nu(e)}function be(e,n){n===void 0&&(n=void 0),se();try{return e.apply(n)}finally{oe()}}function $e(e){return e[w]}var Cu={has:function(n,i){return $e(n).has_(i)},get:function(n,i){return $e(n).get_(i)},set:function(n,i,t){var r;return Re(i)?(r=$e(n).set_(i,t,!0))!=null?r:!0:!1},deleteProperty:function(n,i){var t;return Re(i)?(t=$e(n).delete_(i,!0))!=null?t:!0:!1},defineProperty:function(n,i,t){var r;return(r=$e(n).defineProperty_(i,t))!=null?r:!0},ownKeys:function(n){return $e(n).ownKeys_()},preventExtensions:function(n){T(13)}};function Tu(e,n){var i,t;return ar(),e=it(e,n),(t=(i=e[w]).proxy_)!=null?t:i.proxy_=new Proxy(e,Cu)}function ie(e){return e.interceptors_!==void 0&&e.interceptors_.length>0}function mt(e,n){var i=e.interceptors_||(e.interceptors_=[]);return i.push(n),ur(function(){var t=i.indexOf(n);t!==-1&&i.splice(t,1)})}function re(e,n){var i=Le();try{for(var t=[].concat(e.interceptors_||[]),r=0,s=t.length;r<s&&(n=t[r](n),n&&!n.type&&T(14),!!n);r++);return n}finally{Oe(i)}}function ae(e){return e.changeListeners_!==void 0&&e.changeListeners_.length>0}function vt(e,n){var i=e.changeListeners_||(e.changeListeners_=[]);return i.push(n),ur(function(){var t=i.indexOf(n);t!==-1&&i.splice(t,1)})}function ue(e,n){var i=Le(),t=e.changeListeners_;if(t){t=t.slice();for(var r=0,s=t.length;r<s;r++)t[r](n);Oe(i)}}var Qt=Symbol("mobx-keys");function nt(e,n,i){return Se(e)?Dr(e,e,n,i):(qe(function(){var t=it(e,i)[w];if(!e[Qt]){var r=Object.getPrototypeOf(e),s=new Set([].concat(at(e),at(r)));s.delete("constructor"),s.delete(w),jt(r,Qt,s)}e[Qt].forEach(function(o){return t.make_(o,n&&o in n?n[o]:!0)})}),e)}var Kn="splice",ve="update",Eu=1e4,Ru={get:function(n,i){var t=n[w];return i===w?t:i==="length"?t.getArrayLength_():typeof i=="string"&&!isNaN(i)?t.get_(parseInt(i)):ke(Ct,i)?Ct[i]:n[i]},set:function(n,i,t){var r=n[w];return i==="length"&&r.setArrayLength_(t),typeof i=="symbol"||isNaN(i)?n[i]=t:r.set_(parseInt(i),t),!0},preventExtensions:function(){T(15)}},wn=(function(){function e(i,t,r,s){i===void 0&&(i="ObservableArray"),this.owned_=void 0,this.legacyMode_=void 0,this.atom_=void 0,this.values_=[],this.interceptors_=void 0,this.changeListeners_=void 0,this.enhancer_=void 0,this.dehancer=void 0,this.proxy_=void 0,this.lastKnownLength_=0,this.owned_=r,this.legacyMode_=s,this.atom_=new Ne(i),this.enhancer_=function(o,a){return t(o,a,"ObservableArray[..]")}}var n=e.prototype;return n.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},n.dehanceValues_=function(t){return this.dehancer!==void 0&&t.length>0?t.map(this.dehancer):t},n.intercept_=function(t){return mt(this,t)},n.observe_=function(t,r){return r===void 0&&(r=!1),r&&t({observableKind:"array",object:this.proxy_,debugObjectName:this.atom_.name_,type:"splice",index:0,added:this.values_.slice(),addedCount:this.values_.length,removed:[],removedCount:0}),vt(this,t)},n.getArrayLength_=function(){return this.atom_.reportObserved(),this.values_.length},n.setArrayLength_=function(t){(typeof t!="number"||isNaN(t)||t<0)&&T("Out of range: "+t);var r=this.values_.length;if(t!==r)if(t>r){for(var s=new Array(t-r),o=0;o<t-r;o++)s[o]=void 0;this.spliceWithArray_(r,0,s)}else this.spliceWithArray_(t,r-t)},n.updateArrayLength_=function(t,r){t!==this.lastKnownLength_&&T(16),this.lastKnownLength_+=r,this.legacyMode_&&r>0&&Gr(t+r+1)},n.spliceWithArray_=function(t,r,s){var o=this;this.atom_;var a=this.values_.length;if(t===void 0?t=0:t>a?t=a:t<0&&(t=Math.max(0,a+t)),arguments.length===1?r=a-t:r==null?r=0:r=Math.max(0,Math.min(r,a-t)),s===void 0&&(s=nn),ie(this)){var u=re(this,{object:this.proxy_,type:Kn,index:t,removedCount:r,added:s});if(!u)return nn;r=u.removedCount,s=u.added}if(s=s.length===0?s:s.map(function(f){return o.enhancer_(f,void 0)}),this.legacyMode_){var l=s.length-r;this.updateArrayLength_(a,l)}var d=this.spliceItemsIntoValues_(t,r,s);return(r!==0||s.length!==0)&&this.notifyArraySplice_(t,s,d),this.dehanceValues_(d)},n.spliceItemsIntoValues_=function(t,r,s){if(s.length<Eu){var o;return(o=this.values_).splice.apply(o,[t,r].concat(s))}else{var a=this.values_.slice(t,t+r),u=this.values_.slice(t+r);this.values_.length+=s.length-r;for(var l=0;l<s.length;l++)this.values_[t+l]=s[l];for(var d=0;d<u.length;d++)this.values_[t+s.length+d]=u[d];return a}},n.notifyArrayChildUpdate_=function(t,r,s){var o=!this.owned_&&st(),a=ae(this),u=a||o?{observableKind:"array",object:this.proxy_,type:ve,debugObjectName:this.atom_.name_,index:t,newValue:r,oldValue:s}:null;this.atom_.reportChanged(),a&&ue(this,u)},n.notifyArraySplice_=function(t,r,s){var o=!this.owned_&&st(),a=ae(this),u=a||o?{observableKind:"array",object:this.proxy_,debugObjectName:this.atom_.name_,type:Kn,index:t,removed:s,added:r,removedCount:s.length,addedCount:r.length}:null;this.atom_.reportChanged(),a&&ue(this,u)},n.get_=function(t){if(this.legacyMode_&&t>=this.values_.length){console.warn("[mobx] Out of bounds read: "+t);return}return this.atom_.reportObserved(),this.dehanceValue_(this.values_[t])},n.set_=function(t,r){var s=this.values_;if(this.legacyMode_&&t>s.length&&T(17,t,s.length),t<s.length){this.atom_;var o=s[t];if(ie(this)){var a=re(this,{type:ve,object:this.proxy_,index:t,newValue:r});if(!a)return;r=a.newValue}r=this.enhancer_(r,o);var u=r!==o;u&&(s[t]=r,this.notifyArrayChildUpdate_(t,r,o))}else{for(var l=new Array(t+1-s.length),d=0;d<l.length-1;d++)l[d]=void 0;l[l.length-1]=r,this.spliceWithArray_(s.length,0,l)}},e})();function Vu(e,n,i,t){return i===void 0&&(i="ObservableArray"),t===void 0&&(t=!1),ar(),qe(function(){var r=new wn(i,n,t,!1);cr(r.values_,w,r);var s=new Proxy(r.values_,Ru);return r.proxy_=s,e&&e.length&&r.spliceWithArray_(0,0,e),s})}var Ct={clear:function(){return this.splice(0)},replace:function(n){var i=this[w];return i.spliceWithArray_(0,i.values_.length,n)},toJSON:function(){return this.slice()},splice:function(n,i){for(var t=arguments.length,r=new Array(t>2?t-2:0),s=2;s<t;s++)r[s-2]=arguments[s];var o=this[w];switch(arguments.length){case 0:return[];case 1:return o.spliceWithArray_(n);case 2:return o.spliceWithArray_(n,i)}return o.spliceWithArray_(n,i,r)},spliceWithArray:function(n,i,t){return this[w].spliceWithArray_(n,i,t)},push:function(){for(var n=this[w],i=arguments.length,t=new Array(i),r=0;r<i;r++)t[r]=arguments[r];return n.spliceWithArray_(n.values_.length,0,t),n.values_.length},pop:function(){return this.splice(Math.max(this[w].values_.length-1,0),1)[0]},shift:function(){return this.splice(0,1)[0]},unshift:function(){for(var n=this[w],i=arguments.length,t=new Array(i),r=0;r<i;r++)t[r]=arguments[r];return n.spliceWithArray_(0,0,t),n.values_.length},reverse:function(){return O.trackingDerivation&&T(37,"reverse"),this.replace(this.slice().reverse()),this},sort:function(){O.trackingDerivation&&T(37,"sort");var n=this.slice();return n.sort.apply(n,arguments),this.replace(n),this},remove:function(n){var i=this[w],t=i.dehanceValues_(i.values_).indexOf(n);return t>-1?(this.splice(t,1),!0):!1}};D("at",ne);D("concat",ne);D("flat",ne);D("includes",ne);D("indexOf",ne);D("join",ne);D("lastIndexOf",ne);D("slice",ne);D("toString",ne);D("toLocaleString",ne);D("toSorted",ne);D("toSpliced",ne);D("with",ne);D("every",de);D("filter",de);D("find",de);D("findIndex",de);D("findLast",de);D("findLastIndex",de);D("flatMap",de);D("forEach",de);D("map",de);D("some",de);D("toReversed",de);D("reduce",Br);D("reduceRight",Br);function D(e,n){typeof Array.prototype[e]=="function"&&(Ct[e]=n(e))}function ne(e){return function(){var n=this[w];n.atom_.reportObserved();var i=n.dehanceValues_(n.values_);return i[e].apply(i,arguments)}}function de(e){return function(n,i){var t=this,r=this[w];r.atom_.reportObserved();var s=r.dehanceValues_(r.values_);return s[e](function(o,a){return n.call(i,o,a,t)})}}function Br(e){return function(){var n=this,i=this[w];i.atom_.reportObserved();var t=i.dehanceValues_(i.values_),r=arguments[0];return arguments[0]=function(s,o,a){return r(s,o,a,n)},t[e].apply(t,arguments)}}var Pu=je("ObservableArrayAdministration",wn);function $t(e){return Dt(e)&&Pu(e[w])}var Du={},Ie="add",Tt="delete",qr=(function(){function e(i,t,r){var s=this;t===void 0&&(t=Ve),r===void 0&&(r="ObservableMap"),this.enhancer_=void 0,this.name_=void 0,this[w]=Du,this.data_=void 0,this.hasMap_=void 0,this.keysAtom_=void 0,this.interceptors_=void 0,this.changeListeners_=void 0,this.dehancer=void 0,this.enhancer_=t,this.name_=r,le(Map)||T(18),qe(function(){s.keysAtom_=hr("ObservableMap.keys()"),s.data_=new Map,s.hasMap_=new Map,i&&s.merge(i)})}var n=e.prototype;return n.has_=function(t){return this.data_.has(t)},n.has=function(t){var r=this;if(!O.trackingDerivation)return this.has_(t);var s=this.hasMap_.get(t);if(!s){var o=s=new Ee(this.has_(t),Lt,"ObservableMap.key?",!1);this.hasMap_.set(t,o),Vr(o,function(){return r.hasMap_.delete(t)})}return s.get()},n.set=function(t,r){var s=this.has_(t);if(ie(this)){var o=re(this,{type:s?ve:Ie,object:this,newValue:r,name:t});if(!o)return this;r=o.newValue}return s?this.updateValue_(t,r):this.addValue_(t,r),this},n.delete=function(t){var r=this;if(this.keysAtom_,ie(this)){var s=re(this,{type:Tt,object:this,name:t});if(!s)return!1}if(this.has_(t)){var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:Tt,object:this,oldValue:this.data_.get(t).value_,name:t}:null;return be(function(){var l;r.keysAtom_.reportChanged(),(l=r.hasMap_.get(t))==null||l.setNewValue_(!1);var d=r.data_.get(t);d.setNewValue_(void 0),r.data_.delete(t)}),a&&ue(this,u),!0}return!1},n.updateValue_=function(t,r){var s=this.data_.get(t);if(r=s.prepareNewValue_(r),r!==O.UNCHANGED){var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:ve,object:this,oldValue:s.value_,name:t,newValue:r}:null;s.setNewValue_(r),a&&ue(this,u)}},n.addValue_=function(t,r){var s=this;this.keysAtom_,be(function(){var l,d=new Ee(r,s.enhancer_,"ObservableMap.key",!1);s.data_.set(t,d),r=d.value_,(l=s.hasMap_.get(t))==null||l.setNewValue_(!0),s.keysAtom_.reportChanged()});var o=st(),a=ae(this),u=a||o?{observableKind:"map",debugObjectName:this.name_,type:Ie,object:this,name:t,newValue:r}:null;a&&ue(this,u)},n.get=function(t){return this.has(t)?this.dehanceValue_(this.data_.get(t).get()):this.dehanceValue_(void 0)},n.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},n.keys=function(){return this.keysAtom_.reportObserved(),this.data_.keys()},n.values=function(){var t=this,r=this.keys();return Hn({next:function(){var o=r.next(),a=o.done,u=o.value;return{done:a,value:a?void 0:t.get(u)}}})},n.entries=function(){var t=this,r=this.keys();return Hn({next:function(){var o=r.next(),a=o.done,u=o.value;return{done:a,value:a?void 0:[u,t.get(u)]}}})},n[Symbol.iterator]=function(){return this.entries()},n.forEach=function(t,r){for(var s=ze(this),o;!(o=s()).done;){var a=o.value,u=a[0],l=a[1];t.call(r,l,u,this)}},n.merge=function(t){var r=this;return Be(t)&&(t=new Map(t)),be(function(){Se(t)?pa(t).forEach(function(s){return r.set(s,t[s])}):Array.isArray(t)?t.forEach(function(s){var o=s[0],a=s[1];return r.set(o,a)}):et(t)?(da(t)||T(19,t),t.forEach(function(s,o){return r.set(o,s)})):t!=null&&T(20,t)}),this},n.clear=function(){var t=this;be(function(){Ar(function(){for(var r=ze(t.keys()),s;!(s=r()).done;){var o=s.value;t.delete(o)}})})},n.replace=function(t){var r=this;return be(function(){for(var s=ju(t),o=new Map,a=!1,u=ze(r.data_.keys()),l;!(l=u()).done;){var d=l.value;if(!s.has(d)){var f=r.delete(d);if(f)a=!0;else{var p=r.data_.get(d);o.set(d,p)}}}for(var h=ze(s.entries()),m;!(m=h()).done;){var g=m.value,y=g[0],b=g[1],_=r.data_.has(y);if(r.set(y,b),r.data_.has(y)){var S=r.data_.get(y);o.set(y,S),_||(a=!0)}}if(!a)if(r.data_.size!==o.size)r.keysAtom_.reportChanged();else for(var A=r.data_.keys(),E=o.keys(),M=A.next(),I=E.next();!M.done;){if(M.value!==I.value){r.keysAtom_.reportChanged();break}M=A.next(),I=E.next()}r.data_=o}),this},n.toString=function(){return"[object ObservableMap]"},n.toJSON=function(){return Array.from(this)},n.observe_=function(t,r){return vt(this,t)},n.intercept_=function(t){return mt(this,t)},tt(e,[{key:"size",get:function(){return this.keysAtom_.reportObserved(),this.data_.size}},{key:Symbol.toStringTag,get:function(){return"Map"}}])})(),Be=je("ObservableMap",qr);function Hn(e){return e[Symbol.toStringTag]="MapIterator",kn(e)}function ju(e){if(et(e)||Be(e))return e;if(Array.isArray(e))return new Map(e);if(Se(e)){var n=new Map;for(var i in e)n.set(i,e[i]);return n}else return T(21,e)}var Lu={},Fr=(function(){function e(i,t,r){var s=this;t===void 0&&(t=Ve),r===void 0&&(r="ObservableSet"),this.name_=void 0,this[w]=Lu,this.data_=new Set,this.atom_=void 0,this.changeListeners_=void 0,this.interceptors_=void 0,this.dehancer=void 0,this.enhancer_=void 0,this.name_=r,le(Set)||T(22),this.enhancer_=function(o,a){return t(o,a,r)},qe(function(){s.atom_=hr(s.name_),i&&s.replace(i)})}var n=e.prototype;return n.dehanceValue_=function(t){return this.dehancer!==void 0?this.dehancer(t):t},n.clear=function(){var t=this;be(function(){Ar(function(){for(var r=ze(t.data_.values()),s;!(s=r()).done;){var o=s.value;t.delete(o)}})})},n.forEach=function(t,r){for(var s=ze(this),o;!(o=s()).done;){var a=o.value;t.call(r,a,a,this)}},n.add=function(t){var r=this;if(this.atom_,ie(this)){var s=re(this,{type:Ie,object:this,newValue:t});if(!s)return this;t=s.newValue}if(!this.has(t)){be(function(){r.data_.add(r.enhancer_(t,void 0)),r.atom_.reportChanged()});var o=!1,a=ae(this),u=a||o?{observableKind:"set",debugObjectName:this.name_,type:Ie,object:this,newValue:t}:null;a&&ue(this,u)}return this},n.delete=function(t){var r=this;if(ie(this)){var s=re(this,{type:Tt,object:this,oldValue:t});if(!s)return!1}if(this.has(t)){var o=!1,a=ae(this),u=a||o?{observableKind:"set",debugObjectName:this.name_,type:Tt,object:this,oldValue:t}:null;return be(function(){r.atom_.reportChanged(),r.data_.delete(t)}),a&&ue(this,u),!0}return!1},n.has=function(t){return this.atom_.reportObserved(),this.data_.has(this.dehanceValue_(t))},n.entries=function(){var t=this.values();return Wn({next:function(){var s=t.next(),o=s.value,a=s.done;return a?{value:void 0,done:a}:{value:[o,o],done:a}}})},n.keys=function(){return this.values()},n.values=function(){this.atom_.reportObserved();var t=this,r=this.data_.values();return Wn({next:function(){var o=r.next(),a=o.value,u=o.done;return u?{value:void 0,done:u}:{value:t.dehanceValue_(a),done:u}}})},n.intersection=function(t){if(_e(t)&&!fe(t))return t.intersection(this);var r=new Set(this);return r.intersection(t)},n.union=function(t){if(_e(t)&&!fe(t))return t.union(this);var r=new Set(this);return r.union(t)},n.difference=function(t){return new Set(this).difference(t)},n.symmetricDifference=function(t){if(_e(t)&&!fe(t))return t.symmetricDifference(this);var r=new Set(this);return r.symmetricDifference(t)},n.isSubsetOf=function(t){return new Set(this).isSubsetOf(t)},n.isSupersetOf=function(t){return new Set(this).isSupersetOf(t)},n.isDisjointFrom=function(t){if(_e(t)&&!fe(t))return t.isDisjointFrom(this);var r=new Set(this);return r.isDisjointFrom(t)},n.replace=function(t){var r=this;return fe(t)&&(t=new Set(t)),be(function(){Array.isArray(t)?(r.clear(),t.forEach(function(s){return r.add(s)})):_e(t)?(r.clear(),t.forEach(function(s){return r.add(s)})):t!=null&&T("Cannot initialize set from "+t)}),this},n.observe_=function(t,r){return vt(this,t)},n.intercept_=function(t){return mt(this,t)},n.toJSON=function(){return Array.from(this)},n.toString=function(){return"[object ObservableSet]"},n[Symbol.iterator]=function(){return this.values()},tt(e,[{key:"size",get:function(){return this.atom_.reportObserved(),this.data_.size}},{key:Symbol.toStringTag,get:function(){return"Set"}}])})(),fe=je("ObservableSet",Fr);function Wn(e){return e[Symbol.toStringTag]="SetIterator",kn(e)}var Yn=Object.create(null),Xn="remove",$r=(function(){function e(i,t,r,s){t===void 0&&(t=new Map),s===void 0&&(s=Fa),this.target_=void 0,this.values_=void 0,this.name_=void 0,this.defaultAnnotation_=void 0,this.keysAtom_=void 0,this.changeListeners_=void 0,this.interceptors_=void 0,this.proxy_=void 0,this.isPlainObject_=void 0,this.appliedAnnotations_=void 0,this.pendingKeys_=void 0,this.target_=i,this.values_=t,this.name_=r,this.defaultAnnotation_=s,this.keysAtom_=new Ne("ObservableObject.keys"),this.isPlainObject_=Se(this.target_)}var n=e.prototype;return n.getObservablePropValue_=function(t){return this.values_.get(t).get()},n.setObservablePropValue_=function(t,r){var s=this.values_.get(t);if(s instanceof ce)return s.set(r),!0;if(ie(this)){var o=re(this,{type:ve,object:this.proxy_||this.target_,name:t,newValue:r});if(!o)return null;r=o.newValue}if(r=s.prepareNewValue_(r),r!==O.UNCHANGED){var a=ae(this),u=!1,l=a||u?{type:ve,observableKind:"object",debugObjectName:this.name_,object:this.proxy_||this.target_,oldValue:s.value_,name:t,newValue:r}:null;s.setNewValue_(r),a&&ue(this,l)}return!0},n.get_=function(t){return O.trackingDerivation&&!ke(this.target_,t)&&this.has_(t),this.target_[t]},n.set_=function(t,r,s){return s===void 0&&(s=!1),ke(this.target_,t)?this.values_.has(t)?this.setObservablePropValue_(t,r):s?Reflect.set(this.target_,t,r):(this.target_[t]=r,!0):this.extend_(t,{value:r,enumerable:!0,writable:!0,configurable:!0},this.defaultAnnotation_,s)},n.has_=function(t){if(!O.trackingDerivation)return t in this.target_;this.pendingKeys_||(this.pendingKeys_=new Map);var r=this.pendingKeys_.get(t);return r||(r=new Ee(t in this.target_,Lt,"ObservableObject.key?",!1),this.pendingKeys_.set(t,r)),r.get()},n.make_=function(t,r){if(r===!0&&(r=this.defaultAnnotation_),r!==!1){if(!(t in this.target_)){var s;if((s=this.target_[Ge])!=null&&s[t])return;T(1,r.annotationType_,this.name_+"."+t.toString())}for(var o=this.target_;o&&o!==Pt;){var a=At(o,t);if(a){var u=r.make_(this,t,a,o);if(u===0)return;if(u===1)break}o=Object.getPrototypeOf(o)}Jn(this,r,t)}},n.extend_=function(t,r,s,o){if(o===void 0&&(o=!1),s===!0&&(s=this.defaultAnnotation_),s===!1)return this.defineProperty_(t,r,o);var a=s.extend_(this,t,r,o);return a&&Jn(this,s,t),a},n.defineProperty_=function(t,r,s){s===void 0&&(s=!1),this.keysAtom_;try{se();var o=this.delete_(t);if(!o)return o;if(ie(this)){var a=re(this,{object:this.proxy_||this.target_,name:t,type:Ie,newValue:r.value});if(!a)return null;var u=a.newValue;r.value!==u&&(r=Ze({},r,{value:u}))}if(s){if(!Reflect.defineProperty(this.target_,t,r))return!1}else he(this.target_,t,r);this.notifyPropertyAddition_(t,r.value)}finally{oe()}return!0},n.defineObservableProperty_=function(t,r,s,o){o===void 0&&(o=!1),this.keysAtom_;try{se();var a=this.delete_(t);if(!a)return a;if(ie(this)){var u=re(this,{object:this.proxy_||this.target_,name:t,type:Ie,newValue:r});if(!u)return null;r=u.newValue}var l=Zn(t),d={configurable:O.safeDescriptors?this.isPlainObject_:!0,enumerable:!0,get:l.get,set:l.set};if(o){if(!Reflect.defineProperty(this.target_,t,d))return!1}else he(this.target_,t,d);var f=new Ee(r,s,"ObservableObject.key",!1);this.values_.set(t,f),this.notifyPropertyAddition_(t,f.value_)}finally{oe()}return!0},n.defineComputedProperty_=function(t,r,s){s===void 0&&(s=!1),this.keysAtom_;try{se();var o=this.delete_(t);if(!o)return o;if(ie(this)){var a=re(this,{object:this.proxy_||this.target_,name:t,type:Ie,newValue:void 0});if(!a)return null}r.name||(r.name="ObservableObject.key"),r.context=this.proxy_||this.target_;var u=Zn(t),l={configurable:O.safeDescriptors?this.isPlainObject_:!0,enumerable:!1,get:u.get,set:u.set};if(s){if(!Reflect.defineProperty(this.target_,t,l))return!1}else he(this.target_,t,l);this.values_.set(t,new ce(r)),this.notifyPropertyAddition_(t,void 0)}finally{oe()}return!0},n.delete_=function(t,r){if(r===void 0&&(r=!1),this.keysAtom_,!ke(this.target_,t))return!0;if(ie(this)){var s=re(this,{object:this.proxy_||this.target_,name:t,type:Xn});if(!s)return null}try{var o;se();var a=ae(this),u=!1,l=this.values_.get(t),d=void 0;if(!l&&(a||u)){var f;d=(f=At(this.target_,t))==null?void 0:f.value}if(r){if(!Reflect.deleteProperty(this.target_,t))return!1}else delete this.target_[t];if(l&&(this.values_.delete(t),l instanceof Ee&&(d=l.value_),Nr(l)),this.keysAtom_.reportChanged(),(o=this.pendingKeys_)==null||(o=o.get(t))==null||o.set(t in this.target_),a||u){var p={type:Xn,observableKind:"object",object:this.proxy_||this.target_,debugObjectName:this.name_,oldValue:d,name:t};a&&ue(this,p)}}finally{oe()}return!0},n.observe_=function(t,r){return vt(this,t)},n.intercept_=function(t){return mt(this,t)},n.notifyPropertyAddition_=function(t,r){var s,o=ae(this),a=!1;if(o||a){var u=o||a?{type:Ie,observableKind:"object",debugObjectName:this.name_,object:this.proxy_||this.target_,name:t,newValue:r}:null;o&&ue(this,u)}(s=this.pendingKeys_)==null||(s=s.get(t))==null||s.set(!0),this.keysAtom_.reportChanged()},n.ownKeys_=function(){return this.keysAtom_.reportObserved(),at(this.target_)},n.keys_=function(){return this.keysAtom_.reportObserved(),Object.keys(this.target_)},e})();function it(e,n){var i;if(ke(e,w))return e;var t=(i=n?.name)!=null?i:"ObservableObject",r=new $r(e,new Map,String(t),Ja(n));return jt(e,w,r),e}var Bu=je("ObservableObjectAdministration",$r);function Zn(e){return Yn[e]||(Yn[e]={get:function(){return this[w].getObservablePropValue_(e)},set:function(i){return this[w].setObservablePropValue_(e,i)}})}function Ut(e){return Dt(e)?Bu(e[w]):!1}function Jn(e,n,i){var t;(t=e.target_[Ge])==null||delete t[i]}var qu=zr(0),Fu=(function(){var e=!1,n={};return Object.defineProperty(n,"0",{set:function(){e=!0}}),Object.create(n)[0]=1,e===!1})(),en=0,Ur=function(){};function $u(e,n){Object.setPrototypeOf?Object.setPrototypeOf(e.prototype,n):e.prototype.__proto__!==void 0?e.prototype.__proto__=n:e.prototype=n}$u(Ur,Array.prototype);var In=(function(e){function n(t,r,s,o){var a;return s===void 0&&(s="ObservableArray"),o===void 0&&(o=!1),a=e.call(this)||this,qe(function(){var u=new wn(s,r,o,!0);u.proxy_=a,cr(a,w,u),t&&t.length&&a.spliceWithArray(0,0,t),Fu&&Object.defineProperty(a,"0",qu)}),a}fr(n,e);var i=n.prototype;return i.concat=function(){this[w].atom_.reportObserved();for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return Array.prototype.concat.apply(this.slice(),s.map(function(a){return $t(a)?a.slice():a}))},i[Symbol.iterator]=function(){var t=this,r=0;return kn({next:function(){return r<t.length?{value:t[r++],done:!1}:{done:!0,value:void 0}}})},tt(n,[{key:"length",get:function(){return this[w].getArrayLength_()},set:function(r){this[w].setArrayLength_(r)}},{key:Symbol.toStringTag,get:function(){return"Array"}}])})(Ur);Object.entries(Ct).forEach(function(e){var n=e[0],i=e[1];n!=="concat"&&jt(In.prototype,n,i)});function zr(e){return{enumerable:!1,configurable:!0,get:function(){return this[w].get_(e)},set:function(i){this[w].set_(e,i)}}}function Uu(e){he(In.prototype,""+e,zr(e))}function Gr(e){if(e>en){for(var n=en;n<e+100;n++)Uu(n);en=e}}Gr(1e3);function zu(e,n,i){return new In(e,n,i)}function dn(e,n){if(typeof e=="object"&&e!==null){if($t(e))return n!==void 0&&T(23),e[w].atom_;if(fe(e))return e.atom_;if(Be(e)){if(n===void 0)return e.keysAtom_;var i=e.data_.get(n)||e.hasMap_.get(n);return i||T(25,n,pn(e)),i}if(Ut(e)){if(!n)return T(26);var t=e[w].values_.get(n);return t||T(27,n,pn(e)),t}if(bn(e)||Ft(e)||Nt(e))return e}else if(le(e)&&Nt(e[w]))return e[w];T(28)}function Gu(e,n){if(e||T(29),bn(e)||Ft(e)||Nt(e)||Be(e)||fe(e))return e;if(e[w])return e[w];T(24,e)}function pn(e,n){var i;if(n!==void 0)i=dn(e,n);else{if(Je(e))return e.name;Ut(e)||Be(e)||fe(e)?i=Gu(e):i=dn(e)}return i.name_}function qe(e){var n=Le(),i=On(!0);se();try{return e()}finally{oe(),Sn(i),Oe(n)}}var Qn=Pt.toString;function Kr(e,n,i){return i===void 0&&(i=-1),fn(e,n,i)}function fn(e,n,i,t,r){if(e===n)return e!==0||1/e===1/n;if(e==null||n==null)return!1;if(e!==e)return n!==n;var s=typeof e;if(s!=="function"&&s!=="object"&&typeof n!="object")return!1;var o=Qn.call(e);if(o!==Qn.call(n))return!1;switch(o){case"[object RegExp]":case"[object String]":return""+e==""+n;case"[object Number]":return+e!=+e?+n!=+n:+e==0?1/+e===1/n:+e==+n;case"[object Date]":case"[object Boolean]":return+e==+n;case"[object Symbol]":return typeof Symbol<"u"&&Symbol.valueOf.call(e)===Symbol.valueOf.call(n);case"[object Map]":case"[object Set]":i>=0&&i++;break}e=ei(e),n=ei(n);var a=o==="[object Array]";if(!a){if(typeof e!="object"||typeof n!="object")return!1;var u=e.constructor,l=n.constructor;if(u!==l&&!(le(u)&&u instanceof u&&le(l)&&l instanceof l)&&"constructor"in e&&"constructor"in n)return!1}if(i===0)return!1;i<0&&(i=-1),t=t||[],r=r||[];for(var d=t.length;d--;)if(t[d]===e)return r[d]===n;if(t.push(e),r.push(n),a){if(d=e.length,d!==n.length)return!1;for(;d--;)if(!fn(e[d],n[d],i-1,t,r))return!1}else{var f=Object.keys(e),p=f.length;if(Object.keys(n).length!==p)return!1;for(var h=0;h<p;h++){var m=f[h];if(!(ke(n,m)&&fn(e[m],n[m],i-1,t,r)))return!1}}return t.pop(),r.pop(),!0}function ei(e){return $t(e)?e.slice():et(e)||Be(e)||_e(e)||fe(e)?Array.from(e.entries()):e}var ti,Ku=((ti=_n().Iterator)==null?void 0:ti.prototype)||{};function kn(e){return e[Symbol.iterator]=Hu,Object.assign(Object.create(Ku),e)}function Hu(){return this}["Symbol","Map","Set"].forEach(function(e){var n=_n();typeof n[e]>"u"&&T("MobX requires global '"+e+"' to be available or polyfilled")});typeof __MOBX_DEVTOOLS_GLOBAL_HOOK__=="object"&&__MOBX_DEVTOOLS_GLOBAL_HOOK__.injectMobx({spy:mu,extras:{getDebugName:pn},$mobx:w});class De{constructor(n,i,t){this.id=n.id,this.name=t||n.name||"Untitled",this.type=n.valuetype||"unknown",this.value=n.value;const r=i.endsWith("/")?"":"/",s=this.name.toLowerCase().replace(/[^a-z0-9]+/g,"_");this.path=`${i}${r}${s}`,nt(this)}update(n){this.value=n}}class Mn{constructor(n,i){this.params=[],this.id=n.id,this.name=n.name?.value||n.display_name||`Effect ${n.id}`,this.path=`${i}/effects/${n.id}`,nt(this),this.parse(n)}parse(n){if(n.params)for(const[i,t]of Object.entries(n.params))ct(t)&&this.params.push(new De(t,this.path,i));for(const[i,t]of Object.entries(n))i!=="params"&&ct(t)&&this.params.push(new De(t,this.path,i))}}class Wu{constructor(n,i,t){this.params=[],this.effects=[],this.id=n.id,this.name=n.name?.value||`Clip ${t+1}`,this.path=`${i}/clips/${t+1}`,n.thumbnail?.path&&(this.thumbnail=n.thumbnail.path),nt(this),this.parse(n)}parse(n){const i=(t,r)=>{for(const[s,o]of Object.entries(t))s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mn(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&i(o,`${r}/${s}`)};i(n,this.path)}}class Yu{constructor(n,i,t){this.clips=[],this.params=[],this.effects=[],this.id=n.id,this.name=n.name?.value||`Layer ${t+1}`,this.path=`${i}/layers/${t+1}`,nt(this),this.parse(n)}parse(n){n.clips&&Array.isArray(n.clips)&&(this.clips=n.clips.map((t,r)=>new Wu(t,this.path,r)));const i=(t,r)=>{for(const[s,o]of Object.entries(t))s!=="clips"&&(s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mn(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&i(o,`${r}/${s}`))};i(n,this.path)}}class Xu{constructor(){this.layers=[],this.params=[],this.effects=[],this.path="/composition",nt(this)}load(n){this.layers=[],this.params=[],this.effects=[],n.layers&&Array.isArray(n.layers)&&(this.layers=n.layers.map((t,r)=>new Yu(t,this.path,r)));const i=(t,r)=>{for(const[s,o]of Object.entries(t))s==="layers"||s==="decks"||(s==="effects"&&Array.isArray(o)?o.forEach(a=>this.effects.push(new Mn(a,r))):ct(o)?this.params.push(new De(o,r,s)):typeof o=="object"&&o!==null&&!Array.isArray(o)&&i(o,`${r}/${s}`))};i(n,this.path)}}function ct(e){return typeof e=="object"&&e!==null&&"valuetype"in e&&"id"in e}class Zu{constructor(n){let i=n?.baseUrl??"http://127.0.0.1:8080",t=n?.customFetch,r=n?.customWebSocket??WebSocket;i.endsWith("/")&&(i=i.slice(0,-1)),this.apiBaseUrl=`${i}/api/v1`,this.customFetch=t,this.WebSocket=r}async request(n,i){try{const t=`${this.apiBaseUrl}${n}`,r=await(this.customFetch??fetch)(t,i);if(!r.ok)throw new Error(`API request failed: ${r.status} ${r.statusText}`);return r.status===204?void 0:await r.json()}catch(t){throw console.error("[RealResolumeApiClient] Error in request:",t),t}}getProductInfo(){return this.request("/product")}connectWebSocket(n,i,t){const r=this.apiBaseUrl.replace(/^http/,"ws"),s=new this.WebSocket(r);return s.onmessage=o=>{try{const a=JSON.parse(o.data);n(a)}catch(a){console.error("[RealResolumeApiClient] Error parsing message:",a)}},i&&(s.onerror=i),t&&(s.onclose=t),s.onopen=()=>console.log("[RealResolumeApiClient] Connection established."),{send:o=>{s.readyState===s.OPEN?s.send(JSON.stringify(o)):console.warn("[RealResolumeApiClient] WebSocket is not open. Message not sent:",o)},close:()=>s.close(),get readyState(){return s.readyState}}}}class Ju{constructor(n){this.ws=null,this.isConnecting=!1,this.parameterMap=new Map,this.subscriptions=new Map,this.client=n?.client??new Zu,this.state=new Xu,nt(this)}subscribe(n,i,t){this.subscriptions.has(n)||this.subscriptions.set(n,new Map),this.subscriptions.get(n).set(i,t);const r=this.getParameter(n);r&&this.ws?(this.sendSubscription(r),t&&t(r.value)):console.log(`[ResolumeManager] Queued subscription for ${n} (Connected: ${!!this.ws}, Param found: ${!!r})`)}sendSubscription(n){this.ws&&this.ws.send({action:"subscribe",parameter:`/parameter/by-id/${n.id}`})}unsubscribe(n,i){const t=this.subscriptions.get(n);t&&(t.delete(i),t.size===0&&this.subscriptions.delete(n))}async connect(){if(!(this.isConnected||this.isConnecting)){this.isConnecting=!0,console.log("[ResolumeManager] Connecting...");try{const n=await this.client.getProductInfo();console.log(`[ResolumeManager] Connected to ${n.name} v${n.major}.${n.minor}`),this.ws=this.client.connectWebSocket(i=>this.handleMessage(i),i=>console.error("[ResolumeManager] WS Error:",i),()=>{console.log("[ResolumeManager] WS Closed"),this.isConnecting=!1})}catch(n){console.error("[ResolumeManager] Connection failed:",n),this.isConnecting=!1}}}get isConnected(){return!!this.ws}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}handleMessage(n){if(n.layers&&n.decks)console.log("[ResolumeManager] Received initial state"),this.state.load(n),this.rebuildParameterMap();else if(n.type==="parameter_update"){const i=this.findParameterById(n.id);if(i){i.update(n.value);const t=this.subscriptions.get(i.path);t&&t.forEach(r=>{r&&r(n.value)})}}}rebuildParameterMap(){this.parameterMap.clear();const n=i=>{i instanceof De&&this.parameterMap.set(i.path,i);for(const t in i){const r=i[t];Array.isArray(r)?r.forEach(n):typeof r=="object"&&r!==null&&(r instanceof De||r.constructor.name.startsWith("Resolume"))&&n(r)}};n(this.state),console.log(`[ResolumeManager] Indexed ${this.parameterMap.size} parameters`);for(const[i,t]of this.subscriptions.entries()){const r=this.parameterMap.get(i);r&&(console.log(`[ResolumeManager] Resubscribing to ${i}`),this.sendSubscription(r),t.forEach(s=>{s&&s(r.value)}))}}findParameterById(n){for(const i of this.parameterMap.values())if(i.id===n)return i}getParameter(n){return this.parameterMap.get(n)}setValue(n,i){const t=this.getParameter(n);t&&this.ws&&this.ws.send({action:"set",parameter:`/parameter/by-id/${t.id}`,id:t.id,value:i})}}const xe=new Ju;class Nn{constructor(n,i,t){this.context=n,this.nodeId=i,this.paramName=t}setValueAtTime(n,i){const t=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"setParamValue",id:this.nodeId,param:this.paramName,value:n,time:t})}linearRampToValueAtTime(n,i){const t=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"linearRampToValueAtTime",id:this.nodeId,param:this.paramName,value:n,time:t})}exponentialRampToValueAtTime(n,i){const t=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"exponentialRampToValueAtTime",id:this.nodeId,param:this.paramName,value:n,time:t})}setTargetAtTime(n,i,t){const r=Math.max(0,i-this.context.currentTime);this.context.addCommand({type:"setTargetAtTime",id:this.nodeId,param:this.paramName,target:n,startTime:r,timeConstant:t})}cancelScheduledValues(n){const i=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"cancelScheduledValues",id:this.nodeId,param:this.paramName,time:i})}}class zt{constructor(n,i){this.id=n,this.context=i}connect(n){this.context.addCommand({type:"connect",sourceId:this.id,destId:n.id})}disconnect(){this.context.addCommand({type:"disconnect",sourceId:this.id})}dispose(){this.context.addCommand({type:"dispose",id:this.id})}}class Qu extends zt{constructor(n,i){super(n,i),this.frequency=new Nn(i,n,"frequency")}set type(n){this.context.addCommand({type:"setNodeProperty",id:this.id,property:"type",value:n})}start(n=0){const i=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"start",id:this.id,time:i})}stop(n=0){const i=Math.max(0,n-this.context.currentTime);this.context.addCommand({type:"stop",id:this.id,time:i})}}class el extends zt{constructor(n,i){super(n,i),this.gain=new Nn(i,n,"gain")}}class tl extends zt{constructor(n,i){super(n,i),this.frequency=new Nn(i,n,"frequency")}set type(n){this.context.addCommand({type:"setNodeProperty",id:this.id,property:"type",value:n})}}class nl{constructor(){this.commands=[],this.nodeCount=0,this.state="running",this.currentTime=0,this.contextId=Math.random().toString(36).slice(2),this.destination=new zt("destination",this)}createOscillator(){const n=`osc-${this.nodeCount++}`;return this.addCommand({type:"createOscillator",id:n}),new Qu(n,this)}createGain(){const n=`gain-${this.nodeCount++}`;return this.addCommand({type:"createGain",id:n}),new el(n,this)}createBiquadFilter(){const n=`filter-${this.nodeCount++}`;return this.addCommand({type:"createBiquadFilter",id:n}),new tl(n,this)}addCommand(n){this.commands.push(n)}flushCommands(){const n=this.commands;return this.commands=[],n}reset(){this.commands=[],this.addCommand({type:"clear"}),this.nodeCount=0,this.contextId=Math.random().toString(36).slice(2)}}class il{constructor(){this.enabled=!1,this.isActive=!1,this.pendingResync=!1,this.lastBarPhase=0,this.currentAuxPort=null,this.externalBpm=120,this.externalBarPhase=null,this.hasValidExternalClock=!1,this.lastExternalUpdate=0}setEnabled(n){this.enabled=n,this.updateValidity()}setBeatSyncActive(n){this.isActive=n,this.updateValidity()}updateValidity(){this.isActive||(this.hasValidExternalClock=!1,this.externalBarPhase=null)}handlePort(n){this.currentAuxPort&&(this.currentAuxPort.close(),this.currentAuxPort.onmessage=null),this.currentAuxPort=n,this.currentAuxPort.onmessage=i=>this.onMessage(i)}onMessage(n){const i=n.data;i.type==="CLOCK_UPDATE"?this.handleClockUpdate(i):i.type==="CLOCK_STREAM"?this.handleClockStream(i):i.type==="CLOCK_HARD_SYNC"&&this.handleHardSync()}handleHardSync(){this.enabled&&(xe.setValue("/composition/tempocontroller/resync",!0),xe.setValue("/composition/tempocontroller/resync",!1)),this.pendingResync=!1}handleClockUpdate(n){this.enabled&&(n.bpm&&xe.setValue("/composition/tempocontroller/tempo",n.bpm),n.phase!==void 0&&n.kind==="sync"&&(this.pendingResync=!0))}handleClockStream(n){if(!this.isActive)return;const i=n.data;this.externalBpm=i.bpm,this.externalBarPhase=i.barPhase,this.hasValidExternalClock=!0,this.lastExternalUpdate=self.performance.now();const t=i.barPhase;if(this.pendingResync&&this.enabled){const r=Math.floor(t/4),s=Math.floor(this.lastBarPhase/4);r>s&&(xe.setValue("/composition/tempocontroller/resync",!0),xe.setValue("/composition/tempocontroller/resync",!1),this.pendingResync=!1)}this.lastBarPhase=t}}const ge=new il;let B=null,bt=null,Cn=60,Et=!1,He=new nl,ot=new Map,Te={beat:0},Hr=new Map,hn=[];self.onerror=e=>{console.error("Executor Worker Error (Global):",e)};self.onmessage=e=>{const n=e.data;switch(n.type){case"CONNECT_AUX_PORT":ge.handlePort(n.port);break;case"RESOLUME_SETTINGS":ge.setEnabled(n.enabled);break;case"BEAT_SYNC_STATE":ge.setBeatSyncActive(n.isActive);break;case"INIT_GRAPH":let i,t,r;if(n.isRecompilation&&B&&(i=B.getNodeStates(),t=B.getUserNodeStates(),r=B.getInputs()),B=new aa(n.graph,ii,i,n.inferredNodeTypes,n.dirtyNodeIds,n.nodeMetadata,n.idMap),n.idMap){ot.clear();for(const[o,a]of Object.entries(n.idMap))ot.set(a,o)}if(t&&B.setUserNodeStates(t),r)for(const[o,a]of r)B.setInput(o,a);n.isRecompilation||He.reset();const s=B.getInferredNodeTypes();s&&self.postMessage({type:"INFERRED_TYPES",inferredNodeTypes:s});break;case"UPDATE_CONFIG":B&&B.setNodeConfig(n.nodeId,n.config);break;case"UPDATE_INPUT":if(B)if(B.getNodeConfig(n.name)!==void 0){const o=B.getNodeConfig(n.name)||{fields:{},untagged:[]},a=o.values||{},u={...o,values:{...a,...n.value}};B.setNodeConfig(n.name,u)}else B.setInput(n.name,n.value);break;case"CONTROL":n.action==="START"?(n.frameRate&&(Cn=n.frameRate),rl()):n.action==="STOP"?sl():n.action==="STEP"&&Wr();break;case"UPDATE_AUDIO_STATE":He.state=n.state;break;case"RESOLUME_CONTROL":n.action==="connect"?xe.connect():n.action==="disconnect"&&xe.disconnect();break;case"RESOLUME_SET_VALUE":xe.setValue(n.path,n.value);break;case"MIDI_UPDATE":Hr=n.values,n.events&&(hn=n.events);break;case"NODE_MESSAGE":B&&B.handleNodeMessage(n.nodeId,n.message);break}};function rl(){Et||(Et=!0,bt=setInterval(()=>{Wr()},1e3/Cn))}function sl(){Et&&(Et=!1,bt&&(clearInterval(bt),bt=null))}function Wr(){if(!B)return;const e=self.performance.now(),n=1/Cn;let i=120;const r=self.performance.now()-ge.lastExternalUpdate<2e3;if(ge.hasValidExternalClock&&ge.externalBpm>0&&r&&(i=ge.externalBpm,ge.externalBarPhase!==null)){const y=Te.beat%4,b=ge.externalBarPhase%4;let _=b-y;if(_>2&&(_-=4),_<-2&&(_+=4),Math.abs(_)>1){let E=Math.floor(Te.beat/4)*4+b;E<Te.beat&&(E+=4),Te.beat=E}else{const E=_*2*n;Te.beat+=E}}const s=i/60;Te.beat+=n*s,He.currentTime+=n;try{B.update({clock:{beat:Te.beat,dt:n},audio:{context:He},time:He.currentTime,midi:{values:Hr,events:hn},resolume:xe}),hn=[]}catch(y){console.error("Executor Worker: Error during update",y);return}const o=self.performance.now(),a=B.getExecutedNodes(),u=B.getOutputs(),l=new Map;for(const y of a){const b=u.get(y);if(b){const _=ot.get(y)||y;l.set(_,mn(b))}}const d=B.getInspectedInputs(),f=new Map;for(const y of a){const b=d.get(y);if(b){const _=ot.get(y)||y;f.set(_,mn(b))}}const p=B.getUiOutputs(),h=new Map;for(const y of a){const b=p.get(y);if(b!==void 0){const _=ot.get(y)||y;h.set(_,b)}}const m=He.flushCommands(),g={type:"EXECUTION_UPDATE",outputs:l,inputs:f,uiOutputs:h,stats:{nodeCount:B.graphNodeCount,executionTime:o-e},audioCommands:m.length>0?m:void 0};self.postMessage(g)}function mn(e){return{fields:Yr(e.fields)}}function Yr(e){const n={};for(const i in e)n[i]=Xr(e[i]);return n}function Xr(e){return typeof e=="function"?"<function>":Array.isArray(e)?e.map(Xr):typeof e=="object"&&e!==null?"fields"in e?mn(e):Yr(e):e}
//# sourceMappingURL=executor.worker-Bpnohyn6.js.map
